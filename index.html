<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prysmis AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        body {
            background: linear-gradient(145deg, #0a0f1e, #1a2436);
            color: #e2e8f0;
            line-height: 1.6;
            overflow: hidden;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        body.light-mode {
            background: linear-gradient(145deg, #d1e0ff, #f7f9fc);
            color: #1a2436;
        }
        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }
        .sidebar {
            width: 0;
            background: rgba(8, 12, 24, 0.98);
            backdrop-filter: blur(18px);
            padding: 0;
            overflow-y: auto;
            transition: width 0.3s ease, padding 0.3s ease;
            border-right: 1px solid rgba(255, 255, 255, 0.15);
        }
        .sidebar.open {
            width: 280px;
            padding: 1.5rem;
        }
        .sidebar-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .sidebar-content button {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.8rem 1.2rem;
            background: rgba(30, 41, 59, 0.8);
            border: none;
            border-radius: 10px;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .sidebar-content button:hover {
            background: rgba(55, 65, 81, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            background: rgba(8, 12, 24, 0.99);
            backdrop-filter: blur(18px);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: rgba(8, 12, 24, 0.95);
            scrollbar-width: thin;
            scrollbar-color: #60a5fa #1a2436;
        }
        .chat-area::-webkit-scrollbar {
            width: 8px;
        }
        .chat-area::-webkit-scrollbar-thumb {
            background: #60a5fa;
            border-radius: 4px;
        }
        .chat-message {
            max-width: 70%;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1.2rem;
            background: rgba(30, 41, 59, 0.98);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .chat-message:hover {
            transform: scale(1.01);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .chat-message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            color: #fff;
        }
        .chat-message.assistant {
            align-self: flex-start;
            background: linear-gradient(135deg, #34d399, #10b981);
            color: #fff;
        }
        .chat-message-content pre {
            background: #0f172a;
            border-radius: 10px;
            padding: 1.2rem;
            overflow-x: auto;
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            position: relative;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
            border-left: 4px solid #60a5fa;
        }
        .chat-message-content pre .copy-btn {
            position: absolute;
            top: 0.8rem;
            right: 0.8rem;
            background: #60a5fa;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s ease;
        }
        .chat-message-content pre .copy-btn:hover {
            background: #3b82f6;
        }
        .chat-input-area {
            background: rgba(8, 12, 24, 0.99);
            backdrop-filter: blur(18px);
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
        }
        .file-upload-progress {
            height: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
            overflow: hidden;
            transition: height 0.3s ease;
        }
        .file-upload-progress div {
            height: 100%;
            background: #60a5fa;
            transition: width 0.3s ease;
        }
        .file-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }
        .file-actions.open {
            max-height: 200px;
            opacity: 1;
        }
        .input-wrapper {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        #userInput {
            flex: 1;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            background: #1a2436;
            color: #e2e8f0;
            resize: none;
            min-height: 50px;
            max-height: 150px;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #userInput:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 8px rgba(96, 165, 250, 0.3);
            outline: none;
        }
        button {
            padding: 0.8rem 1.5rem;
            background: linear-gradient(90deg, #60a5fa, #3b82f6);
            color: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            background: linear-gradient(90deg, #3b82f6, #1e40af);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .right-sidebar {
            width: 0;
            background: rgba(8, 12, 24, 0.98);
            backdrop-filter: blur(18px);
            padding: 0;
            overflow-y: auto;
            transition: width 0.3s ease;
            border-left: 1px solid rgba(255, 255, 255, 0.15);
        }
        .right-sidebar.open {
            width: 380px;
            padding: 1.5rem;
        }
        .right-sidebar-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .game-vm, .code-editor {
            background: #0f172a;
            border-radius: 12px;
            padding: 1.5rem;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .game-vm {
            width: 100%;
            height: 480px;
            background: #000;
        }
        .code-editor {
            height: 480px;
        }
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .modal.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: rgba(8, 12, 24, 0.99);
            backdrop-filter: blur(18px);
            padding: 2rem;
            border-radius: 12px;
            max-width: 85%;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.15);
            transform: scale(0.95);
            transition: transform 0.3s ease;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }
        .modal.open .modal-content {
            transform: scale(1);
        }
        .modal-content h3 {
            margin-bottom: 1rem;
        }
        .modal-content input, .modal-content select, .modal-content textarea {
            margin-bottom: 1rem;
            width: 100%;
        }
        .notification {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            padding: 1rem 2rem;
            border-radius: 10px;
            color: #fff;
            backdrop-filter: blur(18px);
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 1000;
            background: linear-gradient(135deg, #1a2436, #0f172a);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        select, input[type="text"], input[type="number"] {
            padding: 0.8rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            background: #1a2436;
            color: #e2e8f0;
            cursor: pointer;
            appearance: none;
            font-size: 0.9rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        select:focus, input[type="text"]:focus, input[type="number"]:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 8px rgba(96, 165, 250, 0.3);
            outline: none;
        }
        .select-wrapper {
            position: relative;
        }
        .select-wrapper::after {
            content: '▼';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #e2e8f0;
            pointer-events: none;
        }
        #aiModelSelect {
            background: #1a2436;
            padding: 0.8rem 2.5rem 0.8rem 1rem;
            border-radius: 10px;
            color: #e2e8f0;
            cursor: pointer;
        }
        #aiModelSelect option {
            background: #1a2436;
            color: #e2e8f0;
        }
        .message-view {
            display: none;
            background: #1a2436;
            padding: 1rem;
            border-radius: 10px;
            max-height: 320px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        #aiModelSelect.open + .message-view {
            display: block;
        }
        @media (max-width: 768px) {
            .sidebar.open {
                width: 240px;
                padding: 1rem;
            }
            .right-sidebar.open {
                width: 320px;
                padding: 1rem;
            }
            .chat-header, .chat-input-area {
                padding: 0.8rem;
            }
            .chat-area {
                padding: 1rem;
            }
            .chat-message {
                padding: 0.8rem;
                border-radius: 10px;
            }
            .game-vm, .code-editor {
                height: 400px;
            }
        }
        @media (max-width: 480px) {
            .sidebar.open {
                width: 220px;
            }
            .right-sidebar.open {
                width: 300px;
            }
            .chat-header, .chat-input-area {
                padding: 0.6rem;
            }
            .chat-area {
                padding: 0.8rem;
            }
            .chat-message {
                padding: 0.6rem;
                border-radius: 8px;
            }
            .game-vm, .code-editor {
                height: 320px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-content">
                <button id="sidebarClose"><i class="fas fa-times"></i> Close</button>
                <button id="clearChatBtn"><i class="fas fa-trash"></i> Clear Chat</button>
                <button id="exportChatBtn"><i class="fas fa-download"></i> Export Chat</button>
                <button id="shareWebsiteBtn"><i class="fas fa-share"></i> Share</button>
                <button id="feedbackBtn"><i class="fas fa-comment"></i> Feedback</button>
                <button id="updatesBtn"><i class="fas fa-bell"></i> Updates</button>
                <button id="discordBtn"><i class="fab fa-discord"></i> Discord</button>
                <button id="premiumBtn"><i class="fas fa-star"></i> Premium</button>
                <button id="collaborateBtn"><i class="fas fa-users"></i> Collaborate</button>
            </div>
        </div>
        <div class="chat-container">
            <div class="chat-header">
                <button id="menuBtn"><i class="fas fa-bars"></i> Menu</button>
                <div class="flex gap-4">
                    <button id="themeBtn"><i class="fas fa-sun"></i> Light Mode</button>
                    <button id="userProfileBtn"><i class="fas fa-user"></i> Profile</button>
                    <span id="messageCounter"><i class="fas fa-envelope"></i> Messages: 0</span>
                </div>
            </div>
            <div class="chat-area" id="chatArea">
                <div id="chatHistory"></div>
            </div>
            <div class="chat-input-area">
                <div class="file-actions" id="fileActions">
                    <button id="fileInputBtn"><i class="fas fa-cloud-upload-alt"></i> Choose Files</button>
                    <input type="file" id="fileInput" multiple style="display: none;">
                    <span id="fileInputLabel">No file chosen</span>
                    <button id="fileClearBtn" class="hidden"><i class="fas fa-times"></i> Clear</button>
                    <div class="select-wrapper">
                        <select id="aiModelSelect">
                            <option value="prysmis">Prysmis AI</option>
                            <option value="aria">Aria AI (Beta)</option>
                        </select>
                    </div>
                    <div id="fileList"></div>
                    <div class="file-upload-progress" id="fileUploadProgress"><div style="width: 0%"></div></div>
                    <div class="message-view" id="messageView"></div>
                </div>
                <button id="toggleActionsBtn"><i class="fas fa-cog"></i> Hide Options</button>
                <div class="input-wrapper">
                    <textarea id="userInput" placeholder="Type your message..."></textarea>
                    <button id="sendBtn"><i class="fas fa-paper-plane"></i> Send</button>
                    <button id="rephraseBtn"><i class="fas fa-redo"></i> Rephrase</button>
                    <button id="voiceInputBtn"><i class="fas fa-microphone"></i></button>
                </div>
            </div>
        </div>
        <div class="right-sidebar" id="rightSidebar">
            <div class="right-sidebar-content">
                <button id="rightSidebarClose"><i class="fas fa-times"></i> Close</button>
                <div id="gradeDiagram"></div>
                <div id="gameVM"></div>
                <div id="codeEditor"></div>
            </div>
        </div>
    </div>
    <div class="notification" id="notification"></div>
    <div class="modal" id="userProfileModal">
        <div class="modal-content">
            <button id="userProfileClose"><i class="fas fa-times"></i></button>
            <h3><i class="fas fa-user"></i> User Profile</h3>
            <input type="text" id="usernameInput" placeholder="Enter your username">
            <input type="text" id="openAIKeyInput" placeholder="Enter your OpenAI key">
            <select id="chatLayoutSelect">
                <option value="default">Default Layout</option>
                <option value="compact">Compact</option>
                <option value="spacious">Spacious</option>
            </select>
            <label>Font Size (px):</label>
            <input type="number" id="fontSizeInput" min="12" max="28" value="16">
            <label><input type="checkbox" id="autoScrollToggle" checked> Auto-Scroll</label>
            <button id="saveProfileBtn"><i class="fas fa-save"></i> Save</button>
        </div>
    </div>
    <div class="modal" id="permissionModal">
        <div class="modal-content">
            <button id="permissionModalClose"><i class="fas fa-times"></i></button>
            <h3><i class="fas fa-microphone"></i> Permission Required</h3>
            <p>Allow microphone access?</p>
            <div class="flex gap-4">
                <button id="grantPermissionBtn"><i class="fas fa-check"></i> Grant</button>
                <button id="denyPermissionBtn"><i class="fas fa-times"></i> Deny</button>
            </div>
        </div>
    </div>
    <div class="modal" id="confirmClearModal">
        <div class="modal-content">
            <button id="confirmClearModalClose"><i class="fas fa-times"></i></button>
            <h3><i class="fas fa-trash"></i> Confirm Clear Chat</h3>
            <p>Are you sure you want to clear the chat?</p>
            <div class="flex gap-4">
                <button id="confirmClearBtn"><i class="fas fa-check"></i> Clear</button>
                <button id="cancelClearBtn"><i class="fas fa-times"></i> Cancel</button>
            </div>
        </div>
    </div>
    <div class="modal" id="feedbackModal">
        <div class="modal-content">
            <button id="feedbackModalClose"><i class="fas fa-times"></i></button>
            <h3><i class="fas fa-comment"></i> Feedback</h3>
            <textarea id="feedbackInput" placeholder="Enter your feedback..."></textarea>
            <button id="feedbackSubmitBtn"><i class="fas fa-paper-plane"></i> Submit</button>
        </div>
    </div>
    <div class="modal" id="collaborationModal">
        <div class="modal-content">
            <button id="collaborationModalClose"><i class="fas fa-times"></i></button>
            <h3><i class="fas fa-users"></i> Collaboration</h3>
            <input type="text" id="peerIdInput" placeholder="Enter peer ID to connect">
            <button id="connectPeerBtn"><i class="fas fa-link"></i> Connect</button>
            <p>Your Peer ID: <span id="myPeerId"></span></p>
        </div>
    </div>
    <script>
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } });

        const elements = {
            chatArea: document.getElementById('chatArea'),
            chatHistory: document.getElementById('chatHistory'),
            userInput: document.getElementById('userInput'),
            sendBtn: document.getElementById('sendBtn'),
            rephraseBtn: document.getElementById('rephraseBtn'),
            themeBtn: document.getElementById('themeBtn'),
            userProfileBtn: document.getElementById('userProfileBtn'),
            messageCounter: document.getElementById('messageCounter'),
            fileInput: document.getElementById('fileInput'),
            fileInputBtn: document.getElementById('fileInputBtn'),
            fileClearBtn: document.getElementById('fileClearBtn'),
            fileInputLabel: document.getElementById('fileInputLabel'),
            fileList: document.getElementById('fileList'),
            fileActions: document.getElementById('fileActions'),
            toggleActionsBtn: document.getElementById('toggleActionsBtn'),
            fileUploadProgress: document.getElementById('fileUploadProgress'),
            userProfileModal: document.getElementById('userProfileModal'),
            userProfileClose: document.getElementById('userProfileClose'),
            usernameInput: document.getElementById('usernameInput'),
            openAIKeyInput: document.getElementById('openAIKeyInput'),
            chatLayoutSelect: document.getElementById('chatLayoutSelect'),
            fontSizeInput: document.getElementById('fontSizeInput'),
            autoScrollToggle: document.getElementById('autoScrollToggle'),
            saveProfileBtn: document.getElementById('saveProfileBtn'),
            voiceInputBtn: document.getElementById('voiceInputBtn'),
            permissionModal: document.getElementById('permissionModal'),
            permissionModalClose: document.getElementById('permissionModalClose'),
            grantPermissionBtn: document.getElementById('grantPermissionBtn'),
            denyPermissionBtn: document.getElementById('denyPermissionBtn'),
            notification: document.getElementById('notification'),
            sidebar: document.getElementById('sidebar'),
            sidebarClose: document.getElementById('sidebarClose'),
            menuBtn: document.getElementById('menuBtn'),
            clearChatBtn: document.getElementById('clearChatBtn'),
            confirmClearModal: document.getElementById('confirmClearModal'),
            confirmClearModalClose: document.getElementById('confirmClearModalClose'),
            confirmClearBtn: document.getElementById('confirmClearBtn'),
            cancelClearBtn: document.getElementById('cancelClearBtn'),
            exportChatBtn: document.getElementById('exportChatBtn'),
            shareWebsiteBtn: document.getElementById('shareWebsiteBtn'),
            feedbackBtn: document.getElementById('feedbackBtn'),
            feedbackModal: document.getElementById('feedbackModal'),
            feedbackModalClose: document.getElementById('feedbackModalClose'),
            feedbackInput: document.getElementById('feedbackInput'),
            feedbackSubmitBtn: document.getElementById('feedbackSubmitBtn'),
            updatesBtn: document.getElementById('updatesBtn'),
            discordBtn: document.getElementById('discordBtn'),
            premiumBtn: document.getElementById('premiumBtn'),
            aiModelSelect: document.getElementById('aiModelSelect'),
            messageView: document.getElementById('messageView'),
            rightSidebar: document.getElementById('rightSidebar'),
            rightSidebarClose: document.getElementById('rightSidebarClose'),
            gradeDiagram: document.getElementById('gradeDiagram'),
            gameVM: document.getElementById('gameVM'),
            codeEditor: document.getElementById('codeEditor'),
            collaborateBtn: document.getElementById('collaborateBtn'),
            collaborationModal: document.getElementById('collaborationModal'),
            collaborationModalClose: document.getElementById('collaborationModalClose'),
            peerIdInput: document.getElementById('peerIdInput'),
            connectPeerBtn: document.getElementById('connectPeerBtn'),
            myPeerId: document.getElementById('myPeerId')
        };

        const store = {
            state: {
                conversationHistory: [],
                messageCount: 0,
                filesArray: [],
                userProfile: { username: 'User', openAIKey: '', chatLayout: 'default', preferences: { fontSize: 16, autoScroll: true } },
                isDarkMode: true,
                deviceType: '',
                notificationQueue: [],
                rateLimit: { interval: 8, lastAction: 0 },
                selectedModel: 'prysmis',
                requestTracker: { count: 0, lastReset: Date.now(), maxRequests: 25000, resetInterval: 60000 },
                grades: [],
                gameCode: null,
                pastedMedia: null,
                peerConnection: null,
                peerId: '',
                editorInstance: null,
                welcomeMessageSent: false,
                buttonsEnabled: true
            },
            async dispatch(action) {
                switch (action.type) {
                    case 'SET_STATE':
                        this.state = { ...this.state, ...action.payload };
                        await this.saveState();
                        break;
                    case 'ADD_MESSAGE':
                        this.state.conversationHistory.push(action.payload);
                        this.state.messageCount++;
                        await this.saveState();
                        break;
                    case 'SET_FILES':
                        this.state.filesArray = action.payload;
                        await this.saveState();
                        break;
                    case 'CLEAR_CHAT':
                        this.state.conversationHistory = [];
                        this.state.messageCount = 0;
                        this.state.filesArray = [];
                        this.state.welcomeMessageSent = false;
                        await this.saveState();
                        break;
                    case 'ENQUEUE_NOTIFICATION':
                        this.state.notificationQueue.push(action.payload);
                        await this.saveState();
                        break;
                    case 'DEQUEUE_NOTIFICATION':
                        this.state.notificationQueue.shift();
                        await this.saveState();
                        break;
                    case 'INCREMENT_REQUEST':
                        if (Date.now() - this.state.requestTracker.lastReset > this.state.requestTracker.resetInterval) this.state.requestTracker = { count: 0, lastReset: Date.now(), maxRequests: 25000, resetInterval: 60000 };
                        this.state.requestTracker.count++;
                        await this.saveState();
                        break;
                    case 'SET_GRADES':
                        this.state.grades = action.payload;
                        await this.saveState();
                        break;
                    case 'SET_GAME_CODE':
                        this.state.gameCode = action.payload;
                        await this.saveState();
                        break;
                    case 'SET_PASTED_MEDIA':
                        this.state.pastedMedia = action.payload;
                        await this.saveState();
                        break;
                    case 'SET_PEER_CONNECTION':
                        this.state.peerConnection = action.payload;
                        await this.saveState();
                        break;
                    case 'SET_PEER_ID':
                        this.state.peerId = action.payload;
                        elements.myPeerId.textContent = action.payload;
                        await this.saveState();
                        break;
                    case 'SET_EDITOR_INSTANCE':
                        this.state.editorInstance = action.payload;
                        await this.saveState();
                        break;
                    case 'SET_WELCOME_SENT':
                        this.state.welcomeMessageSent = action.payload;
                        await this.saveState();
                        break;
                    case 'SET_BUTTONS_ENABLED':
                        this.state.buttonsEnabled = action.payload;
                        await this.saveState();
                        break;
                }
            },
            async loadState() {
                const db = await initDB();
                const savedState = await getFromDB(db, 'state');
                if (savedState) {
                    this.state = { ...this.state, ...savedState };
                    if (this.state.peerId) elements.myPeerId.textContent = this.state.peerId;
                }
            },
            async saveState() {
                const db = await initDB();
                const transaction = db.transaction(['state'], 'readwrite');
                const store = transaction.objectStore('state');
                const serializableState = { ...this.state, peerConnection: null, editorInstance: null };
                await store.put({ id: 'appState', ...serializableState });
            }
        };

        const aiEngine = {
            async searchWeb(query) {
                const response = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1`);
                const data = await response.json();
                if (data.RelatedTopics && data.RelatedTopics.length > 0) {
                    return data.RelatedTopics.slice(0, 3).map(topic => topic.Text).join('\n');
                }
                return "No relevant information found.";
            },
            async getAIResponse(userMessage, media = null) {
                if (!store.state.userProfile.openAIKey) {
                    showNotification('Please set your OpenAI key in the profile to enable responses.', 'warning');
                    return null;
                }
                if (store.state.selectedModel === 'aria') return `Aria AI is in beta! Using Prysmis AI instead.`;
                const context = store.state.conversationHistory.slice(-5).map(msg => ({ role: msg.role, content: msg.content }));
                context.push({ role: 'system', content: `You’re Prysmis AI, a helpful assistant. Use natural language and address the user as ${store.state.userProfile.username}. Handle code, media, grades, and games with precision. Use OpenAI key: ${store.state.userProfile.openAIKey}` });
                context.push({ role: 'user', content: userMessage });
                if (userMessage.toLowerCase().includes('search') || userMessage.toLowerCase().includes('find')) {
                    const webResults = await this.searchWeb(userMessage);
                    context.push({ role: 'system', content: `Web search results: ${webResults}` });
                }
                if (store.state.filesArray.length > 0 || media) {
                    const filesToProcess = media ? [media] : store.state.filesArray;
                    const fileDescriptions = await Promise.all(filesToProcess.map(async file => {
                        let content = '';
                        if (file.type.startsWith('image/')) content = await this.analyzeImage(file.data);
                        else if (file.type.startsWith('video/')) content = await this.analyzeVideo(file);
                        else if (file.type.startsWith('text/')) content = file.data;
                        return `File: ${file.name}, Type: ${file.type}, Size: ${(file.size / 1024).toFixed(2)} KB, Content: ${content}`;
                    }));
                    context.push({ role: 'user', content: `Attached files:\n${fileDescriptions.join('\n')}` });
                }
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${store.state.userProfile.openAIKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: context,
                        max_tokens: 150,
                        temperature: 0.7
                    })
                });
                const data = await response.json();
                if (data.choices && data.choices.length > 0) {
                    return data.choices[0].message.content.trim();
                }
                return `Hey ${store.state.userProfile.username}, I’m ready to assist! What would you like to do?`;
            },
            async rephraseMessage(message) {
                if (!store.state.userProfile.openAIKey) {
                    showNotification('Please set your OpenAI key to rephrase.', 'warning');
                    return null;
                }
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${store.state.userProfile.openAIKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{ role: 'user', content: `Rephrase this: ${message}` }],
                        max_tokens: 100,
                        temperature: 0.7
                    })
                });
                const data = await response.json();
                return data.choices[0].message.content.trim();
            },
            async analyzeImage(dataUrl) {
                const img = new Image();
                img.src = dataUrl;
                await new Promise(resolve => img.onload = resolve);
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const imageData = ctx.getImageData(0, 0, img.width, img.height);
                const tensor = tf.tensor3d(imageData.data, [img.height, img.width, 4]);
                const normalized = tensor.slice([0, 0, 0], [-1, -1, 3]).div(255);
                const meanColor = tf.mean(normalized, [0, 1]).dataSync();
                const description = `Image with dominant colors: RGB(${Math.round(meanColor[0] * 255)}, ${Math.round(meanColor[1] * 255)}, ${Math.round(meanColor[2] * 255)}).`;
                tf.dispose([tensor, normalized]);
                return description;
            },
            async analyzeVideo(file) {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);
                await new Promise(resolve => video.onloadedmetadata = resolve);
                const duration = video.duration;
                video.currentTime = 0;
                await new Promise(resolve => video.onseeked = resolve);
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const tensor = tf.tensor3d(imageData.data, [canvas.height, canvas.width, 4]);
                const normalized = tensor.slice([0, 0, 0], [-1, -1, 3]).div(255);
                const meanColor = tf.mean(normalized, [0, 1]).dataSync();
                const description = `Video: ${file.name}, Duration: ${Math.round(duration)} seconds, Frame colors: RGB(${Math.round(meanColor[0] * 255)}, ${Math.round(meanColor[1] * 255)}, ${Math.round(meanColor[2] * 255)}).`;
                tf.dispose([tensor, normalized]);
                return description;
            }
        };

        const codeProcessor = {
            obfuscate(code) {
                return btoa(code);
            },
            deobfuscate(code) {
                return atob(code);
            },
            initializeEditor() {
                require(['vs/editor/editor.main'], () => {
                    const editor = monaco.editor.create(elements.codeEditor, {
                        value: 'function greet() { return "Hello, Prysmis!"; }\n',
                        language: 'javascript',
                        theme: store.state.isDarkMode ? 'vs-dark' : 'vs-light',
                        automaticLayout: true,
                        minimap: { enabled: false },
                        fontSize: 15,
                        lineNumbers: 'on',
                        scrollBeyondLastLine: false
                    });
                    store.dispatch({ type: 'SET_EDITOR_INSTANCE', payload: editor });
                    elements.codeEditor.style.display = 'block';
                    toggleRightSidebar();
                });
            }
        };

        const gradeOrganizer = {
            async processGradeImage(dataUrl) {
                const description = await aiEngine.analyzeImage(dataUrl);
                const grades = await this.parseGrades(description);
                store.dispatch({ type: 'SET_GRADES', payload: grades });
                this.renderGradeDiagram();
                toggleRightSidebar();
            },
            async parseGrades(description) {
                return [
                    { subject: 'Math', score: 92, priority: 2, due: '2025-05-10', advice: 'Practice algebra daily.' },
                    { subject: 'Science', score: 88, priority: 1, due: '2025-05-05', advice: 'Review experiments.' },
                    { subject: 'English', score: 95, priority: 3, due: '2025-05-15', advice: 'Focus on literature analysis.' }
                ].sort((a, b) => a.priority - b.priority);
            },
            renderGradeDiagram() {
                elements.gradeDiagram.style.display = 'block';
                elements.gradeDiagram.innerHTML = `
                    <h3>Grade Priorities</h3>
                    <ul>
                        ${store.state.grades.map(grade => `
                            <li class="p-2 rounded-lg flex justify-between items-center bg-gray-700 text-white">
                                <span><strong>${grade.subject}</strong>: ${grade.score}% (Due: ${grade.due}, Priority: ${grade.priority})</span>
                                <span>${grade.advice}</span>
                            </li>
                        `).join('')}
                    </ul>
                `;
            }
        };

        const gameEngine = {
            async generateGameCode() {
                const code = `
                    function setup() {
                        createCanvas(400, 400);
                        background(0);
                    }
                    function draw() {
                        fill(random(255), random(255), random(255));
                        ellipse(mouseX, mouseY, 60, 60);
                        text("Interactive Art!", 20, 20);
                    }
                `;
                store.dispatch({ type: 'SET_GAME_CODE', payload: code });
                elements.gameVM.style.display = 'block';
                elements.gameVM.innerHTML = '';
                toggleRightSidebar();
                new p5(function(sketch) {
                    eval(code);
                }, elements.gameVM);
                return `Game loaded! Check the right sidebar for an interactive art experience.`;
            }
        };

        const collaborationEngine = {
            initializePeer() {
                const peer = new Peer();
                peer.on('open', id => {
                    store.dispatch({ type: 'SET_PEER_ID', payload: id });
                });
                peer.on('connection', conn => {
                    store.dispatch({ type: 'SET_PEER_CONNECTION', payload: conn });
                    conn.on('data', data => {
                        if (data.type === 'message') {
                            store.dispatch({ type: 'ADD_MESSAGE', payload: data.payload });
                            renderMessages();
                        }
                    });
                });
                return peer;
            },
            connectToPeer(peerId) {
                const conn = store.state.peer.connect(peerId);
                store.dispatch({ type: 'SET_PEER_CONNECTION', payload: conn });
                conn.on('open', () => {});
                conn.on('data', data => {
                    if (data.type === 'message') {
                        store.dispatch({ type: 'ADD_MESSAGE', payload: data.payload });
                        renderMessages();
                    }
                });
            }
        };

        const initDB = () => new Promise((resolve, reject) => {
            const request = indexedDB.open('PrysmisDB', 10);
            request.onupgradeneeded = event => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('state')) {
                    db.createObjectStore('state', { keyPath: 'id' });
                }
            };
            request.onsuccess = event => resolve(event.target.result);
            request.onerror = event => reject(event.target.error);
        });

        const saveToDB = (db, storeName, data) => new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            store.put({ id: 'appState', ...data }).onsuccess = () => resolve();
            transaction.onerror = event => reject(event.target.error);
        });

        const getFromDB = (db, storeName) => new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            store.get('appState').onsuccess = event => resolve(event.target.result);
            transaction.onerror = event => reject(event.target.error);
        });

        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), delay);
            };
        };

        const showNotification = (message, type = 'success') => {
            store.dispatch({ type: 'ENQUEUE_NOTIFICATION', payload: { message, type } });
            processNotificationQueue();
        };

        const processNotificationQueue = () => {
            if (store.state.notificationQueue.length === 0) return;
            const { message, type } = store.state.notificationQueue[0];
            elements.notification.textContent = message;
            elements.notification.className = `notification ${type === 'success' ? 'bg-green-700' : type === 'warning' ? 'bg-yellow-700' : 'bg-red-700'} show`;
            setTimeout(() => {
                elements.notification.className = 'notification';
                store.dispatch({ type: 'DEQUEUE_NOTIFICATION' });
                processNotificationQueue();
            }, 3000);
        };

        const sanitizeInput = input => {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        };

        const checkRateLimit = () => {
            store.dispatch({ type: 'INCREMENT_REQUEST' });
            if (store.state.requestTracker.count > store.state.requestTracker.maxRequests || Date.now() - store.state.rateLimit.lastAction < store.state.rateLimit.interval) {
                showNotification('Too many requests! Please wait.', 'error');
                return false;
            }
            store.state.rateLimit.lastAction = Date.now();
            return true;
        };

        const toggleTheme = () => {
            if (!checkRateLimit()) return;
            store.state.isDarkMode = !store.state.isDarkMode;
            document.body.classList.toggle('light-mode');
            elements.themeBtn.innerHTML = store.state.isDarkMode ? '<i class="fas fa-sun"></i> Light Mode' : '<i class="fas fa-moon"></i> Dark Mode';
            if (store.state.editorInstance) monaco.editor.setTheme(store.state.isDarkMode ? 'vs-dark' : 'vs-light');
            localStorage.setItem('theme', store.state.isDarkMode ? 'dark' : 'light');
        };

        const renderMessages = () => {
            const fragment = document.createDocumentFragment();
            store.state.conversationHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${message.role}`;
                messageDiv.dataset.messageId = message.id;
                const contentDiv = document.createElement('div');
                contentDiv.className = 'chat-message-content';
                if (message.content.includes('```')) {
                    const parts = message.content.split(/```/);
                    let htmlContent = '';
                    parts.forEach((part, index) => {
                        if (index % 2 === 0) htmlContent += part;
                        else {
                            const [lang, ...codeLines] = part.split('\n');
                            const code = codeLines.join('\n');
                            htmlContent += `<pre><code>${code}</code><button class="copy-btn">Copy</button></pre>`;
                        }
                    });
                    contentDiv.innerHTML = htmlContent;
                    contentDiv.querySelectorAll('.copy-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            navigator.clipboard.writeText(btn.previousSibling.textContent).then(() => showNotification('Code copied!')).catch(() => showNotification('Copy failed.', 'error'));
                        });
                    });
                } else contentDiv.textContent = message.content;
                messageDiv.appendChild(contentDiv);
                fragment.appendChild(messageDiv);
            });
            elements.chatHistory.innerHTML = '';
            elements.chatHistory.appendChild(fragment);
            elements.messageCounter.innerHTML = `<i class="fas fa-envelope"></i> Messages: ${store.state.messageCount}`;
            elements.messageView.innerHTML = store.state.conversationHistory.map(msg => `<div class="${msg.role}">${msg.content}</div>`).join('');
            if (store.state.userProfile.preferences.autoScroll) elements.chatArea.scrollTop = elements.chatArea.scrollHeight;
        };

        const handleSendMessage = async () => {
            if (!checkRateLimit()) return;
            if (!store.state.buttonsEnabled) return;
            const userMessage = sanitizeInput(elements.userInput.value.trim());
            let media = store.state.pastedMedia;
            if (!userMessage && !media) {
                showNotification('Please provide a message or media!', 'error');
                return;
            }
            const messageId = Date.now();
            const newMessage = { id: messageId, role: 'user', content: userMessage || 'Sent media', timestamp: Date.now() };
            store.dispatch({ type: 'ADD_MESSAGE', payload: newMessage });
            elements.userInput.value = '';
            store.dispatch({ type: 'SET_PASTED_MEDIA', payload: null });
            renderMessages();
            const aiResponse = await aiEngine.getAIResponse(userMessage, media);
            if (aiResponse) {
                store.dispatch({ type: 'ADD_MESSAGE', payload: { id: Date.now(), role: 'assistant', content: aiResponse, timestamp: Date.now() } });
                renderMessages();
            }
        };

        const debouncedSendMessage = debounce(handleSendMessage, 200);

        const handleFileUpload = async event => {
            if (!checkRateLimit()) return;
            if (!store.state.buttonsEnabled) return;
            const files = Array.from(event.target.files);
            elements.fileInputLabel.textContent = files.length ? `${files.length} file(s) chosen` : 'No file chosen';
            const progressBar = elements.fileUploadProgress.querySelector('div');
            let uploaded = 0;
            const newFiles = [];
            for (const file of files) {
                const fileId = Date.now() + Math.random();
                const fileObj = { id: fileId, name: file.name, type: file.type, size: file.size, data: null };
                if (file.type.startsWith('text/')) fileObj.data = await file.text();
                else if (file.type.startsWith('image/')) fileObj.data = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(file);
                });
                else if (file.type.startsWith('video/')) fileObj.data = file;
                newFiles.push(fileObj);
                uploaded++;
                progressBar.style.width = `${(uploaded / files.length) * 100}%`;
                if (file.name.toLowerCase().includes('grade')) await gradeOrganizer.processGradeImage(fileObj.data);
            }
            store.dispatch({ type: 'SET_FILES', payload: [...store.state.filesArray, ...newFiles] });
            renderFileList();
            progressBar.style.width = '0%';
            elements.fileClearBtn.style.display = store.state.filesArray.length ? 'block' : 'none';
        };

        const handlePaste = async event => {
            const items = event.clipboardData.items;
            for (const item of items) if (item.type.startsWith('image/')) {
                const file = item.getAsFile();
                const fileId = Date.now() + Math.random();
                const fileObj = { id: fileId, name: `pasted-image-${fileId}.png`, type: file.type, size: file.size, data: await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(file);
                }) };
                store.dispatch({ type: 'SET_PASTED_MEDIA', payload: fileObj });
                break;
            }
        };

        const renderFileList = () => {
            elements.fileList.innerHTML = '';
            store.state.filesArray.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'p-2 rounded-lg flex justify-between items-center bg-gray-700 text-white';
                fileItem.dataset.fileId = file.id;
                fileItem.innerHTML = `<span>${file.name} (${(file.size / 1024).toFixed(2)} KB)</span><button class="remove-file-btn"><i class="fas fa-trash"></i></button>`;
                elements.fileList.appendChild(fileItem);
            });
            elements.fileList.querySelectorAll('.remove-file-btn').forEach(btn => btn.addEventListener('click', () => {
                const fileId = parseFloat(btn.closest('.file-item').dataset.fileId);
                store.dispatch({ type: 'SET_FILES', payload: store.state.filesArray.filter(f => f.id !== fileId) });
                renderFileList();
                elements.fileClearBtn.style.display = store.state.filesArray.length ? 'block' : 'none';
            }));
        };

        const clearFiles = () => {
            if (!checkRateLimit()) return;
            if (!store.state.buttonsEnabled) return;
            store.dispatch({ type: 'SET_FILES', payload: [] });
            elements.fileInputLabel.textContent = 'No file chosen';
            renderFileList();
            elements.fileClearBtn.style.display = 'none';
        };

        const toggleFileActions = () => {
            if (!store.state.buttonsEnabled) return;
            elements.fileActions.classList.toggle('open');
            elements.toggleActionsBtn.innerHTML = elements.fileActions.classList.contains('open') ? '<i class="fas fa-cog"></i> Hide Options' : '<i class="fas fa-cog"></i> Show Options';
        };

        const applyChatLayout = () => {
            const layout = store.state.userProfile.chatLayout;
            const fontSize = store.state.userProfile.preferences.fontSize;
            elements.chatArea.style.fontSize = `${fontSize}px`;
            if (layout === 'compact') elements.chatArea.style.padding = '1rem';
            else if (layout === 'spacious') elements.chatArea.style.padding = '2rem';
            else elements.chatArea.style.padding = '1.5rem';
        };

        const saveUserProfile = async () => {
            if (!checkRateLimit()) return;
            if (!store.state.buttonsEnabled) return;
            const newUsername = sanitizeInput(elements.usernameInput.value) || 'User';
            const openAIKey = sanitizeInput(elements.openAIKeyInput.value) || '';
            store.state.userProfile = {
                username: newUsername,
                openAIKey: openAIKey,
                chatLayout: elements.chatLayoutSelect.value,
                preferences: { fontSize: parseInt(elements.fontSizeInput.value) || 16, autoScroll: elements.autoScrollToggle.checked }
            };
            applyChatLayout();
            store.state.conversationHistory = store.state.conversationHistory.map(msg => msg.role === 'assistant' ? { ...msg, content: msg.content.replace(/Hey \w+!/, `Hey ${newUsername}!`) } : msg);
            if (openAIKey) {
                showNotification('OpenAI key saved! Full functionality enabled.', 'success');
                if (store.state.conversationHistory.length > 0) {
                    const lastUserMessage = store.state.conversationHistory.slice().reverse().find(msg => msg.role === 'user');
                    if (lastUserMessage) {
                        const aiResponse = await aiEngine.getAIResponse(lastUserMessage.content);
                        if (aiResponse) {
                            store.dispatch({ type: 'ADD_MESSAGE', payload: { id: Date.now(), role: 'assistant', content: aiResponse, timestamp: Date.now() } });
                        }
                    }
                }
            } else {
                showNotification('No OpenAI key provided. Some features may not work.', 'warning');
            }
            elements.userProfileModal.classList.remove('open');
            renderMessages();
        };

        const handleVoiceInput = () => {
            if (!checkRateLimit()) return;
            if (!store.state.buttonsEnabled) return;
            if (!('webkitSpeechRecognition' in window)) {
                showNotification('Voice recognition not supported.', 'error');
                return;
            }
            elements.permissionModal.classList.add('open');
            elements.grantPermissionBtn.focus();
        };

        const startVoiceRecognition = () => {
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = true;
            recognition.onresult = event => elements.userInput.value = Array.from(event.results).map(result => result[0].transcript).join('');
            recognition.onerror = event => showNotification(`Voice error: ${event.error}`, 'error');
            recognition.onend = () => showNotification('Voice input stopped.');
            recognition.start();
        };

        const rephraseMessage = async () => {
            if (!checkRateLimit()) return;
            if (!store.state.buttonsEnabled) return;
            const lastAIMessage = store.state.conversationHistory.slice().reverse().find(msg => msg.role === 'assistant');
            if (!lastAIMessage) {
                showNotification('No AI message to rephrase.', 'error');
                return;
            }
            const rephrased = await aiEngine.rephraseMessage(lastAIMessage.content);
            if (rephrased) {
                store.dispatch({ type: 'ADD_MESSAGE', payload: { id: Date.now(), role: 'assistant', content: rephrased, timestamp: Date.now() } });
                renderMessages();
            }
        };

        const toggleSidebar = () => {
            if (!checkRateLimit()) return;
            if (!store.state.buttonsEnabled) return;
            const isOpen = elements.sidebar.classList.toggle('open');
            elements.sidebar.style.width = isOpen ? (store.state.deviceType === 'Mobile' ? 220 : 280) + 'px' : 0;
        };

        const toggleRightSidebar = () => {
            if (!store.state.buttonsEnabled) return;
            const isOpen = elements.rightSidebar.classList.toggle('open');
            elements.rightSidebar.style.width = isOpen ? (store.state.deviceType === 'Mobile' ? 300 : 380) + 'px' : 0;
        };

        const clearChat = () => {
            if (!checkRateLimit()) return;
            if (!store.state.buttonsEnabled) return;
            elements.confirmClearModal.classList.add('open');
        };

        const confirmClearChat = async () => {
            store.dispatch({ type: 'CLEAR_CHAT' });
            renderMessages();
            renderFileList();
            elements.fileClearBtn.style.display = 'none';
            elements.confirmClearModal.classList.remove('open');
            await sendWelcomeMessage();
        };

        const exportChat = () => {
            if (!checkRateLimit()) return;
            if (!store.state.buttonsEnabled) return;
            const chatData = JSON.stringify({ conversationHistory: store.state.conversationHistory, timestamp: Date.now() }, null, 2);
            const blob = new Blob([chatData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `prysmis_chat_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        const shareWebsite = () => {
            if (!checkRateLimit()) return;
            if (!store.state.buttonsEnabled) return;
            navigator.share({ title: 'Prysmis AI', text: 'Discover Prysmis AI, your ultimate AI assistant!', url: window.location.href }).catch(() => {});
        };

        const handleFeedback = () => {
            if (!checkRateLimit()) return;
            if (!store.state.buttonsEnabled) return;
            const feedback = sanitizeInput(elements.feedbackInput.value.trim());
            if (feedback) {
                console.log(feedback);
                elements.feedbackInput.value = '';
                elements.feedbackModal.classList.remove('open');
                showNotification('Feedback submitted!', 'success');
            }
        };

        const showUpdates = () => {
            if (!checkRateLimit()) return;
            if (!store.state.buttonsEnabled) return;
            store.dispatch({ type: 'ADD_MESSAGE', payload: { id: Date.now(), role: 'assistant', content: `Prysmis AI updates: Enhanced AI responses, sleek UI, optimized code blocks, and more features coming!`, timestamp: Date.now() } });
            renderMessages();
        };

        const joinDiscord = () => {
            if (!checkRateLimit()) return;
            if (!store.state.buttonsEnabled) return;
            window.open('https://discord.gg/TKC8XjGSAw', '_blank');
            showNotification('Joined Discord!', 'success');
        };

        const goToPremium = () => {};

        const handleCollaboration = () => {
            if (!checkRateLimit()) return;
            if (!store.state.buttonsEnabled) return;
            elements.collaborationModal.classList.add('open');
        };

        const connectToPeer = () => {
            if (!store.state.buttonsEnabled) return;
            const peerId = elements.peerIdInput.value.trim();
            if (peerId) {
                collaborationEngine.connectToPeer(peerId);
                elements.collaborationModal.classList.remove('open');
                showNotification('Connected to peer!', 'success');
            }
        };

        const detectDeviceType = () => {
            const ua = navigator.userAgent.toLowerCase();
            return /mobile|android|iphone|ipad|tablet/i.test(ua) ? /iphone|ipad/i.test(ua) ? 'iOS' : /android/i.test(ua) ? 'Android' : 'Mobile' : /chromebook/i.test(ua) ? 'Chromebook' : 'PC/Laptop';
        };

        const sendWelcomeMessage = async () => {
            if (!store.state.welcomeMessageSent) {
                store.dispatch({ type: 'ADD_MESSAGE', payload: { id: Date.now(), role: 'assistant', content: `Welcome to Prysmis AI! Your all-go-to AI. THE #1 best free AI.`, timestamp: Date.now() } });
                store.dispatch({ type: 'SET_WELCOME_SENT', payload: true });
                renderMessages();
            }
        };

        ['sendBtn', 'userInput', 'rephraseBtn', 'themeBtn', 'userProfileBtn', 'fileInputBtn', 'fileClearBtn', 'toggleActionsBtn', 'voiceInputBtn', 'permissionModalClose', 'denyPermissionBtn', 'grantPermissionBtn', 'menuBtn', 'sidebarClose', 'clearChatBtn', 'confirmClearModalClose', 'cancelClearBtn', 'confirmClearBtn', 'exportChatBtn', 'shareWebsiteBtn', 'feedbackBtn', 'feedbackModalClose', 'feedbackSubmitBtn', 'updatesBtn', 'discordBtn', 'premiumBtn', 'aiModelSelect', 'rightSidebarClose', 'collaborateBtn', 'collaborationModalClose', 'connectPeerBtn', 'userProfileClose', 'saveProfileBtn'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('click', e => {
                e.preventDefault();
                switch (id) {
                    case 'sendBtn': debouncedSendMessage(); break;
                    case 'rephraseBtn': rephraseMessage(); break;
                    case 'themeBtn': toggleTheme(); break;
                    case 'userProfileBtn': elements.userProfileModal.classList.add('open'); break;
                    case 'userProfileClose': elements.userProfileModal.classList.remove('open'); break;
                    case 'saveProfileBtn': saveUserProfile(); break;
                    case 'fileInputBtn': elements.fileInput.click(); break;
                    case 'fileClearBtn': clearFiles(); break;
                    case 'toggleActionsBtn': toggleFileActions(); break;
                    case 'voiceInputBtn': handleVoiceInput(); break;
                    case 'permissionModalClose': case 'denyPermissionBtn': elements.permissionModal.classList.remove('open'); break;
                    case 'grantPermissionBtn': elements.permissionModal.classList.remove('open'); startVoiceRecognition(); break;
                    case 'menuBtn': toggleSidebar(); break;
                    case 'sidebarClose': toggleSidebar(); break;
                    case 'clearChatBtn': clearChat(); break;
                    case 'confirmClearModalClose': case 'cancelClearBtn': elements.confirmClearModal.classList.remove('open'); break;
                    case 'confirmClearBtn': confirmClearChat(); break;
                    case 'exportChatBtn': exportChat(); break;
                    case 'shareWebsiteBtn': shareWebsite(); break;
                    case 'feedbackBtn': elements.feedbackModal.classList.add('open'); break;
                    case 'feedbackModalClose': elements.feedbackModal.classList.remove('open'); break;
                    case 'feedbackSubmitBtn': handleFeedback(); break;
                    case 'updatesBtn': showUpdates(); break;
                    case 'discordBtn': joinDiscord(); break;
                    case 'premiumBtn': goToPremium(); break;
                    case 'aiModelSelect': elements.messageView.classList.toggle('open'); break;
                    case 'rightSidebarClose': toggleRightSidebar(); break;
                    case 'collaborateBtn': handleCollaboration(); break;
                    case 'collaborationModalClose': elements.collaborationModal.classList.remove('open'); break;
                    case 'connectPeerBtn': connectToPeer(); break;
                }
            });
        });

        elements.fileInput.addEventListener('change', handleFileUpload);
        elements.userInput.addEventListener('keypress', e => e.key === 'Enter' && !e.shiftKey && debouncedSendMessage());
        elements.userInput.addEventListener('paste', handlePaste);
        elements.aiModelSelect.addEventListener('change', () => store.state.selectedModel = elements.aiModelSelect.value);

        const init = async () => {
            store.state.deviceType = detectDeviceType();
            store.state.peer = collaborationEngine.initializePeer();
            await store.loadState();
            renderMessages();
            renderFileList();
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                store.state.isDarkMode = false;
                document.body.classList.add('light-mode');
                elements.themeBtn.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
            }
            applyChatLayout();
            store.dispatch({ type: 'SET_BUTTONS_ENABLED', payload: true });
            await sendWelcomeMessage();
        };

        init();
    </script>
</body>
</html>
