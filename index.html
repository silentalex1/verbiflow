<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VerbiFlow - AI Chat</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{background:linear-gradient(135deg,#f0f4f8,#e2e8f0);font-family:Inter,sans-serif;color:#1a202c;min-height:100vh;display:flex;justify-content:center;padding:16px}
        .container{max-width:960px;width:100%;background:#fff;border-radius:20px;box-shadow:0 8px 32px rgba(0,0,0,0.1);overflow:hidden;display:flex;flex-direction:column;transition:all 0.3s ease}
        .nav-bar{background:linear-gradient(90deg,#2b6cb0,#3182ce);padding:12px;display:flex;gap:12px;justify-content:flex-end;align-items:center}
        .nav-btn{background:#fff;color:#2b6cb0;border:none;padding:10px 20px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.2s ease;outline:none}
        .nav-btn:hover{transform:scale(1.05);background:#f7fafc}
        .nav-btn:active{transform:scale(0.95)}
        .discord-btn{background:#7289da;color:#fff}
        .discord-btn:hover{background:#677bc4}
        .header{background:#fff;padding:20px;text-align:center;border-bottom:1px solid #e2e8f0}
        .logo{font-size:28px;font-weight:700;color:#2b6cb0;letter-spacing:-0.5px}
        .chat-area{flex:1;padding:24px;overflow-y:auto;max-height:70vh;min-height:50vh;background:#f7fafc;scroll-behavior:smooth}
        .chat-history{display:flex;flex-direction:column;gap:16px}
        .chat-message{display:flex;flex-direction:column;gap:8px;padding:12px;border-radius:16px;max-width:80%;animation:slideIn 0.3s ease}
        .chat-message.user{align-self:flex-end;background:#2b6cb0;color:#fff}
        .chat-message.ai{align-self:flex-start;background:#edf2f7;color:#1a202c}
        .chat-message-content{padding:14px;border-radius:16px;font-size:15px;line-height:1.6;word-break:break-word}
        .chat-message-meta{font-size:12px;color:#718096;margin-top:4px;opacity:0.7}
        .chat-message img{max-width:100%;border-radius:12px;margin-top:12px;cursor:pointer;transition:transform 0.2s ease}
        .chat-message img:hover{transform:scale(1.02)}
        .code-block{position:relative;margin:12px 0;border-radius:12px;overflow:hidden}
        .code-block pre{background:#1a202c;color:#e2e8f0;padding:16px;border-radius:12px;overflow-x:auto;font-family:'JetBrains Mono',monospace;font-size:14px;line-height:1.5}
        .code-text{background:#1a202c;color:#e2e8f0;padding:16px;border-radius:12px;font-family:'JetBrains Mono',monospace;font-size:14px;white-space:pre-wrap;user-select:text}
        .copy-btn,.copy-all-btn{position:absolute;top:12px;background:#2b6cb0;color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s ease}
        .copy-btn{right:12px}
        .copy-all-btn{right:90px}
        .copy-btn:hover,.copy-all-btn:hover{background:#3182ce;transform:scale(1.05)}
        .file-upload-container{padding:16px;border-top:1px solid #e2e8f0;background:#fff}
        .file-actions{display:flex;gap:12px;align-items:center}
        .file-input-label{background:#2b6cb0;color:#fff;padding:12px 20px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:600;min-height:44px;transition:all 0.2s ease}
        .file-input-label:hover{transform:scale(1.05)}
        .file-input{display:none}
        .file-clear-btn{background:#e53e3e;color:#fff;padding:12px 20px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:600;border:none;min-height:44px;transition:all 0.2s ease}
        .file-clear-btn:hover{transform:scale(1.05);background:#c53030}
        .file-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:12px}
        .file-item{display:flex;align-items:center;gap:12px;background:#edf2f7;padding:10px;border-radius:12px;cursor:pointer;transition:all 0.2s ease}
        .file-item:hover{background:#e2e8f0;transform:scale(1.02)}
        .file-item-name{flex:1;font-size:14px;color:#1a202c;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .file-item-details{font-size:12px;color:#718096}
        .file-preview-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:100;padding:16px;justify-content:center;align-items:center}
        .file-preview-modal.open{display:flex}
        .file-preview-content{background:#fff;border-radius:16px;padding:20px;max-width:90%;max-height:90%;overflow:auto;color:#1a202c;font-size:14px}
        .file-preview-content img{max-width:80% !important}
        .file-preview-close{background:#e53e3e;color:#fff;border:none;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;position:absolute;top:20px;right:20px;transition:all 0.2s ease}
        .file-preview-close:hover{transform:scale(1.1);background:#c53030}
        .file-preview-close svg{width:20px;height:20px;fill:#fff}
        .input-container{display:flex;align-items:flex-end;padding:16px;border-top:1px solid #e2e8f0;background:#fff;gap:12px;position:sticky;bottom:0;z-index:10}
        .user-input{flex:1;padding:14px;border:1px solid #e2e8f0;border-radius:10px;font-size:15px;outline:none;resize:none;min-height:44px;max-height:160px;background:#fff;color:#1a202c;transition:all 0.2s ease}
        .user-input:focus{border-color:#2b6cb0;box-shadow:0 0 0 3px rgba(43,108,176,0.1)}
        .send-btn{background:#2b6cb0;border:none;border-radius:10px;padding:12px 24px;cursor:pointer;color:#fff;font-size:14px;font-weight:600;min-height:44px;transition:all 0.2s ease}
        .send-btn:hover{transform:scale(1.05);background:#3182ce}
        .send-btn:disabled{background:#a0aec0;cursor:not-allowed}
        .loading-spinner{display:none;margin:12px auto;width:32px;height:32px;border:4px solid #2b6cb0;border-top:4px solid transparent;border-radius:50%;animation:spin 0.8s linear infinite}
        .typing-indicator{display:none;font-size:14px;color:#718096;margin:12px auto;text-align:center}
        .typing-indicator span{display:inline-block;animation:dotPulse 1.4s infinite ease-in-out}
        .typing-indicator span:nth-child(2){animation-delay:0.2s}
        .typing-indicator span:nth-child(3){animation-delay:0.4s}
        .notification{position:fixed;top:20px;right:20px;background:#2d3748;color:#fff;padding:12px 24px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.2);opacity:0;transform:translateY(-20px);transition:all 0.3s ease;font-size:14px;font-weight:500;z-index:200}
        .notification.show{opacity:1;transform:translateY(0)}
        @keyframes slideIn{0%{opacity:0;transform:translateY(20px)}100%{opacity:1;transform:translateY(0)}}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        @keyframes dotPulse{0%,80%,100%{transform:scale(1);opacity:0.5}40%{transform:scale(1.5);opacity:1}}
        @media (max-width:640px){
            .container{max-width:100%;border-radius:12px;padding:8px}
            .nav-bar{padding:10px;gap:8px}
            .nav-btn{font-size:13px;padding:8px 16px}
            .header{padding:16px}
            .logo{font-size:24px}
            .chat-area{padding:16px;min-height:40vh;max-height:65vh}
            .chat-message{max-width:90%}
            .chat-message-content{font-size:14px}
            .chat-message img{max-width:85%}
            .input-container{padding:12px;gap:8px}
            .user-input{font-size:14px;min-height:40px}
            .send-btn{padding:10px 20px;min-height:40px}
            .file-input-label,.file-clear-btn{font-size:13px;padding:10px 16px;min-height:40px}
            .file-preview-content img{max-width:85% !important}
            .notification{top:16px;right:16px;padding:10px 20px;font-size:13px}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-bar">
            <button class="nav-btn" id="clearChatBtn">Clear Chat</button>
            <button class="nav-btn" id="copyCodeBtn">Copy Code</button>
            <button class="nav-btn discord-btn" id="discordBtn">Discord Server</button>
        </div>
        <div class="header">
            <div class="logo">VerbiFlow</div>
        </div>
        <div class="chat-area" id="chatArea">
            <div class="chat-history" id="chatHistory">
                <div class="chat-message ai">
                    <div class="chat-message-content">Hello! I'm VerbiFlow, your AI assistant. I can read and generate images, answer questions, and deobfuscate complex code. Try asking for code deobfuscation or pasting an image!</div>
                    <div class="chat-message-meta">Just now</div>
                </div>
            </div>
            <div class="loading-spinner" id="loadingSpinner"></div>
            <div class="typing-indicator" id="typingIndicator">
                VerbiFlow is typing<span>.</span><span>.</span><span>.</span>
            </div>
        </div>
        <div class="file-upload-container" id="fileUploadContainer">
            <div class="file-actions">
                <label class="file-input-label" for="fileInput">Upload File</label>
                <input type="file" class="file-input" id="fileInput" multiple accept="image/*,text/*">
                <button class="file-clear-btn" id="fileClearBtn" style="display:none;">Clear</button>
            </div>
            <div class="file-list" id="fileList"></div>
        </div>
        <div class="input-container">
            <textarea class="user-input" id="userInput" placeholder="Type or paste an image..." rows="1"></textarea>
            <button class="send-btn" id="sendBtn">Send</button>
        </div>
        <div class="file-preview-modal" id="filePreviewModal">
            <button class="file-preview-close" id="filePreviewClose">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <div class="file-preview-content" id="filePreviewContent"></div>
        </div>
        <div class="notification" id="notification">The Discord invite link has been copied to your clipboard.</div>
    </div>
    <script defer>
        const API_KEY = "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";
        const API_URL = "https://api.openai.com/v1/chat/completions";
        const IMAGE_GEN_API_URL = "https://api.openai.com/v1/images/generations";
        const DISCORD_INVITE = "https://discord.gg/rCTRQvD4TP";
        const chatHistory = document.getElementById('chatHistory');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const fileClearBtn = document.getElementById('fileClearBtn');
        const fileUploadContainer = document.getElementById('fileUploadContainer');
        const filePreviewModal = document.getElementById('filePreviewModal');
        const filePreviewContent = document.getElementById('filePreviewContent');
        const filePreviewClose = document.getElementById('filePreviewClose');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const typingIndicator = document.getElementById('typingIndicator');
        const chatArea = document.getElementById('chatArea');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const copyCodeBtn = document.getElementById('copyCodeBtn');
        const discordBtn = document.getElementById('discordBtn');
        const notification = document.getElementById('notification');
        let filesArray = [];
        let conversationHistory = [{ role: "assistant", content: "Hello! I'm VerbiFlow, your AI assistant. I can read and generate images, answer questions, and deobfuscate complex code. Try asking for code deobfuscation or pasting an image!" }];
        let latestCodeBlocks = [];

        class Deobfuscator {
            static decodeBase64(str) {
                try {
                    return atob(str);
                } catch {
                    return str;
                }
            }
            static decodeXOR(str, key = 42) {
                return String.fromCharCode(...str.split('').map((c, i) => c.charCodeAt(0) ^ (key + i % 10)));
            }
            static decodeStringManipulation(str) {
                let result = str.replace(/\[(\d+)\]/g, (_, num) => String.fromCharCode(parseInt(num)));
                result = result.split('').reverse().join('');
                return result;
            }
            static analyzePatterns(code) {
                const patterns = [
                    { regex: /^[A-Za-z0-9+/=]+$/g, method: 'base64' },
                    { regex: /[\x00-\x1F\x7F-\xFF]+/g, method: 'xor' },
                    { regex: /\[\d+\]/g, method: 'stringManipulation' }
                ];
                for (const pattern of patterns) {
                    if (code.match(pattern.regex)) {
                        return pattern.method;
                    }
                }
                return 'unknown';
            }
            static deobfuscate(code) {
                let result = code;
                const maxLayers = 5;
                for (let i = 0; i < maxLayers; i++) {
                    const method = this.analyzePatterns(result);
                    if (method === 'base64') {
                        result = this.decodeBase64(result);
                    } else if (method === 'xor') {
                        result = this.decodeXOR(result);
                    } else if (method === 'stringManipulation') {
                        result = this.decodeStringManipulation(result);
                    } else {
                        break;
                    }
                }
                return result;
            }
        }

        function showNotification() {
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        discordBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(DISCORD_INVITE);
            showNotification();
        });

        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = `${Math.min(userInput.scrollHeight, 160)}px`;
        });

        userInput.addEventListener('paste', async (e) => {
            const items = e.clipboardData.items;
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    if (file.size > 2 * 1024 * 1024 * 1024) {
                        showError(`Image "${file.name}" exceeds the 2GB limit.`);
                        return;
                    }
                    filesArray.push(file);
                    displayFileItem(file);
                }
            }
        });

        fileInput.addEventListener('change', handleFileUpload);
        fileUploadContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadContainer.style.background = '#e2e8f0';
        });
        fileUploadContainer.addEventListener('dragleave', () => {
            fileUploadContainer.style.background = '#fff';
        });
        fileUploadContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadContainer.style.background = '#fff';
            fileInput.files = e.dataTransfer.files;
            handleFileUpload();
        });

        function handleFileUpload() {
            const files = Array.from(fileInput.files);
            files.forEach(file => {
                if (file.size > 2 * 1024 * 1024 * 1024) {
                    showError(`File "${file.name}" exceeds the 2GB limit.`);
                    return;
                }
                if (!filesArray.some(f => f.name === file.name && f.size === file.size)) {
                    filesArray.push(file);
                    displayFileItem(file);
                }
            });
            fileClearBtn.style.display = filesArray.length ? 'block' : 'none';
            fileInput.value = '';
        }

        function displayFileItem(file) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <span class="file-item-name">${file.name}</span>
                <span class="file-item-details">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
            `;
            fileItem.addEventListener('click', () => previewFile(file));
            fileList.appendChild(fileItem);
        }

        fileClearBtn.addEventListener('click', () => {
            filesArray = [];
            fileList.innerHTML = '';
            fileClearBtn.style.display = 'none';
        });

        function previewFile(file) {
            filePreviewContent.innerHTML = `<strong>${file.name}</strong><br>Size: ${(file.size / 1024 / 1024).toFixed(2)} MB<br>Type: ${file.type}`;
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.style.maxWidth = '100%';
                filePreviewContent.appendChild(img);
            } else if (file.type.startsWith('text/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const pre = document.createElement('pre');
                    pre.textContent = e.target.result;
                    filePreviewContent.appendChild(pre);
                };
                reader.readAsText(file);
            }
            filePreviewModal.classList.add('open');
        }

        filePreviewClose.addEventListener('click', () => {
            filePreviewModal.classList.remove('open');
            filePreviewContent.innerHTML = '';
        });

        clearChatBtn.addEventListener('click', () => {
            chatHistory.innerHTML = `
                <div class="chat-message ai">
                    <div class="chat-message-content">Hello! I'm VerbiFlow, your AI assistant. I can read and generate images, answer questions, and deobfuscate complex code. Try asking for code deobfuscation or pasting an image!</div>
                    <div class="chat-message-meta">Just now</div>
                </div>
            `;
            conversationHistory = [{ role: "assistant", content: "Hello! I'm VerbiFlow, your AI assistant. I can read and generate images, answer questions, and deobfuscate complex code. Try asking for code deobfuscation or pasting an image!" }];
            filesArray = [];
            fileList.innerHTML = '';
            fileClearBtn.style.display = 'none';
            userInput.value = '';
            userInput.style.height = 'auto';
            chatArea.scrollTop = 0;
            copyCodeBtn.style.display = 'block';
            latestCodeBlocks = [];
        });

        copyCodeBtn.addEventListener('click', () => {
            if (latestCodeBlocks.length > 0) {
                navigator.clipboard.writeText(latestCodeBlocks.join('\n\n'));
                showNotification('Code copied to clipboard.');
            }
        });

        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function showError(message) {
            const errorMessage = document.createElement('div');
            errorMessage.className = 'chat-message ai';
            errorMessage.innerHTML = `
                <div class="chat-message-content">${message}</div>
                <div class="chat-message-meta">Just now</div>
            `;
            chatHistory.appendChild(errorMessage);
            chatArea.scrollTop = chatArea.scrollHeight;
            copyCodeBtn.style.display = 'block';
            latestCodeBlocks = [];
        }

        function formatMessage(content, messageElement) {
            const codeBlockRegex = /```([\s\S]*?)```/g;
            let codeBlocks = [];
            let html = content.replace(codeBlockRegex, (match, code) => {
                codeBlocks.push(code.trim());
                return `<div class="code-block"><pre class="code-text">${code.trim()}</pre><button class="copy-btn" onclick="navigator.clipboard.writeText(\`${code.trim().replace(/`/g, '\\`')}\`)">Copy Code</button></div>`;
            });
            if (codeBlocks.length === 0) {
                return html;
            }
            latestCodeBlocks = codeBlocks;
            copyCodeBtn.style.display = 'block';
            if (codeBlocks.length > 1) {
                const copyAllBtn = `<button class="copy-all-btn" onclick="navigator.clipboard.writeText(\`${codeBlocks.join('\n\n').replace(/`/g, '\\`')}\`)">Copy All Code</button>`;
                messageElement.querySelector('.chat-message-content').insertAdjacentHTML('afterbegin', copyAllBtn);
            }
            return html;
        }

        async function generateImage(prompt) {
            try {
                const response = await fetch(IMAGE_GEN_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        n: 1,
                        size: "512x512",
                    }),
                });
                if (!response.ok) throw new Error('Image generation failed');
                const data = await response.json();
                return data.data[0].url;
            } catch (error) {
                return null;
            }
        }

        async function readImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message && filesArray.length === 0) return;

            const userMessage = document.createElement('div');
            userMessage.className = 'chat-message user';
            let messageContent = message;
            let messageHTML = `<div class="chat-message-content">${message}</div>`;

            if (filesArray.length > 0) {
                const fileDescriptions = filesArray.map(file => `File: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`).join(', ');
                messageContent += `\nAttached files: ${fileDescriptions}`;
                messageHTML += filesArray.map(file => file.type.startsWith('image/') ? `<img src="${URL.createObjectURL(file)}" alt="${file.name}">` : '').join('');
            }

            userMessage.innerHTML = `${messageHTML}<div class="chat-message-meta">Just now</div>`;
            chatHistory.appendChild(userMessage);
            userInput.value = '';
            userInput.style.height = 'auto';
            chatArea.scrollTop = chatArea.scrollHeight;

            conversationHistory.push({ role: "user", content: messageContent });

            typingIndicator.style.display = 'block';
            sendBtn.disabled = true;

            try {
                let aiMessageText = '';
                const aiMessage = document.createElement('div');
                aiMessage.className = 'chat-message ai';
                aiMessage.innerHTML = `<div class="chat-message-content"></div><div class="chat-message-meta">Just now</div>`;
                chatHistory.appendChild(aiMessage);

                if (message.toLowerCase().includes('generate image') || message.toLowerCase().includes('create image')) {
                    const imageUrl = await generateImage(message);
                    if (imageUrl) {
                        aiMessageText = `Generated image for: "${message}"`;
                        aiMessage.querySelector('.chat-message-content').innerHTML = `${formatMessage(aiMessageText, aiMessage)}<img src="${imageUrl}" alt="Generated Image">`;
                    } else {
                        aiMessageText = 'Sorry, image generation failed.';
                        aiMessage.querySelector('.chat-message-content').innerHTML = formatMessage(aiMessageText, aiMessage);
                    }
                    conversationHistory.push({ role: "assistant", content: aiMessageText });
                    chatArea.scrollTop = chatArea.scrollHeight;
                } else if (message.toLowerCase().includes('deobfuscate') || message.toLowerCase().includes('decode')) {
                    const codeToDeobfuscate = message.match(/```([\s\S]*?)```/)?.[1]?.trim() || message;
                    try {
                        const deobfuscatedCode = Deobfuscator.deobfuscate(codeToDeobfuscate);
                        aiMessageText = `Deobfuscated code:\n\`\`\`\n${deobfuscatedCode}\n\`\`\``;
                        aiMessage.querySelector('.chat-message-content').innerHTML = formatMessage(aiMessageText, aiMessage);
                    } catch (error) {
                        aiMessageText = 'Failed to deobfuscate the code. It might be too complex or not obfuscated.';
                        aiMessage.querySelector('.chat-message-content').innerHTML = formatMessage(aiMessageText, aiMessage);
                    }
                    conversationHistory.push({ role: "assistant", content: aiMessageText });
                    chatArea.scrollTop = chatArea.scrollHeight;
                } else if (message.toLowerCase().includes('luau') || message.toLowerCase().includes('roblox')) {
                    const luauPrompt = `You are an expert in Luau, the scripting language used in Roblox. Design a clean, modern, and delightful UI for a Roblox game based on the following user request: "${message}". Provide the Luau code with a focus on creating an intuitive and visually appealing UI using Roblox's UI framework (e.g., Frames, TextLabels, TextButtons, etc.). Include comments for clarity and ensure the code is optimized for performance.`;
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${API_KEY}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: "gpt-4o-mini",
                            messages: [{ role: "user", content: luauPrompt }],
                            max_tokens: 300,
                        }),
                    });
                    if (!response.ok) throw new Error('API request failed');
                    const data = await response.json();
                    aiMessageText = data.choices[0].message.content;
                    aiMessage.querySelector('.chat-message-content').innerHTML = formatMessage(aiMessageText, aiMessage);
                    conversationHistory.push({ role: "assistant", content: aiMessageText });
                    chatArea.scrollTop = chatArea.scrollHeight;
                } else {
                    const messages = [...conversationHistory];
                    if (filesArray.some(file => file.type.startsWith('image/'))) {
                        const image = filesArray.find(file => file.type.startsWith('image/'));
                        const imageData = await readImage(image);
                        messages.push({
                            role: "user",
                            content: [
                                { type: "text", text: messageContent },
                                { type: "image_url", image_url: { url: imageData } },
                            ],
                        });
                    }

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${API_KEY}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: "gpt-4o-mini",
                            messages: messages.slice(-3),
                            max_tokens: 100,
                            stream: true,
                        }),
                    });

                    if (!response.ok) throw new Error('API request failed');

                    const reader = response.body.getReader();
                    let buffer = '';
                    let updateCounter = 0;
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        buffer += new TextDecoder().decode(value);
                        const lines = buffer.split('\n');
                        buffer = lines.pop();
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') continue;
                                try {
                                    const parsed = JSON.parse(data);
                                    const content = parsed.choices[0].delta.content;
                                    if (content) {
                                        aiMessageText += content;
                                        updateCounter++;
                                        if (updateCounter % 2 === 0) {
                                            aiMessage.querySelector('.chat-message-content').innerHTML = formatMessage(aiMessageText, aiMessage);
                                            chatArea.scrollTop = chatArea.scrollHeight;
                                        }
                                    }
                                } catch (e) {}
                            }
                        }
                    }
                    aiMessage.querySelector('.chat-message-content').innerHTML = formatMessage(aiMessageText, aiMessage);
                    chatArea.scrollTop = chatArea.scrollHeight;
                    conversationHistory.push({ role: "assistant", content: aiMessageText });
                }

                filesArray = [];
                fileList.innerHTML = '';
                fileClearBtn.style.display = 'none';
            } catch (error) {
                showError('Sorry, something went wrong. Please try again.');
            } finally {
                typingIndicator.style.display = 'none';
                sendBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
