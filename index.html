<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Prysmis AI - Your ultimate AI assistant with gaming capabilities.">
    <meta name="keywords" content="AI, assistant, chat, Prysmis, games, snake.io">
    <meta name="author" content="Prysmis AI Team">
    <title>Prysmis AI - Ultimate Assistant with Games</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;-webkit-tap-highlight-color:transparent}
        body{background:linear-gradient(135deg,#1a2a50 0%,#0a1020 100%);color:#e6e9ff;overflow:hidden;min-height:100vh;font-size:1rem}
        .light-theme{background:linear-gradient(135deg,#f3f4f6 0%,#d1d5db 100%);color:#1f2937}
        .light-theme .chat-header,.light-theme .chat-input-area,.light-theme .sidebar,.light-theme .modal-content,.light-theme .game-sidebar{background:rgba(255,255,255,0.9);border-color:rgba(0,0,0,0.1)}
        .light-theme .chat-message.ai{background:rgba(34,197,94,0.2);border-color:rgba(34,197,94,0.3)}
        .light-theme .chat-message.user{background:rgba(59,130,246,0.2);border-color:rgba(59,130,246,0.3)}
        .light-theme .chat-area{background:rgba(255,255,255,0.5)}
        .container{display:flex;height:100vh;width:100vw;overflow:hidden}
        .sidebar{width:0;background:rgba(255,255,255,0.2);backdrop-filter:blur(10px);padding:0;overflow-y:auto;transition:width 0.2s ease;border-right:1px solid rgba(255,255,255,0.3);z-index:10}
        .sidebar.open{width:220px;padding:0.75rem}
        .game-sidebar{width:0;background:rgba(255,255,255,0.2);backdrop-filter:blur(10px);padding:0;overflow-y:auto;transition:width 0.2s ease;border-left:1px solid rgba(255,255,255,0.3);z-index:10}
        .game-sidebar.open{width:280px;padding:0.75rem}
        .sidebar-content,.game-sidebar-content{display:flex;flex-direction:column;gap:0.5rem}
        .recent-messages-section,.search-messages-section,.activity-log-section,.game-section{margin-top:0.75rem}
        .recent-messages-section h3,.search-messages-section h3,.activity-log-section h3,.game-section h3{font-size:0.85rem;color:#a0aec0;margin-bottom:0.4rem}
        .recent-message-item,.activity-log-item,.game-item{padding:0.4rem;border-radius:6px;background:rgba(255,255,255,0.1);cursor:pointer;transition:background 0.2s ease,transform 0.2s ease}
        .recent-message-item:hover,.activity-log-item:hover,.game-item:hover{background:rgba(255,255,255,0.2);transform:scale(1.02)}
        .recent-message-item{display:flex;justify-content:space-between;align-items:center}
        .search-messages-section input{width:100%;padding:0.4rem;border-radius:6px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);color:#e6e9ff;outline:none;font-size:0.85rem}
        .search-messages-section input:focus{border-color:#3b82f6}
        .chat-container{flex:1;display:flex;flex-direction:column;overflow:hidden}
        .chat-header{background:rgba(255,255,255,0.3);backdrop-filter:blur(10px);padding:0.5rem 0.75rem;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,0.3);position:sticky;top:0;z-index:5}
        .chat-area{flex:1;overflow-y:auto;padding:0.75rem;background:rgba(255,255,255,0.1);backdrop-filter:blur(8px);scrollbar-width:thin;scrollbar-color:rgba(255,255,255,0.4) transparent}
        .chat-area::-webkit-scrollbar{width:5px}
        .chat-area::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.4);border-radius:3px}
        .chat-message{max-width:90%;padding:0.5rem;border-radius:10px;margin-bottom:0.75rem;background:rgba(255,255,255,0.2);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.3);transition:transform 0.2s ease,box-shadow 0.2s ease;opacity:0;transform:scale(0.98);position:relative}
        .chat-message.visible{opacity:1;transform:scale(1)}
        .chat-message:hover{transform:scale(1.01);box-shadow:0 0 8px rgba(59,130,246,0.3)}
        .chat-message.user{align-self:flex-end;background:rgba(59,130,246,0.35);margin-left:auto}
        .chat-message.ai{align-self:flex-start;background:rgba(45,212,191,0.35)}
        .chat-message-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.4rem}
        .chat-message-header .role{font-size:0.8rem;color:#a0aec0}
        .chat-message-timestamp{font-size:0.7rem;color:#a0aec0;display:none}
        .chat-message-timestamp.visible{display:inline}
        .reaction-buttons{display:flex;gap:0.4rem;margin-top:0.4rem}
        .reaction-btn{background:none;border:none;color:#a0aec0;cursor:pointer;font-size:0.8rem;transition:color 0.2s ease,transform 0.2s ease}
        .reaction-btn:hover{transform:scale(1.1)}
        .reaction-btn.reacted{color:#3b82f6}
        .chat-message-content pre{background:#1e293b;border-radius:6px;padding:0.5rem;overflow-x:auto;font-family:'Fira Code',monospace;font-size:0.85rem}
        .chat-message-content img,.chat-message-content video{max-width:100%;border-radius:6px;margin-top:0.5rem}
        .chat-message-content .media-meta{margin-top:0.2rem;font-size:0.7rem;color:#a0aec0}
        .code-block-actions{display:flex;gap:0.2rem;margin-top:0.2rem}
        .code-block-actions button{background:#4b5563;color:white;padding:0.2rem 0.4rem;border-radius:4px;cursor:pointer;font-size:0.7rem;transition:background 0.2s ease}
        .code-block-actions button:hover{background:#6b7280}
        .chat-input-area{background:rgba(255,255,255,0.3);backdrop-filter:blur(10px);padding:0.75rem;border-top:1px solid rgba(255,255,255,0.3);position:sticky;bottom:0}
        .file-upload-progress{height:3px;background:rgba(255,255,255,0.2);border-radius:2px;overflow:hidden}
        .file-upload-progress div{height:100%;background:#3b82f6;transition:width 0.2s ease}
        .preloader{position:fixed;inset:0;background:#0a1020;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity 0.3s ease}
        .preloader-input{margin-top:0.5rem;width:35%;background:rgba(255,255,255,0.25);backdrop-filter:blur(10px);padding:0.75rem;border-radius:8px;opacity:0}
        .preloader-input.open{opacity:1}
        .preloader-input textarea{width:100%;padding:0.5rem;border:none;background:transparent;color:#e6e9ff;font-size:0.9rem;resize:none;outline:none}
        .loading-spinner{width:30px;height:30px;border:3px solid #3b82f6;border-top:3px solid transparent;border-radius:50%;animation:spin 0.5s linear infinite}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all 0.2s ease}
        .modal.open{opacity:1;visibility:visible}
        .modal-content{background:rgba(255,255,255,0.2);backdrop-filter:blur(10px);padding:1rem;border-radius:10px;max-width:80%;max-height:60vh;overflow-y:auto;border:1px solid rgba(255,255,255,0.3);transform:scale(0.98);transition:transform 0.2s ease}
        .modal.open .modal-content{transform:scale(1)}
        .notification{position:fixed;top:0.75rem;right:0.75rem;padding:0.5rem 1rem;border-radius:6px;color:#ffffff;backdrop-filter:blur(8px);transform:translateY(-20px);transition:all 0.2s ease;z-index:10000;display:flex;align-items:center;gap:0.5rem}
        .notification.show{transform:translateY(0)}
        button{transition:all 0.2s ease;background:linear-gradient(135deg,#3b82f6 0%,#1e40af 100%);border:none}
        button:hover{transform:translateY(-1px);box-shadow:0 0 8px rgba(59,130,246,0.3)}
        button:focus{outline:none;box-shadow:0 0 0 2px rgba(59,130,246,0.5)}
        button:active{transform:translateY(0)}
        .glass-effect{background:rgba(255,255,255,0.2);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.3)}
        .typing-indicator{display:none;text-align:center;color:#3b82f6;font-style:italic;font-size:0.85rem;opacity:0}
        .typing-indicator.visible{display:block;opacity:1}
        .user-input{transition:background 0.2s ease,border-color 0.2s ease,box-shadow 0.2s ease;min-height:36px}
        .user-input:focus{background:rgba(255,255,255,0.35);border-color:#3b82f6;box-shadow:0 0 6px rgba(59,130,246,0.3)}
        .quick-actions{display:flex;gap:0.5rem;margin-bottom:0.5rem;justify-content:center}
        .quick-action-btn{background:linear-gradient(135deg,#4b5563 0%,#374151 100%);color:white;padding:0.3rem 0.6rem;border-radius:5px;cursor:pointer;transition:background 0.2s ease,transform 0.2s ease;font-size:0.8rem;box-shadow:0 0 6px rgba(0,0,0,0.2);position:relative;overflow:hidden}
        .quick-action-btn:hover{transform:scale(1.05);background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%)}
        .quick-action-btn::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transform:translateX(-100%);transition:transform 0.5s ease}
        .quick-action-btn:hover::before{transform:translateX(100%)}
        .status-indicator{position:absolute;top:0.2rem;right:0.2rem;width:8px;height:8px;border-radius:50%;background:#22c55e;border:1px solid #ffffff}
        .status-indicator.offline{background:#ef4444}
        .char-counter{font-size:0.8rem;color:#a0aec0;margin-top:0.2rem;text-align:right}
        .game-canvas{border:1px solid rgba(255,255,255,0.3);border-radius:6px}
        .game-controls{display:flex;gap:0.4rem;margin-top:0.4rem}
        .game-btn{background:#4b5563;color:white;padding:0.3rem 0.6rem;border-radius:5px;cursor:pointer;font-size:0.8rem;transition:background 0.2s ease}
        .game-btn:hover{background:#6b7280}
        @media (max-width:768px){
            .sidebar.open,.game-sidebar.open{width:100%;position:fixed;top:0;height:100vh;z-index:20}
            .sidebar.open{left:0}
            .game-sidebar.open{right:0}
            .chat-header{padding:0.4rem}
            .chat-area{padding:0.5rem}
            .chat-input-area{padding:0.5rem}
            .chat-message{max-width:95%}
            .user-input{min-height:1rem}
            .modal-content{max-width:90%;padding:0.75rem}
            .preloader-input{width:80%}
        }
        @media (max-width:480px){
            .chat-header{flex-direction:column;gap:0.5rem}
            .chat-area{padding:0.4rem}
            .chat-input-area{padding:0.4rem}
            .input-wrapper{flex-direction:column;gap:0.5rem}
            .user-input{width:100%;padding:0.4rem}
            .send-btn,.rephrase-btn,.voice-input-btn{width:100%;padding:0.4rem}
            .quick-actions{flex-wrap:wrap}
        }
    </style>
</head>
<body>
    <div class="preloader" id="preloader">
        <div class="loading-spinner"></div>
        <div class="preloader-input" id="preloaderInput">
            <textarea class="captcha-input mb-2" id="captchaInput" placeholder="Enter your answer" aria-label="CAPTCHA Input"></textarea>
            <button id="submitBtn" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 w-full" aria-label="Submit">Submit</button>
        </div>
    </div>
    <div class="container">
        <div class="sidebar" id="sidebar" role="navigation" aria-label="Sidebar Menu">
            <div class="sidebar-content">
                <button class="sidebar-close bg-red-500 text-white px-2 py-1 rounded-lg hover:bg-red-600" id="sidebarClose" aria-label="Close Sidebar"><i class="fas fa-times"></i> Close</button>
                <button class="clear-chat-btn bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700" id="clearChatBtn" aria-label="Clear Chat"><i class="fas fa-trash"></i> Clear Chat</button>
                <button class="export-chat-btn bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700" id="exportChatBtn" aria-label="Export Chat"><i class="fas fa-download"></i> Export Chat</button>
                <button class="copy-conversation-btn bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700" id="copyConversationBtn" aria-label="Copy Conversation"><i class="fas fa-copy"></i> Copy Conversation</button>
                <button class="share-website-btn bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700" id="shareWebsiteBtn" aria-label="Share Website"><i class="fas fa-share"></i> Share Website</button>
                <button class="feedback-btn bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700" id="feedbackBtn" aria-label="Provide Feedback"><i class="fas fa-comment"></i> Feedback</button>
                <button class="prysmis-updates-btn bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700" id="prysmisUpdatesBtn" aria-label="View Updates"><i class="fas fa-info-circle"></i> Updates</button>
                <button class="discord-btn bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700" id="discordBtn" aria-label="Join Discord"><i class="fab fa-discord"></i> Discord</button>
                <button class="premium-btn bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700" id="premiumBtn" aria-label="View Premium Plans"><i class="fas fa-crown"></i> Premium</button>
                <div class="search-messages-section">
                    <h3>Search Messages</h3>
                    <input type="text" id="searchMessagesInput" placeholder="Search messages..." aria-label="Search Messages">
                </div>
                <div class="recent-messages-section">
                    <h3>Recent Messages</h3>
                    <div id="recentMessages" class="flex flex-col gap-1"></div>
                </div>
                <div class="activity-log-section">
                    <h3>Activity Log</h3>
                    <div id="activityLog" class="flex flex-col gap-1"></div>
                </div>
            </div>
        </div>
        <div class="chat-container">
            <div class="chat-header glass-effect">
                <div class="flex gap-2 items-center">
                    <button class="menu-btn bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700" id="menuBtn" aria-label="Open Menu"><i class="fas fa-bars"></i> Menu</button>
                    <button class="game-btn bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700" id="gameBtn" aria-label="Open Game Sidebar"><i class="fas fa-gamepad"></i> Games</button>
                </div>
                <div class="flex gap-2 items-center">
                    <button class="theme-toggle-btn bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700" id="themeToggleBtn" aria-label="Toggle Theme"><i class="fas fa-sun"></i> Toggle Theme</button>
                    <button class="user-profile-btn bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700 relative" id="userProfileBtn" aria-label="Open Profile Settings"><i class="fas fa-user"></i> Profile <span class="status-indicator" id="statusIndicator"></span></button>
                    <span class="message-counter text-gray-200 font-medium text-xs" id="messageCounter" aria-live="polite">Messages: 0</span>
                </div>
            </div>
            <div class="chat-area" id="chatArea" role="log" aria-label="Chat Messages">
                <div class="chat-history flex flex-col gap-2" id="chatHistory"></div>
                <div class="typing-indicator text-gray-400 mt-2" id="typingIndicator" aria-live="polite">Prysmis AI is typing...</div>
            </div>
            <div class="chat-input-area glass-effect">
                <div class="quick-actions" id="quickActions">
                    <button class="quick-action-btn" data-action="code" aria-label="Generate Code"><i class="fas fa-code"></i> Code</button>
                    <button class="quick-action-btn" data-action="joke" aria-label="Tell a Joke"><i class="fas fa-laugh"></i> Joke</button>
                    <button class="quick-action-btn" data-action="fact" aria-label="Share a Fact"><i class="fas fa-book"></i> Fact</button>
                    <button class="quick-action-btn" data-action="weather" aria-label="Get Weather"><i class="fas fa-cloud"></i> Weather</button>
                </div>
                <div class="file-actions-container mb-2 max-h-24 overflow-hidden transition-all duration-200 opacity-100" id="fileActionsContainer">
                    <div class="file-input-wrapper flex gap-2 items-center">
                        <label for="fileInput" class="file-input-label bg-blue-600 text-white px-2 py-1 rounded-lg cursor-pointer hover:bg-blue-700" aria-label="Upload File"><i class="fas fa-upload"></i> Upload</label>
                        <input type="file" id="fileInput" class="file-input hidden" accept="image/*,video/*,text/*" aria-label="File Input">
                        <button class="file-clear-btn hidden bg-red-500 text-white px-2 py-1 rounded-lg hover:bg-red-600" id="fileClearBtn" aria-label="Clear Files"><i class="fas fa-trash"></i> Clear</button>
                    </div>
                    <div class="file-list mt-1 flex flex-col gap-1 max-h-20 overflow-y-auto" id="fileList" aria-label="Uploaded Files"></div>
                    <div class="file-upload-progress mt-1" id="fileUploadProgress" aria-label="File Upload Progress"><div style="width: 0%"></div></div>
                </div>
                <button class="toggle-actions-btn bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700 mb-1" id="toggleActionsBtn" aria-label="Toggle Extra Options">Hide Extra Options</button>
                <div class="input-wrapper flex gap-2 items-center">
                    <div class="relative flex-1">
                        <textarea class="user-input w-full p-2 border rounded-lg resize-none min-h-10 max-h-28 bg-transparent focus:border-blue-500 focus:ring-1 focus:ring-blue-400 outline-none glass-effect text-white" id="userInput" placeholder="Type your message..." aria-label="Message Input" maxlength="1500"></textarea>
                        <div class="char-counter" id="charCounter">0/1500</div>
                    </div>
                    <button class="send-btn bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700" id="sendBtn" aria-label="Send Message"><i class="fas fa-paper-plane"></i></button>
                    <button class="rephrase-btn bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700" id="rephraseBtn" aria-label="Rephrase Last AI Message"><i class="fas fa-redo"></i></button>
                    <button class="voice-input-btn bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700" id="voiceInputBtn" aria-label="Voice Input"><i class="fas fa-microphone"></i></button>
                </div>
            </div>
        </div>
        <div class="game-sidebar" id="gameSidebar" role="region" aria-label="Game Sidebar">
            <div class="game-sidebar-content">
                <button class="game-sidebar-close bg-red-500 text-white px-2 py-1 rounded-lg hover:bg-red-600" id="gameSidebarClose" aria-label="Close Game Sidebar"><i class="fas fa-times"></i> Close</button>
                <div class="game-section">
                    <h3>Game Area</h3>
                    <canvas id="gameCanvas" width="240" height="240" class="game-canvas"></canvas>
                    <div class="game-controls">
                        <button class="game-btn start-game" id="startGameBtn" aria-label="Start Game">Start</button>
                        <button class="game-btn stop-game" id="stopGameBtn" aria-label="Stop Game">Stop</button>
                    </div>
                    <div class="game-score text-sm text-gray-200 mt-2" id="gameScore">Score: 0</div>
                </div>
            </div>
        </div>
    </div>
    <div class="notification" id="notification" aria-live="assertive"></div>
    <div class="modal" id="userProfileModal" role="dialog" aria-label="User Profile Modal">
        <div class="modal-content glass-effect">
            <button class="modal-close absolute top-1 right-1 text-red-500 hover:text-red-600" id="userProfileClose" aria-label="Close Profile Modal"><i class="fas fa-times fa-lg"></i></button>
            <h3 class="text-lg font-bold mb-3 text-white">User Profile</h3>
            <input type="text" id="usernameInput" class="w-full p-2 border rounded-lg mb-2 focus:ring-1 focus:ring-blue-400 outline-none glass-effect text-white" placeholder="Enter your username" aria-label="Username Input">
            <input type="text" id="openAIKeyInput" class="w-full p-2 border rounded-lg mb-2 focus:ring-1 focus:ring-blue-400 outline-none glass-effect text-white" placeholder="Enter your OpenAI API Key" aria-label="OpenAI API Key Input">
            <select id="chatLayoutSelect" class="w-full p-2 border rounded-lg mb-2 focus:ring-1 focus:ring-blue-400 outline-none glass-effect text-white" aria-label="Chat Layout Selection">
                <option value="default">Default Layout</option>
                <option value="compact">Compact</option>
                <option value="spacious">Spacious</option>
            </select>
            <label class="text-xs text-gray-300" for="fontSizeInput">Font Size (px):</label>
            <input type="number" id="fontSizeInput" min="10" max="22" value="16" class="w-full p-2 border rounded-lg mb-2 focus:ring-1 focus:ring-blue-400 outline-none glass-effect text-white" aria-label="Font Size Input">
            <label class="text-xs text-gray-300 flex items-center gap-2 mb-2">
                <input type="checkbox" id="autoScrollToggle" checked aria-label="Auto-Scroll Toggle">
                Auto-Scroll
            </label>
            <label class="text-xs text-gray-300 flex items-center gap-2 mb-2">
                <input type="checkbox" id="showTimestampsToggle" aria-label="Show Message Timestamps Toggle">
                Show Timestamps
            </label>
            <button id="saveSettingsBtn" class="bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700 w-full" aria-label="Save Settings">Save</button>
        </div>
    </div>
    <div class="modal" id="permissionModal" role="dialog" aria-label="Permission Modal">
        <div class="modal-content glass-effect">
            <button class="modal-close absolute top-1 right-1 text-red-500 hover:text-red-600" id="permissionModalClose" aria-label="Close Permission Modal"><i class="fas fa-times fa-lg"></i></button>
            <h3 class="text-lg font-bold mb-3 text-white">Permission Required</h3>
            <p class="text-gray-300">Allow microphone access for voice commands?</p>
            <div class="mt-3 flex gap-2">
                <button id="grantPermissionBtn" class="bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700" aria-label="Grant Microphone Access">Grant</button>
                <button id="denyPermissionBtn" class="bg-red-500 text-white px-2 py-1 rounded-lg hover:bg-red-600" aria-label="Deny Microphone Access">Deny</button>
            </div>
        </div>
    </div>
    <div class="modal" id="confirmClearModal" role="dialog" aria-label="Confirm Clear Chat Modal">
        <div class="modal-content glass-effect">
            <button class="modal-close absolute top-1 right-1 text-red-500 hover:text-red-600" id="confirmClearModalClose" aria-label="Close Clear Chat Modal"><i class="fas fa-times fa-lg"></i></button>
            <h3 class="text-lg font-bold mb-3 text-white">Confirm Clear Chat</h3>
            <p class="text-gray-300">Are you sure you want to clear the chat?</p>
            <div class="mt-3 flex gap-2">
                <button id="confirmClearBtn" class="bg-red-500 text-white px-2 py-1 rounded-lg hover:bg-red-600" aria-label="Confirm Clear Chat">Clear</button>
                <button id="cancelClearBtn" class="bg-gray-500 text-white px-2 py-1 rounded-lg hover:bg-gray-600" aria-label="Cancel Clear Chat">Cancel</button>
            </div>
        </div>
    </div>
    <div class="modal" id="feedbackModal" role="dialog" aria-label="Feedback Modal">
        <div class="modal-content glass-effect">
            <button class="modal-close absolute top-1 right-1 text-red-500 hover:text-red-600" id="feedbackModalClose" aria-label="Close Feedback Modal"><i class="fas fa-times fa-lg"></i></button>
            <h3 class="text-lg font-bold mb-3 text-white">Feedback</h3>
            <textarea id="feedbackInput" class="w-full p-2 border rounded-lg mb-2 focus:ring-1 focus:ring-blue-400 outline-none glass-effect text-white" placeholder="Enter your feedback..." aria-label="Feedback Input"></textarea>
            <button id="feedbackSubmitBtn" class="bg-blue-600 text-white px-2 py-1 rounded-lg hover:bg-blue-700" aria-label="Submit Feedback">Submit</button>
        </div>
    </div>
    <script>
        const elements = {
            preloader: document.getElementById('preloader'),
            preloaderInput: document.getElementById('preloaderInput'),
            captchaInput: document.getElementById('captchaInput'),
            submitBtn: document.getElementById('submitBtn'),
            chatArea: document.getElementById('chatArea'),
            chatHistory: document.getElementById('chatHistory'),
            userInput: document.getElementById('userInput'),
            sendBtn: document.getElementById('sendBtn'),
            rephraseBtn: document.getElementById('rephraseBtn'),
            typingIndicator: document.getElementById('typingIndicator'),
            userProfileBtn: document.getElementById('userProfileBtn'),
            messageCounter: document.getElementById('messageCounter'),
            fileInput: document.getElementById('fileInput'),
            fileClearBtn: document.getElementById('fileClearBtn'),
            fileList: document.getElementById('fileList'),
            fileActionsContainer: document.getElementById('fileActionsContainer'),
            toggleActionsBtn: document.getElementById('toggleActionsBtn'),
            fileUploadProgress: document.getElementById('fileUploadProgress'),
            userProfileModal: document.getElementById('userProfileModal'),
            userProfileClose: document.getElementById('userProfileClose'),
            usernameInput: document.getElementById('usernameInput'),
            openAIKeyInput: document.getElementById('openAIKeyInput'),
            chatLayoutSelect: document.getElementById('chatLayoutSelect'),
            fontSizeInput: document.getElementById('fontSizeInput'),
            autoScrollToggle: document.getElementById('autoScrollToggle'),
            showTimestampsToggle: document.getElementById('showTimestampsToggle'),
            saveSettingsBtn: document.getElementById('saveSettingsBtn'),
            voiceInputBtn: document.getElementById('voiceInputBtn'),
            permissionModal: document.getElementById('permissionModal'),
            permissionModalClose: document.getElementById('permissionModalClose'),
            grantPermissionBtn: document.getElementById('grantPermissionBtn'),
            denyPermissionBtn: document.getElementById('denyPermissionBtn'),
            notification: document.getElementById('notification'),
            sidebar: document.getElementById('sidebar'),
            sidebarClose: document.getElementById('sidebarClose'),
            menuBtn: document.getElementById('menuBtn'),
            clearChatBtn: document.getElementById('clearChatBtn'),
            confirmClearModal: document.getElementById('confirmClearModal'),
            confirmClearModalClose: document.getElementById('confirmClearModalClose'),
            confirmClearBtn: document.getElementById('confirmClearBtn'),
            cancelClearBtn: document.getElementById('cancelClearBtn'),
            exportChatBtn: document.getElementById('exportChatBtn'),
            copyConversationBtn: document.getElementById('copyConversationBtn'),
            shareWebsiteBtn: document.getElementById('shareWebsiteBtn'),
            feedbackBtn: document.getElementById('feedbackBtn'),
            feedbackModal: document.getElementById('feedbackModal'),
            feedbackModalClose: document.getElementById('feedbackModalClose'),
            feedbackInput: document.getElementById('feedbackInput'),
            feedbackSubmitBtn: document.getElementById('feedbackSubmitBtn'),
            prysmisUpdatesBtn: document.getElementById('prysmisUpdatesBtn'),
            discordBtn: document.getElementById('discordBtn'),
            premiumBtn: document.getElementById('premiumBtn'),
            quickActions: document.getElementById('quickActions'),
            statusIndicator: document.getElementById('statusIndicator'),
            recentMessages: document.getElementById('recentMessages'),
            searchMessagesInput: document.getElementById('searchMessagesInput'),
            activityLog: document.getElementById('activityLog'),
            charCounter: document.getElementById('charCounter'),
            themeToggleBtn: document.getElementById('themeToggleBtn'),
            gameSidebar: document.getElementById('gameSidebar'),
            gameSidebarClose: document.getElementById('gameSidebarClose'),
            gameBtn: document.getElementById('gameBtn'),
            gameCanvas: document.getElementById('gameCanvas'),
            startGameBtn: document.getElementById('startGameBtn'),
            stopGameBtn: document.getElementById('stopGameBtn'),
            gameScore: document.getElementById('gameScore')
        };

        const store = {
            state: {
                conversationHistory: [],
                messageCount: 0,
                filesArray: [],
                userProfile: {
                    username: 'Developer',
                    chatLayout: 'default',
                    openAIKey: '',
                    preferences: { fontSize: 16, autoScroll: true, showTimestamps: false, theme: 'dark', animationSpeed: 'medium' }
                },
                notificationQueue: [],
                rateLimit: { interval: 5, lastAction: 0, tokens: 50, maxTokens: 50, refillRate: 20 },
                requestTracker: { count: 0, lastReset: Date.now(), maxRequests: 100, resetInterval: 6000 },
                captcha: null,
                isCaptchaVerified: false,
                isOnline: true,
                messageReactions: new Map(),
                activityLog: [],
                lastTypingUpdate: 0,
                gameState: { isPlaying: false, score: 0, snake: [], food: null, direction: 'right', gameLoop: null }
            },
            dispatch(action) {
                switch (action.type) {
                    case "SET_STATE":
                        this.state = { ...this.state, ...action.payload };
                        this.saveState();
                        break;
                    case "ADD_MESSAGE":
                        this.state.conversationHistory.push(action.payload);
                        this.state.messageCount++;
                        this.trimConversationHistory();
                        this.addToActivityLog(`Sent a message: ${action.payload.content.substring(0, 20)}...`);
                        this.saveState();
                        break;
                    case "SET_FILES":
                        this.state.filesArray = action.payload;
                        this.addToActivityLog(`Uploaded ${action.payload.length} file(s)`);
                        this.saveState();
                        break;
                    case "CLEAR_CHAT":
                        this.state.conversationHistory = [];
                        this.state.messageCount = 0;
                        this.state.filesArray = [];
                        this.state.messageReactions.clear();
                        this.state.conversationHistory.push({
                            id: Date.now(),
                            role: "assistant",
                            content: `Welcome, ${this.state.userProfile.username}! I'm Prysmis, your ultimate assistant. How can I assist you today?`,
                            timestamp: Date.now()
                        });
                        this.state.messageCount = 1;
                        this.addToActivityLog("Cleared chat");
                        this.saveState();
                        break;
                    case "ENQUEUE_NOTIFICATION":
                        this.state.notificationQueue.push(action.payload);
                        this.saveState();
                        break;
                    case "DEQUEUE_NOTIFICATION":
                        this.state.notificationQueue.shift();
                        this.saveState();
                        break;
                    case "INCREMENT_REQUEST":
                        const now = Date.now();
                        if (now - this.state.requestTracker.lastReset > this.state.requestTracker.resetInterval) {
                            this.state.requestTracker = { count: 0, lastReset: now, maxRequests: 100, resetInterval: 6000 };
                        }
                        this.state.requestTracker.count++;
                        this.saveState();
                        break;
                    case "UPDATE_RATE_LIMIT":
                        const currentTime = Date.now();
                        const elapsed = (currentTime - this.state.rateLimit.lastAction) / 1000;
                        const tokensToAdd = elapsed * this.state.rateLimit.refillRate;
                        this.state.rateLimit.tokens = Math.min(this.state.rateLimit.maxTokens, this.state.rateLimit.tokens + tokensToAdd);
                        this.state.rateLimit.lastAction = currentTime;
                        this.saveState();
                        break;
                    case "SET_ONLINE_STATUS":
                        this.state.isOnline = action.payload;
                        this.saveState();
                        break;
                    case "TOGGLE_REACTION":
                        const { messageId, reaction } = action.payload;
                        const reactions = this.state.messageReactions.get(messageId) || { thumbsUp: false, thumbsDown: false };
                        reactions[reaction] = !reactions[reaction];
                        this.state.messageReactions.set(messageId, reactions);
                        this.addToActivityLog(`Reacted to message ID ${messageId} with ${reaction}`);
                        this.saveState();
                        break;
                    case "ADD_ACTIVITY_LOG":
                        this.state.activityLog.push({ id: Date.now(), action: action.payload, timestamp: Date.now() });
                        if (this.state.activityLog.length > 10) this.state.activityLog.shift();
                        this.saveState();
                        break;
                    case "UPDATE_TYPING":
                        this.state.lastTypingUpdate = action.payload;
                        this.saveState();
                        break;
                    case "UPDATE_GAME_STATE":
                        this.state.gameState = { ...this.state.gameState, ...action.payload };
                        this.saveState();
                        break;
                }
            },
            trimConversationHistory() {
                if (this.state.conversationHistory.length > 30) {
                    this.state.conversationHistory = this.state.conversationHistory.slice(-30);
                    this.state.messageCount = this.state.conversationHistory.length;
                }
            },
            addToActivityLog(action) {
                this.dispatch({ type: "ADD_ACTIVITY_LOG", payload: action });
            },
            async loadState() {
                const db = await initDB();
                const data = await getFromDB(db, "state");
                if (data) {
                    this.state = { ...this.state, ...data };
                    this.state.messageReactions = new Map(data.messageReactions || []);
                }
                if (this.state.conversationHistory.length === 0) {
                    this.dispatch({
                        type: "ADD_MESSAGE",
                        payload: {
                            id: Date.now(),
                            role: "assistant",
                            content: `Welcome, ${this.state.userProfile.username}! I'm Prysmis, your ultimate assistant. How can I assist you today?`,
                            timestamp: Date.now()
                        }
                    });
                    this.dispatch({ type: "SET_STATE", payload: { messageCount: 1 } });
                }
            },
            async saveState() {
                const db = await initDB();
                const dataToSave = {
                    ...this.state,
                    messageReactions: Array.from(this.state.messageReactions.entries())
                };
                await saveToDB(db, "state", dataToSave);
            }
        };

        const openAI = {
            async getAIResponse(message, apiKey) {
                if (!apiKey) {
                    throw new Error("No OpenAI API key provided.");
                }
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [
                            { role: "system", content: "You are Prysmis AI, a helpful assistant capable of playing games like Snake.io." },
                            { role: "user", content: message }
                        ],
                        max_tokens: 500
                    })
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error?.message || "Failed to get AI response.");
                }
                return data.choices[0].message.content;
            },
            async rephraseMessage(message, apiKey) {
                if (!apiKey) {
                    throw new Error("No OpenAI API key provided.");
                }
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [
                            { role: "system", content: "Rephrase the following message in a natural way:" },
                            { role: "user", content: message }
                        ],
                        max_tokens: 500
                    })
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error?.message || "Failed to rephrase message.");
                }
                return data.choices[0].message.content;
            }
        };

        const initDB = () => new Promise((resolve, reject) => {
            const request = indexedDB.open("PrysmisDB", 5);
            request.onupgradeneeded = e => {
                const db = e.target.result;
                if (e.oldVersion < 1) {
                    db.createObjectStore("state", { keyPath: "id" });
                }
            };
            request.onsuccess = e => resolve(e.target.result);
            request.onerror = e => reject(e.target.error);
        });

        const saveToDB = (db, storeName, data) => new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], "readwrite").objectStore(storeName).put({ id: "appState", ...data });
            transaction.onsuccess = () => resolve();
            transaction.onerror = e => reject(e.target.error);
        });

        const getFromDB = (db, storeName) => new Promise((resolve, reject) => {
            const request = db.transaction([storeName], "readonly").objectStore(storeName).get("appState");
            request.onsuccess = e => resolve(e.target.result);
            request.onerror = e => reject(e.target.error);
        });

        const debounce = (func, wait) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        };

        const showNotification = (message, type = "success") => {
            store.dispatch({ type: "ENQUEUE_NOTIFICATION", payload: { message, type } });
            processNotificationQueue();
        };

        const processNotificationQueue = () => {
            if (store.state.notificationQueue.length === 0) return;
            const { message, type } = store.state.notificationQueue[0];
            elements.notification.innerHTML = `<i class="fas ${type === "success" ? "fa-check-circle" : "fa-exclamation-circle"}"></i> ${message}`;
            elements.notification.className = `notification ${type === "success" ? "bg-green-500" : "bg-red-500"} show`;
            gsap.fromTo(elements.notification, { opacity: 0, y: -20 }, { opacity: 1, y: 0, duration: 0.15 });
            setTimeout(() => {
                gsap.to(elements.notification, {
                    opacity: 0,
                    y: -20,
                    duration: 0.15,
                    onComplete: () => {
                        elements.notification.className = "notification";
                        store.dispatch({ type: "DEQUEUE_NOTIFICATION" });
                        processNotificationQueue();
                    }
                });
            }, 1500);
        };

        const sanitizeInput = input => {
            const div = document.createElement("div");
            div.textContent = input;
            return div.innerHTML;
        };

        const checkRateLimit = () => {
            store.dispatch({ type: "UPDATE_RATE_LIMIT" });
            if (store.state.rateLimit.tokens < 1) {
                showNotification("Too many requests. Please wait.", "error");
                return false;
            }
            store.dispatch({ type: "INCREMENT_REQUEST" });
            if (store.state.requestTracker.count > store.state.requestTracker.maxRequests) {
                showNotification("Request limit exceeded. Please wait.", "error");
                return false;
            }
            store.state.rateLimit.tokens -= 1;
            return true;
        };

        const checkOnlineStatus = () => {
            const isOnline = navigator.onLine;
            store.dispatch({ type: "SET_ONLINE_STATUS", payload: isOnline });
            elements.statusIndicator.classList.toggle("offline", !isOnline);
            if (!isOnline) showNotification("You are offline. Some features may be limited.", "error");
        };

        const updateTimestampsVisibility = () => {
            const timestamps = document.querySelectorAll(".chat-message-timestamp");
            timestamps.forEach(timestamp => {
                timestamp.classList.toggle("visible", store.state.userProfile.preferences.showTimestamps);
            });
        };

        const renderMessages = (container, messages) => {
            const fragment = document.createDocumentFragment();
            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const messageEl = entry.target;
                        messageEl.classList.add("visible");
                        const speed = store.state.userProfile.preferences.animationSpeed === "fast" ? 0.1 : store.state.userProfile.preferences.animationSpeed === "slow" ? 0.3 : 0.15;
                        gsap.fromTo(messageEl, { opacity: 0, scale: 0.98 out, y: 8 }, { opacity: 1, scale: 1, y: 0, duration: speed, ease: "power3.out" });
                        obs.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });

            messages.forEach(message => {
                const messageEl = document.createElement("div");
                messageEl.className = `chat-message ${message.role}`;
                messageEl.dataset.messageId = message.id;

                const headerEl = document.createElement("div");
                headerEl.className = "chat-message-header";
                const roleEl = document.createElement("span");
                roleEl.className = "role";
                roleEl.textContent = message.role === "user" ? store.state.userProfile.username : "Prysmis AI";
                const timestampEl = document.createElement("span");
                timestampEl.className = "chat-message-timestamp";
                timestampEl.textContent = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                headerEl.append(roleEl, timestampEl);

                const contentEl = document.createElement("div");
                contentEl.className = "chat-message-content";
                if (message.content.includes("```")) {
                    const parts = message.content.split(/```/);
                    let content = "";
                    parts.forEach((part, idx) => {
                        if (idx % 2 === 0) {
                            content += part;
                        } else {
                            const [lang, ...codeLines] = part.split('\n');
                            const code = codeLines.join('\n').trim();
                            content += `<pre><code class="language-${lang.trim()}">${code}</code></pre>`;
                            content += `<div class="code-block-actions">
                                <button class="copy-code-btn" data-code="${encodeURIComponent(code)}" aria-label="Copy Code">Copy</button>
                                <button class="execute-code-btn" data-code="${encodeURIComponent(code)}" aria-label="Execute Code">Execute</button>
                            </div>`;
                        }
                    });
                    contentEl.innerHTML = content;
                    setTimeout(() => hljs.highlightAll(), 0);
                } else if (message.file) {
                    contentEl.textContent = message.content;
                    if (message.file.type.startsWith("image/")) {
                        const img = document.createElement("img");
                        img.src = message.file.data;
                        img.alt = message.file.name;
                        img.className = "rounded-lg shadow-lg transition-transform duration-200 hover:scale-105";
                        contentEl.appendChild(img);
                        const meta = document.createElement("div");
                        meta.className = "media-meta";
                        meta.textContent = `Image: ${message.file.name} (${(message.file.size / 1024).toFixed(2)} KB) | Dimensions: ${message.file.width}x${message.file.height}`;
                        contentEl.appendChild(meta);
                    } else if (message.file.type.startsWith("video/")) {
                        const video = document.createElement("video");
                        video.src = message.file.data;
                        video.controls = true;
                        video.className = "rounded-lg shadow-lg";
                        contentEl.appendChild(video);
                        const meta = document.createElement("div");
                        meta.className = "media-meta";
                        meta.textContent = `Video: ${message.file.name} (${(message.file.size / 1024).toFixed(2)} KB) | Duration: ${message.file.duration}s`;
                        contentEl.appendChild(meta);
                    }
                } else {
                    contentEl.textContent = message.content;
                }

                const reactionsEl = document.createElement("div");
                reactionsEl.className = "reaction-buttons";
                const thumbsUpBtn = document.createElement("button");
                thumbsUpBtn.className = "reaction-btn thumbs-up";
                thumbsUpBtn.innerHTML = '<i class="fas fa-thumbs-up"></i>';
                thumbsUpBtn.setAttribute("aria-label", "Thumbs Up Reaction");
                const thumbsDownBtn = document.createElement("button");
                thumbsDownBtn.className = "reaction-btn thumbs-down";
                thumbsDownBtn.innerHTML = '<i class="fas fa-thumbs-down"></i>';
                thumbsDownBtn.setAttribute("aria-label", "Thumbs Down Reaction");
                const reactions = store.state.messageReactions.get(message.id) || { thumbsUp: false, thumbsDown: false };
                thumbsUpBtn.classList.toggle("reacted", reactions.thumbsUp);
                thumbsDownBtn.classList.toggle("reacted", reactions.thumbsDown);
                reactionsEl.append(thumbsUpBtn, thumbsDownBtn);

                messageEl.append(headerEl, contentEl, reactionsEl);
                fragment.appendChild(messageEl);
                observer.observe(messageEl);
            });

            container.innerHTML = "";
            container.appendChild(fragment);
            elements.messageCounter.textContent = `Messages: ${store.state.messageCount}`;
            if (store.state.userProfile.preferences.autoScroll) {
                const speed = store.state.userProfile.preferences.animationSpeed === "fast" ? 0.1 : store.state.userProfile.preferences.animationSpeed === "slow" ? 0.3 : 0.15;
                gsap.to(elements.chatArea, { scrollTop: elements.chatArea.scrollHeight, duration: speed, ease: "power3.out" });
            }
            updateTimestampsVisibility();
        };

        const renderRecentMessages = () => {
            elements.recentMessages.innerHTML = "";
            const recentMessages = store.state.conversationHistory.slice(-5).reverse();
            recentMessages.forEach(message => {
                const messageEl = document.createElement("div");
                messageEl.className = "recent-message-item transition-all duration-200 hover:bg-opacity-30";
                messageEl.dataset.messageId = message.id;
                messageEl.innerHTML = `
                    <span class="text-xs">${message.content.substring(0, 30) + (message.content.length > 30 ? "..." : "")}</span>
                    <span class="text-xs text-gray-400 ml-auto">${new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                `;
                elements.recentMessages.appendChild(messageEl);
                gsap.from(messageEl, { opacity: 0, x: -15, duration: 0.15, ease: "power3.out" });
            });
        };

        const renderActivityLog = () => {
            elements.activityLog.innerHTML = "";
            store.state.activityLog.slice().reverse().forEach(log => {
                const logEl = document.createElement("div");
                logEl.className = "activity-log-item transition-all duration-200 hover:bg-opacity-30";
                logEl.innerHTML = `
                    <span class="text-xs">${log.action}</span>
                    <span class="text-xs text-gray-400 ml-auto">${new Date(log.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                `;
                elements.activityLog.appendChild(logEl);
                gsap.from(logEl, { opacity: 0, x: -15, duration: 0.15, ease: "power3.out" });
            });
        };

        const handleSendMessage = async () => {
            if (!store.state.isOnline) return showNotification("You are offline. Please connect to the internet.", "error");
            if (!checkRateLimit()) return;
            const input = sanitizeInput(elements.userInput.value.trim());
            if (!input) return showNotification("Please enter a message.", "error");

            const messageId = Date.now();
            let userMessage = { id: messageId, role: "user", content: input, timestamp: Date.now() };
            if (store.state.filesArray.length > 0) {
                userMessage.file = store.state.filesArray[0];
                userMessage.content = `File uploaded: ${userMessage.file.name}\n${input}`;
            }

            store.dispatch({ type: "ADD_MESSAGE", payload: userMessage });
            elements.userInput.value = "";
            elements.charCounter.textContent = "0/1500";
            store.dispatch({ type: "SET_FILES", payload: [] });

            elements.typingIndicator.classList.add("visible");
            gsap.fromTo(elements.typingIndicator, { opacity: 0, scale: 0.95 }, { opacity: 1, scale: 1, duration: 0.1, ease: "power3.out" });

            try {
                if (input.toLowerCase().includes("play snake") || input.toLowerCase().includes("start snake game")) {
                    const aiMessage = { id: Date.now(), role: "assistant", content: "Starting Snake game in the game sidebar!", timestamp: Date.now() };
                    store.dispatch({ type: "ADD_MESSAGE", payload: aiMessage });
                    toggleGameSidebar();
                    startSnakeGame();
                } else {
                    const response = await openAI.getAIResponse(input, store.state.userProfile.openAIKey);
                    const aiMessage = { id: Date.now(), role: "assistant", content: response, timestamp: Date.now() };
                    store.dispatch({ type: "ADD_MESSAGE", payload: aiMessage });
                }
            } catch (error) {
                showNotification(error.message, "error");
                const errorMessage = { id: Date.now(), role: "assistant", content: "Sorry, I couldn't process your request. Please check your API key or try again later.", timestamp: Date.now() };
                store.dispatch({ type: "ADD_MESSAGE", payload: errorMessage });
            }

            elements.typingIndicator.classList.remove("visible");
            renderMessages(elements.chatHistory, store.state.conversationHistory);
            renderRecentMessages();
            renderActivityLog();
        };

        const debouncedSendMessage = debounce(handleSendMessage, 20);

        const handleQuickAction = e => {
            const action = e.target.closest(".quick-action-btn").dataset.action;
            switch (action) {
                case "code":
                    elements.userInput.value = "Generate a JavaScript function to calculate Fibonacci numbers.";
                    break;
                case "joke":
                    elements.userInput.value = "Tell me a funny joke!";
                    break;
                case "fact":
                    elements.userInput.value = "Share an interesting fact!";
                    break;
                case "weather":
                    elements.userInput.value = "What's the weather like in New York today?";
                    break;
            }
            elements.charCounter.textContent = `${elements.userInput.value.length}/1500`;
            debouncedSendMessage();
        };

        const handleFileUpload = async e => {
            if (!store.state.isOnline) return showNotification("You are offline. Please connect to the internet.", "error");
            if (!checkRateLimit()) return;
            const files = Array.from(e.target.files);
            if (files.length > 1) return showNotification("Only one file can be uploaded at a time.", "error");

            const progressBar = elements.fileUploadProgress.querySelector("div");
            const uploadedFiles = [];
            for (const file of files) {
                const fileData = { id: Date.now() + Math.random(), name: file.name, type: file.type, size: file.size, data: null };
                try {
                    if (file.type.startsWith("text/")) {
                        fileData.data = await new Promise(resolve => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.readAsText(file);
                        });
                    } else if (file.type.startsWith("image/") || file.type.startsWith("video/")) {
                        fileData.data = await new Promise(resolve => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.readAsDataURL(file);
                        });
                        if (file.type.startsWith("image/")) {
                            const img = new Image();
                            img.src = fileData.data;
                            await new Promise(resolve => img.onload = resolve);
                            fileData.width = img.width;
                            fileData.height = img.height;
                        } else if (file.type.startsWith("video/")) {
                            const video = document.createElement("video");
                            video.src = fileData.data;
                            await new Promise(resolve => video.onloadedmetadata = resolve);
                            fileData.duration = Math.round(video.duration);
                        }
                    }
                    uploadedFiles.push(fileData);
                    gsap.to(progressBar, { width: "100%", duration: 0.15, ease: "power3.inOut" });
                } catch (err) {
                    showNotification(`Failed to process ${file.name}.`, "error");
                }
            }
            store.dispatch({ type: "SET_FILES", payload: uploadedFiles });
            renderFileList();
            gsap.to(progressBar, { width: "0%", duration: 0.15, ease: "power3.inOut" });
            elements.fileClearBtn.classList.toggle("hidden", store.state.filesArray.length === 0);
            showNotification(`${uploadedFiles.length} file(s) uploaded successfully!`);
        };

        const renderFileList = () => {
            elements.fileList.innerHTML = "";
            store.state.filesArray.forEach(file => {
                const fileEl = document.createElement("div");
                fileEl.className = "file-item p-1 bg-gray-100 rounded-lg flex justify-between items-center glass-effect transition-all duration-200 hover:bg-opacity-50";
                fileEl.dataset.fileId = file.id;
                fileEl.innerHTML = `
                    <span class="text-xs text-white">${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>
                    <button class="remove-file-btn text-red-500 hover:text-red-600 transition-colors duration-200" aria-label="Remove File"><i class="fas fa-trash"></i></button>
                `;
                elements.fileList.appendChild(fileEl);
                gsap.from(fileEl, { opacity: 0, x: -15, duration: 0.15, ease: "power3.out" });
            });
        };

        const clearFiles = () => {
            if (!checkRateLimit()) return;
            store.dispatch({ type: "SET_FILES", payload: [] });
            elements.fileList.innerHTML = "";
            elements.fileClearBtn.classList.add("hidden");
            showNotification("All files cleared.");
        };

        const toggleFileActions = () => {
            const isHidden = elements.fileActionsContainer.classList.contains("max-h-0");
            elements.fileActionsContainer.classList.toggle("max-h-0", !isHidden);
            elements.fileActionsContainer.classList.toggle("max-h-24", isHidden);
            elements.fileActionsContainer.classList.toggle("opacity-0", !isHidden);
            elements.fileActionsContainer.classList.toggle("opacity-100", isHidden);
            elements.toggleActionsBtn.textContent = isHidden ? "Hide Extra Options" : "Show Extra Options";
            elements.toggleActionsBtn.setAttribute("aria-expanded", isHidden);
            const speed = store.state.userProfile.preferences.animationSpeed === "fast" ? 0.1 : store.state.userProfile.preferences.animationSpeed === "slow" ? 0.3 : 0.15;
            gsap.to(elements.fileActionsContainer, { height: isHidden ? "auto" : 0, duration: speed, ease: "power3.out" });
        };

        const applyChatLayout = () => {
            const layout = store.state.userProfile.chatLayout;
            const fontSize = store.state.userProfile.preferences.fontSize;
            const chatArea = elements.chatArea;
            if (layout === "compact") {
                chatArea.style.padding = "0.4rem";
                chatArea.style.fontSize = `${fontSize - 2}px`;
                elements.chatHistory.style.gap = "0.2rem";
            } else if (layout === "spacious") {
                chatArea.style.padding = "1rem";
                chatArea.style.fontSize = `${fontSize + 2}px`;
                elements.chatHistory.style.gap = "0.75rem";
            } else {
                chatArea.style.padding = "0.75rem";
                chatArea.style.fontSize = `${fontSize}px`;
                elements.chatHistory.style.gap = "0.5rem";
            }
        };

        const checkMicPermission = async () => {
            try {
                const permission = await navigator.permissions.query({ name: "microphone" });
                return permission.state === "granted";
            } catch (error) {
                return false;
            }
        };

        const handleVoiceInput = async () => {
            if (!store.state.isOnline) return showNotification("You are offline. Please connect to the internet.", "error");
            if (!checkRateLimit()) return;
            if (!("webkitSpeechRecognition" in window)) return showNotification("Voice recognition not supported in this browser.", "error");

            if (await checkMicPermission()) {
                startVoiceRecognition();
            } else {
                elements.permissionModal.classList.add("open");
                const speed = store.state.userProfile.preferences.animationSpeed === "fast" ? 0.1 : store.state.userProfile.preferences.animationSpeed === "slow" ? 0.3 : 0.15;
                gsap.fromTo(elements.permissionModal.querySelector(".modal-content"), { scale: 0.98, opacity: 0 }, { scale: 1, opacity: 1, duration: speed, ease: "power3.out" });
                elements.grantPermissionBtn.focus();
            }
        };

        const startVoiceRecognition = () => {
            const recognition = new webkitSpeechRecognition();
            recognition.lang = "en-US";
            recognition.interimResults = true;
            recognition.continuous = true;
            recognition.onresult = e => {
                const transcript = Array.from(e.results).map(r => r[0].transcript).join("");
                elements.userInput.value = transcript;
                elements.charCounter.textContent = `${transcript.length}/1500`;
            };
            recognition.onerror = e => {
                showNotification(`Voice recognition error: ${e.error}`, "error");
                recognition.stop();
            };
            recognition.onend = () => {
                showNotification("Voice recognition stopped.");
            };
            recognition.start();
        };

        const rephraseMessage = async () => {
            if (!store.state.isOnline) return showNotification("You are offline. Please connect to the internet.", "error");
            if (!checkRateLimit()) return;
            const lastAIMessage = store.state.conversationHistory.slice().reverse().find(m => m.role === "assistant");
            if (!lastAIMessage) return showNotification("No AI message to rephrase. Please send a message first.", "error");

            elements.typingIndicator.classList.add("visible");
            gsap.fromTo(elements.typingIndicator, { opacity: 0, scale: 0.95 }, { opacity: 1, scale: 1, duration: 0.1, ease: "power3.out" });

            try {
                const rephrased = await openAI.rephraseMessage(lastAIMessage.content, store.state.userProfile.openAIKey);
                const newMessage = { id: Date.now(), role: "assistant", content: rephrased, timestamp: Date.now() };
                store.dispatch({ type: "ADD_MESSAGE", payload: newMessage });
            } catch (error) {
                showNotification(error.message, "error");
                const errorMessage = { id: Date.now(), role: "assistant", content: "Sorry, I couldn't rephrase the message. Please check your API key or try again later.", timestamp: Date.now() };
                store.dispatch({ type: "ADD_MESSAGE", payload: errorMessage });
            }

            elements.typingIndicator.classList.remove("visible");
            renderMessages(elements.chatHistory, store.state.conversationHistory);
            renderRecentMessages();
            renderActivityLog();
            showNotification("Message rephrased!");
        };

        const toggleSidebar = () => {
            if (!checkRateLimit()) return;
            const isOpen = elements.sidebar.classList.toggle("open");
            const speed = store.state.userProfile.preferences.animationSpeed === "fast" ? 0.1 : store.state.userProfile.preferences.animationSpeed === "slow" ? 0.3 : 0.15;
                        gsap.to(elements.sidebar, { width: isOpen ? (window.innerWidth <= 768 ? "100%" : 220) : 0, duration: speed, ease: "power3.out" });
            elements.menuBtn.setAttribute("aria-expanded", isOpen);
            if (isOpen) elements.sidebarClose.focus();
            store.addToActivityLog(`Sidebar ${isOpen ? "opened" : "closed"}`);
        };

        const toggleGameSidebar = () => {
            if (!checkRateLimit()) return;
            const isOpen = elements.gameSidebar.classList.toggle("open");
            const speed = store.state.userProfile.preferences.animationSpeed === "fast" ? 0.1 : store.state.userProfile.preferences.animationSpeed === "slow" ? 0.3 : 0.15;
            gsap.to(elements.gameSidebar, { width: isOpen ? (window.innerWidth <= 768 ? "100%" : 280) : 0, duration: speed, ease: "power3.out" });
            elements.gameBtn.setAttribute("aria-expanded", isOpen);
            if (isOpen) elements.gameSidebarClose.focus();
            store.addToActivityLog(`Game sidebar ${isOpen ? "opened" : "closed"}`);
        };

        const startSnakeGame = () => {
            if (store.state.gameState.isPlaying) return;
            const canvas = elements.gameCanvas;
            const ctx = canvas.getContext("2d");
            const gridSize = 20;
            const tileCount = canvas.width / gridSize;
            let snake = [{ x: 5, y: 5 }];
            let food = { x: Math.floor(Math.random() * tileCount), y: Math.floor(Math.random() * tileCount) };
            let direction = "right";
            let score = 0;

            store.dispatch({ type: "UPDATE_GAME_STATE", payload: { isPlaying: true, score: 0, snake, food, direction } });

            const drawGame = () => {
                ctx.fillStyle = "#1e293b";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = "#22c55e";
                snake.forEach(segment => {
                    ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 2, gridSize - 2);
                });

                ctx.fillStyle = "#ef4444";
                ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 2, gridSize - 2);

                let head = { x: snake[0].x, y: snake[0].y };
                if (direction === "right") head.x++;
                else if (direction === "left") head.x--;
                else if (direction === "up") head.y--;
                else if (direction === "down") head.y++;

                if (head.x === food.x && head.y === food.y) {
                    score++;
                    food = { x: Math.floor(Math.random() * tileCount), y: Math.floor(Math.random() * tileCount) };
                } else {
                    snake.pop();
                }

                snake.unshift(head);

                if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount || snake.slice(1).some(segment => segment.x === head.x && segment.y === head.y)) {
                    stopSnakeGame();
                    showNotification("Game Over! Score: " + score);
                    return;
                }

                store.dispatch({ type: "UPDATE_GAME_STATE", payload: { snake, food, score } });
                elements.gameScore.textContent = `Score: ${score}`;
            };

            const gameLoop = setInterval(drawGame, 100);
            store.dispatch({ type: "UPDATE_GAME_STATE", payload: { gameLoop } });

            document.addEventListener("keydown", e => {
                if (!store.state.gameState.isPlaying) return;
                if (e.key === "ArrowRight" && direction !== "left") direction = "right";
                else if (e.key === "ArrowLeft" && direction !== "right") direction = "left";
                else if (e.key === "ArrowUp" && direction !== "down") direction = "up";
                else if (e.key === "ArrowDown" && direction !== "up") direction = "down";
                store.dispatch({ type: "UPDATE_GAME_STATE", payload: { direction } });
            });
        };

        const stopSnakeGame = () => {
            if (!store.state.gameState.isPlaying) return;
            clearInterval(store.state.gameState.gameLoop);
            store.dispatch({ type: "UPDATE_GAME_STATE", payload: { isPlaying: false, gameLoop: null } });
            const canvas = elements.gameCanvas;
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        };

        const handleReaction = e => {
            if (!checkRateLimit()) return;
            const btn = e.target.closest(".reaction-btn");
            if (!btn) return;
            const messageId = Number(btn.closest(".chat-message").dataset.messageId);
            const reaction = btn.classList.contains("thumbs-up") ? "thumbsUp" : "thumbsDown";
            store.dispatch({ type: "TOGGLE_REACTION", payload: { messageId, reaction } });
            btn.classList.toggle("reacted");
            renderMessages(elements.chatHistory, store.state.conversationHistory);
        };

        const copyCode = e => {
            const code = decodeURIComponent(e.target.dataset.code);
            navigator.clipboard.writeText(code).then(() => showNotification("Code copied!"));
        };

        const executeCode = e => {
            const code = decodeURIComponent(e.target.dataset.code);
            try {
                const result = eval(code);
                showNotification(`Code executed! Result: ${result}`);
                store.addToActivityLog("Executed code snippet");
            } catch (error) {
                showNotification(`Execution error: ${error.message}`, "error");
            }
        };

        const exportChat = () => {
            if (!checkRateLimit()) return;
            const chatText = store.state.conversationHistory.map(m => `${m.role === "user" ? store.state.userProfile.username : "Prysmis AI"} (${new Date(m.timestamp).toLocaleString()}): ${m.content}`).join("\n\n");
            const blob = new Blob([chatText], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "Prysmis_Chat_Export.txt";
            a.click();
            URL.revokeObjectURL(url);
            showNotification("Chat exported successfully!");
            store.addToActivityLog("Exported chat history");
        };

        const copyConversation = () => {
            if (!checkRateLimit()) return;
            const chatText = store.state.conversationHistory.map(m => `${m.role === "user" ? store.state.userProfile.username : "Prysmis AI"} (${new Date(m.timestamp).toLocaleString()}): ${m.content}`).join("\n\n");
            navigator.clipboard.writeText(chatText).then(() => {
                showNotification("Conversation copied to clipboard!");
                store.addToActivityLog("Copied conversation");
            });
        };

        const shareWebsite = async () => {
            if (!checkRateLimit()) return;
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: "Prysmis AI",
                        text: "Check out Prysmis AI - your ultimate AI assistant with gaming capabilities!",
                        url: window.location.href
                    });
                    showNotification("Website shared successfully!");
                    store.addToActivityLog("Shared website");
                } catch (error) {
                    showNotification("Sharing failed.", "error");
                }
            } else {
                navigator.clipboard.writeText(window.location.href).then(() => {
                    showNotification("Website URL copied to clipboard!");
                    store.addToActivityLog("Copied website URL");
                });
            }
        };

        const toggleTheme = () => {
            if (!checkRateLimit()) return;
            const newTheme = store.state.userProfile.preferences.theme === "dark" ? "light" : "dark";
            store.dispatch({
                type: "SET_STATE",
                payload: { userProfile: { ...store.state.userProfile, preferences: { ...store.state.userProfile.preferences, theme: newTheme } } }
            });
            document.body.classList.toggle("light-theme", newTheme === "light");
            elements.themeToggleBtn.innerHTML = `<i class="fas ${newTheme === "dark" ? "fa-sun" : "fa-moon"}"></i> Toggle Theme`;
            showNotification(`Theme switched to ${newTheme}!`);
            store.addToActivityLog(`Switched to ${newTheme} theme`);
        };

        const searchMessages = e => {
            const query = e.target.value.toLowerCase();
            const filteredMessages = store.state.conversationHistory.filter(m => m.content.toLowerCase().includes(query));
            renderMessages(elements.chatHistory, filteredMessages);
            store.addToActivityLog(`Searched messages for: ${query}`);
        };

        const generateMathQuestion = () => {
            const a = Math.floor(Math.random() * 10) + 1;
            const b = Math.floor(Math.random() * 10) + 1;
            return { question: `${a} + ${b} = ?`, answer: a + b };
        };

        elements.userProfileBtn.addEventListener("click", () => {
            elements.userProfileModal.classList.add("open");
            const speed = store.state.userProfile.preferences.animationSpeed === "fast" ? 0.1 : store.state.userProfile.preferences.animationSpeed === "slow" ? 0.3 : 0.15;
            gsap.fromTo(elements.userProfileModal.querySelector(".modal-content"), { scale: 0.98, opacity: 0 }, { scale: 1, opacity: 1, duration: speed, ease: "power3.out" });
            elements.usernameInput.focus();
            store.addToActivityLog("Opened user profile");
        });

        elements.userProfileClose.addEventListener("click", () => {
            elements.userProfileModal.classList.remove("open");
            store.addToActivityLog("Closed user profile");
        });

        elements.openAIKeyInput.addEventListener("change", () => {
            const key = elements.openAIKeyInput.value.trim();
            store.dispatch({
                type: "SET_STATE",
                payload: { userProfile: { ...store.state.userProfile, openAIKey: key } }
            });
            showNotification("OpenAI API Key updated!");
        });

        elements.chatLayoutSelect.addEventListener("change", () => {
            store.dispatch({
                type: "SET_STATE",
                payload: { userProfile: { ...store.state.userProfile, chatLayout: elements.chatLayoutSelect.value } }
            });
            applyChatLayout();
        });

        elements.fontSizeInput.addEventListener("input", () => {
            const fontSize = Number(elements.fontSizeInput.value);
            if (fontSize < 10 || fontSize > 22) return;
            store.dispatch({
                type: "SET_STATE",
                payload: {
                    userProfile: {
                        ...store.state.userProfile,
                        preferences: { ...store.state.userProfile.preferences, fontSize }
                    }
                }
            });
            applyChatLayout();
        });

        elements.autoScrollToggle.addEventListener("change", () => {
            store.dispatch({
                type: "SET_STATE",
                payload: {
                    userProfile: {
                        ...store.state.userProfile,
                        preferences: { ...store.state.userProfile.preferences, autoScroll: elements.autoScrollToggle.checked }
                    }
                }
            });
        });

        elements.showTimestampsToggle.addEventListener("change", () => {
            store.dispatch({
                type: "SET_STATE",
                payload: {
                    userProfile: {
                        ...store.state.userProfile,
                        preferences: { ...store.state.userProfile.preferences, showTimestamps: elements.showTimestampsToggle.checked }
                    }
                }
            });
            updateTimestampsVisibility();
        });

        elements.saveSettingsBtn.addEventListener("click", () => {
            store.dispatch({
                type: "SET_STATE",
                payload: { userProfile: { ...store.state.userProfile } }
            });
            elements.userProfileModal.classList.remove("open");
            showNotification("Settings saved successfully!");
            applyChatLayout();
            store.addToActivityLog("Saved user settings");
        });

        elements.userInput.addEventListener("input", () => {
            elements.charCounter.textContent = `${elements.userInput.value.length}/1500`;
            const now = Date.now();
            if (now - store.state.lastTypingUpdate > 300) {
                store.dispatch({ type: "UPDATE_TYPING", payload: now });
                gsap.to(elements.userInput, { borderColor: "#3b82f6", duration: 0.15 });
            }
        });

        elements.sendBtn.addEventListener("click", debouncedSendMessage);

        elements.userInput.addEventListener("keypress", e => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                debouncedSendMessage();
            }
        });

        elements.rephraseBtn.addEventListener("click", rephraseMessage);

        elements.fileInput.addEventListener("change", handleFileUpload);

        elements.fileClearBtn.addEventListener("click", clearFiles);

        elements.fileList.addEventListener("click", e => {
            const btn = e.target.closest(".remove-file-btn");
            if (!btn) return;
            const fileId = btn.closest(".file-item").dataset.fileId;
            const updatedFiles = store.state.filesArray.filter(file => file.id !== Number(fileId));
            store.dispatch({ type: "SET_FILES", payload: updatedFiles });
            renderFileList();
            elements.fileClearBtn.classList.toggle("hidden", store.state.filesArray.length === 0);
            showNotification("File removed.");
        });

        elements.toggleActionsBtn.addEventListener("click", toggleFileActions);

        elements.voiceInputBtn.addEventListener("click", handleVoiceInput);

        elements.grantPermissionBtn.addEventListener("click", () => {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(() => {
                elements.permissionModal.classList.remove("open");
                startVoiceRecognition();
                showNotification("Microphone access granted.");
                store.addToActivityLog("Granted microphone access");
            }).catch(err => {
                showNotification("Failed to access microphone.", "error");
                elements.permissionModal.classList.remove("open");
            });
        });

        elements.denyPermissionBtn.addEventListener("click", () => {
            elements.permissionModal.classList.remove("open");
            showNotification("Microphone access denied.", "error");
            store.addToActivityLog("Denied microphone access");
        });

        elements.permissionModalClose.addEventListener("click", () => {
            elements.permissionModal.classList.remove("open");
            showNotification("Microphone access denied.", "error");
            store.addToActivityLog("Closed permission modal");
        });

        elements.chatHistory.addEventListener("click", e => {
            if (e.target.closest(".reaction-btn")) handleReaction(e);
            if (e.target.closest(".copy-code-btn")) copyCode(e);
            if (e.target.closest(".execute-code-btn")) executeCode(e);
        });

        elements.menuBtn.addEventListener("click", toggleSidebar);

        elements.sidebarClose.addEventListener("click", toggleSidebar);

        elements.gameBtn.addEventListener("click", toggleGameSidebar);

        elements.gameSidebarClose.addEventListener("click", toggleGameSidebar);

        elements.startGameBtn.addEventListener("click", startSnakeGame);

        elements.stopGameBtn.addEventListener("click", stopSnakeGame);

        elements.clearChatBtn.addEventListener("click", () => {
            elements.confirmClearModal.classList.add("open");
            const speed = store.state.userProfile.preferences.animationSpeed === "fast" ? 0.1 : store.state.userProfile.preferences.animationSpeed === "slow" ? 0.3 : 0.15;
            gsap.fromTo(elements.confirmClearModal.querySelector(".modal-content"), { scale: 0.98, opacity: 0 }, { scale: 1, opacity: 1, duration: speed, ease: "power3.out" });
            elements.confirmClearBtn.focus();
            store.addToActivityLog("Opened clear chat confirmation");
        });

        elements.confirmClearBtn.addEventListener("click", () => {
            store.dispatch({ type: "CLEAR_CHAT" });
            elements.confirmClearModal.classList.remove("open");
            renderMessages(elements.chatHistory, store.state.conversationHistory);
            renderRecentMessages();
            renderActivityLog();
            showNotification("Chat cleared successfully!");
        });

        elements.cancelClearBtn.addEventListener("click", () => {
            elements.confirmClearModal.classList.remove("open");
            store.addToActivityLog("Cancelled clear chat");
        });

        elements.confirmClearModalClose.addEventListener("click", () => {
            elements.confirmClearModal.classList.remove("open");
            store.addToActivityLog("Closed clear chat modal");
        });

        elements.exportChatBtn.addEventListener("click", exportChat);

        elements.copyConversationBtn.addEventListener("click", copyConversation);

        elements.shareWebsiteBtn.addEventListener("click", shareWebsite);

        elements.feedbackBtn.addEventListener("click", () => {
            elements.feedbackModal.classList.add("open");
            const speed = store.state.userProfile.preferences.animationSpeed === "fast" ? 0.1 : store.state.userProfile.preferences.animationSpeed === "slow" ? 0.3 : 0.15;
            gsap.fromTo(elements.feedbackModal.querySelector(".modal-content"), { scale: 0.98, opacity: 0 }, { scale: 1, opacity: 1, duration: speed, ease: "power3.out" });
            elements.feedbackInput.focus();
            store.addToActivityLog("Opened feedback modal");
        });

        elements.feedbackSubmitBtn.addEventListener("click", () => {
            const feedback = elements.feedbackInput.value.trim();
            if (!feedback) return showNotification("Please enter your feedback.", "error");
            console.log("Feedback submitted:", feedback);
            elements.feedbackModal.classList.remove("open");
            elements.feedbackInput.value = "";
            showNotification("Feedback submitted! Thank you!");
            store.addToActivityLog("Submitted feedback");
        });

        elements.feedbackModalClose.addEventListener("click", () => {
            elements.feedbackModal.classList.remove("open");
            store.addToActivityLog("Closed feedback modal");
        });

        elements.prysmisUpdatesBtn.addEventListener("click", () => {
            window.open("https://prysmis.ai/updates", "_blank");
            store.addToActivityLog("Clicked Prysmis updates");
        });

        elements.discordBtn.addEventListener("click", () => {
            window.open("https://discord.gg/prysmis", "_blank");
            store.addToActivityLog("Clicked Discord link");
        });

        elements.premiumBtn.addEventListener("click", () => {
            window.open("https://prysmis.ai/premium", "_blank");
            store.addToActivityLog("Clicked Premium link");
        });

        elements.themeToggleBtn.addEventListener("click", toggleTheme);

        elements.quickActions.addEventListener("click", handleQuickAction);

        elements.searchMessagesInput.addEventListener("input", searchMessages);

        window.addEventListener("online", checkOnlineStatus);
        window.addEventListener("offline", checkOnlineStatus);
        window.addEventListener("resize", applyChatLayout);

        const initChat = async () => {
            await store.loadState();
            elements.usernameInput.value = store.state.userProfile.username;
            elements.openAIKeyInput.value = store.state.userProfile.openAIKey;
            elements.chatLayoutSelect.value = store.state.userProfile.chatLayout;
            elements.fontSizeInput.value = store.state.userProfile.preferences.fontSize;
            elements.autoScrollToggle.checked = store.state.userProfile.preferences.autoScroll;
            elements.showTimestampsToggle.checked = store.state.userProfile.preferences.showTimestamps;
            document.body.classList.toggle("light-theme", store.state.userProfile.preferences.theme === "light");
            elements.themeToggleBtn.innerHTML = `<i class="fas ${store.state.userProfile.preferences.theme === "dark" ? "fa-sun" : "fa-moon"}"></i> Toggle Theme`;
            renderMessages(elements.chatHistory, store.state.conversationHistory);
            renderRecentMessages();
            renderActivityLog();
            applyChatLayout();
            checkOnlineStatus();
        };

        const initPreloader = () => {
            store.state.captcha = generateMathQuestion();
            elements.captchaInput.placeholder = store.state.captcha.question;
            setTimeout(() => {
                elements.preloaderInput.classList.add("open");
                elements.captchaInput.focus();
            }, 500);
        };

        elements.submitBtn.addEventListener("click", () => {
            const userAnswer = Number(elements.captchaInput.value.trim());
            if (userAnswer === store.state.captcha.answer) {
                store.dispatch({ type: "SET_STATE", payload: { isCaptchaVerified: true } });
                elements.preloader.style.display = "none";
                initChat();
            } else {
                showNotification("Incorrect answer. Try again!", "error");
                elements.captchaInput.value = "";
                store.state.captcha = generateMathQuestion();
                elements.captchaInput.placeholder = store.state.captcha.question;
            }
        });

        if (!store.state.isCaptchaVerified) {
            initPreloader();
        } else {
            elements.preloader.style.display = "none";
            initChat();
        }

        window.addEventListener("load", () => {
            if (!store.state.isCaptchaVerified) {
                initPreloader();
            } else {
                elements.preloader.style.display = "none";
                initChat();
            }
        });
    </script>
</body>
</html>
            
