<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: blob: https://*.pixabay.com https://*.googleapis.com; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; connect-src 'self'; frame-src 'none'; media-src 'self' data: blob: https://*.pixabay.com; worker-src blob:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="VerbiFlow - Ultra-fast AI companion for creativity, coding, analytics, and more.">
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains; preload">
    <meta http-equiv="Referrer-Policy" content="no-referrer">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(self), camera=(self)">
    <title>VerbiFlow</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" media="print" onload="this.media='all'">
    <style>
        :root {
            --primary-color: #6b48ff;
            --secondary-color: #f1f3f5;
            --text-color: #1a1a1a;
            --bg-color: #f7f9fc;
            --ai-bg: #e9ecef;
            --user-bg: #d1e7ff;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
            --border-radius: 12px;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-blur: blur(12px);
            --highlight: #ffd700;
            --error: #ff4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--bg-color), #e0e7ff);
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
            transition: var(--transition);
        }

        body.dark-mode {
            --primary-color: #a78bfa;
            --secondary-color: #2d2d2d;
            --text-color: #e0e0e0;
            --bg-color: #1a1a1a;
            --ai-bg: #333;
            --user-bg: #4a6fa5;
            --glass-bg: rgba(0, 0, 0, 0.4);
            background: linear-gradient(135deg, var(--bg-color), #2a2a2a);
        }

        body.custom-theme {
            --primary-color: var(--custom-primary, #6b48ff);
            --secondary-color: var(--custom-secondary, #f1f3f5);
            --text-color: var(--custom-text, #1a1a1a);
            --bg-color: var(--custom-bg, #f7f9fc);
            --ai-bg: var(--custom-ai-bg, #e9ecef);
            --user-bg: var(--custom-user-bg, #d1e7ff);
            background: linear-gradient(135deg, var(--bg-color), var(--custom-gradient, #e0e7ff));
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .preloader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 18px;
            font-weight: 500;
            color: var(--text-color);
            opacity: 0;
            transition: opacity 0.5s ease;
            text-align: center;
            max-width: 500px;
        }

        .loading-text.visible {
            opacity: 1;
        }

        .api-key-container {
            margin-top: 30px;
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 450px;
            background: var(--secondary-color);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .api-key-container.visible {
            display: flex;
        }

        .api-key-input {
            padding: 12px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            font-size: 16px;
            background: var(--bg-color);
            color: var(--text-color);
            transition: border-color 0.3s ease;
        }

        .api-key-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(107, 72, 255, 0.2);
        }

        .api-key-submit {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
        }

        .api-key-submit:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow);
        }

        .nav-bar {
            position: relative;
            z-index: 1000;
        }

        .menu-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
        }

        .menu-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow);
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -350px;
            width: 350px;
            height: 100%;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            transition: left 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 999;
            overflow-y: auto;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-close {
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .sidebar-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 14px;
            background: var(--secondary-color);
            border: none;
            border-radius: var(--border-radius);
            color: var(--text-color);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 10px;
            transition: var(--transition);
        }

        .sidebar-btn:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }

        .theme-customizer {
            margin-top: 20px;
            padding: 15px;
            background: var(--secondary-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .theme-customizer label {
            display: block;
            margin: 8px 0;
            font-size: 14px;
            font-weight: 500;
        }

        .theme-customizer input[type="color"] {
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .theme-preview {
            width: 100%;
            height: 60px;
            margin-top: 10px;
            border-radius: var(--border-radius);
            background: linear-gradient(135deg, var(--custom-bg, #f7f9fc), var(--custom-gradient, #e0e7ff));
            transition: var(--transition);
        }

        .header {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .logo {
            font-size: 36px;
            font-weight: 800;
            color: var(--primary-color);
            letter-spacing: 1px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .message-counter {
            font-size: 14px;
            color: #888;
            text-align: right;
            margin-bottom: 10px;
        }

        .chat-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            background: var(--secondary-color);
            padding: 10px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .pagination-btn, .search-btn, .export-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
        }

        .pagination-btn:hover, .search-btn:hover, .export-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow);
        }

        .pagination-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .search-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            width: 250px;
            font-size: 14px;
            background: var(--bg-color);
            color: var(--text-color);
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(107, 72, 255, 0.2);
        }

        .chat-area {
            max-height: 65vh;
            overflow-y: auto;
            padding: 25px;
            border-radius: var(--border-radius);
            background: var(--secondary-color);
            box-shadow: var(--shadow);
            position: relative;
            scroll-behavior: smooth;
        }

        .chat-message {
            display: flex;
            flex-direction: column;
            margin-bottom: 25px;
            animation: fadeIn 0.5s ease;
            opacity: 0;
            transition: opacity 0.5s ease, transform 0.3s ease;
        }

        .chat-message.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .chat-message.ai .chat-message-content {
            background: var(--ai-bg);
            align-self: flex-start;
        }

        .chat-message.user .chat-message-content {
            background: var(--user-bg);
            align-self: flex-end;
        }

        .chat-message.pinned .chat-message-content {
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 10px rgba(107, 72, 255, 0.3);
        }

        .chat-message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            font-size: 16px;
            line-height: 1.6;
            position: relative;
            transition: var(--transition);
        }

        .chat-message-content:hover {
            transform: scale(1.02);
        }

        .chat-message-meta {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-message-actions {
            display: flex;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .chat-message:hover .chat-message-actions {
            opacity: 1;
        }

        .copy-message-btn, .edit-message-btn, .react-message-btn, .pin-message-btn, .thread-message-btn {
            background: transparent;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: var(--transition);
        }

        .copy-message-btn:hover, .edit-message-btn:hover, .react-message-btn:hover, .pin-message-btn:hover, .thread-message-btn:hover {
            color: #ff6b6b;
            transform: scale(1.1);
        }

        .reaction-emoji {
            font-size: 14px;
            margin-left: 5px;
            animation: pop 0.3s ease;
        }

        @keyframes pop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .threaded-message {
            margin-left: 30px;
            border-left: 3px solid var(--primary-color);
            padding-left: 15px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 5px;
        }

        .typing-indicator {
            display: none;
            font-style: italic;
            color: #888;
            margin: 15px 0;
        }

        .typing-indicator span {
            animation: blink 1s infinite;
            animation-delay: calc(0.2s * var(--i));
        }

        .typing-animation {
            display: inline-block;
            white-space: pre-wrap;
        }

        .response-spinner {
            display: none;
            margin: 15px 0;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-left: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .file-actions-container {
            margin: 20px 0;
            transition: var(--transition);
        }

        .file-actions-container.collapsed {
            height: 0;
            overflow: hidden;
        }

        .file-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            background: var(--secondary-color);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .file-input-label {
            background: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
        }

        .file-input-label:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow);
        }

        .file-input {
            display: none;
        }

        .file-clear-btn, .generate-media-btn, .voice-search-btn, .keep-generating-btn, .rephrase-btn, .stop-generating-btn, .feedback-btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            background: var(--secondary-color);
            color: var(--text-color);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
        }

        .file-clear-btn:hover, .generate-media-btn:hover, .voice-search-btn:hover, .keep-generating-btn:hover, .rephrase-btn:hover, .stop-generating-btn:hover, .feedback-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow);
        }

        .school-help-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .school-help-dropdown, .ai-model-dropdown, .language-dropdown {
            padding: 12px;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .school-help-dropdown:focus, .ai-model-dropdown:focus, .language-dropdown:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .file-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .file-item {
            background: var(--secondary-color);
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-item:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow);
        }

        .file-item-name {
            font-size: 14px;
            font-weight: 500;
        }

        .file-item-details {
            font-size: 12px;
            color: #888;
        }

        .toggle-actions-btn {
            display: block;
            margin: 10px auto;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
        }

        .toggle-actions-btn.collapsed {
            transform: rotate(180deg);
        }

        .input-container {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .user-input {
            flex: 1;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            resize: none;
            font-size: 16px;
            background: var(--secondary-color);
            color: var(--text-color);
            transition: border-color 0.3s ease;
        }

        .user-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(107, 72, 255, 0.2);
        }

        .send-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow);
        }

        .file-preview-modal, .edit-message-modal, .search-modal, .user-profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .file-preview-modal.open, .edit-message-modal.open, .search-modal.open, .user-profile-modal.open {
            display: flex;
        }

        .file-preview-content, .edit-message-content, .search-modal-content, .user-profile-content {
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            background: var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 25px;
            position: relative;
            box-shadow: var(--shadow);
        }

        .file-preview-content img {
            max-width: 100%;
            height: auto;
            transition: transform 0.3s ease;
            border-radius: 5px;
        }

        .zoom-controls {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            gap: 10px;
        }

        .zoom-in, .zoom-out {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }

        .zoom-in:hover, .zoom-out:hover {
            transform: scale(1.1);
        }

        .file-preview-close, .edit-message-close, .search-modal-close, .user-profile-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
        }

        .edit-message-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            font-size: 16px;
            background: var(--bg-color);
            color: var(--text-color);
        }

        .save-edit-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .search-modal-content {
            text-align: center;
        }

        .search-modal-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            background: var(--bg-color);
            color: var(--text-color);
        }

        .search-results {
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .search-result-item {
            padding: 12px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .search-result-item:hover {
            background: var(--ai-bg);
        }

        .highlight {
            background: var(--highlight);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .user-profile-content {
            text-align: center;
        }

        .user-profile-content label {
            display: block;
            margin: 15px 0 5px;
            font-size: 14px;
            font-weight: 500;
        }

        .user-profile-content input, .user-profile-content select {
            padding: 10px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 14px;
            background: var(--bg-color);
            color: var(--text-color);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 30px;
            background: var(--primary-color);
            color: white;
            border-radius: var(--border-radius);
            opacity: 0;
            transition: opacity 0.5s ease, transform 0.5s ease;
            z-index: 1000;
            font-size: 14px;
            font-weight: 500;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.error {
            background: var(--error);
        }

        .permission-modal, .feedback-modal, .confirm-clear-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .permission-modal.open, .feedback-modal.open, .confirm-clear-modal.open {
            display: flex;
        }

        .permission-content, .feedback-content, .confirm-clear-content {
            background: var(--secondary-color);
            padding: 25px;
            border-radius: var(--border-radius);
            max-width: 550px;
            width: 90%;
            text-align: center;
            animation: fadeIn 0.5s ease;
            box-shadow: var(--shadow);
        }

        .permission-content h2, .feedback-content h2, .confirm-clear-content h2 {
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 600;
        }

        .permission-btn, .feedback-submit-btn, .confirm-clear-btn, .cancel-clear-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            cursor: pointer;
            margin: 10px;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
        }

        .permission-btn:hover, .feedback-submit-btn:hover, .confirm-clear-btn:hover, .cancel-clear-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow);
        }

        .permission-btn.deny, .cancel-clear-btn {
            background: var(--error);
        }

        #feedbackInput {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            resize: none;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
        }

        .back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            transition: var(--transition);
            z-index: 999;
        }

        .back-to-top.visible {
            display: block;
        }

        @media (max-width: 768px) {
            body.mobile {
                .container {
                    padding: 10px;
                }

                .menu-btn {
                    padding: 14px 28px;
                    font-size: 18px;
                }

                .sidebar {
                    width: 100%;
                    left: -100%;
                }

                .chat-message-content {
                    max-width: 90%;
                    font-size: 14px;
                }

                .chat-area {
                    max-height: 50vh;
                    padding: 15px;
                }

                .file-actions {
                    flex-direction: column;
                }

                .chat-controls {
                    flex-direction: column;
                    gap: 10px;
                }

                .search-input {
                    width: 100%;
                }

                .input-container {
                    flex-direction: column;
                }

                .user-input {
                    font-size: 16px;
                    padding: 15px;
                }

                .send-btn {
                    padding: 15px;
                    font-size: 16px;
                    width: 100%;
                }

                .toggle-actions-btn {
                    padding: 12px;
                }
            }
        }

        @media (min-width: 769px) {
            body.desktop, body.chromebook {
                .container {
                    padding: 30px;
                }

                .sidebar {
                    left: 0;
                    width: 300px;
                }

                .menu-btn {
                    display: none;
                }

                .chat-area {
                    margin-left: 320px;
                    max-height: 70vh;
                }

                .chat-message-content {
                    font-size: 16px;
                }

                .input-container {
                    margin-left: 320px;
                }

                .file-actions-container {
                    margin-left: 320px;
                }
            }

            body.chromebook {
                .chat-area {
                    padding: 25px;
                }

                .sidebar {
                    width: 250px;
                }

                .chat-message-content {
                    max-width: 80%;
                }
            }
        }
    </style>
</head>
<body>
    <div class="preloader" id="preloader">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText"></div>
        <div class="api-key-container" id="apiKeyContainer">
            <input type="text" class="api-key-input" id="apiKeyInput" placeholder="Enter your OpenAI API key..." aria-label="OpenAI API key input">
            <button class="api-key-submit" id="apiKeySubmit" aria-label="Submit API key">Submit</button>
        </div>
    </div>
    <div class="container">
        <div class="nav-bar">
            <button class="menu-btn" id="menuBtn" aria-label="Open menu"><i class="fas fa-bars"></i> Menu</button>
            <div class="sidebar" id="sidebar">
                <button class="sidebar-close" id="sidebarClose" aria-label="Close menu"><i class="fas fa-times"></i> Close</button>
                <button class="sidebar-btn" id="clearChatBtn" aria-label="Clear chat"><i class="fas fa-trash-alt"></i> Clear Chat</button>
                <button class="sidebar-btn" id="verbiflowUpdatesBtn" aria-label="View updates"><i class="fas fa-bell"></i> Updates</button>
                <button class="sidebar-btn" id="premiumPriceBtn" aria-label="Premium price"><i class="fas fa-star"></i> Premium Price</button>
                <button class="sidebar-btn" id="shareChatBtn" aria-label="Share chat"><i class="fas fa-share-alt"></i> Share Chat</button>
                <button class="sidebar-btn" id="shareWebsiteBtn" aria-label="Share website"><i class="fas fa-link"></i> Share Website</button>
                <button class="sidebar-btn theme-btn" id="themeBtn" aria-label="Toggle dark mode"><i class="fas fa-moon"></i> Dark Mode</button>
                <button class="sidebar-btn" id="copyCodeBtn" aria-label="Copy code"><i class="fas fa-code"></i> Copy Code</button>
                <button class="sidebar-btn discord-btn" id="discordBtn" aria-label="Join Discord"><i class="fab fa-discord"></i> Discord</button>
                <button class="sidebar-btn" id="userProfileBtn" aria-label="User profile"><i class="fas fa-user"></i> Profile</button>
                <div class="theme-customizer">
                    <label for="primaryColor">Primary Color</label>
                    <input type="color" id="primaryColor" value="#6b48ff" aria-label="Primary color picker">
                    <label for="secondaryColor">Secondary Color</label>
                    <input type="color" id="secondaryColor" value="#f1f3f5" aria-label="Secondary color picker">
                    <label for="textColor">Text Color</label>
                    <input type="color" id="textColor" value="#1a1a1a" aria-label="Text color picker">
                    <label for="bgColor">Background Color</label>
                    <input type="color" id="bgColor" value="#f7f9fc" aria-label="Background color picker">
                    <label for="aiBgColor">AI Background</label>
                    <input type="color" id="aiBgColor" value="#e9ecef" aria-label="AI background color picker">
                    <label for="userBgColor">User Background</label>
                    <input type="color" id="userBgColor" value="#d1e7ff" aria-label="User background color picker">
                    <label for="gradientColor">Gradient Color</label>
                    <input type="color" id="gradientColor" value="#e0e7ff" aria-label="Gradient color picker">
                    <div class="theme-preview" id="themePreview"></div>
                </div>
            </div>
        </div>
        <header class="header">
            <div class="logo" role="img" aria-label="VerbiFlow Logo">VerbiFlow</div>
        </header>
        <main class="chat-area" id="chatArea">
            <div class="message-counter" id="messageCounter">Messages: 1</div>
            <div class="chat-controls">
                <div>
                    <button class="pagination-btn" id="prevPageBtn" aria-label="Previous page">Prev</button>
                    <button class="pagination-btn" id="nextPageBtn" aria-label="Next page">Next</button>
                </div>
                <div>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search messages..." aria-label="Search messages">
                    <button class="search-btn" id="searchBtn" aria-label="Search messages">Search</button>
                </div>
                <button class="export-btn" id="exportChatBtn" aria-label="Export chat">Export Chat</button>
            </div>
            <div class="chat-content">
                <div class="chat-history" id="chatHistory">
                    <div class="chat-message ai visible">
                        <div class="chat-message-content">Hey there, I’m VerbiFlow—your ultra-fast AI companion for creativity, coding, analytics, and more! What’s on your mind?</div>
                        <div class="chat-message-meta">
                            <span>Just now</span>
                            <div class="chat-message-actions">
                                <button class="copy-message-btn" aria-label="Copy message"><i class="fas fa-copy"></i> Copy</button>
                                <button class="edit-message-btn" style="display:none;" aria-label="Edit message"><i class="fas fa-edit"></i> Edit</button>
                                <button class="react-message-btn" aria-label="React to message"><i class="fas fa-heart"></i> React</button>
                                <button class="pin-message-btn" aria-label="Pin message"><i class="fas fa-thumbtack"></i> Pin</button>
                                <button class="thread-message-btn" aria-label="Start thread"><i class="fas fa-comment"></i> Thread</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="typing-indicator" id="typingIndicator">
                    VerbiFlow is thinking<span style="--i: 1">.</span><span style="--i: 2">.</span><span style="--i: 3">.</span>
                </div>
                <div class="response-spinner" id="responseSpinner"></div>
            </div>
        </main>
        <div class="file-actions-container" id="fileActionsContainer">
            <div class="file-actions">
                <label class="file-input-label" for="fileInput" aria-label="Upload file">Upload File</label>
                <input type="file" class="file-input" id="fileInput" multiple accept="image/*,video/*,text/*,application/json,application/xml">
                <button class="file-clear-btn" id="fileClearBtn" style="display:none;" aria-label="Clear files">Clear</button>
                <button class="generate-media-btn" id="generateMediaBtn" aria-label="Generate media">Generate Media</button>
                <button class="voice-search-btn" id="voiceSearchBtn" aria-label="Voice search">Voice Search</button>
                <button class="keep-generating-btn" id="keepGeneratingBtn" aria-label="Continue generating">Continue Generating</button>
                <div class="school-help-container">
                    <select class="school-help-dropdown" id="schoolHelpDropdown" aria-label="Select task">
                        <option value="">Select Task</option>
                        <option value="algebra">Algebra Help</option>
                        <option value="science">Science Help</option>
                        <option value="geometry">Geometry Help</option>
                        <option value="history">History Help</option>
                        <option value="literature">Literature Help</option>
                        <option value="physics">Physics Help</option>
                        <option value="chemistry">Chemistry Help</option>
                        <option value="biology">Biology Help</option>
                        <option value="robloxGame">Roblox Game</option>
                        <option value="googleSlides">Google Slides</option>
                        <option value="videoAnalysis">Video Analysis</option>
                        <option value="robloxScripting">Roblox Scripting</option>
                        <option value="contentGeneration">Content Generation</option>
                        <option value="discordBot">Discord Bot (Helper)</option>
                    </select>
                    <select class="ai-model-dropdown" id="aiModelDropdown" aria-label="Select AI model">
                        <option value="default">VerbiFlow (Default)</option>
                        <option value="lingoLogicAI">LingoLogicAI</option>
                        <option value="codeMasterAI">CodeMasterAI</option>
                        <option value="visualGeniusAI">VisualGeniusAI</option>
                        <option value="betterGrok">Better Grok</option>
                        <option value="helper">Helper</option>
                        <option value="kultumGPT">KultumGPT</option>
                    </select>
                    <select class="language-dropdown" id="languageDropdown" aria-label="Select language">
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="zh">Chinese</option>
                    </select>
                    <button class="rephrase-btn" id="rephraseBtn" aria-label="Rephrase">Rephrase</button>
                    <button class="stop-generating-btn" id="stopGeneratingBtn" style="display:none;" aria-label="Stop generating">Stop Generating</button>
                    <button class="feedback-btn" id="feedbackBtn" aria-label="Provide feedback">Feedback</button>
                </div>
            </div>
            <div class="file-list" id="fileList"></div>
        </div>
        <button class="toggle-actions-btn" id="toggleActionsBtn" aria-label="Toggle file actions">^</button>
        <div class="input-container" id="inputContainer">
            <textarea class="user-input" id="userInput" placeholder="Ask anything, generate content, or use voice commands..." rows="1" aria-label="User input"></textarea>
            <button class="send-btn" id="sendBtn" aria-label="Send message">Send</button>
        </div>
        <div class="file-preview-modal" id="filePreviewModal">
            <button class="file-preview-close" id="filePreviewClose" aria-label="Close preview">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <div class="file-preview-content" id="filePreviewContent"></div>
            <div class="zoom-controls" id="zoomControls">
                <button class="zoom-in" id="zoomIn" aria-label="Zoom in">+</button>
                <button class="zoom-out" id="zoomOut" aria-label="Zoom out">-</button>
            </div>
        </div>
        <div class="edit-message-modal" id="editMessageModal">
            <button class="edit-message-close" id="editMessageClose" aria-label="Close edit modal">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <div class="edit-message-content">
                <textarea class="edit-message-input" id="editMessageInput" aria-label="Edit message"></textarea>
                <button class="save-edit-btn" id="saveEditBtn" aria-label="Save edit">Save</button>
            </div>
        </div>
        <div class="search-modal" id="searchModal">
            <button class="search-modal-close" id="searchModalClose" aria-label="Close search modal">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <div class="search-modal-content">
                <h2>Search Messages</h2>
                <input type="text" class="search-modal-input" id="searchModalInput" placeholder="Search (supports regex)..." aria-label="Search messages">
                <div class="search-results" id="searchResults"></div>
            </div>
        </div>
        <div class="user-profile-modal" id="userProfileModal">
            <button class="user-profile-close" id="userProfileClose" aria-label="Close profile modal">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <div class="user-profile-content">
                <h2>User Profile</h2>
                <label for="usernameInput">Username</label>
                <input type="text" id="usernameInput" placeholder="Enter username" aria-label="Username">
                <label for="chatLayoutSelect">Chat Layout</label>
                <select id="chatLayoutSelect" aria-label="Chat layout">
                    <option value="default">Default</option>
                    <option value="compact">Compact</option>
                    <option value="spacious">Spacious</option>
                </select>
            </div>
        </div>
        <div class="notification" id="notification" role="alert"></div>
        <div class="permission-modal" id="permissionModal">
            <div class="permission-content">
                <h2>Request Permissions</h2>
                <p>VerbiFlow needs access to enable features like voice commands, media analysis, and more. Do you grant permission?</p>
                <button class="permission-btn" id="grantPermissionBtn" aria-label="Grant permission">Grant</button>
                <button class="permission-btn deny" id="denyPermissionBtn" aria-label="Deny permission">Deny</button>
            </div>
        </div>
        <div class="feedback-modal" id="feedbackModal">
            <div class="feedback-content">
                <h2>Provide Feedback</h2>
                <textarea id="feedbackInput" placeholder="Share your feedback to improve VerbiFlow..." aria-label="Feedback input"></textarea>
                <button class="feedback-submit-btn" id="feedbackSubmitBtn" aria-label="Submit feedback">Submit</button>
            </div>
        </div>
        <div class="confirm-clear-modal" id="confirmClearModal">
            <div class="confirm-clear-content">
                <h2>Clear Conversation</h2>
                <p>Are you sure you want to clear the conversation? This action cannot be undone.</p>
                <button class="confirm-clear-btn" id="confirmClearBtn" aria-label="Confirm clear">Yes, Clear</button>
                <button class="cancel-clear-btn" id="cancelClearBtn" aria-label="Cancel clear">Cancel</button>
            </div>
        </div>
        <button class="back-to-top" id="backToTopBtn" aria-label="Back to top"><i class="fas fa-arrow-up"></i></button>
    </div>
    <script>
        const DISCORD_INVITE = "https://discord.gg/rCTRQvD4TP";
        const WEBSITE_URL = "https://verbiflow.site";
        const FEEDBACK_EMAIL = "asdwwas233@gmail.com";

        const elements = {
            preloader: document.getElementById('preloader'),
            loadingText: document.getElementById('loadingText'),
            apiKeyContainer: document.getElementById('apiKeyContainer'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            apiKeySubmit: document.getElementById('apiKeySubmit'),
            chatHistory: document.getElementById('chatHistory'),
            userInput: document.getElementById('userInput'),
            sendBtn: document.getElementById('sendBtn'),
            fileInput: document.getElementById('fileInput'),
            fileList: document.getElementById('fileList'),
            fileClearBtn: document.getElementById('fileClearBtn'),
            fileActionsContainer: document.getElementById('fileActionsContainer'),
            filePreviewModal: document.getElementById('filePreviewModal'),
            filePreviewContent: document.getElementById('filePreviewContent'),
            filePreviewClose: document.getElementById('filePreviewClose'),
            zoomIn: document.getElementById('zoomIn'),
            zoomOut: document.getElementById('zoomOut'),
            zoomControls: document.getElementById('zoomControls'),
            typingIndicator: document.getElementById('typingIndicator'),
            responseSpinner: document.getElementById('responseSpinner'),
            chatArea: document.getElementById('chatArea'),
            menuBtn: document.getElementById('menuBtn'),
            sidebar: document.getElementById('sidebar'),
            sidebarClose: document.getElementById('sidebarClose'),
            clearChatBtn: document.getElementById('clearChatBtn'),
            copyCodeBtn: document.getElementById('copyCodeBtn'),
            discordBtn: document.getElementById('discordBtn'),
            verbiflowUpdatesBtn: document.getElementById('verbiflowUpdatesBtn'),
            premiumPriceBtn: document.getElementById('premiumPriceBtn'),
            shareChatBtn: document.getElementById('shareChatBtn'),
            shareWebsiteBtn: document.getElementById('shareWebsiteBtn'),
            themeBtn: document.getElementById('themeBtn'),
            userProfileBtn: document.getElementById('userProfileBtn'),
            notification: document.getElementById('notification'),
            toggleActionsBtn: document.getElementById('toggleActionsBtn'),
            generateMediaBtn: document.getElementById('generateMediaBtn'),
            voiceSearchBtn: document.getElementById('voiceSearchBtn'),
            schoolHelpDropdown: document.getElementById('schoolHelpDropdown'),
            aiModelDropdown: document.getElementById('aiModelDropdown'),
            languageDropdown: document.getElementById('languageDropdown'),
            rephraseBtn: document.getElementById('rephraseBtn'),
            stopGeneratingBtn: document.getElementById('stopGeneratingBtn'),
            feedbackBtn: document.getElementById('feedbackBtn'),
            feedbackModal: document.getElementById('feedbackModal'),
            feedbackInput: document.getElementById('feedbackInput'),
            feedbackSubmitBtn: document.getElementById('feedbackSubmitBtn'),
            permissionModal: document.getElementById('permissionModal'),
            grantPermissionBtn: document.getElementById('grantPermissionBtn'),
            denyPermissionBtn: document.getElementById('denyPermissionBtn'),
            backToTopBtn: document.getElementById('backToTopBtn'),
            messageCounter: document.getElementById('messageCounter'),
            confirmClearModal: document.getElementById('confirmClearModal'),
            confirmClearBtn: document.getElementById('confirmClearBtn'),
            cancelClearBtn: document.getElementById('cancelClearBtn'),
            primaryColor: document.getElementById('primaryColor'),
            secondaryColor: document.getElementById('secondaryColor'),
            textColor: document.getElementById('textColor'),
            bgColor: document.getElementById('bgColor'),
            aiBgColor: document.getElementById('aiBgColor'),
            userBgColor: document.getElementById('userBgColor'),
            gradientColor: document.getElementById('gradientColor'),
            themePreview: document.getElementById('themePreview'),
            prevPageBtn: document.getElementById('prevPageBtn'),
            nextPageBtn: document.getElementById('nextPageBtn'),
            searchInput: document.getElementById('searchInput'),
            searchBtn: document.getElementById('searchBtn'),
            exportChatBtn: document.getElementById('exportChatBtn'),
            editMessageModal: document.getElementById('editMessageModal'),
            editMessageInput: document.getElementById('editMessageInput'),
            saveEditBtn: document.getElementById('saveEditBtn'),
            editMessageClose: document.getElementById('editMessageClose'),
            searchModal: document.getElementById('searchModal'),
            searchModalInput: document.getElementById('searchModalInput'),
            searchResults: document.getElementById('searchResults'),
            searchModalClose: document.getElementById('searchModalClose'),
            userProfileModal: document.getElementById('userProfileModal'),
            userProfileClose: document.getElementById('userProfileClose'),
            usernameInput: document.getElementById('usernameInput'),
            chatLayoutSelect: document.getElementById('chatLayoutSelect')
        };

        const initialState = {
            filesArray: [],
            conversationHistory: [],
            threads: {},
            latestCodeBlocks: [],
            isDarkMode: false,
            isGenerating: false,
            lastAction: 0,
            messageCount: 1,
            zoomLevel: 1,
            currentPage: 1,
            messagesPerPage: 15,
            userProfile: { username: 'User', chatLayout: 'default', preferences: { fontSize: 16, autoScroll: true } },
            rateLimit: { interval: 400 },
            notificationQueue: [],
            messageDrafts: {},
            pinnedMessages: new Set(),
            deviceType: 'unknown',
            apiKey: null,
            isApiKeyValid: false,
            selectedModel: 'default',
            selectedLanguage: 'en',
            selectedTask: '',
            typingSpeed: 30,
            searchHistory: [],
            userStats: { messagesSent: 0, reactionsAdded: 0, threadsCreated: 0 }
        };

        const reducer = (state, action) => {
            switch (action.type) {
                case 'SET_STATE':
                    return { ...state, ...action.payload };
                case 'ADD_MESSAGE':
                    return {
                        ...state,
                        conversationHistory: [...state.conversationHistory, action.payload],
                        messageCount: state.messageCount + 1,
                        userStats: { ...state.userStats, messagesSent: state.userStats.messagesSent + (action.payload.role === 'user' ? 1 : 0) }
                    };
                case 'UPDATE_MESSAGE':
                    return {
                        ...state,
                        conversationHistory: state.conversationHistory.map(msg =>
                            msg.id === action.payload.id ? { ...msg, ...action.payload } : msg
                        )
                    };
                case 'ADD_THREAD_MESSAGE':
                    const threadId = action.payload.threadId;
                    const threads = { ...state.threads, [threadId]: [...(state.threads[threadId] || []), action.payload] };
                    return {
                        ...state,
                        threads,
                        userStats: { ...state.userStats, threadsCreated: state.userStats.threadsCreated + 1 }
                    };
                case 'SET_PAGE':
                    return { ...state, currentPage: action.payload };
                case 'SET_FILES':
                    return { ...state, filesArray: action.payload };
                case 'SET_DRAFT':
                    return { ...state, messageDrafts: { ...state.messageDrafts, ...action.payload } };
                case 'CLEAR_DRAFT':
                    const newDrafts = { ...state.messageDrafts };
                    delete newDrafts[action.payload];
                    return { ...state, messageDrafts: newDrafts };
                case 'PIN_MESSAGE':
                    const pinned = new Set(state.pinnedMessages);
                    pinned.add(action.payload);
                    return { ...state, pinnedMessages: pinned };
                case 'UNPIN_MESSAGE':
                    const unpinned = new Set(state.pinnedMessages);
                    unpinned.delete(action.payload);
                    return { ...state, pinnedMessages: unpinned };
                case 'ADD_REACTION':
                    return {
                        ...state,
                        userStats: { ...state.userStats, reactionsAdded: state.userStats.reactionsAdded + 1 }
                    };
                case 'ENQUEUE_NOTIFICATION':
                    return { ...state, notificationQueue: [...state.notificationQueue, action.payload] };
                case 'DEQUEUE_NOTIFICATION':
                    return { ...state, notificationQueue: state.notificationQueue.slice(1) };
                case 'ADD_SEARCH':
                    return { ...state, searchHistory: [...state.searchHistory.slice(-9), action.payload] };
                default:
                    return state;
            }
        };

        const store = {
            state: initialState,
            listeners: [],
            dispatch(action) {
                this.state = reducer(this.state, action);
                this.listeners.forEach(listener => listener(this.state));
                this.saveState();
            },
            subscribe(listener) {
                this.listeners.push(listener);
                return () => {
                    this.listeners = this.listeners.filter(l => l !== listener);
                };
            },
            async saveState() {
                const db = await initDB();
                await saveToDB(db, 'state', this.state);
            },
            async loadState() {
                const db = await initDB();
                const saved = await getFromDB(db, 'state');
                if (saved) {
                    this.state = { ...this.state, ...saved };
                } else {
                    this.state.conversationHistory = [
                        { id: Date.now(), role: "assistant", content: "Hey there, I’m VerbiFlow—your ultra-fast AI companion for creativity, coding, analytics, and more! What’s on your mind?", reactions: [], threadId: null, timestamp: Date.now() }
                    ];
                    this.state.messageCount = 1;
                }
                this.listeners.forEach(listener => listener(this.state));
            }
        };

        const mockBackend = {
            async validateApiKey(apiKey) {
                await new Promise(resolve => setTimeout(resolve, 500));
                if (apiKey && apiKey.trim().startsWith('sk-') && apiKey.length > 10) {
                    return { success: true, message: 'API key validated successfully!' };
                }
                return { success: false, message: 'Invalid API key. Must start with "sk-" and be at least 10 characters.' };
            },
            async getAIResponse(userMessage, apiKey, model, language, task) {
                await new Promise(resolve => setTimeout(resolve, 30));
                if (!apiKey || !store.state.isApiKeyValid) {
                    return `Please provide a valid OpenAI API key to get AI responses.`;
                }
                const context = task ? `Task: ${task}. ` : '';
                const lang = language !== 'en' ? ` Respond in ${language}.` : '';
                return `${context}AI Response to: "${userMessage}" using model ${model}.${lang} (Simulated OpenAI response using provided API key.)`;
            },
            async saveUserData(data) {
                await new Promise(resolve => setTimeout(resolve, 100));
                return { success: true, message: 'User data saved!' };
            },
            async analyzeFile(file) {
                await new Promise(resolve => setTimeout(resolve, 300));
                return `Analysis of ${file.name}: This is a ${file.type} file of size ${(file.size / 1024).toFixed(2)} KB. (Mock analysis)`;
            }
        };

        const initDB = () => new Promise((resolve, reject) => {
            const request = indexedDB.open('VerbiFlowDB', 1);
            request.onupgradeneeded = event => {
                const db = event.target.result;
                db.createObjectStore('state', { keyPath: 'id' });
            };
            request.onsuccess = event => resolve(event.target.result);
            request.onerror = event => reject(event.target.error);
        });

        const saveToDB = (db, storeName, data) => new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.put({ id: 'appState', ...data });
            request.onsuccess = () => resolve();
            request.onerror = event => reject(event.target.error);
        });

        const getFromDB = (db, storeName) => new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.get('appState');
            request.onsuccess = event => resolve(event.target.result);
            request.onerror = event => reject(event.target.error);
        });

        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), delay);
            };
        };

        const showNotification = (message, type = 'success') => {
            store.dispatch({ type: 'ENQUEUE_NOTIFICATION', payload: { message, type } });
            processNotificationQueue();
        };

        const processNotificationQueue = () => {
            if (store.state.notificationQueue.length === 0) return;
            const { message, type } = store.state.notificationQueue[0];
            elements.notification.textContent = message;
            elements.notification.className = `notification ${type} show`;
            setTimeout(() => {
                elements.notification.className = 'notification';
                store.dispatch({ type: 'DEQUEUE_NOTIFICATION' });
                processNotificationQueue();
            }, 3000);
        };

        const sanitizeInput = input => {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        };

        const checkRateLimit = () => {
            const now = Date.now();
            if (now - store.state.lastAction < store.state.rateLimit.interval) {
                showNotification('Please wait before performing another action.', 'error');
                return false;
            }
            store.dispatch({ type: 'SET_STATE', payload: { lastAction: now } });
            return true;
        };

        const toggleTheme = () => {
            if (!checkRateLimit()) return;
            const isDarkMode = !store.state.isDarkMode;
            store.dispatch({ type: 'SET_STATE', payload: { isDarkMode } });
            document.body.classList.toggle('dark-mode');
            document.body.classList.remove('custom-theme');
            elements.themeBtn.innerHTML = `<i class="fas ${isDarkMode ? 'fa-sun' : 'fa-moon'}"></i> ${isDarkMode ? 'Light Mode' : 'Dark Mode'}`;
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        };

        const applyCustomTheme = () => {
            document.body.classList.add('custom-theme');
            document.body.style.setProperty('--custom-primary', elements.primaryColor.value);
            document.body.style.setProperty('--custom-secondary', elements.secondaryColor.value);
            document.body.style.setProperty('--custom-text', elements.textColor.value);
            document.body.style.setProperty('--custom-bg', elements.bgColor.value);
            document.body.style.setProperty('--custom-ai-bg', elements.aiBgColor.value);
            document.body.style.setProperty('--custom-user-bg', elements.userBgColor.value);
            document.body.style.setProperty('--custom-gradient', elements.gradientColor.value);
            elements.themePreview.style.background = `linear-gradient(135deg, ${elements.bgColor.value}, ${elements.gradientColor.value})`;
            localStorage.setItem('customTheme', JSON.stringify({
                primary: elements.primaryColor.value,
                secondary: elements.secondaryColor.value,
                text: elements.textColor.value,
                bg: elements.bgColor.value,
                aiBg: elements.aiBgColor.value,
                userBg: elements.userBgColor.value,
                gradient: elements.gradientColor.value
            }));
        };

        const loadTheme = () => {
            const savedTheme = localStorage.getItem('theme');
            const customTheme = JSON.parse(localStorage.getItem('customTheme'));
            if (savedTheme === 'dark') {
                store.dispatch({ type: 'SET_STATE', payload: { isDarkMode: true } });
                document.body.classList.add('dark-mode');
                elements.themeBtn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
            }
            if (customTheme) {
                elements.primaryColor.value = customTheme.primary;
                elements.secondaryColor.value = customTheme.secondary;
                elements.textColor.value = customTheme.text;
                elements.bgColor.value = customTheme.bg;
                elements.aiBgColor.value = customTheme.aiBg;
                elements.userBgColor.value = customTheme.userBg;
                elements.gradientColor.value = customTheme.gradient;
                applyCustomTheme();
            }
        };

        const formatRelativeTime = timestamp => {
            const now = Date.now();
            const diff = Math.floor((now - timestamp) / 1000);
            if (diff < 60) return `${diff}s ago`;
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
            return new Date(timestamp).toLocaleDateString();
        };

        const updateTimestamps = () => {
            document.querySelectorAll('.chat-message-meta span').forEach(span => {
                const messageId = span.closest('.chat-message').dataset.messageId;
                const message = store.state.conversationHistory.find(msg => msg.id === parseInt(messageId)) || 
                    Object.values(store.state.threads).flat().find(msg => msg.id === parseInt(messageId));
                if (message && message.timestamp) {
                    span.textContent = formatRelativeTime(message.timestamp);
                }
            });
            requestAnimationFrame(updateTimestamps);
        };

        const typeMessage = (content, contentDiv, callback) => {
            let index = 0;
            contentDiv.textContent = '';
            contentDiv.classList.add('typing-animation');
            const type = () => {
                if (index < content.length) {
                    contentDiv.textContent += content[index];
                    index++;
                    setTimeout(type, store.state.typingSpeed);
                } else {
                    callback();
                }
            };
            setTimeout(type, store.state.typingSpeed);
        };

        const virtualRenderMessages = () => {
            const fragment = document.createDocumentFragment();
            const start = (store.state.currentPage - 1) * store.state.messagesPerPage;
            const end = start + store.state.messagesPerPage;
            const messagesToRender = store.state.conversationHistory.slice(start, end);
            messagesToRender.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${message.role}${message.threadId ? ' threaded-message' : ''}${store.state.pinnedMessages.has(message.id) ? ' pinned' : ''}`;
                messageDiv.dataset.messageId = message.id;
                if (message.threadId) messageDiv.dataset.threadId = message.threadId;
                const contentDiv = document.createElement('div');
                contentDiv.className = 'chat-message-content';
                messageDiv.appendChild(contentDiv);
                const metaDiv = document.createElement('div');
                metaDiv.className = 'chat-message-meta';
                metaDiv.innerHTML = `<span>${formatRelativeTime(message.timestamp)}</span>`;
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'chat-message-actions';
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-message-btn';
                copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-message-btn';
                editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
                editBtn.style.display = message.role === 'user' ? 'inline-block' : 'none';
                const reactBtn = document.createElement('button');
                reactBtn.className = 'react-message-btn';
                reactBtn.innerHTML = '<i class="fas fa-heart"></i> React';
                const pinBtn = document.createElement('button');
                pinBtn.className = 'pin-message-btn';
                pinBtn.innerHTML = store.state.pinnedMessages.has(message.id) ? '<i class="fas fa-thumbtack"></i> Unpin' : '<i class="fas fa-thumbtack"></i> Pin';
                const threadBtn = document.createElement('button');
                threadBtn.className = 'thread-message-btn';
                threadBtn.innerHTML = '<i class="fas fa-comment"></i> Thread';
                if (message.reactions.length) {
                    const reactionsSpan = document.createElement('span');
                    reactionsSpan.className = 'reaction-emoji';
                    reactionsSpan.textContent = message.reactions.join(' ');
                    actionsDiv.appendChild(reactionsSpan);
                }
                actionsDiv.appendChild(copyBtn);
                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(reactBtn);
                actionsDiv.appendChild(pinBtn);
                actionsDiv.appendChild(threadBtn);
                metaDiv.appendChild(actionsDiv);
                messageDiv.appendChild(metaDiv);
                fragment.appendChild(messageDiv);
                if (store.state.threads[message.id]) {
                    store.state.threads[message.id].forEach(threadMessage => {
                        const threadDiv = document.createElement('div');
                        threadDiv.className = `chat-message ${threadMessage.role} threaded-message${store.state.pinnedMessages.has(threadMessage.id) ? ' pinned' : ''}`;
                        threadDiv.dataset.messageId = threadMessage.id;
                        threadDiv.dataset.threadId = message.id;
                        const threadContentDiv = document.createElement('div');
                        threadContentDiv.className = 'chat-message-content';
                        threadContentDiv.textContent = threadMessage.content;
                        threadDiv.appendChild(threadContentDiv);
                        const threadMetaDiv = document.createElement('div');
                        threadMetaDiv.className = 'chat-message-meta';
                        threadMetaDiv.innerHTML = `<span>${formatRelativeTime(threadMessage.timestamp)}</span>`;
                        const threadActionsDiv = document.createElement('div');
                        threadActionsDiv.className = 'chat-message-actions';
                        const threadCopyBtn = document.createElement('button');
                        threadCopyBtn.className = 'copy-message-btn';
                        threadCopyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
                        const threadEditBtn = document.createElement('button');
                        threadEditBtn.className = 'edit-message-btn';
                        threadEditBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
                        threadEditBtn.style.display = threadMessage.role === 'user' ? 'inline-block' : 'none';
                        const threadReactBtn = document.createElement('button');
                        threadReactBtn.className = 'react-message-btn';
                        threadReactBtn.innerHTML = '<i class="fas fa-heart"></i> React';
                        const threadPinBtn = document.createElement('button');
                        threadPinBtn.className = 'pin-message-btn';
                        threadPinBtn.innerHTML = store.state.pinnedMessages.has(threadMessage.id) ? '<i class="fas fa-thumbtack"></i> Unpin' : '<i class="fas fa-thumbtack"></i> Pin';
                        const threadThreadBtn = document.createElement('button');
                        threadThreadBtn.className = 'thread-message-btn';
                        threadThreadBtn.innerHTML = '<i class="fas fa-comment"></i> Thread';
                        if (threadMessage.reactions.length) {
                            const threadReactionsSpan = document.createElement('span');
                            threadReactionsSpan.className = 'reaction-emoji';
                            threadReactionsSpan.textContent = threadMessage.reactions.join(' ');
                            threadActionsDiv.appendChild(threadReactionsSpan);
                        }
                        threadActionsDiv.appendChild(threadCopyBtn);
                        threadActionsDiv.appendChild(threadEditBtn);
                        threadActionsDiv.appendChild(threadReactBtn);
                        threadActionsDiv.appendChild(threadPinBtn);
                        threadActionsDiv.appendChild(threadThreadBtn);
                        threadMetaDiv.appendChild(threadActionsDiv);
                        threadDiv.appendChild(threadMetaDiv);
                        fragment.appendChild(threadDiv);
                    });
                }
                if (message.role === 'ai') {
                    typeMessage(message.content, contentDiv, () => {
                        messageDiv.classList.add('visible');
                        if (store.state.userProfile.preferences.autoScroll) {
                            elements.chatArea.scrollTo({ top: elements.chatArea.scrollHeight, behavior: 'smooth' });
                        }
                    });
                } else {
                    contentDiv.textContent = message.content;
                    setTimeout(() => messageDiv.classList.add('visible'), 10);
                    if (store.state.userProfile.preferences.autoScroll) {
                        elements.chatArea.scrollTo({ top: elements.chatArea.scrollHeight, behavior: 'smooth' });
                    }
                }
            });
            elements.chatHistory.innerHTML = '';
            elements.chatHistory.appendChild(fragment);
            elements.prevPageBtn.disabled = store.state.currentPage === 1;
            elements.nextPageBtn.disabled = end >= store.state.conversationHistory.length;
            elements.messageCounter.textContent = `Messages: ${store.state.messageCount} | Sent: ${store.state.userStats.messagesSent} | Reactions: ${store.state.userStats.reactionsAdded} | Threads: ${store.state.userStats.threadsCreated}`;
        };

        const handleSendMessage = async (threadId = null) => {
            if (!checkRateLimit()) return;
            const userMessage = sanitizeInput(elements.userInput.value.trim());
            if (!userMessage || userMessage.length > 1000) {
                showNotification(userMessage ? 'Input too long! Maximum 1000 characters.' : 'Please enter a message.', 'error');
                return;
            }
            const messageId = Date.now();
            const newMessage = { id: messageId, role: 'user', content: userMessage, reactions: [], threadId, timestamp: Date.now() };
            if (threadId) {
                store.dispatch({ type: 'ADD_THREAD_MESSAGE', payload: newMessage });
            } else {
                store.dispatch({ type: 'ADD_MESSAGE', payload: newMessage });
            }
            elements.userInput.value = '';
            store.dispatch({ type: 'CLEAR_DRAFT', payload: 'userInput' });
            elements.typingIndicator.style.display = 'block';
            elements.responseSpinner.style.display = 'block';
            virtualRenderMessages();
            const aiResponse = await mockBackend.getAIResponse(
                userMessage,
                store.state.apiKey,
                store.state.selectedModel,
                store.state.selectedLanguage,
                store.state.selectedTask
            );
            const aiMessage = { id: Date.now(), role: 'ai', content: aiResponse, reactions: [], threadId, timestamp: Date.now() };
            if (threadId) {
                store.dispatch({ type: 'ADD_THREAD_MESSAGE', payload: aiMessage });
            } else {
                store.dispatch({ type: 'ADD_MESSAGE', payload: aiMessage });
            }
            elements.typingIndicator.style.display = 'none';
            elements.responseSpinner.style.display = 'none';
            virtualRenderMessages();
        };

        const debouncedSendMessage = debounce(handleSendMessage, 50);

        const handleFileUpload = async event => {
            if (!checkRateLimit()) return;
            const files = Array.from(event.target.files);
            if (files.length > 5) {
                                showNotification('Maximum 5 files allowed.', 'error');
                return;
            }
            const totalSize = files.reduce((sum, file) => sum + file.size, 0);
            if (totalSize > 10 * 1024 * 1024) {
                showNotification('Total file size exceeds 10MB limit.', 'error');
                return;
            }
            const newFiles = files.map(file => ({
                id: Date.now() + Math.random(),
                file,
                name: file.name,
                type: file.type,
                size: file.size,
                preview: null,
                analysis: null
            }));
            store.dispatch({ type: 'SET_FILES', payload: [...store.state.filesArray, ...newFiles] });
            elements.fileClearBtn.style.display = store.state.filesArray.length ? 'block' : 'none';
            renderFileList();
            newFiles.forEach(async fileObj => {
                if (fileObj.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        fileObj.preview = e.target.result;
                        renderFileList();
                    };
                    reader.readAsDataURL(fileObj.file);
                }
                const analysis = await mockBackend.analyzeFile(fileObj.file);
                fileObj.analysis = analysis;
                renderFileList();
            });
        };

        const renderFileList = () => {
            elements.fileList.innerHTML = '';
            store.state.filesArray.forEach(fileObj => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.dataset.fileId = fileObj.id;
                const fileIcon = document.createElement('i');
                fileIcon.className = `fas ${fileObj.type.startsWith('image/') ? 'fa-image' : fileObj.type.startsWith('video/') ? 'fa-video' : 'fa-file'}`;
                const fileName = document.createElement('span');
                fileName.className = 'file-item-name';
                fileName.textContent = fileObj.name;
                const fileDetails = document.createElement('span');
                fileDetails.className = 'file-item-details';
                fileDetails.textContent = `${(fileObj.size / 1024).toFixed(2)} KB${fileObj.analysis ? ` - ${fileObj.analysis}` : ''}`;
                fileItem.appendChild(fileIcon);
                fileItem.appendChild(fileName);
                fileItem.appendChild(fileDetails);
                elements.fileList.appendChild(fileItem);
            });
        };

        const clearFiles = () => {
            store.dispatch({ type: 'SET_FILES', payload: [] });
            elements.fileList.innerHTML = '';
            elements.fileClearBtn.style.display = 'none';
        };

        const previewFile = fileObj => {
            elements.filePreviewContent.innerHTML = '';
            if (fileObj.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = fileObj.preview;
                img.style.transform = `scale(${store.state.zoomLevel})`;
                elements.filePreviewContent.appendChild(img);
                elements.zoomControls.style.display = 'flex';
            } else if (fileObj.type.startsWith('video/')) {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(fileObj.file);
                video.controls = true;
                elements.filePreviewContent.appendChild(video);
                elements.zoomControls.style.display = 'none';
            } else {
                const text = document.createElement('div');
                text.textContent = fileObj.analysis || 'No preview available.';
                elements.filePreviewContent.appendChild(text);
                elements.zoomControls.style.display = 'none';
            }
            elements.filePreviewModal.classList.add('open');
        };

        const zoomIn = () => {
            store.state.zoomLevel = Math.min(store.state.zoomLevel + 0.1, 3);
            const img = elements.filePreviewContent.querySelector('img');
            if (img) img.style.transform = `scale(${store.state.zoomLevel})`;
        };

        const zoomOut = () => {
            store.state.zoomLevel = Math.max(store.state.zoomLevel - 0.1, 0.5);
            const img = elements.filePreviewContent.querySelector('img');
            if (img) img.style.transform = `scale(${store.state.zoomLevel})`;
        };

        const toggleSidebar = () => {
            if (!checkRateLimit()) return;
            elements.sidebar.classList.toggle('open');
            elements.menuBtn.innerHTML = elements.sidebar.classList.contains('open') ? '<i class="fas fa-times"></i> Close' : '<i class="fas fa-bars"></i> Menu';
        };

        const toggleFileActions = () => {
            if (!checkRateLimit()) return;
            elements.fileActionsContainer.classList.toggle('collapsed');
            elements.toggleActionsBtn.classList.toggle('collapsed');
        };

        const scrollToTop = () => {
            if (!checkRateLimit()) return;
            elements.chatArea.scrollTo({ top: 0, behavior: 'smooth' });
        };

        const handleScroll = () => {
            const isScrolled = elements.chatArea.scrollTop > 300;
            elements.backToTopBtn.classList.toggle('visible', isScrolled);
        };

        const saveUserProfile = () => {
            const userProfile = {
                username: sanitizeInput(elements.usernameInput.value) || 'User',
                chatLayout: elements.chatLayoutSelect.value,
                preferences: store.state.userProfile.preferences
            };
            store.dispatch({ type: 'SET_STATE', payload: { userProfile } });
            applyChatLayout();
            showNotification('Profile updated!');
        };

        const applyChatLayout = () => {
            const layout = store.state.userProfile.chatLayout;
            document.querySelectorAll('.chat-message-content').forEach(content => {
                if (layout === 'compact') {
                    content.style.padding = '8px 12px';
                    content.style.fontSize = '14px';
                    content.style.lineHeight = '1.4';
                } else if (layout === 'spacious') {
                    content.style.padding = '20px 25px';
                    content.style.fontSize = '18px';
                    content.style.lineHeight = '1.8';
                } else {
                    content.style.padding = '15px 20px';
                    content.style.fontSize = '16px';
                    content.style.lineHeight = '1.6';
                }
            });
        };

        const exportChat = () => {
            if (!checkRateLimit()) return;
            const chatData = store.state.conversationHistory.map(msg => ({
                role: msg.role,
                content: msg.content,
                timestamp: new Date(msg.timestamp).toISOString(),
                reactions: msg.reactions,
                threadId: msg.threadId
            }));
            const blob = new Blob([JSON.stringify(chatData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `VerbiFlow_Chat_${new Date().toISOString()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Chat exported successfully!');
        };

        const searchMessages = () => {
            const query = elements.searchModalInput.value.trim();
            if (!query) {
                elements.searchResults.innerHTML = '<p>Enter a search query.</p>';
                return;
            }
            store.dispatch({ type: 'ADD_SEARCH', payload: query });
            let results;
            try {
                const regex = new RegExp(query, 'i');
                results = store.state.conversationHistory.filter(msg => regex.test(msg.content));
            } catch (e) {
                results = store.state.conversationHistory.filter(msg => msg.content.toLowerCase().includes(query.toLowerCase()));
            }
            elements.searchResults.innerHTML = '';
            if (results.length === 0) {
                elements.searchResults.innerHTML = '<p>No results found.</p>';
                return;
            }
            results.forEach(msg => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                resultItem.dataset.messageId = msg.id;
                const highlightedContent = msg.content.replace(
                    new RegExp(query, 'gi'),
                    match => `<span class="highlight">${match}</span>`
                );
                resultItem.innerHTML = `<strong>${msg.role.toUpperCase()}</strong>: ${highlightedContent} <br><small>${formatRelativeTime(msg.timestamp)}</small>`;
                elements.searchResults.appendChild(resultItem);
            });
        };

        const handleUpdatesClick = () => {
            if (!checkRateLimit()) return;
            window.open('https://verbiflow.site/updates', '_blank');
            showNotification('Check out the latest updates!');
        };

        const handlePremiumPriceClick = () => {
            if (!checkRateLimit()) return;
            window.open('https://verbiflow.site/premium', '_blank');
            showNotification('Explore our premium plans!');
        };

        const loadConversationHistory = () => {
            virtualRenderMessages();
            if (store.state.filesArray.length) {
                renderFileList();
                elements.fileClearBtn.style.display = 'block';
            }
            if (store.state.isDarkMode) {
                document.body.classList.add('dark-mode');
                elements.themeBtn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
            }
            applyChatLayout();
            elements.aiModelDropdown.value = store.state.selectedModel;
            elements.languageDropdown.value = store.state.selectedLanguage;
            elements.schoolHelpDropdown.value = store.state.selectedTask;
        };

        const detectDevice = () => {
            const ua = navigator.userAgent.toLowerCase();
            if (/mobile|android|iphone|ipad|ipod|opera mini|opera mobi|webos|blackberry|windows phone/i.test(ua)) {
                return 'mobile';
            } else if (/chromebook|crOS/i.test(ua)) {
                return 'chromebook';
            } else {
                return 'desktop';
            }
        };

        const showLoadingMessages = async () => {
            const messages = [
                'Detecting the user device..',
                'Detecting if the user is on Chromebook..',
                'Detected!',
                `User is on ${store.state.deviceType}`,
                'VerbiFlow supports the device, enjoy using VerbiFlow.'
            ];
            for (let i = 0; i < messages.length; i++) {
                elements.loadingText.textContent = messages[i];
                elements.loadingText.classList.add('visible');
                await new Promise(resolve => setTimeout(resolve, 1000));
                elements.loadingText.classList.remove('visible');
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            elements.apiKeyContainer.classList.add('visible');
        };

        const handleApiKeySubmission = async () => {
            const apiKey = elements.apiKeyInput.value.trim();
            if (!apiKey) {
                showNotification('Please enter an OpenAI API key.', 'error');
                return;
            }
            const validationResult = await mockBackend.validateApiKey(apiKey);
            if (validationResult.success) {
                store.dispatch({ type: 'SET_STATE', payload: { apiKey, isApiKeyValid: true } });
                showNotification(validationResult.message);
                elements.preloader.classList.add('hidden');
                setTimeout(() => {
                    elements.preloader.style.display = 'none';
                    loadConversationHistory();
                }, 500);
            } else {
                showNotification(validationResult.message, 'error');
                elements.apiKeyInput.value = '';
            }
        };

        elements.chatHistory.addEventListener('click', e => {
            const target = e.target.closest('button');
            if (!target) return;
            const messageDiv = target.closest('.chat-message');
            const messageId = parseInt(messageDiv.dataset.messageId);
            const threadId = messageDiv.dataset.threadId ? parseInt(messageDiv.dataset.threadId) : null;
            let message;
            if (threadId) {
                message = store.state.threads[threadId]?.find(msg => msg.id === messageId);
            } else {
                message = store.state.conversationHistory.find(msg => msg.id === messageId);
            }
            if (!message) return;
            if (target.classList.contains('copy-message-btn')) {
                if (!checkRateLimit()) return;
                navigator.clipboard.writeText(message.content);
                showNotification('Message copied to clipboard!');
            } else if (target.classList.contains('edit-message-btn')) {
                if (!checkRateLimit()) return;
                elements.editMessageModal.dataset.messageId = messageId;
                elements.editMessageModal.dataset.threadId = threadId || '';
                elements.editMessageInput.value = message.content;
                elements.editMessageModal.classList.add('open');
            } else if (target.classList.contains('react-message-btn')) {
                if (!checkRateLimit()) return;
                const emoji = '❤️';
                message.reactions.push(emoji);
                store.dispatch({ type: 'UPDATE_MESSAGE', payload: message });
                store.dispatch({ type: 'ADD_REACTION' });
                virtualRenderMessages();
                showNotification('Reaction added!');
            } else if (target.classList.contains('pin-message-btn')) {
                if (!checkRateLimit()) return;
                if (store.state.pinnedMessages.has(messageId)) {
                    store.dispatch({ type: 'UNPIN_MESSAGE', payload: messageId });
                    showNotification('Message unpinned!');
                } else {
                    store.dispatch({ type: 'PIN_MESSAGE', payload: messageId });
                    showNotification('Message pinned!');
                }
                virtualRenderMessages();
            } else if (target.classList.contains('thread-message-btn')) {
                if (!checkRateLimit()) return;
                const userMessage = prompt('Enter your thread message:');
                if (userMessage) {
                    const threadMessage = {
                        id: Date.now(),
                        role: 'user',
                        content: sanitizeInput(userMessage),
                        reactions: [],
                        threadId: messageId,
                        timestamp: Date.now()
                    };
                    store.dispatch({ type: 'ADD_THREAD_MESSAGE', payload: threadMessage });
                    virtualRenderMessages();
                    showNotification('Thread message added!');
                }
            }
        });

        elements.fileList.addEventListener('click', e => {
            const fileItem = e.target.closest('.file-item');
            if (!fileItem) return;
            const fileId = parseFloat(fileItem.dataset.fileId);
            const file = store.state.filesArray.find(f => f.id === fileId);
            if (file) previewFile(file);
        });

        elements.zoomIn.addEventListener('click', zoomIn);
        elements.zoomOut.addEventListener('click', zoomOut);

        elements.fileInput.addEventListener('change', handleFileUpload);
        elements.fileClearBtn.addEventListener('click', () => {
            if (!checkRateLimit()) return;
            clearFiles();
            showNotification('Files cleared!');
        });

        elements.filePreviewClose.addEventListener('click', () => {
            elements.filePreviewModal.classList.remove('open');
            elements.filePreviewContent.innerHTML = '';
            elements.zoomControls.style.display = 'none';
            store.state.zoomLevel = 1;
        });

        elements.sendBtn.addEventListener('click', debouncedSendMessage);
        elements.userInput.addEventListener('keypress', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                debouncedSendMessage();
            }
        });

        elements.userInput.addEventListener('input', () => {
            store.dispatch({ type: 'SET_DRAFT', payload: { userInput: elements.userInput.value } });
            elements.userInput.style.height = 'auto';
            elements.userInput.style.height = `${elements.userInput.scrollHeight}px`;
        });

        elements.menuBtn.addEventListener('click', toggleSidebar);
        elements.sidebarClose.addEventListener('click', toggleSidebar);

        elements.clearChatBtn.addEventListener('click', () => {
            if (!checkRateLimit()) return;
            elements.confirmClearModal.classList.add('open');
        });

        elements.confirmClearBtn.addEventListener('click', () => {
            if (!checkRateLimit()) return;
            store.dispatch({ type: 'SET_STATE', payload: { conversationHistory: [], messageCount: 0, pinnedMessages: new Set(), threads: {}, userStats: { ...store.state.userStats, messagesSent: 0, reactionsAdded: 0, threadsCreated: 0 } } });
            const welcomeMessage = { id: Date.now(), role: 'ai', content: "Hey there, I’m VerbiFlow—your ultra-fast AI companion for creativity, coding, analytics, and more! What’s on your mind?", reactions: [], threadId: null, timestamp: Date.now() };
            store.dispatch({ type: 'ADD_MESSAGE', payload: welcomeMessage });
            store.dispatch({ type: 'SET_STATE', payload: { messageCount: 1 } });
            virtualRenderMessages();
            elements.confirmClearModal.classList.remove('open');
            showNotification('Conversation cleared!');
            toggleSidebar();
        });

        elements.cancelClearBtn.addEventListener('click', () => {
            elements.confirmClearModal.classList.remove('open');
        });

        elements.copyCodeBtn.addEventListener('click', () => {
            if (!checkRateLimit()) return;
            if (store.state.latestCodeBlocks.length) {
                navigator.clipboard.writeText(store.state.latestCodeBlocks.join('\n'));
                showNotification('Code copied to clipboard!');
            } else {
                showNotification('No code blocks to copy.', 'error');
            }
        });

        elements.discordBtn.addEventListener('click', () => {
            if (!checkRateLimit()) return;
            window.open(DISCORD_INVITE, '_blank');
            showNotification('Join our Discord community!');
        });

        elements.verbiflowUpdatesBtn.addEventListener('click', handleUpdatesClick);
        elements.premiumPriceBtn.addEventListener('click', handlePremiumPriceClick);

        elements.shareChatBtn.addEventListener('click', () => {
            if (!checkRateLimit()) return;
            const shareData = { title: 'VerbiFlow Chat', text: 'Check out my chat on VerbiFlow!', url: window.location.href };
            navigator.share(shareData).then(() => showNotification('Chat shared successfully!')).catch(() => showNotification('Sharing not supported on this device.', 'error'));
        });

        elements.shareWebsiteBtn.addEventListener('click', () => {
            if (!checkRateLimit()) return;
            const shareData = { title: 'VerbiFlow', text: 'Check out VerbiFlow - an ultra-fast AI companion!', url: WEBSITE_URL };
            navigator.share(shareData).then(() => showNotification('Website shared successfully!')).catch(() => showNotification('Sharing not supported on this device.', 'error'));
        });

        elements.themeBtn.addEventListener('click', toggleTheme);

        elements.userProfileBtn.addEventListener('click', () => {
            if (!checkRateLimit()) return;
            elements.usernameInput.value = store.state.userProfile.username;
            elements.chatLayoutSelect.value = store.state.userProfile.chatLayout;
            elements.userProfileModal.classList.add('open');
        });

        elements.userProfileClose.addEventListener('click', () => elements.userProfileModal.classList.remove('open'));
        elements.usernameInput.addEventListener('change', saveUserProfile);
        elements.chatLayoutSelect.addEventListener('change', saveUserProfile);

        elements.toggleActionsBtn.addEventListener('click', toggleFileActions);

        elements.generateMediaBtn.addEventListener('click', () => {
            if (!checkRateLimit()) return;
            showNotification('Media generation is a premium feature. Please upgrade!');
        });

        elements.voiceSearchBtn.addEventListener('click', () => {
            if (!checkRateLimit()) return;
            elements.permissionModal.classList.add('open');
        });

        elements.grantPermissionBtn.addEventListener('click', () => {
            elements.permissionModal.classList.remove('open');
            showNotification('Permissions granted! Voice search enabled.');
        });

        elements.denyPermissionBtn.addEventListener('click', () => {
            elements.permissionModal.classList.remove('open');
            showNotification('Permissions denied.', 'error');
        });

        elements.schoolHelpDropdown.addEventListener('change', () => {
            store.dispatch({ type: 'SET_STATE', payload: { selectedTask: elements.schoolHelpDropdown.value } });
        });

        elements.aiModelDropdown.addEventListener('change', () => {
            store.dispatch({ type: 'SET_STATE', payload: { selectedModel: elements.aiModelDropdown.value } });
        });

        elements.languageDropdown.addEventListener('change', () => {
            store.dispatch({ type: 'SET_STATE', payload: { selectedLanguage: elements.languageDropdown.value } });
        });

        elements.rephraseBtn.addEventListener('click', async () => {
            if (!checkRateLimit()) return;
            const lastUserMessage = store.state.conversationHistory.filter(msg => msg.role === 'user').slice(-1)[0];
            if (!lastUserMessage) {
                showNotification('No user message to rephrase.', 'error');
                return;
            }
            const rephrased = await mockBackend.getAIResponse(
                `Rephrase: "${lastUserMessage.content}"`,
                store.state.apiKey,
                store.state.selectedModel,
                store.state.selectedLanguage,
                store.state.selectedTask
            );
            const aiMessage = { id: Date.now(), role: 'ai', content: rephrased, reactions: [], threadId: null, timestamp: Date.now() };
            store.dispatch({ type: 'ADD_MESSAGE', payload: aiMessage });
            virtualRenderMessages();
        });

        elements.stopGeneratingBtn.addEventListener('click', () => {
            if (!checkRateLimit()) return;
            store.dispatch({ type: 'SET_STATE', payload: { isGenerating: false } });
            elements.stopGeneratingBtn.style.display = 'none';
            showNotification('Generation stopped.');
        });

        elements.feedbackBtn.addEventListener('click', () => {
            if (!checkRateLimit()) return;
            elements.feedbackModal.classList.add('open');
        });

        elements.feedbackSubmitBtn.addEventListener('click', () => {
            if (!checkRateLimit()) return;
            const feedback = elements.feedbackInput.value.trim();
            if (!feedback) {
                showNotification('Please enter feedback.', 'error');
                return;
            }
            const mailtoLink = `mailto:${FEEDBACK_EMAIL}?subject=VerbiFlow Feedback&body=${encodeURIComponent(feedback)}`;
            window.location.href = mailtoLink;
            elements.feedbackModal.classList.remove('open');
            elements.feedbackInput.value = '';
            showNotification('Thank you for your feedback!');
        });

        elements.backToTopBtn.addEventListener('click', scrollToTop);
        elements.chatArea.addEventListener('scroll', handleScroll);

        elements.prevPageBtn.addEventListener('click', () => {
            if (!checkRateLimit()) return;
            if (store.state.currentPage > 1) {
                store.dispatch({ type: 'SET_PAGE', payload: store.state.currentPage - 1 });
                virtualRenderMessages();
            }
        });

        elements.nextPageBtn.addEventListener('click', () => {
            if (!checkRateLimit()) return;
            if (store.state.currentPage * store.state.messagesPerPage < store.state.conversationHistory.length) {
                store.dispatch({ type: 'SET_PAGE', payload: store.state.currentPage + 1 });
                virtualRenderMessages();
            }
        });

        elements.searchBtn.addEventListener('click', () => {
            if (!checkRateLimit()) return;
            elements.searchModal.classList.add('open');
        });

        elements.searchModalClose.addEventListener('click', () => elements.searchModal.classList.remove('open'));
        elements.searchModalInput.addEventListener('input', debounce(searchMessages, 300));

        elements.searchResults.addEventListener('click', e => {
            const resultItem = e.target.closest('.search-result-item');
            if (!resultItem) return;
            const messageId = parseInt(resultItem.dataset.messageId);
            const message = store.state.conversationHistory.find(msg => msg.id === messageId);
            if (!message) return;
            const messageDiv = elements.chatHistory.querySelector(`[data-message-id="${messageId}"]`);
            if (messageDiv) {
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                messageDiv.style.background = 'rgba(255, 215, 0, 0.3)';
                setTimeout(() => (messageDiv.style.background = ''), 2000);
            }
            elements.searchModal.classList.remove('open');
        });

        elements.exportChatBtn.addEventListener('click', exportChat);

        elements.editMessageClose.addEventListener('click', () => elements.editMessageModal.classList.remove('open'));
        elements.saveEditBtn.addEventListener('click', () => {
            if (!checkRateLimit()) return;
            const messageId = parseInt(elements.editMessageModal.dataset.messageId);
            const threadId = elements.editMessageModal.dataset.threadId ? parseInt(elements.editMessageModal.dataset.threadId) : null;
            const updatedContent = sanitizeInput(elements.editMessageInput.value.trim());
            if (!updatedContent) {
                showNotification('Message cannot be empty.', 'error');
                return;
            }
            let message;
            if (threadId) {
                const threadMessages = store.state.threads[threadId] || [];
                message = threadMessages.find(msg => msg.id === messageId);
                if (message) {
                    message.content = updatedContent;
                    message.timestamp = Date.now();
                    store.dispatch({ type: 'UPDATE_MESSAGE', payload: message });
                }
            } else {
                message = store.state.conversationHistory.find(msg => msg.id === messageId);
                if (message) {
                    message.content = updatedContent;
                    message.timestamp = Date.now();
                    store.dispatch({ type: 'UPDATE_MESSAGE', payload: message });
                }
            }
            virtualRenderMessages();
            elements.editMessageModal.classList.remove('open');
            showNotification('Message updated!');
        });

        elements.primaryColor.addEventListener('input', applyCustomTheme);
        elements.secondaryColor.addEventListener('input', applyCustomTheme);
        elements.textColor.addEventListener('input', applyCustomTheme);
        elements.bgColor.addEventListener('input', applyCustomTheme);
        elements.aiBgColor.addEventListener('input', applyCustomTheme);
        elements.userBgColor.addEventListener('input', applyCustomTheme);
        elements.gradientColor.addEventListener('input', applyCustomTheme);

        elements.apiKeySubmit.addEventListener('click', handleApiKeySubmission);
        elements.apiKeyInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                handleApiKeySubmission();
            }
        });

        const init = async () => {
            store.state.deviceType = detectDevice();
            document.body.classList.add(store.state.deviceType);
            await showLoadingMessages();
            await store.loadState();
            loadTheme();
            applyChatLayout();
            if (store.state.messageDrafts.userInput) {
                elements.userInput.value = store.state.messageDrafts.userInput;
                elements.userInput.style.height = `${elements.userInput.scrollHeight}px`;
            }
            if (store.state.isApiKeyValid) {
                elements.preloader.classList.add('hidden');
                setTimeout(() => {
                    elements.preloader.style.display = 'none';
                    loadConversationHistory();
                }, 500);
            }
            requestAnimationFrame(updateTimestamps);
        };

        init();
    </script>
</body>
</html>
