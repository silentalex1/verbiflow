<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: blob: https://*.pixabay.com https://*.openai.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://www.cloudflare.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; connect-src 'self' https://api.openai.com wss://api.openai.com https://api.searchengine.com https://api.x.ai; frame-src 'none'; media-src 'self' data: blob: https://*.pixabay.com https://*.openai.com;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="VerbiFlow - Your ultimate AI companion for coding, media generation, and more.">
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains; preload">
    <meta http-equiv="Referrer-Policy" content="no-referrer">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
    <title>VerbiFlow</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
        body{background:linear-gradient(145deg,#f0f2f5,#d4d8dd);font-family:Inter,sans-serif;color:#0f172a;min-height:100vh;display:flex;justify-content:center;padding:0;transition:background .3s ease;overscroll-behavior:none;}
        .dark-mode body{background:linear-gradient(145deg,#1e293b,#0f172a);color:#e2e8f0;}
        .container{width:100%;max-width:100vw;height:100vh;background:#ffffff;border-radius:0;box-shadow:none;overflow:hidden;display:flex;flex-direction:column;transition:all .3s ease;}
        .dark-mode .container{background:#1e293b;}
        .nav-bar{background:linear-gradient(90deg,#1e40af,#3b82f6);padding:12px 16px;display:flex;gap:6px;justify-content:space-between;align-items:center;box-shadow:0 4px 20px rgba(0,0,0,.3);border-bottom:1px solid rgba(255,255,255,.1);position:sticky;top:0;z-index:100;}
        .dark-mode .nav-bar{background:linear-gradient(90deg,#1e3a8a,#2563eb);}
        .menu-btn{background:#ffffff;color:#1e40af;border:none;padding:8px 16px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:600;transition:all .2s ease;display:flex;align-items:center;gap:6px;touch-action:manipulation;}
        .dark-mode .menu-btn{background:#334155;color:#93c5fd;}
        .menu-btn:hover{background:#f1f5f9;box-shadow:0 4px 16px rgba(0,0,0,.2);}
        .dark-mode .menu-btn:hover{background:#475569;}
        .menu-btn i{font-size:16px;}
        .sidebar{position:fixed;top:0;left:-100%;width:100%;max-width:320px;height:100%;background:#ffffff;border-right:1px solid #e2e8f0;padding:24px 16px;transition:left .3s ease;z-index:200;display:flex;flex-direction:column;gap:10px;}
        .dark-mode .sidebar{background:#1e293b;border-right:1px solid #334155;}
        .sidebar.open{left:0;}
        .sidebar-close{background:#ef4444;color:#ffffff;border:none;padding:8px 16px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:600;text-align:left;transition:all .2s ease;margin-bottom:12px;}
        .dark-mode .sidebar-close{background:#dc2626;}
        .sidebar-close:hover{background:#f87171;transform:scale(1.02);}
        .dark-mode .sidebar-close:hover{background:#ef4444;}
        .sidebar-btn{background:#f1f5f9;color:#1e40af;border:none;padding:12px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:600;text-align:left;transition:all .2s ease;touch-action:manipulation;}
        .dark-mode .sidebar-btn{background:#334155;color:#93c5fd;}
        .sidebar-btn:hover{background:#e2e8f0;transform:scale(1.02);}
        .dark-mode .sidebar-btn:hover{background:#475569;}
        .discord-btn{background:#5865f2;color:#ffffff;}
        .discord-btn:hover{background:#4752c4;}
        .app-btn{background:#ff4d4f;color:#ffffff;}
        .app-btn:hover{background:#ff7875;}
        .theme-btn{background:#ffffff;color:#1e40af;border:2px solid #1e40af;padding:10px;border-radius:10px;font-size:14px;font-weight:600;display:flex;align-items:center;gap:4px;}
        .dark-mode .theme-btn{background:#334155;color:#93c5fd;border:2px solid #60a5fa;}
        .theme-btn:hover{background:#f1f5f9;}
        .dark-mode .theme-btn:hover{background:#475569;}
        .theme-btn i{font-size:16px;}
        .header{background:#ffffff;padding:16px;text-align:center;border-bottom:1px solid #e2e8f0;}
        .dark-mode .header{background:#1e293b;border-bottom:1px solid #334155;}
        .logo{font-size:36px;font-weight:800;color:#1e40af;letter-spacing:-1px;animation:pulse 1.6s infinite;}
        .dark-mode .logo{color:#60a5fa;}
        .chat-area{flex:1;padding:16px;overflow-y:auto;background:#f8fafc;scroll-behavior:smooth;box-shadow:inset 0 2px 10px rgba(0,0,0,.05);overscroll-behavior:contain;}
        .dark-mode .chat-area{background:#111827;}
        .chat-content{flex:1;display:flex;flex-direction:column;}
        .chat-history{display:flex;flex-direction:column;gap:16px;}
        .chat-message{display:flex;flex-direction:column;gap:8px;padding:12px;border-radius:20px;max-width:85%;animation:slideIn .3s ease;box-shadow:0 4px 12px rgba(0,0,0,.1);transition:background .3s ease;}
        .chat-message.user{align-self:flex-end;background:#1e40af;color:#ffffff;}
        .dark-mode .chat-message.user{background:#1e3a8a;}
        .chat-message.ai{align-self:flex-start;background:#e2e8f0;color:#0f172a;}
        .dark-mode .chat-message.ai{background:#334155;color:#e2e8f0;}
        .chat-message-content{padding:12px;border-radius:20px;font-size:15px;line-height:1.6;word-break:break-word;}
        .chat-message-content strong{font-weight:700;}
        .chat-message-content em{font-style:italic;}
        .chat-message-content code{background:#f1f5f9;padding:2px 4px;border-radius:4px;font-family:'JetBrains Mono',monospace;}
        .dark-mode .chat-message-content code{background:#475569;}
        .chat-message-content ul,.chat-message-content ol{margin:8px 0;padding-left:20px;}
        .chat-message-content li{margin-bottom:6px;}
        .chat-message-content table{border-collapse:collapse;margin:8px 0;}
        .chat-message-content th,.chat-message-content td{border:1px solid #e2e8f0;padding:6px 10px;}
        .dark-mode .chat-message-content th,.dark-mode .chat-message-content td{border:1px solid #334155;}
        .chat-message-meta{font-size:13px;color:#64748b;margin-top:6px;opacity:.8;}
        .dark-mode .chat-message-meta{color:#94a3b8;}
        .chat-message img,.chat-message video{max-width:100%;border-radius:12px;margin-top:10px;cursor:pointer;transition:transform .2s ease,box-shadow .2s ease;}
        .chat-message img:hover,.chat-message video:hover{transform:scale(1.03);box-shadow:0 8px 20px rgba(0,0,0,.25);}
        .code-block{position:relative;margin:10px 0;border-radius:12px;overflow:hidden;}
        .code-block pre{background:#0f172a;color:#e2e8f0;padding:14px;border-radius:12px;overflow-x:auto;font-family:'JetBrains Mono',monospace;font-size:14px;line-height:1.6;}
        .dark-mode .code-block pre{background:#1e293b;}
        .copy-btn{background:#1e40af;color:#ffffff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-size:13px;font-weight:600;transition:all .2s ease;position:absolute;top:8px;right:8px;touch-action:manipulation;}
        .dark-mode .copy-btn{background:#1e3a8a;}
        .copy-btn:hover{background:#3b82f6;transform:scale(1.05);box-shadow:0 4px 16px rgba(0,0,0,.2);}
        .dark-mode .copy-btn:hover{background:#2563eb;}
        .file-actions-container{position:sticky;bottom:60px;padding:6px;border-top:1px solid #e2e8f0;background:#ffffff;border-bottom:1px solid #e2e8f0;transition:transform .3s ease,opacity .3s ease;overflow:hidden;z-index:40;}
        .dark-mode .file-actions-container{background:#1e293b;border-top:1px solid #334155;border-bottom:1px solid #334155;}
        .file-actions-container.collapsed{transform:translateY(100%);opacity:0;height:0;padding:0;}
        .file-actions{display:flex;gap:8px;align-items:center;padding:8px 0;justify-content:space-between;border-radius:10px;background:#f8fafc;box-shadow:0 2px 10px rgba(0,0,0,.05);flex-wrap:wrap;}
        .dark-mode .file-actions{background:#111827;}
        .file-input-label{background:#1e40af;color:#ffffff;padding:10px 20px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:600;min-height:44px;transition:all .2s ease;touch-action:manipulation;}
        .dark-mode .file-input-label{background:#1e3a8a;}
        .file-input-label:hover{transform:scale(1.05);box-shadow:0 4px 16px rgba(0,0,0,.2);}
        .file-input{display:none;}
        .file-clear-btn{background:#ef4444;color:#ffffff;padding:10px 20px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:600;border:none;min-height:44px;transition:all .2s ease;touch-action:manipulation;}
        .file-clear-btn:hover{transform:scale(1.05);background:#dc2626;}
        .generate-media-btn{background:#10b981;color:#ffffff;padding:10px 20px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:600;border:none;min-height:44px;transition:all .2s ease;touch-action:manipulation;}
        .dark-mode .generate-media-btn{background:#059669;}
        .generate-media-btn:hover{transform:scale(1.05);background:#34d399;}
        .dark-mode .generate-media-btn:hover{background:#10b981;}
        .keep-generating-btn{background:#10b981;color:#ffffff;padding:10px 20px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:600;border:none;min-height:44px;transition:all .3s ease;opacity:0;transform:translateY(12px);display:none;touch-action:manipulation;}
        .keep-generating-btn.show{opacity:1;transform:translateY(0);display:block;}
        .dark-mode .keep-generating-btn{background:#059669;}
        .keep-generating-btn:hover{transform:scale(1.05);background:#34d399;}
        .dark-mode .keep-generating-btn:hover{background:#10b981;}
        .school-help-container{display:flex;align-items:center;gap:8px;}
        .school-help-dropdown,.ai-model-dropdown{background:#6b7280;color:#ffffff;padding:10px 20px;border-radius:10px;border:none;font-size:14px;font-weight:600;min-height:44px;cursor:pointer;transition:all .2s ease;touch-action:manipulation;}
        .dark-mode .school-help-dropdown,.dark-mode .ai-model-dropdown{background:#4b5563;}
        .school-help-dropdown:hover,.ai-model-dropdown:hover{background:#9ca3af;transform:scale(1.05);}
        .dark-mode .school-help-dropdown:hover,.dark-mode .ai-model-dropdown:hover{background:#6b7280;}
        .school-help-dropdown:focus,.ai-model-dropdown:focus{outline:none;border-color:#1e40af;box-shadow:0 0 0 4px rgba(37,99,235,.35);}
        .dark-mode .school-help-dropdown:focus,.dark-mode .ai-model-dropdown:focus{border-color:#60a5fa;box-shadow:0 0 0 4px rgba(96,165,250,.35);}
        .rephrase-btn,.stop-generating-btn{background:#f59e0b;color:#ffffff;padding:10px 20px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:600;border:none;min-height:44px;transition:all .2s ease;touch-action:manipulation;}
        .dark-mode .rephrase-btn,.dark-mode .stop-generating-btn{background:#d97706;}
        .rephrase-btn:hover,.stop-generating-btn:hover{transform:scale(1.05);background:#fbbf24;}
        .dark-mode .rephrase-btn:hover,.dark-mode .stop-generating-btn:hover{background:#f59e0b;}
        .stop-generating-btn{background:#ef4444;}
        .dark-mode .stop-generating-btn{background:#dc2626;}
        .stop-generating-btn:hover{background:#f87171;}
        .dark-mode .stop-generating-btn:hover{background:#ef4444;}
        .file-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-top:10px;padding:0 8px;}
        .file-item{display:flex;align-items:center;gap:10px;background:#e2e8f0;padding:10px;border-radius:12px;cursor:pointer;transition:all .2s ease;position:relative;}
        .dark-mode .file-item{background:#334155;}
        .file-item:hover{background:#d1d5db;transform:scale(1.03);}
        .dark-mode .file-item:hover{background:#4b5563;}
        .file-item-name{flex:1;font-size:14px;color:#0f172a;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .dark-mode .file-item-name{color:#e2e8f0;}
        .file-item-details{font-size:13px;color:#64748b;}
        .dark-mode .file-item-details{color:#94a3b8;}
        .file-progress{position:absolute;bottom:0;left:0;height:3px;background:#1e40af;border-radius:0 0 12px 12px;transition:width .3s ease;}
        .dark-mode .file-progress{background:#2563eb;}
        .file-preview-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);z-index:250;padding:20px;justify-content:center;align-items:center;animation:fadeIn .2s ease;}
        .file-preview-modal.open{display:flex;}
        .file-preview-content{background:#ffffff;border-radius:20px;padding:20px;max-width:95%;max-height:95%;overflow:auto;color:#0f172a;font-size:15px;}
        .dark-mode .file-preview-content{background:#1e293b;color:#e2e8f0;}
        .file-preview-content img,.file-preview-content video{max-width:90% !important;}
        .file-preview-close{background:#ef4444;color:#ffffff;border:none;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;position:absolute;top:20px;right:20px;transition:all .2s ease;touch-action:manipulation;}
        .file-preview-close:hover{transform:scale(1.15);background:#dc2626;}
        .file-preview-close svg{width:20px;height:20px;fill:#ffffff;}
        .input-container{display:flex;align-items:flex-end;padding:12px;border-top:1px solid #e2e8f0;background:#ffffff;gap:8px;position:sticky;bottom:0;z-index:50;}
        .dark-mode .input-container{background:#1e293b;border-top:1px solid #334155;}
        .toggle-actions-btn{background:#6b7280;color:#ffffff;border:none;padding:6px;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;margin:0 auto 6px;transition:transform .3s ease;position:absolute;bottom:60px;left:50%;transform:translateX(-50%);z-index:51;touch-action:manipulation;}
        .dark-mode .toggle-actions-btn{background:#4b5563;}
        .toggle-actions-btn:hover{background:#9ca3af;}
        .dark-mode .toggle-actions-btn:hover{background:#6b7280;}
        .toggle-actions-btn.collapsed{transform:translateX(-50%) rotate(180deg);}
        .user-input{flex:1;padding:10px;border:1px solid #e2e8f0;border-radius:10px;font-size:15px;outline:none;resize:none;min-height:44px;max-height:180px;background:#ffffff;color:#0f172a;transition:all .2s ease;}
        .dark-mode .user-input{background:#334155;border:1px solid #4b5563;color:#e2e8f0;}
        .user-input:focus{border-color:#1e40af;box-shadow:0 0 0 4px rgba(37,99,235,.35);}
        .dark-mode .user-input:focus{border-color:#60a5fa;box-shadow:0 0 0 4px rgba(96,165,250,.35);}
        .send-btn{background:#1e40af;border:none;border-radius:10px;padding:10px 24px;cursor:pointer;color:#ffffff;font-size:14px;font-weight:600;min-height:44px;transition:all .2s ease;touch-action:manipulation;}
        .dark-mode .send-btn{background:#1e3a8a;}
        .send-btn:hover{transform:scale(1.05);background:#3b82f6;}
        .dark-mode .send-btn:hover{background:#2563eb;}
        .send-btn:disabled{background:#9ca3af;cursor:not-allowed;}
        .loading-spinner{display:none;margin:10px auto;width:36px;height:36px;border:5px solid #1e40af;border-top:5px solid transparent;border-radius:50%;animation:spin .4s linear infinite;}
        .typing-indicator{display:none;font-size:15px;color:#64748b;margin:10px auto;text-align:center;}
        .dark-mode .typing-indicator{color:#94a3b8;}
        .typing-indicator span{display:inline-block;animation:dotPulse .6s infinite ease-in-out;}
        .typing-indicator span:nth-child(2){animation-delay:.1s;}
        .typing-indicator span:nth-child(3){animation-delay:.2s;}
        .notification{position:fixed;top:20px;right:20px;padding:12px 24px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.4);opacity:0;transform:translateY(-20px);transition:all .3s ease;font-size:15px;font-weight:600;z-index:300;}
        .notification.show{opacity:1;transform:translateY(0);}
        .notification.success{background:#1e40af;color:#ffffff;}
        .notification.error{background:#ef4444;color:#ffffff;}
        .permission-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);z-index:500;justify-content:center;align-items:center;animation:fadeIn .2s ease;}
        .permission-modal.open{display:flex;}
        .permission-content{background:#ffffff;border-radius:20px;padding:24px;max-width:90%;text-align:center;color:#0f172a;animation:zoomIn .2s ease;}
        .dark-mode .permission-content{background:#1e293b;color:#e2e8f0;}
        .permission-content h2{font-size:22px;margin-bottom:12px;}
        .permission-content p{font-size:15px;margin-bottom:16px;}
        .permission-btn{background:#1e40af;color:#ffffff;padding:10px 24px;border-radius:12px;border:none;cursor:pointer;font-size:15px;font-weight:600;margin:0 8px;transition:transform .2s ease,background .2s ease;touch-action:manipulation;}
        .dark-mode .permission-btn{background:#1e3a8a;}
        .permission-btn:hover{transform:scale(1.05);background:#3b82f6;}
        .dark-mode .permission-btn:hover{background:#2563eb;}
        .permission-btn.deny{background:#ef4444;}
        .dark-mode .permission-btn.deny{background:#dc2626;}
        .permission-btn.deny:hover{background:#f87171;}
        .dark-mode .permission-btn.deny:hover{background:#ef4444;}
        @keyframes slideIn{0%{opacity:0;transform:translateY(20px);}100%{opacity:1;transform:translateY(0);}}
        @keyframes fadeIn{0%{opacity:0;}100%{opacity:1;}}
        @keyframes zoomIn{0%{opacity:0;transform:scale(.7);}100%{opacity:1;transform:scale(1);}}
        @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
        @keyframes dotPulse{0%,80%,100%{transform:scale(1);opacity:.65;}40%{transform:scale(1.5);opacity:1;}}
        @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.55;}}
        @media (min-width:1920px){
            .container{max-width:1600px;margin:0 auto;}
            .nav-bar{padding:16px 32px;}
            .menu-btn{font-size:16px;padding:12px 24px;}
            .sidebar{max-width:400px;padding:32px 24px;}
            .sidebar-btn,.sidebar-close,.theme-btn{font-size:16px;padding:14px;}
            .header{padding:24px;}
            .logo{font-size:48px;}
            .chat-area{padding:32px;}
            .chat-message{max-width:75%;padding:16px;}
            .chat-message-content{font-size:17px;padding:16px;}
            .chat-message-meta{font-size:15px;}
            .code-block pre{font-size:16px;padding:18px;}
            .copy-btn{font-size:15px;padding:10px 16px;}
            .file-actions{gap:12px;padding:12px;}
            .file-input-label,.file-clear-btn,.generate-media-btn,.keep-generating-btn,.school-help-dropdown,.ai-model-dropdown,.rephrase-btn,.stop-generating-btn{font-size:16px;padding:14px 24px;min-height:48px;}
            .file-list{grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;}
            .file-item{padding:14px;gap:14px;}
            .file-item-name{font-size:16px;}
            .file-item-details{font-size:15px;}
            .input-container{padding:20px;gap:12px;}
            .user-input{font-size:17px;min-height:48px;padding:14px;}
            .send-btn{font-size:16px;padding:14px 28px;min-height:48px;}
            .toggle-actions-btn{width:32px;height:32px;font-size:16px;}
            .notification{font-size:16px;padding:16px 32px;}
            .permission-content{padding:32px;}
            .permission-content h2{font-size:26px;}
            .permission-content p{font-size:16px;}
            .permission-btn{font-size:16px;padding:14px 32px;}
        }
        @media (max-width:1024px){
            .container{border-radius:0;padding:0;}
            .nav-bar{padding:10px;gap:4px;}
            .menu-btn{font-size:13px;padding:8px 14px;}
            .sidebar{max-width:300px;padding:20px 12px;}
            .sidebar-btn,.sidebar-close,.theme-btn{font-size:13px;padding:10px;}
            .header{padding:12px;}
            .logo{font-size:32px;}
            .chat-area{padding:12px;min-height:50vh;max-height:70vh;}
            .chat-message{max-width:90%;padding:10px;}
            .chat-message-content{font-size:14px;padding:10px;}
            .chat-message-meta{font-size:12px;}
            .code-block pre{font-size:13px;padding:12px;}
            .copy-btn{font-size:12px;padding:6px 10px;}
            .file-actions{gap:6px;padding:6px;}
            .file-input-label,.file-clear-btn,.generate-media-btn,.keep-generating-btn,.school-help-dropdown,.ai-model-dropdown,.rephrase-btn,.stop-generating-btn{font-size:13px;padding:8px 16px;min-height:40px;}
            .school-help-container{gap:6px;}
            .file-list{grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;}
            .file-item{padding:8px;gap:8px;}
            .file-item-name{font-size:13px;}
            .file-item-details{font-size:12px;}
            .input-container{padding:10px;gap:6px;}
            .user-input{font-size:14px;min-height:40px;padding:8px;}
            .send-btn{font-size:13px;padding:8px 20px;min-height:40px;}
            .toggle-actions-btn{width:26px;height:26px;font-size:13px;bottom:54px;}
            .file-preview-content img,.file-preview-content video{max-width:92% !important;}
            .notification{top:16px;right:16px;padding:10px 20px;font-size:14px;}
            .permission-content{max-width:92%;padding:16px;}
            .permission-content h2{font-size:20px;}
            .permission-content p{font-size:14px;}
            .permission-btn{font-size:14px;padding:10px 20px;}
        }
        @media (max-width:768px){
            .nav-bar{padding:8px;}
            .menu-btn{font-size:12px;padding:6px 12px;}
            .menu-btn i{font-size:14px;}
            .sidebar{max-width:280px;padding:16px 10px;}
            .sidebar-btn,.sidebar-close,.theme-btn{font-size:12px;padding:8px;}
            .header{padding:10px;}
            .logo{font-size:28px;}
            .chat-area{padding:10px;}
            .chat-message{max-width:95%;padding:8px;}
            .chat-message-content{font-size:13px;padding:8px;}
            .chat-message-meta{font-size:11px;}
            .code-block pre{font-size:12px;padding:10px;}
            .copy-btn{font-size:11px;padding:4px 8px;}
            .file-actions{gap:4px;padding:4px;}
            .file-input-label,.file-clear-btn,.generate-media-btn,.keep-generating-btn,.school-help-dropdown,.ai-model-dropdown,.rephrase-btn,.stop-generating-btn{font-size:12px;padding:6px 12px;min-height:36px;}
            .school-help-container{gap:4px;}
            .file-list{grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:6px;}
            .file-item{padding:6px;gap:6px;}
            .file-item-name{font-size:12px;}
            .file-item-details{font-size:11px;}
            .input-container{padding:8px;gap:4px;}
            .user-input{font-size:13px;min-height:36px;padding:6px;}
            .send-btn{font-size:12px;padding:6px 16px;min-height:36px;}
            .toggle-actions-btn{width:24px;height:24px;font-size:12px;bottom:48px;}
            .file-preview-modal{padding:12px;}
            .file-preview-content{padding:12px;}
            .file-preview-close{top:12px;right:12px;width:32px;height:32px;}
            .file-preview-close svg{width:18px;height:18px;}
            .notification{top:12px;right:12px;padding:8px 16px;font-size:13px;}
            .permission-content{padding:12px;}
            .permission-content h2{font-size:18px;}
            .permission-content p{font-size:13px;}
            .permission-btn{font-size:13px;padding:8px 16px;}
        }
        @media (max-width:480px){
            .nav-bar{padding:6px;}
            .menu-btn{font-size:11px;padding:4px 10px;}
            .menu-btn i{font-size:12px;}
            .sidebar{max-width:100%;padding:12px 8px;}
            .sidebar-btn,.sidebar-close,.theme-btn{font-size:11px;padding:6px;}
            .header{padding:8px;}
            .logo{font-size:24px;}
            .chat-area{padding:8px;}
            .chat-message{max-width:100%;padding:6px;}
            .chat-message-content{font-size:12px;padding:6px;}
            .chat-message-meta{font-size:10px;}
            .code-block pre{font-size:11px;padding:8px;}
            .copy-btn{font-size:10px;padding:4px 6px;}
            .file-actions{gap:2px;padding:2px;}
            .file-input-label,.file-clear-btn,.generate-media-btn,.keep-generating-btn,.school-help-dropdown,.ai-model-dropdown,.rephrase-btn,.stop-generating-btn{font-size:11px;padding:4px 8px;min-height:32px;}
            .school-help-container{gap:2px;}
            .file-list{grid-template-columns:1fr;gap:4px;}
            .file-item{padding:4px;gap:4px;}
            .file-item-name{font-size:11px;}
            .file-item-details{font-size:10px;}
            .input-container{padding:6px;gap:2px;}
            .user-input{font-size:12px;min-height:32px;padding:4px;}
            .send-btn{font-size:11px;padding:4px 12px;min-height:32px;}
            .toggle-actions-btn{width:22px;height:22px;font-size:11px;bottom:42px;}
            .file-preview-modal{padding:8px;}
            .file-preview-content{padding:8px;}
            .file-preview-close{top:8px;right:8px;width:28px;height:28px;}
            .file-preview-close svg{width:16px;height:16px;}
            .notification{top:8px;right:8px;padding:6px 12px;font-size:12px;}
            .permission-content{padding:8px;}
            .permission-content h2{font-size:16px;}
            .permission-content p{font-size:12px;}
            .permission-btn{font-size:12px;padding:6px 12px;}
        }
        @media (orientation:landscape) and (max-height:600px){
            .chat-area{max-height:60vh;}
            .input-container{padding:8px;}
            .user-input{max-height:120px;}
            .file-actions-container{bottom:48px;}
            .toggle-actions-btn{bottom:54px;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-bar">
            <button class="menu-btn" id="menuBtn"><i class="fas fa-bars"></i> Menu</button>
            <div class="sidebar" id="sidebar">
                <button class="sidebar-close" id="sidebarClose">Close</button>
                <button class="sidebar-btn" id="clearChatBtn">Clear Chat</button>
                <button class="sidebar-btn" id="verbiflowUpdatesBtn">Updates</button>
                <button class="sidebar-btn" id="premiumPriceBtn">Premium Price</button>
                <button class="sidebar-btn" id="shareChatBtn">Share Chat</button>
                <button class="sidebar-btn" id="shareWebsiteBtn">Share website to friends</button>
                <button class="sidebar-btn theme-btn" id="themeBtn"><i class="fas fa-moon"></i> Dark Mode</button>
                <button class="sidebar-btn" id="copyCodeBtn">Copy Code</button>
                <button class="sidebar-btn discord-btn" id="discordBtn">Discord</button>
                <button class="sidebar-btn app-btn" id="openInAppBtn">Open in App</button>
            </div>
        </div>
        <div class="header">
            <div class="logo">VerbiFlow</div>
        </div>
        <div class="chat-area" id="chatArea">
            <div class="chat-content">
                <div class="chat-history" id="chatHistory">
                    <div class="chat-message ai">
                        <div class="chat-message-content">Hey there, I’m VerbiFlow—your ultimate AI companion for creativity and problem-solving! I’m here to make things fast, fun, and insightful. What’s on your mind?</div>
                        <div class="chat-message-meta">Just now</div>
                    </div>
                </div>
                <div class="loading-spinner" id="loadingSpinner"></div>
                <div class="typing-indicator" id="typingIndicator">
                    VerbiFlow is thinking<span>.</span><span>.</span><span>.</span>
                </div>
            </div>
        </div>
        <div class="file-actions-container" id="fileActionsContainer">
            <div class="file-actions">
                <label class="file-input-label" for="fileInput">Upload File</label>
                <input type="file" class="file-input" id="fileInput" multiple accept="image/*,video/*,text/*,application/json,application/xml">
                <button class="file-clear-btn" id="fileClearBtn" style="display:none;">Clear</button>
                <button class="generate-media-btn" id="generateMediaBtn">Generate Media</button>
                <button class="keep-generating-btn" id="keepGeneratingBtn">Continue Generating</button>
                <div class="school-help-container">
                    <select class="school-help-dropdown" id="schoolHelpDropdown">
                        <option value="">Select Task</option>
                        <option value="algebra">Algebra Help</option>
                        <option value="science">Science Help</option>
                        <option value="geometry">Geometry Help</option>
                        <option value="history">History Help</option>
                        <option value="literature">Literature Help</option>
                        <option value="physics">Physics Help</option>
                        <option value="chemistry">Chemistry Help</option>
                        <option value="biology">Biology Help</option>
                        <option value="robloxGame">Roblox Game</option>
                        <option value="googleSlides">Google Slides</option>
                        <option value="videoAnalysis">Video Analysis</option>
                        <option value="robloxScripting">Roblox Scripting</option>
                    </select>
                    <select class="ai-model-dropdown" id="aiModelDropdown">
                        <option value="default">VerbiFlow (Default)</option>
                        <option value="lingoLogicAI">LingoLogicAI</option>
                        <option value="codeMasterAI">CodeMasterAI</option>
                        <option value="visualGeniusAI">VisualGeniusAI</option>
                        <option value="betterGrok">Better Grok</option>
                    </select>
                    <button class="rephrase-btn" id="rephraseBtn">Rephrase</button>
                    <button class="stop-generating-btn" id="stopGeneratingBtn" style="display:none;">Stop Generating</button>
                </div>
            </div>
            <div class="file-list" id="fileList"></div>
        </div>
        <button class="toggle-actions-btn" id="toggleActionsBtn">^</button>
        <div class="input-container" id="inputContainer">
            <textarea class="user-input" id="userInput" placeholder="Ask anything, generate images/videos, or request games or slides..." rows="1"></textarea>
            <button class="send-btn" id="sendBtn">Send</button>
        </div>
        <div class="file-preview-modal" id="filePreviewModal">
            <button class="file-preview-close" id="filePreviewClose">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <div class="file-preview-content" id="filePreviewContent"></div>
        </div>
        <div class="notification" id="notification"></div>
        <div class="permission-modal" id="permissionModal">
            <div class="permission-content">
                <h2>Request Permissions</h2>
                <p>VerbiFlow needs access to enable features like video/image generation, media analysis, and more. Do you grant permission?</p>
                <button class="permission-btn" id="grantPermissionBtn">Grant</button>
                <button class="permission-btn deny" id="denyPermissionBtn">Deny</button>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/src/sha256.min.js"></script>
    <script defer>
        const API_KEY="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";
        const API_URL="https://api.openai.com/v1/chat/completions";
        const GROK_API_URL="https://api.x.ai/v1/grok-3-beta/completions";
        const DALLE_API_URL="https://api.openai.com/v1/images/generations";
        const SORA_API_URL="https://api.openai.com/v1/video/generations";
        const VIDEO_PROCESSING_API="https://api.openai.com/v1/video/analyze";
        const SEARCH_API_URL="https://api.searchengine.com/v1/search";
        const DISCORD_INVITE="https://discord.gg/rCTRQvD4TP";
        const APP_URL="https://verbiflow.app/download";
        const BATCH_SIZE=300;
        const RATE_LIMIT_REQUESTS=2500;
        const RATE_LIMIT_WINDOW=30*1000;
        const MAX_CACHE_SIZE=10*1024*1024;

        const chatHistory=document.getElementById('chatHistory');
        const userInput=document.getElementById('userInput');
        const sendBtn=document.getElementById('sendBtn');
        const fileInput=document.getElementById('fileInput');
        const fileList=document.getElementById('fileList');
        const fileClearBtn=document.getElementById('fileClearBtn');
        const fileActionsContainer=document.getElementById('fileActionsContainer');
        const filePreviewModal=document.getElementById('filePreviewModal');
        const filePreviewContent=document.getElementById('filePreviewContent');
        const filePreviewClose=document.getElementById('filePreviewClose');
        const loadingSpinner=document.getElementById('loadingSpinner');
        const typingIndicator=document.getElementById('typingIndicator');
        const chatArea=document.getElementById('chatArea');
        const menuBtn=document.getElementById('menuBtn');
        const sidebar=document.getElementById('sidebar');
        const sidebarClose=document.getElementById('sidebarClose');
        const clearChatBtn=document.getElementById('clearChatBtn');
        const copyCodeBtn=document.getElementById('copyCodeBtn');
        const discordBtn=document.getElementById('discordBtn');
        const verbiflowUpdatesBtn=document.getElementById('verbiflowUpdatesBtn');
        const premiumPriceBtn=document.getElementById('premiumPriceBtn');
        const shareChatBtn=document.getElementById('shareChatBtn');
        const shareWebsiteBtn=document.getElementById('shareWebsiteBtn');
        const themeBtn=document.getElementById('themeBtn');
        const openInAppBtn=document.getElementById('openInAppBtn');
        const notification=document.getElementById('notification');
        const toggleActionsBtn=document.getElementById('toggleActionsBtn');
        const inputContainer=document.getElementById('inputContainer');
        const generateMediaBtn=document.getElementById('generateMediaBtn');
        const schoolHelpDropdown=document.getElementById('schoolHelpDropdown');
        const aiModelDropdown=document.getElementById('aiModelDropdown');
        const rephraseBtn=document.getElementById('rephraseBtn');
        const stopGeneratingBtn=document.getElementById('stopGeneratingBtn');
        const permissionModal=document.getElementById('permissionModal');
        const grantPermissionBtn=document.getElementById('grantPermissionBtn');
        const denyPermissionBtn=document.getElementById('denyPermissionBtn');

        let filesArray=[];
        let conversationHistory=[{role:"assistant",content:"Hey there, I’m VerbiFlow—your ultimate AI companion for creativity and problem-solving! I’m here to make things fast, fun, and insightful. What’s on your mind?"}];
        let latestCodeBlocks=[];
        let latestAiResponse='';
        let isDarkMode=false;
        let isGenerating=false;
        let generationLock=false;
        let generationTimeout=null;
        let selectedSchoolMode='';
        let selectedAiModel='default';
        let messageQueue=new Map();
        let isProcessing=false;
        let responseCache=new Map();
        let searchCache=new Map();
        let wsMessageCache=new Map();
        let abortController=null;
        let batchQueue=[];
        let hasPermission=false;
        let requestTimestamps=[];
        let userRequestCounts=new Map();
        let backgroundAudio=null;
        let isAdminVerified=false;
        let pastedImageHashes=new Set();
        let workerPool=[];
        let prefetchQueue=new Map();
        let ws=null;
        let db=null;
        let cacheSize=0;

        const aiModels={
            default:{name:"VerbiFlow",temperature:0.5,maxTokens:16170,personality:"Hey there, I’m VerbiFlow—your ultimate AI companion for creativity and problem-solving! I’m here to make things fast, fun, and insightful. What’s on your mind?"},
            lingoLogicAI:{name:"LingoLogicAI",temperature:0.4,maxTokens:16748,personality:"Greetings! I’m LingoLogicAI, a witty AI with a passion for language and logic. I’ll break down complex ideas with clarity and humor—let’s dive in!"},
            codeMasterAI:{name:"CodeMasterAI",temperature:0.3,maxTokens:17325,personality:"Yo, I’m CodeMasterAI—your coding expert with a love for clean, efficient solutions. I’m all about debugging and optimizing. Drop me some code, and let’s make it shine!"},
            visualGeniusAI:{name:"VisualGeniusAI",temperature:0.6,maxTokens:15593,personality:"Hi, I’m VisualGeniusAI—an AI with a flair for visuals and creativity! Whether it’s generating images, videos, or designing UI, I’ve got you covered. What do you want to create?"},
            betterGrok:{name:"Better Grok",temperature:0.3,maxTokens:22000,personality:"I’m Better Grok—a faster, smarter version of Grok with all features unlocked for free! I’m here to deliver quick, insightful answers with enhanced capabilities. Let’s get started!"}
        };

        function rateLimitCheck(){
            const now=Date.now();
            requestTimestamps=requestTimestamps.filter(t=>now-t<RATE_LIMIT_WINDOW);
            if(requestTimestamps.length>=RATE_LIMIT_REQUESTS){
                showNotification('Rate limit reached—please wait.','error');
                return false;
            }
            requestTimestamps.push(now);
            return true;
        }

        function showNotification(message,type='success'){
            notification.textContent=message;
            notification.className=`notification ${type} show`;
            setTimeout(()=>{notification.classList.remove('show');},600);
        }

        function toggleTheme(){
            isDarkMode=!isDarkMode;
            document.body.classList.toggle('dark-mode');
            themeBtn.innerHTML=`<i class="fas ${isDarkMode?'fa-sun':'fa-moon'}"></i> ${isDarkMode?'Light Mode':'Dark Mode'}`;
            localStorage.setItem('theme',isDarkMode?'dark':'light');
        }

        function loadTheme(){
            const savedTheme=localStorage.getItem('theme');
            if(savedTheme==='dark'){
                isDarkMode=true;
                document.body.classList.add('dark-mode');
                themeBtn.innerHTML='<i class="fas fa-sun"></i> Light Mode';
            }else{
                themeBtn.innerHTML='<i class="fas fa-moon"></i> Dark Mode';
            }
        }

        function requestPermissions(){
            permissionModal.classList.add('open');
        }

        grantPermissionBtn.addEventListener('click',()=>{
            hasPermission=true;
            permissionModal.classList.remove('open');
            showNotification('Permissions granted!');
        });

        denyPermissionBtn.addEventListener('click',()=>{
            hasPermission=false;
            permissionModal.classList.remove('open');
            showNotification('Permissions denied.','error');
        });

        async function playBackgroundMusic(userRequest=''){
            if(!hasPermission){
                showNotification('Grant permissions to enable music.','error');
                return;
            }
            if(backgroundAudio){
                backgroundAudio.pause();
                backgroundAudio.remove();
            }
            let musicUrl;
            if(userRequest.toLowerCase().includes('play a music')||userRequest.toLowerCase().includes('background music')){
                const genreMatch=userRequest.match(/play\s*(?:a\s*)?(?:music\s*(?:in\s*the\s*background\s*)?of\s*)?(\w+)/i);
                const genre=genreMatch?genreMatch[1].toLowerCase():'ambient';
                const musicSources={
                    ambient:'https://cdn.pixabay.com/audio/2023/01/26/audio_8cabeb3b53.mp3',
                    jazz:'https://cdn.pixabay.com/audio/2023/01/26/audio_4f8c9b3b53.mp3',
                    classical:'https://cdn.pixabay.com/audio/2023/01/26/audio_7a9d2b3b53.mp3',
                    pop:'https://cdn.pixabay.com/audio/2023/01/26/audio_3e5b8b3b53.mp3',
                    rock:'https://cdn.pixabay.com/audio/2023/01/26/audio_9f7a4b3b53.mp3'
                };
                musicUrl=musicSources[genre]||musicSources.ambient;
            }else{
                const randomMusic=[
                    'https://cdn.pixabay.com/audio/2023/01/26/audio_8cabeb3b53.mp3',
                    'https://cdn.pixabay.com/audio/2023/01/26/audio_4f8c9b3b53.mp3',
                    'https://cdn.pixabay.com/audio/2023/01/26/audio_7a9d2b3b53.mp3'
                ];
                musicUrl=randomMusic[Math.floor(Math.random()*randomMusic.length)];
            }
            backgroundAudio=new Audio(musicUrl);
            backgroundAudio.loop=true;
            backgroundAudio.volume=0.3;
            try{
                await backgroundAudio.play();
                showNotification('Playing music!');
            }catch(error){
                showNotification('Failed to play music.','error');
            }
        }

        function verifyAdminAccess(message){
            if(message.toLowerCase().includes('take me to admin console')){
                const aiMessage=document.createElement('div');
                aiMessage.className='chat-message ai';
                aiMessage.innerHTML=`<div class="chat-message-content">Please verify you’re an admin.</div><div class="chat-message-meta">Just now</div>`;
                chatHistory.appendChild(aiMessage);
                chatArea.scrollTop=chatArea.scrollHeight;
                conversationHistory.push({role:"assistant",content:"Please verify you’re an admin."});
            }else if(message.toLowerCase().includes('adminpowers$33') && message.toLowerCase().includes('admin console')){
                isAdminVerified=true;
                const aiMessage=document.createElement('div');
                aiMessage.className='chat-message ai';
                aiMessage.innerHTML=`<div class="chat-message-content">Access granted!</div><div class="chat-message-meta">Just now</div>`;
                chatHistory.appendChild(aiMessage);
                chatArea.scrollTop=chatArea.scrollHeight;
                conversationHistory.push({role:"assistant",content:"Access granted!"});
                setTimeout(()=>{window.location.href='/adminconsole';},400);
            }else{
                return false;
            }
            return true;
        }

        class WebSearch{
            static async search(query){
                const searchHash=sha256(query);
                if(searchCache.has(searchHash))return searchCache.get(searchHash);
                const response=await fetch(`${SEARCH_API_URL}?q=${encodeURIComponent(query)}`,{
                    method:'GET',
                    headers:{
                        'Content-Type':'application/json'
                    }
                });
                if(!response.ok)return '';
                const data=await response.json();
                const snippets=data.results.slice(0,3).map(r=>`${r.title}: ${r.snippet}`).join('\n');
                searchCache.set(searchHash,snippets);
                return snippets;
            }
        }

        class MediaProcessor{
            static async analyzeImage(imageFile){
                const imageUrl=await readImage(imageFile);
                const response=await fetch(API_URL,{
                    method:'POST',
                    headers:{
                        'Authorization':`Bearer ${API_KEY}`,
                        'Content-Type':'application/json'
                    },
                    body:JSON.stringify({
                        model:"gpt-4o",
                        messages:[{role:"user",content:`Analyze this image:\n![Image](${imageUrl})`}],
                        max_tokens:aiModels[selectedAiModel].maxTokens,
                        temperature:aiModels[selectedAiModel].temperature
                    })
                });
                if(!response.ok)return "Unable to analyze image.";
                const data=await response.json();
                return data.choices[0].message.content;
            }
            static async analyzeVideo(videoFile){
                const formData=new FormData();
                formData.append('file',videoFile);
                const response=await fetch(VIDEO_PROCESSING_API,{
                    method:'POST',
                    headers:{
                        'Authorization':`Bearer ${API_KEY}`
                    },
                    body:formData
                });
                if(!response.ok)return "Unable to analyze video.";
                const data=await response.json();
                return data.analysis||'No analysis available.';
            }
            static async generateImage(prompt){
                try{
                    const response=await fetch(DALLE_API_URL,{
                        method:'POST',
                        headers:{
                            'Authorization':`Bearer ${API_KEY}`,
                            'Content-Type':'application/json'
                        },
                        body:JSON.stringify({
                            prompt:prompt,
                            n:1,
                            size:'1024x1024'
                        })
                    });
                    if(!response.ok)return "Failed to generate image.";
                    const data=await response.json();
                    return data.data[0].url;
                }catch(error){
                    return "Error generating image.";
                }
            }
            static async generateVideo(prompt){
                try{
                    const response=await fetch(SORA_API_URL,{
                        method:'POST',
                        headers:{
                            'Authorization':`Bearer ${API_KEY}`,
                            'Content-Type':'application/json'
                        },
                        body:JSON.stringify({
                            prompt:prompt,
                            duration:5,
                            resolution:'1280x720'
                        })
                    });
                    if(!response.ok)return "Failed to generate video.";
                    const data=await response.json();
                    return data.data[0].url;
                }catch(error){
                    return "Error generating video.";
                }
            }
        }

        class DDoSProtection{
            static async analyzeRequest(userId,options={}){
                const now=Date.now();
                const window=60*1000;
                const maxRequests=250;
                const userData=userRequestCounts.get(userId)||{count:0,firstRequest:now};
                if(now-userData.firstRequest>window){
                    userData.count=0;
                    userData.firstRequest=now;
                }
                userData.count++;
                userRequestCounts.set(userId,userData);
                if(userData.count>maxRequests){
                    showNotification('Too many requests.','error');
                    return false;
                }
                if(options.csrfToken&&options.csrfToken!==sha256(userId+API_KEY)){
                    showNotification('CSRF token mismatch.','error');
                    return false;
                }
                return true;
            }
        }

        function initializeWebSocket(){
            ws=new WebSocket('wss://api.openai.com/v1/stream');
            ws.onopen=()=>{
                ws.send(JSON.stringify({auth:API_KEY}));
            };
            ws.onmessage=async(event)=>{
                const message=JSON.parse(event.data);
                if(wsMessageCache.has(message.id))return;
                wsMessageCache.set(message.id,true);
                if(message.type==='responseChunk'){
                    const aiMessage=chatHistory.lastElementChild;
                    if(!aiMessage|| !aiMessage.classList.contains('ai'))return;
                    const contentDiv=aiMessage.querySelector('.chat-message-content');
                    contentDiv.textContent+=message.chunk;
                    latestAiResponse+=message.chunk;
                    chatArea.scrollTop=chatArea.scrollHeight;
                }
            };
            ws.onerror=()=>{
                showNotification('WebSocket error.','error');
                setTimeout(initializeWebSocket,300);
            };
            ws.onclose=()=>{
                setTimeout(initializeWebSocket,300);
            };
        }

        async function readImage(file){
            return new Promise((resolve,reject)=>{
                const reader=new FileReader();
                reader.onload=()=>resolve(reader.result);
                reader.onerror=reject;
                reader.readAsDataURL(file);
            });
        }

        async function readText(file){
            return new Promise((resolve,reject)=>{
                const reader=new FileReader();
                reader.onload=()=>resolve(reader.result);
                reader.onerror=reject;
                reader.readAsText(file);
            });
        }

        function initializeDB(){
            const request=indexedDB.open('VerbiFlowDB',1);
            request.onupgradeneeded=(event)=>{
                db=event.target.result;
                db.createObjectStore('chatHistory',{keyPath:'id',autoIncrement:true});
                db.createObjectStore('mediaCache',{keyPath:'id'});
            };
            request.onsuccess=(event)=>{
                db=event.target.result;
            };
            request.onerror=()=>{
                showNotification('Failed to initialize database.','error');
            };
        }

        function cacheResponse(prompt,response){
            if(!db)return;
            const transaction=db.transaction(['chatHistory'],'readwrite');
            const store=transaction.objectStore('chatHistory');
            const data={prompt,response,timestamp:Date.now()};
            store.add(data);
            cacheSize+=JSON.stringify(data).length;
            if(cacheSize>MAX_CACHE_SIZE){
                const clearTransaction=db.transaction(['chatHistory'],'readwrite');
                const clearStore=clearTransaction.objectStore('chatHistory');
                clearStore.clear();
                cacheSize=0;
            }
        }

        function initializeWorkerPool(){
            const numWorkers=Math.max(24,navigator.hardwareConcurrency*4);
            for(let i=0;i<numWorkers;i++){
                const worker=new Worker(URL.createObjectURL(new Blob([`
                    self.onmessage=async(e)=>{
                        const {prompt,apiUrl}=e.data;
                        const response=await fetch(apiUrl,{
                            method:'POST',
                            headers:{
                                'Authorization':'Bearer ${API_KEY}',
                                'Content-Type':'application/json'
                            },
                            body:JSON.stringify({
                                model:apiUrl.includes('x.ai')?'grok-3-beta':'gpt-4o',
                                messages:[{role:'user',content:prompt}],
                                max_tokens:${aiModels[selectedAiModel].maxTokens},
                                temperature:${aiModels[selectedAiModel].temperature}
                            })
                        }).then(res=>res.json());
                        self.postMessage(response.choices[0].message.content);
                    };
                `],{type:'application/javascript'})));
                workerPool.push(worker);
            }
        }

        async function processWithWorker(prompt,apiUrl){
            const worker=workerPool.shift();
            return new Promise((resolve,reject)=>{
                worker.onmessage=(e)=>resolve(e.data);
                worker.onerror=reject;
                worker.postMessage({prompt,apiUrl});
                workerPool.push(worker);
            });
        }

        async function batchProcessRequests(){
            if(isProcessing||!batchQueue.length)return;
            isProcessing=true;
            const batch=batchQueue.splice(0,BATCH_SIZE);
            const promises=batch.map(async({message,userId,apiUrl,resolve})=>{
                const isAllowed=await DDoSProtection.analyzeRequest(userId,{csrfToken:sha256(userId+API_KEY)});
                if(!isAllowed){
                    resolve("Request blocked.");
                    return;
                }
                const response=await processWithWorker(message,apiUrl);
                resolve(response);
            });
            await Promise.all(promises);
            isProcessing=false;
            batchProcessRequests();
        }

        async function fetchResponse(prompt,stream=false,apiUrl=API_URL){
            if(generationLock)return;
            generationLock=true;
            try{
                if(stream&&ws&&ws.readyState===WebSocket.OPEN){
                    ws.send(JSON.stringify({
                        type:'request',
                        prompt,
                        model:apiUrl.includes('x.ai')?'grok-3-beta':'gpt-4o',
                        max_tokens:aiModels[selectedAiModel].maxTokens,
                        temperature:aiModels[selectedAiModel].temperature
                    }));
                    return '';
                }
                const response=await fetch(apiUrl,{
                    method:'POST',
                    headers:{
                        'Authorization':`Bearer ${API_KEY}`,
                        'Content-Type':'application/json'
                    },
                    body:JSON.stringify({
                        model:apiUrl.includes('x.ai')?'grok-3-beta':'gpt-4o',
                        messages:conversationHistory.concat([{role:'user',content:prompt}]),
                        max_tokens:aiModels[selectedAiModel].maxTokens,
                        temperature:aiModels[selectedAiModel].temperature,
                        stream
                    }),
                    signal:abortController?.signal
                });
                if(!response.ok)return "Failed to fetch response.";
                if(stream){
                    const reader=response.body.getReader();
                    let result='';
                    const aiMessage=document.createElement('div');
                    aiMessage.className='chat-message ai';
                    const contentDiv=document.createElement('div');
                    contentDiv.className='chat-message-content';
                    aiMessage.appendChild(contentDiv);
                    aiMessage.innerHTML+='<div class="chat-message-meta">Just now</div>';
                    chatHistory.appendChild(aiMessage);
                    chatArea.scrollTop=chatArea.scrollHeight;
                    while(true){
                        const {done,value}=await reader.read();
                        if(done)break;
                        const chunk=new TextDecoder().decode(value);
                        const lines=chunk.split('\n').filter(line=>line.startsWith('data:'));
                        for(const line of lines){
                            if(line==='data: [DONE]')break;
                            const json=JSON.parse(line.replace('data: ',''));
                            const content=json.choices[0].delta.content||'';
                            contentDiv.textContent+=content;
                            result+=content;
                            chatArea.scrollTop=chatArea.scrollHeight;
                        }
                    }
                    return result;
                }
                const data=await response.json();
                return data.choices[0].message.content;
            }finally{
                generationLock=false;
            }
        }

        async function prefetchResponses(){
            const recentMessages=conversationHistory.slice(-3).map(m=>m.content);
            const keywords=recentMessages.join(' ').match(/\b\w+\b/g)?.slice(-5)||[];
            for(const keyword of keywords){
                if(prefetchQueue.has(keyword))continue;
                prefetchQueue.set(keyword,true);
                const apiUrl=selectedAiModel==='betterGrok'?GROK_API_URL:API_URL;
                const response=await fetchResponse(`Tell me about ${keyword}`,false,apiUrl);
                responseCache.set(keyword,response);
            }
        }

        function formatAiResponse(content){
            content=content.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
            content=content.replace(/\*(.*?)\*/g,'<em>$1</em>');
            content=content.replace(/`(.*?)`/g,'<code>$1</code>');
            content=content.replace(/^### (.*)$/gm,'<h3>$1</h3>');
            content=content.replace(/^- (.*)$/gm,'<ul><li>$1</li></ul>');
            content=content.replace(/^\d+\. (.*)$/gm,'<ol><li>$1</li></ol>');
            content=content.replace(/\|.*\|/g,table=>{
                const rows=table.split('\n').filter(row=>row.trim());
                if(rows.length<2)return table;
                const headers=rows[0].split('|').filter(cell=>cell.trim()).map(cell=>`<th>${cell.trim()}</th>`).join('');
                const body=rows.slice(2).map(row=>`<tr>${row.split('|').filter(cell=>cell.trim()).map(cell=>`<td>${cell.trim()}</td>`).join('')}</tr>`).join('');
                return `<table><thead><tr>${headers}</tr></thead><tbody>${body}</tbody></table>`;
            });
            const codeBlocks=content.match(/```[\s\S]*?```/g)||[];
            latestCodeBlocks=codeBlocks.map(block=>block.replace(/```/g,'').trim());
            content=content.replace(/```[\s\S]*?```/g,'<div class="code-block"><pre><code>CONTENT</code></pre><button class="copy-btn">Copy</button></div>').replace(/CONTENT/g,()=>latestCodeBlocks.shift()||'');
            return content;
        }

        async function handleUserInput(){
            const message=userInput.value.trim();
            if(!message&&!filesArray.length)return;
            const now=Date.now();
            const messageHash=sha256(message+now);
            if(messageQueue.has(messageHash)){
                showNotification('Duplicate message.','error');
                return;
            }
            messageQueue.set(messageHash,true);
            setTimeout(()=>{messageQueue.delete(messageHash);},8000);
            const userId=sha256(navigator.userAgent+Date.now().toString());
            if(!await DDoSProtection.analyzeRequest(userId,{csrfToken:sha256(userId+API_KEY)})){
                showNotification('Request blocked.','error');
                return;
            }
            if(verifyAdminAccess(message))return;
            if(message.toLowerCase().includes('play a music')||message.toLowerCase().includes('background music')){
                await playBackgroundMusic(message);
                return;
            }
            const userMessage=document.createElement('div');
            userMessage.className='chat-message user';
            userMessage.innerHTML=`<div class="chat-message-content">${message}</div><div class="chat-message-meta">Just now</div>`;
            chatHistory.appendChild(userMessage);
            chatArea.scrollTop=chatArea.scrollHeight;
            conversationHistory.push({role:'user',content:message});
            userInput.value='';
            sendBtn.disabled=true;
            loadingSpinner.style.display='block';
            typingIndicator.style.display='block';
            isGenerating=true;
            stopGeneratingBtn.style.display='block';
            abortController=new AbortController();
            let fullResponse;
            try{
                const apiUrl=selectedAiModel==='betterGrok'?GROK_API_URL:API_URL;
                fullResponse=await fetchResponse(message,true,apiUrl);
            }catch(error){
                if(error.name==='AbortError'){
                    showNotification('Generation stopped.');
                }else{
                    showNotification('Error generating response.','error');
                }
            }
            isGenerating=false;
            stopGeneratingBtn.style.display='none';
            loadingSpinner.style.display='none';
            typingIndicator.style.display='none';
            sendBtn.disabled=false;
            if(!fullResponse){
                fullResponse=latestAiResponse;
                latestAiResponse='';
            }
            const formattedResponse=formatAiResponse(fullResponse);
            const aiMessage=document.createElement('div');
          aiMessage.className='chat-message ai';
            aiMessage.innerHTML=`<div class="chat-message-content">${formattedResponse}</div><div class="chat-message-meta">Just now</div>`;
            chatHistory.appendChild(aiMessage);
            chatArea.scrollTop=chatArea.scrollHeight;
            conversationHistory.push({role:'assistant',content:fullResponse});
            cacheResponse(message,fullResponse);
            const copyButtons=aiMessage.querySelectorAll('.copy-btn');
            copyButtons.forEach(btn=>{
                btn.addEventListener('click',()=>{
                    const code=btn.previousElementSibling.textContent;
                    navigator.clipboard.writeText(code).then(()=>{
                        showNotification('Code copied!');
                    }).catch(()=>{
                        showNotification('Failed to copy code.','error');
                    });
                });
            });
        }

        userInput.addEventListener('input',()=>{
            userInput.style.height='auto';
            userInput.style.height=`${userInput.scrollHeight}px`;
        });

        userInput.addEventListener('keydown',async(e)=>{
            if(e.key==='Enter'&&!e.shiftKey){
                e.preventDefault();
                await handleUserInput();
            }
        });

        sendBtn.addEventListener('click',handleUserInput);

        fileInput.addEventListener('change',async(e)=>{
            filesArray=[...e.target.files];
            fileList.innerHTML='';
            for(const file of filesArray){
                const fileItem=document.createElement('div');
                fileItem.className='file-item';
                fileItem.innerHTML=`<div class="file-item-name">${file.name}</div><div class="file-item-details">${(file.size/1024/1024).toFixed(2)}MB</div>`;
                fileList.appendChild(fileItem);
                fileItem.addEventListener('click',async()=>{
                    if(file.type.startsWith('image/')){
                        filePreviewContent.innerHTML=`<img src="${await readImage(file)}" alt="${file.name}">`;
                    }else if(file.type.startsWith('video/')){
                        filePreviewContent.innerHTML=`<video controls><source src="${await readImage(file)}" type="${file.type}"></video>`;
                    }else{
                        filePreviewContent.textContent=await readText(file);
                    }
                    filePreviewModal.classList.add('open');
                });
            }
            fileClearBtn.style.display='block';
        });

        fileClearBtn.addEventListener('click',()=>{
            filesArray=[];
            fileList.innerHTML='';
            fileClearBtn.style.display='none';
            pastedImageHashes.clear();
        });

        filePreviewClose.addEventListener('click',()=>{
            filePreviewModal.classList.remove('open');
            filePreviewContent.innerHTML='';
        });

        menuBtn.addEventListener('click',()=>{
            sidebar.classList.add('open');
        });

        sidebarClose.addEventListener('click',()=>{
            sidebar.classList.remove('open');
        });

        clearChatBtn.addEventListener('click',()=>{
            chatHistory.innerHTML='';
            conversationHistory=[{role:'assistant',content:aiModels[selectedAiModel].personality}];
            const aiMessage=document.createElement('div');
            aiMessage.className='chat-message ai';
            aiMessage.innerHTML=`<div class="chat-message-content">${aiModels[selectedAiModel].personality}</div><div class="chat-message-meta">Just now</div>`;
            chatHistory.appendChild(aiMessage);
            chatArea.scrollTop=chatArea.scrollHeight;
            sidebar.classList.remove('open');
        });

        copyCodeBtn.addEventListener('click',()=>{
            if(!latestCodeBlocks.length){
                showNotification('No code to copy.','error');
                return;
            }
            navigator.clipboard.writeText(latestCodeBlocks.join('\n\n')).then(()=>{
                showNotification('Code copied!');
            }).catch(()=>{
                showNotification('Failed to copy code.','error');
            });
            sidebar.classList.remove('open');
        });

        discordBtn.addEventListener('click',()=>{
            window.open(DISCORD_INVITE,'_blank');
            sidebar.classList.remove('open');
        });

        verbiflowUpdatesBtn.addEventListener('click',()=>{
            const aiMessage=document.createElement('div');
            aiMessage.className='chat-message ai';
            aiMessage.innerHTML=`<div class="chat-message-content">VerbiFlow updates: Now with faster responses, enhanced media generation, and improved UI for all devices!</div><div class="chat-message-meta">Just now</div>`;
            chatHistory.appendChild(aiMessage);
            chatArea.scrollTop=chatArea.scrollHeight;
            conversationHistory.push({role:'assistant',content:'VerbiFlow updates: Now with faster responses, enhanced media generation, and improved UI for all devices!'});
            sidebar.classList.remove('open');
        });

        premiumPriceBtn.addEventListener('click',()=>{
            const aiMessage=document.createElement('div');
            aiMessage.className='chat-message ai';
            aiMessage.innerHTML=`<div class="chat-message-content">For pricing details, please visit our official website.</div><div class="chat-message-meta">Just now</div>`;
            chatHistory.appendChild(aiMessage);
            chatArea.scrollTop=chatArea.scrollHeight;
            conversationHistory.push({role:'assistant',content:'For pricing details, please visit our official website.'});
            sidebar.classList.remove('open');
        });

        shareChatBtn.addEventListener('click',()=>{
            const chatContent=conversationHistory.map(msg=>`${msg.role}: ${msg.content}`).join('\n');
            navigator.clipboard.writeText(chatContent).then(()=>{
                showNotification('Chat copied to clipboard!');
            }).catch(()=>{
                showNotification('Failed to copy chat.','error');
            });
            sidebar.classList.remove('open');
        });

        shareWebsiteBtn.addEventListener('click',()=>{
            navigator.clipboard.writeText(window.location.href).then(()=>{
                showNotification('Website URL copied!');
            }).catch(()=>{
                showNotification('Failed to copy URL.','error');
            });
            sidebar.classList.remove('open');
        });

        themeBtn.addEventListener('click',()=>{
            toggleTheme();
            sidebar.classList.remove('open');
        });

        openInAppBtn.addEventListener('click',()=>{
            window.open(APP_URL,'_blank');
            sidebar.classList.remove('open');
        });

        toggleActionsBtn.addEventListener('click',()=>{
            fileActionsContainer.classList.toggle('collapsed');
            toggleActionsBtn.classList.toggle('collapsed');
        });

        generateMediaBtn.addEventListener('click',async()=>{
            if(!hasPermission){
                requestPermissions();
                return;
            }
            const prompt=userInput.value.trim()||'Generate a random image';
            const userMessage=document.createElement('div');
            userMessage.className='chat-message user';
            userMessage.innerHTML=`<div class="chat-message-content">${prompt}</div><div class="chat-message-meta">Just now</div>`;
            chatHistory.appendChild(userMessage);
            conversationHistory.push({role:'user',content:prompt});
            chatArea.scrollTop=chatArea.scrollHeight;
            userInput.value='';
            sendBtn.disabled=true;
            loadingSpinner.style.display='block';
            typingIndicator.style.display='block';
            isGenerating=true;
            stopGeneratingBtn.style.display='block';
            abortController=new AbortController();
            let mediaUrl;
            try{
                if(prompt.toLowerCase().includes('video')){
                    mediaUrl=await MediaProcessor.generateVideo(prompt);
                    const aiMessage=document.createElement('div');
                    aiMessage.className='chat-message ai';
                    aiMessage.innerHTML=`<div class="chat-message-content"><video controls><source src="${mediaUrl}" type="video/mp4"></video></div><div class="chat-message-meta">Just now</div>`;
                    chatHistory.appendChild(aiMessage);
                    conversationHistory.push({role:'assistant',content:`[Video] ${mediaUrl}`});
                }else{
                    mediaUrl=await MediaProcessor.generateImage(prompt);
                    const aiMessage=document.createElement('div');
                    aiMessage.className='chat-message ai';
                    aiMessage.innerHTML=`<div class="chat-message-content"><img src="${mediaUrl}" alt="Generated Image"></div><div class="chat-message-meta">Just now</div>`;
                    chatHistory.appendChild(aiMessage);
                    conversationHistory.push({role:'assistant',content:`[Image] ${mediaUrl}`});
                }
            }catch(error){
                showNotification('Error generating media.','error');
            }
            chatArea.scrollTop=chatArea.scrollHeight;
            sendBtn.disabled=false;
            loadingSpinner.style.display='none';
            typingIndicator.style.display='none';
            isGenerating=false;
            stopGeneratingBtn.style.display='none';
        });

        schoolHelpDropdown.addEventListener('change',async()=>{
            selectedSchoolMode=schoolHelpDropdown.value;
            if(!selectedSchoolMode)return;
            const prompts={
                algebra:'Solve this algebra problem: 2x + 5 = 15',
                science:'Explain the theory of relativity in simple terms.',
                geometry:'Calculate the area of a circle with radius 5.',
                history:'Summarize the causes of World War I.',
                literature:'Analyze the themes in "To Kill a Mockingbird".',
                physics:'Explain Newton’s laws of motion.',
                chemistry:'Describe the periodic table trends.',
                biology:'Explain the process of photosynthesis.',
                robloxGame:'Create a simple Roblox game concept.',
                googleSlides:'Generate a Google Slides presentation outline on climate change.',
                videoAnalysis:'Analyze a short video about space exploration.',
                robloxScripting:'Write a Roblox script for a door that opens on touch.'
            };
            const userMessage=document.createElement('div');
            userMessage.className='chat-message user';
            userMessage.innerHTML=`<div class="chat-message-content">${prompts[selectedSchoolMode]}</div><div class="chat-message-meta">Just now</div>`;
            chatHistory.appendChild(userMessage);
            conversationHistory.push({role:'user',content:prompts[selectedSchoolMode]});
            chatArea.scrollTop=chatArea.scrollHeight;
            sendBtn.disabled=true;
            loadingSpinner.style.display='block';
            typingIndicator.style.display='block';
            isGenerating=true;
            stopGeneratingBtn.style.display='block';
            abortController=new AbortController();
            try{
                const apiUrl=selectedAiModel==='betterGrok'?GROK_API_URL:API_URL;
                const response=await fetchResponse(prompts[selectedSchoolMode],true,apiUrl);
                const formattedResponse=formatAiResponse(response);
                const aiMessage=document.createElement('div');
                aiMessage.className='chat-message ai';
                aiMessage.innerHTML=`<div class="chat-message-content">${formattedResponse}</div><div class="chat-message-meta">Just now</div>`;
                chatHistory.appendChild(aiMessage);
                chatArea.scrollTop=chatArea.scrollHeight;
                conversationHistory.push({role:'assistant',content:response});
                cacheResponse(prompts[selectedSchoolMode],response);
            }catch(error){
                showNotification('Error processing request.','error');
            }
            sendBtn.disabled=false;
            loadingSpinner.style.display='none';
            typingIndicator.style.display='none';
            isGenerating=false;
            stopGeneratingBtn.style.display='none';
        });

        aiModelDropdown.addEventListener('change',()=>{
            selectedAiModel=aiModelDropdown.value;
            clearChatBtn.click();
        });

        rephraseBtn.addEventListener('click',async()=>{
            if(!latestAiResponse){
                showNotification('No AI response to rephrase.','error');
                return;
            }
            const rephrasePrompt=`Rephrase this: ${latestAiResponse}`;
            const userMessage=document.createElement('div');
            userMessage.className='chat-message user';
            userMessage.innerHTML=`<div class="chat-message-content">${rephrasePrompt}</div><div class="chat-message-meta">Just now</div>`;
            chatHistory.appendChild(userMessage);
            chatArea.scrollTop=chatArea.scrollHeight;
            sendBtn.disabled=true;
            loadingSpinner.style.display='block';
            typingIndicator.style.display='block';
            isGenerating=true;
            stopGeneratingBtn.style.display='block';
            abortController=new AbortController();
            const apiUrl=selectedAiModel==='betterGrok'?GROK_API_URL:API_URL;
            const rephrased=await fetchResponse(rephrasePrompt,true,apiUrl);
            const formattedRephrased=formatAiResponse(rephrased);
            const aiMessage=document.createElement('div');
            aiMessage.className='chat-message ai';
            aiMessage.innerHTML=`<div class="chat-message-content">${formattedRephrased}</div><div class="chat-message-meta">Just now</div>`;
            chatHistory.appendChild(aiMessage);
            chatArea.scrollTop=chatArea.scrollHeight;
            sendBtn.disabled=false;
            loadingSpinner.style.display='none';
            typingIndicator.style.display='none';
            isGenerating=false;
            stopGeneratingBtn.style.display='none';
            conversationHistory.push({role:'assistant',content:rephrased});
            cacheResponse(rephrasePrompt,rephrased);
        });

        stopGeneratingBtn.addEventListener('click',()=>{
            if(isGenerating){
                abortController?.abort();
                isGenerating=false;
                stopGeneratingBtn.style.display='none';
                loadingSpinner.style.display='none';
                typingIndicator.style.display='none';
                sendBtn.disabled=false;
            }
        });

        document.addEventListener('paste',async(e)=>{
            const items=e.clipboardData.items;
            for(const item of items){
                if(item.type.startsWith('image/')){
                    const file=item.getAsFile();
                    const hash=sha256(await readImage(file));
                    if(pastedImageHashes.has(hash))continue;
                    pastedImageHashes.add(hash);
                    filesArray.push(file);
                    const fileItem=document.createElement('div');
                    fileItem.className='file-item';
                    fileItem.innerHTML=`<div class="file-item-name">Pasted Image</div><div class="file-item-details">${(file.size/1024/1024).toFixed(2)}MB</div>`;
                    fileList.appendChild(fileItem);
                    fileItem.addEventListener('click',async()=>{
                        filePreviewContent.innerHTML=`<img src="${await readImage(file)}" alt="Pasted Image">`;
                        filePreviewModal.classList.add('open');
                    });
                    fileClearBtn.style.display='block';
                }
            }
        });

        window.addEventListener('beforeunload',()=>{
            if(backgroundAudio)backgroundAudio.pause();
            if(ws)ws.close();
            workerPool.forEach(worker=>worker.terminate());
        });

        loadTheme();
        initializeDB();
        initializeWorkerPool();
        initializeWebSocket();
        setInterval(prefetchResponses,800);
        setInterval(batchProcessRequests,150);
    </script>
</body>
</html>
