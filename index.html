<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: blob: https://*.pixabay.com https://*.openai.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://www.cloudflare.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; connect-src 'self' https://api.openai.com wss://api.openai.com https://api.searchengine.com; frame-src 'none'; media-src 'self' data: blob: https://*.pixabay.com https://*.openai.com;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="VerbiFlow - Your ultimate AI companion for coding, media generation, and more.">
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains; preload">
    <meta http-equiv="Referrer-Policy" content="no-referrer">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
    <title>VerbiFlow</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{background:linear-gradient(145deg,#f3f4f6,#d1d5db);font-family:Inter,sans-serif;color:#111827;min-height:100vh;display:flex;justify-content:center;padding:0;transition:background .3s ease;}
        .dark-mode body{background:linear-gradient(145deg,#1f2937,#111827);color:#e5e7eb;}
        .container{width:100vw;height:100vh;background:#ffffff;border-radius:0;box-shadow:none;overflow:hidden;display:flex;flex-direction:column;transition:all .3s ease;}
        .dark-mode .container{background:#1f2937;}
        .nav-bar{background:linear-gradient(90deg,#1d4ed8,#3b82f6);padding:16px 32px;display:flex;gap:16px;justify-content:space-between;align-items:center;box-shadow:0 4px 20px rgba(0,0,0,.3);}
        .dark-mode .nav-bar{background:linear-gradient(90deg,#1e40af,#2563eb);}
        .nav-btn{background:#ffffff;color:#1d4ed8;border:none;padding:12px 28px;border-radius:16px;cursor:pointer;font-size:16px;font-weight:600;transition:all .24s ease;outline:none;}
        .dark-mode .nav-btn{background:#374151;color:#93c5fd;}
        .nav-btn:hover{transform:scale(1.08);background:#f3f4f6;box-shadow:0 6px 18px rgba(0,0,0,.25);}
        .dark-mode .nav-btn:hover{background:#4b5563;}
        .nav-btn:active{transform:scale(.92);}
        .discord-btn{background:#5865f2;color:#ffffff;}
        .discord-btn:hover{background:#4752c4;}
        .theme-btn{background:#ffffff;color:#1d4ed8;border:2px solid #1d4ed8;padding:10px 20px;border-radius:16px;cursor:pointer;font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px;transition:all .24s ease;}
        .dark-mode .theme-btn{background:#374151;color:#93c5fd;border:2px solid #60a5fa;}
        .theme-btn:hover{transform:scale(1.08);background:#f3f4f6;}
        .dark-mode .theme-btn:hover{background:#4b5563;}
        .theme-btn i{font-size:20px;}
        .header{background:#ffffff;padding:20px;text-align:center;border-bottom:1px solid #e5e7eb;}
        .dark-mode .header{background:#1f2937;border-bottom:1px solid #374151;}
        .logo{font-size:40px;font-weight:800;color:#1d4ed8;letter-spacing:-1.2px;animation:pulse 1.6s infinite;}
        .dark-mode .logo{color:#60a5fa;}
        .chat-area{flex:1;padding:32px;overflow-y:auto;max-height:75vh;min-height:55vh;background:#f9fafb;scroll-behavior:smooth;}
        .dark-mode .chat-area{background:#111827;}
        .chat-content{flex:1;display:flex;flex-direction:column;}
        .chat-history{display:flex;flex-direction:column;gap:20px;}
        .chat-message{display:flex;flex-direction:column;gap:12px;padding:16px;border-radius:24px;max-width:80%;animation:slideIn .3s ease;box-shadow:0 4px 12px rgba(0,0,0,.1);}
        .chat-message.user{align-self:flex-end;background:#1d4ed8;color:#ffffff;}
        .dark-mode .chat-message.user{background:#1e40af;}
        .chat-message.ai{align-self:flex-start;background:#e5e7eb;color:#111827;}
        .dark-mode .chat-message.ai{background:#374151;color:#e5e7eb;}
        .chat-message-content{padding:16px;border-radius:24px;font-size:16px;line-height:1.7;word-break:break-word;}
        .chat-message-content strong{font-weight:700;}
        .chat-message-content em{font-style:italic;}
        .chat-message-content code{background:#f3f4f6;padding:2px 6px;border-radius:6px;font-family:'JetBrains Mono',monospace;}
        .dark-mode .chat-message-content code{background:#4b5563;}
        .chat-message-content ul,.chat-message-content ol{margin:12px 0;padding-left:24px;}
        .chat-message-content li{margin-bottom:8px;}
        .chat-message-content table{border-collapse:collapse;margin:12px 0;}
        .chat-message-content th,.chat-message-content td{border:1px solid #e5e7eb;padding:8px 12px;}
        .dark-mode .chat-message-content th,.dark-mode .chat-message-content td{border:1px solid #374151;}
        .chat-message-meta{font-size:14px;color:#6b7280;margin-top:8px;opacity:.8;}
        .dark-mode .chat-message-meta{color:#9ca3af;}
        .chat-message img,.chat-message video{max-width:100%;border-radius:16px;margin-top:14px;cursor:pointer;transition:transform .24s ease,box-shadow .24s ease;}
        .chat-message img:hover,.chat-message video:hover{transform:scale(1.05);box-shadow:0 10px 30px rgba(0,0,0,.25);}
        .code-block{position:relative;margin:14px 0;border-radius:16px;overflow:hidden;}
        .code-block pre{background:#111827;color:#e5e7eb;padding:18px;border-radius:16px;overflow-x:auto;font-family:'JetBrains Mono',monospace;font-size:15px;line-height:1.7;}
        .dark-mode .code-block pre{background:#1f2937;}
        .code-text{background:#111827;color:#e5e7eb;padding:18px;border-radius:16px;font-family:'JetBrains Mono',monospace;font-size:15px;white-space:pre-wrap;user-select:text;}
        .dark-mode .code-text{background:#1f2937;}
        .hello-code-block{position:relative;margin:14px 0;border-radius:16px;overflow:hidden;background:linear-gradient(135deg,#1d4ed8,#3b82f6);box-shadow:0 10px 25px rgba(0,0,0,.35);padding:4px;}
        .dark-mode .hello-code-block{background:linear-gradient(135deg,#1e40af,#2563eb);}
        .hello-code-block pre{background:#ffffff;color:#1d4ed8;padding:18px;border-radius:12px;overflow-x:auto;font-family:'JetBrains Mono',monospace;font-size:15px;line-height:1.7;border:1px solid #e5e7eb;}
        .dark-mode .hello-code-block pre{background:#111827;color:#93c5fd;border:1px solid #374151;}
        .hello-code-block pre::before{content:"✨ Hello Code ✨";display:block;color:#ffffff;font-size:14px;font-weight:600;margin-bottom:10px;padding:6px 10px;border-radius:10px;background:#1d4ed8;}
        .dark-mode .hello-code-block pre::before{background:#2563eb;}
        .copy-btn,.copy-all-btn{background:#1d4ed8;color:#ffffff;border:none;padding:10px 16px;border-radius:14px;cursor:pointer;font-size:14px;font-weight:600;transition:all .24s ease;}
        .copy-btn{position:absolute;top:12px;right:12px;}
        .copy-all-btn{position:absolute;top:12px;right:90px;}
        .dark-mode .copy-btn,.dark-mode .copy-all-btn{background:#1e40af;}
        .copy-btn:hover,.copy-all-btn:hover{background:#3b82f6;transform:scale(1.08);box-shadow:0 6px 18px rgba(0,0,0,.25);}
        .dark-mode .copy-btn:hover,.dark-mode .copy-all-btn:hover{background:#2563eb;}
        .code-sidebar{position:fixed;top:0;right:-500px;width:500px;height:100%;background:#f9fafb;border-left:1px solid #e5e7eb;padding:28px;overflow-y:auto;transition:right .3s ease;z-index:200;}
        .dark-mode .code-sidebar{background:#1f2937;border-left:1px solid #374151;}
        .code-sidebar.open{right:0;}
        .code-sidebar-close{background:#ef4444;color:#ffffff;border:none;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:22px;margin-bottom:14px;}
        .code-sidebar-close:hover{background:#dc2626;transform:scale(1.15);}
        .code-sidebar-content{font-family:'JetBrains Mono',monospace;font-size:15px;color:#111827;white-space:pre-wrap;}
        .dark-mode .code-sidebar-content{color:#e5e7eb;}
        .file-upload-container{padding:20px;border-top:1px solid #e5e7eb;background:#ffffff;}
        .dark-mode .file-upload-container{background:#1f2937;border-top:1px solid #374151;}
        .file-actions{display:flex;gap:16px;align-items:center;flex-wrap:wrap;}
        .file-input-label{background:#1d4ed8;color:#ffffff;padding:16px 28px;border-radius:16px;cursor:pointer;font-size:16px;font-weight:600;min-height:52px;transition:all .24s ease;}
        .dark-mode .file-input-label{background:#1e40af;}
        .file-input-label:hover{transform:scale(1.08);box-shadow:0 6px 18px rgba(0,0,0,.25);}
        .file-input{display:none;}
        .file-clear-btn{background:#ef4444;color:#ffffff;padding:16px 28px;border-radius:16px;cursor:pointer;font-size:16px;font-weight:600;border:none;min-height:52px;transition:all .24s ease;}
        .file-clear-btn:hover{transform:scale(1.08);background:#dc2626;}
        .generate-media-btn{background:#10b981;color:#ffffff;padding:16px 28px;border-radius:16px;cursor:pointer;font-size:16px;font-weight:600;border:none;min-height:52px;transition:all .24s ease;}
        .dark-mode .generate-media-btn{background:#059669;}
        .generate-media-btn:hover{transform:scale(1.08);background:#34d399;}
        .dark-mode .generate-media-btn:hover{background:#10b981;}
        .keep-generating-btn{background:#10b981;color:#ffffff;padding:16px 28px;border-radius:16px;cursor:pointer;font-size:16px;font-weight:600;border:none;min-height:52px;transition:all .3s ease;opacity:0;transform:translateY(16px);display:none;}
        .keep-generating-btn.show{opacity:1;transform:translateY(0);display:block;}
        .dark-mode .keep-generating-btn{background:#059669;}
        .keep-generating-btn:hover{transform:scale(1.08);background:#34d399;}
        .dark-mode .keep-generating-btn:hover{background:#10b981;}
        .school-help-container{display:flex;align-items:center;gap:16px;margin-left:16px;}
        .school-help-dropdown,.ai-model-dropdown{background:#6b7280;color:#ffffff;padding:16px 28px;border-radius:16px;border:none;font-size:16px;font-weight:600;min-height:52px;cursor:pointer;transition:all .24s ease;}
        .dark-mode .school-help-dropdown,.dark-mode .ai-model-dropdown{background:#4b5563;}
        .school-help-dropdown:hover,.ai-model-dropdown:hover{background:#9ca3af;transform:scale(1.08);}
        .dark-mode .school-help-dropdown:hover,.dark-mode .ai-model-dropdown:hover{background:#6b7280;}
        .school-help-dropdown:focus,.ai-model-dropdown:focus{outline:none;border-color:#1d4ed8;box-shadow:0 0 0 6px rgba(37,99,235,.35);}
        .dark-mode .school-help-dropdown:focus,.dark-mode .ai-model-dropdown:focus{border-color:#60a5fa;box-shadow:0 0 0 6px rgba(96,165,250,.35);}
        .rephrase-btn,.stop-generating-btn{background:#f59e0b;color:#ffffff;padding:16px 28px;border-radius:16px;cursor:pointer;font-size:16px;font-weight:600;border:none;min-height:52px;transition:all .24s ease;}
        .dark-mode .rephrase-btn,.dark-mode .stop-generating-btn{background:#d97706;}
        .rephrase-btn:hover,.stop-generating-btn:hover{transform:scale(1.08);background:#fbbf24;}
        .dark-mode .rephrase-btn:hover,.dark-mode .stop-generating-btn:hover{background:#f59e0b;}
        .stop-generating-btn{background:#ef4444;}
        .dark-mode .stop-generating-btn{background:#dc2626;}
        .stop-generating-btn:hover{background:#f87171;}
        .dark-mode .stop-generating-btn:hover{background:#ef4444;}
        .file-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin-top:14px;}
        .file-item{display:flex;align-items:center;gap:14px;background:#e5e7eb;padding:14px;border-radius:16px;cursor:pointer;transition:all .24s ease;position:relative;}
        .dark-mode .file-item{background:#374151;}
        .file-item:hover{background:#d1d5db;transform:scale(1.03);}
        .dark-mode .file-item:hover{background:#4b5563;}
        .file-item-name{flex:1;font-size:16px;color:#111827;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .dark-mode .file-item-name{color:#e5e7eb;}
        .file-item-details{font-size:14px;color:#6b7280;}
        .dark-mode .file-item-details{color:#9ca3af;}
        .file-progress{position:absolute;bottom:0;left:0;height:4px;background:#1d4ed8;border-radius:0 0 16px 16px;transition:width .3s ease;}
        .dark-mode .file-progress{background:#2563eb;}
        .file-preview-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);z-index:250;padding:28px;justify-content:center;align-items:center;animation:fadeIn .24s ease;}
        .file-preview-modal.open{display:flex;}
        .file-preview-content{background:#ffffff;border-radius:24px;padding:28px;max-width:90%;max-height:90%;overflow:auto;color:#111827;font-size:16px;}
        .dark-mode .file-preview-content{background:#1f2937;color:#e5e7eb;}
        .file-preview-content img,.file-preview-content video{max-width:85% !important;}
        .file-preview-close{background:#ef4444;color:#ffffff;border:none;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;position:absolute;top:28px;right:28px;transition:all .24s ease;}
        .file-preview-close:hover{transform:scale(1.15);background:#dc2626;}
        .file-preview-close svg{width:24px;height:24px;fill:#ffffff;}
        .input-container{display:flex;align-items:flex-end;padding:20px;border-top:1px solid #e5e7eb;background:#ffffff;gap:16px;position:sticky;bottom:0;z-index:50;}
        .dark-mode .input-container{background:#1f2937;border-top:1px solid #374151;}
        .user-input{flex:1;padding:16px;border:1px solid #e5e7eb;border-radius:16px;font-size:16px;outline:none;resize:none;min-height:52px;max-height:220px;background:#ffffff;color:#111827;transition:all .24s ease;}
        .dark-mode .user-input{background:#374151;border:1px solid #4b5563;color:#e5e7eb;}
        .user-input:focus{border-color:#1d4ed8;box-shadow:0 0 0 6px rgba(37,99,235,.35);}
        .dark-mode .user-input:focus{border-color:#60a5fa;box-shadow:0 0 0 6px rgba(96,165,250,.35);}
        .send-btn{background:#1d4ed8;border:none;border-radius:16px;padding:16px 32px;cursor:pointer;color:#ffffff;font-size:16px;font-weight:600;min-height:52px;transition:all .24s ease;}
        .dark-mode .send-btn{background:#1e40af;}
        .send-btn:hover{transform:scale(1.08);background:#3b82f6;}
        .dark-mode .send-btn:hover{background:#2563eb;}
        .send-btn:disabled{background:#9ca3af;cursor:not-allowed;}
        .loading-spinner{display:none;margin:14px auto;width:40px;height:40px;border:6px solid #1d4ed8;border-top:6px solid transparent;border-radius:50%;animation:spin .4s linear infinite;}
        .typing-indicator{display:none;font-size:16px;color:#6b7280;margin:14px auto;text-align:center;}
        .dark-mode .typing-indicator{color:#9ca3af;}
        .typing-indicator span{display:inline-block;animation:dotPulse .64s infinite ease-in-out;}
        .typing-indicator span:nth-child(2){animation-delay:.12s;}
        .typing-indicator span:nth-child(3){animation-delay:.24s;}
        .notification{position:fixed;top:28px;right:28px;padding:16px 32px;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.4);opacity:0;transform:translateY(-28px);transition:all .3s ease;font-size:16px;font-weight:600;z-index:300;}
        .notification.show{opacity:1;transform:translateY(0);}
        .notification.success{background:#1d4ed8;color:#ffffff;}
        .notification.error{background:#ef4444;color:#ffffff;}
        .permission-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);z-index:500;justify-content:center;align-items:center;animation:fadeIn .24s ease;}
        .permission-modal.open{display:flex;}
        .permission-content{background:#ffffff;border-radius:24px;padding:32px;max-width:600px;text-align:center;color:#111827;animation:zoomIn .24s ease;}
        .dark-mode .permission-content{background:#1f2937;color:#e5e7eb;}
        .permission-content h2{font-size:26px;margin-bottom:16px;}
        .permission-content p{font-size:16px;margin-bottom:20px;}
        .permission-btn{background:#1d4ed8;color:#ffffff;padding:14px 32px;border-radius:16px;border:none;cursor:pointer;font-size:16px;font-weight:600;margin:0 12px;transition:transform .24s ease,background .24s ease;}
        .dark-mode .permission-btn{background:#1e40af;}
        .permission-btn:hover{transform:scale(1.08);background:#3b82f6;}
        .dark-mode .permission-btn:hover{background:#2563eb;}
        .permission-btn.deny{background:#ef4444;}
        .dark-mode .permission-btn.deny{background:#dc2626;}
        .permission-btn.deny:hover{background:#f87171;}
        .dark-mode .permission-btn.deny:hover{background:#ef4444;}
        @keyframes slideIn{0%{opacity:0;transform:translateY(28px);}100%{opacity:1;transform:translateY(0);}}
        @keyframes fadeIn{0%{opacity:0;}100%{opacity:1;}}
        @keyframes zoomIn{0%{opacity:0;transform:scale(.7);}100%{opacity:1;transform:scale(1);}}
        @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
        @keyframes dotPulse{0%,80%,100%{transform:scale(1);opacity:.65;}40%{transform:scale(1.5);opacity:1;}}
        @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.55;}}
        @media (max-width:768px){
            .container{border-radius:0;padding:0;}
            .nav-bar{padding:12px;gap:12px;}
            .nav-btn{font-size:14px;padding:10px 20px;}
            .theme-btn{padding:8px 16px;font-size:14px;}
            .header{padding:16px;}
            .logo{font-size:32px;}
            .chat-area{padding:20px;min-height:50vh;max-height:70vh;}
            .chat-message{max-width:92%;}
            .chat-message-content{font-size:15px;}
            .chat-message img,.chat-message video{max-width:100%;}
            .input-container{padding:16px;gap:12px;}
            .user-input{font-size:15px;min-height:48px;}
            .send-btn{padding:14px 24px;min-height:48px;}
            .file-input-label,.file-clear-btn,.generate-media-btn,.keep-generating-btn,.school-help-dropdown,.ai-model-dropdown,.rephrase-btn,.stop-generating-btn{font-size:14px;padding:14px 20px;min-height:48px;}
            .school-help-container{gap:12px;margin-left:12px;}
            .file-preview-content img,.file-preview-content video{max-width:90% !important;}
            .notification{top:20px;right:20px;padding:12px 24px;font-size:14px;}
            .code-sidebar{width:100%;right:-100%;}
            .permission-content{max-width:90%;padding:20px;}
            .permission-content h2{font-size:22px;}
            .permission-content p{font-size:14px;}
            .permission-btn{padding:12px 24px;font-size:14px;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-bar">
            <button class="nav-btn" id="clearChatBtn">Clear Chat</button>
            <button class="nav-btn" id="verbiflowUpdatesBtn">Updates</button>
            <button class="nav-btn" id="premiumPriceBtn">Premium Price</button>
            <button class="nav-btn" id="shareChatBtn">Share Chat</button>
            <button class="theme-btn" id="themeBtn"><i class="fas fa-moon"></i> Dark Mode</button>
            <button class="nav-btn" id="copyCodeBtn">Copy Code</button>
            <button class="nav-btn discord-btn" id="discordBtn">Discord</button>
        </div>
        <div class="header">
            <div class="logo">VerbiFlow</div>
        </div>
        <div class="chat-area" id="chatArea">
            <div class="chat-content">
                <div class="chat-history" id="chatHistory">
                    <div class="chat-message ai">
                        <div class="chat-message-content">Hey there, I’m VerbiFlow—your ultimate AI companion for creativity and problem-solving! I’m here to make things fast, fun, and insightful. What’s on your mind?</div>
                        <div class="chat-message-meta">Just now</div>
                    </div>
                </div>
                <div class="loading-spinner" id="loadingSpinner"></div>
                <div class="typing-indicator" id="typingIndicator">
                    VerbiFlow is thinking<span>.</span><span>.</span><span>.</span>
                </div>
            </div>
        </div>
        <div class="file-upload-container" id="fileUploadContainer">
            <div class="file-actions">
                <label class="file-input-label" for="fileInput">Upload File</label>
                <input type="file" class="file-input" id="fileInput" multiple accept="image/*,video/*,text/*,application/json,application/xml">
                <button class="file-clear-btn" id="fileClearBtn" style="display:none;">Clear</button>
                <button class="generate-media-btn" id="generateMediaBtn">Generate Media</button>
                <button class="keep-generating-btn" id="keepGeneratingBtn">Continue Generating</button>
                <div class="school-help-container">
                    <select class="school-help-dropdown" id="schoolHelpDropdown">
                        <option value="">Select Task</option>
                        <option value="algebra">Algebra Help</option>
                        <option value="science">Science Help</option>
                        <option value="geometry">Geometry Help</option>
                        <option value="history">History Help</option>
                        <option value="literature">Literature Help</option>
                        <option value="physics">Physics Help</option>
                        <option value="chemistry">Chemistry Help</option>
                        <option value="biology">Biology Help</option>
                        <option value="robloxGame">Roblox Game</option>
                        <option value="googleSlides">Google Slides</option>
                        <option value="videoAnalysis">Video Analysis</option>
                        <option value="robloxScripting">Roblox Scripting</option>
                    </select>
                    <select class="ai-model-dropdown" id="aiModelDropdown">
                        <option value="default">VerbiFlow (Default)</option>
                        <option value="lingoLogicAI">LingoLogicAI</option>
                        <option value="codeMasterAI">CodeMasterAI</option>
                        <option value="visualGeniusAI">VisualGeniusAI</option>
                    </select>
                    <button class="rephrase-btn" id="rephraseBtn">Rephrase</button>
                    <button class="stop-generating-btn" id="stopGeneratingBtn" style="display:none;">Stop Generating</button>
                </div>
            </div>
            <div class="file-list" id="fileList"></div>
        </div>
        <div class="input-container">
            <textarea class="user-input" id="userInput" placeholder="Ask anything, generate images/videos, or request games or slides..." rows="1"></textarea>
            <button class="send-btn" id="sendBtn">Send</button>
        </div>
        <div class="file-preview-modal" id="filePreviewModal">
            <button class="file-preview-close" id="filePreviewClose">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <div class="file-preview-content" id="filePreviewContent"></div>
        </div>
        <div class="code-sidebar" id="codeSidebar">
            <button class="code-sidebar-close" id="codeSidebarClose">×</button>
            <pre class="code-sidebar-content" id="codeSidebarContent"></pre>
        </div>
        <div class="notification" id="notification"></div>
        <div class="permission-modal" id="permissionModal">
            <div class="permission-content">
                <h2>Request Permissions</h2>
                <p>VerbiFlow needs access to enable features like video/image generation, media analysis, and more. Do you grant permission?</p>
                <button class="permission-btn" id="grantPermissionBtn">Grant</button>
                <button class="permission-btn deny" id="denyPermissionBtn">Deny</button>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/src/sha256.min.js"></script>
    <script defer>
        const API_KEY="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";
        const API_URL="https://api.openai.com/v1/chat/completions";
        const DALLE_API_URL="https://api.openai.com/v1/images/generations";
        const SORA_API_URL="https://api.openai.com/v1/video/generations";
        const VIDEO_PROCESSING_API="https://api.openai.com/v1/video/analyze";
        const SEARCH_API_URL="https://api.searchengine.com/v1/search";
        const DISCORD_INVITE="https://discord.gg/rCTRQvD4TP";
        const MAX_VIDEO_SIZE=40*1024*1024;
        const MAX_FILE_SIZE=40*1024*1024;
        const BATCH_SIZE=150;
        const RATE_LIMIT_REQUESTS=1500;
        const RATE_LIMIT_WINDOW=30*1000;
        const MAX_CACHE_SIZE=8*1024*1024;

        const chatHistory=document.getElementById('chatHistory');
        const userInput=document.getElementById('userInput');
        const sendBtn=document.getElementById('sendBtn');
        const fileInput=document.getElementById('fileInput');
        const fileList=document.getElementById('fileList');
        const fileClearBtn=document.getElementById('fileClearBtn');
        const fileUploadContainer=document.getElementById('fileUploadContainer');
        const filePreviewModal=document.getElementById('filePreviewModal');
        const filePreviewContent=document.getElementById('filePreviewContent');
        const filePreviewClose=document.getElementById('filePreviewClose');
        const loadingSpinner=document.getElementById('loadingSpinner');
        const typingIndicator=document.getElementById('typingIndicator');
        const chatArea=document.getElementById('chatArea');
        const clearChatBtn=document.getElementById('clearChatBtn');
        const copyCodeBtn=document.getElementById('copyCodeBtn');
        const discordBtn=document.getElementById('discordBtn');
        const verbiflowUpdatesBtn=document.getElementById('verbiflowUpdatesBtn');
        const premiumPriceBtn=document.getElementById('premiumPriceBtn');
        const shareChatBtn=document.getElementById('shareChatBtn');
        const themeBtn=document.getElementById('themeBtn');
        const notification=document.getElementById('notification');
        const codeSidebar=document.getElementById('codeSidebar');
        const codeSidebarClose=document.getElementById('codeSidebarClose');
        const keepGeneratingBtn=document.getElementById('keepGeneratingBtn');
        const generateMediaBtn=document.getElementById('generateMediaBtn');
        const schoolHelpDropdown=document.getElementById('schoolHelpDropdown');
        const aiModelDropdown=document.getElementById('aiModelDropdown');
        const rephraseBtn=document.getElementById('rephraseBtn');
        const stopGeneratingBtn=document.getElementById('stopGeneratingBtn');
        const permissionModal=document.getElementById('permissionModal');
        const grantPermissionBtn=document.getElementById('grantPermissionBtn');
        const denyPermissionBtn=document.getElementById('denyPermissionBtn');

        let filesArray=[];
        let conversationHistory=[{role:"assistant",content:"Hey there, I’m VerbiFlow—your ultimate AI companion for creativity and problem-solving! I’m here to make things fast, fun, and insightful. What’s on your mind?"}];
        let latestCodeBlocks=[];
        let latestAiResponse='';
        let isDarkMode=false;
        let isGenerating=false;
        let lastMessageContent='';
        let generationTimeout=null;
        let selectedSchoolMode='';
        let selectedAiModel='default';
        let messageQueue=new Map();
        let isProcessing=false;
        let codeAnalysisCache=new Map();
        let videoAnalysisCache=new Map();
        let imageAnalysisCache=new Map();
        let responseCache=new Map();
        let searchCache=new Map();
        let wsMessageCache=new Map();
        let abortController=null;
        let batchQueue=[];
        let hasPermission=false;
        let requestTimestamps=[];
        let userRequestCounts=new Map();
        let backgroundAudio=null;
        let isAdminVerified=false;
        let pastedImageHashes=new Set();
        let workerPool=[];
        let prefetchQueue=new Map();
        let ws=null;
        let db=null;
        let cacheSize=0;

        const aiModels={
            default:{name:"VerbiFlow",temperature:0.5,maxTokens:16170,personality:"Hey there, I’m VerbiFlow—your ultimate AI companion for creativity and problem-solving! I’m here to make things fast, fun, and insightful. What’s on your mind?"},
            lingoLogicAI:{name:"LingoLogicAI",temperature:0.4,maxTokens:16748,personality:"Greetings! I’m LingoLogicAI, a witty AI with a passion for language and logic. I’ll break down complex ideas with clarity and humor—let’s dive in!"},
            codeMasterAI:{name:"CodeMasterAI",temperature:0.3,maxTokens:17325,personality:"Yo, I’m CodeMasterAI—your coding expert with a love for clean, efficient solutions! I’m all about debugging and optimizing. Drop me some code, and let’s make it shine!"},
            visualGeniusAI:{name:"VisualGeniusAI",temperature:0.6,maxTokens:15593,personality:"Hi, I’m VisualGeniusAI—an AI with a flair for visuals and creativity! Whether it’s generating images, videos, or designing UI, I’ve got you covered. What do you want to create?"}
        };

        const livelyResponses={
            default:[
                "Let’s dive into this with flair—here’s a detailed breakdown for you!",
                "That’s a brilliant query! I’ve got a comprehensive answer ready—check it out!",
                "I’m buzzing with excitement! Here’s a deep dive into your request…",
                "Your question sparks my creativity! Let’s explore this with a rich response…",
                "Fresh insights incoming! I’ve searched the web to enhance my answer—here you go!"
            ],
            lingoLogicAI:[
                "A fascinating challenge! Let me unravel it with precision and wit—here we go!",
                "I’m ready to tackle this with linguistic finesse—brace for an insightful reply!",
                "Let’s dissect this with clarity and humor—here’s my detailed take!",
                "Your query ignites my logic circuits! Here’s a nuanced response for you!",
                "I’ve tapped into the latest web data for a sharper response—check this out!"
            ],
            codeMasterAI:[
                "Code mode activated! Let’s optimize and debug with a thorough solution—here it is!",
                "I’m in my element! Here’s a meticulously crafted code solution for you!",
                "Let’s polish this code to perfection—check out this detailed implementation!",
                "This is my domain! Here’s an advanced, optimized code response—ready to roll!",
                "I’ve pulled the latest coding trends from the web—here’s an enhanced solution!"
            ],
            visualGeniusAI:[
                "I’m envisioning something spectacular! Here’s a creative and detailed output…",
                "Let’s craft a visual masterpiece with depth—check out this rich result!",
                "My creative gears are turning! Here’s a stunning, layered visual response!",
                "I’m channeling my artistic side! Here’s a vibrant and detailed creation for you!",
                "I’ve searched the web for inspiration—here’s a visually stunning result!"
            ]
        };

        function rateLimitCheck(){
            const now=Date.now();
            requestTimestamps=requestTimestamps.filter(t=>now-t<RATE_LIMIT_WINDOW);
            if(requestTimestamps.length>=RATE_LIMIT_REQUESTS){
                showNotification('Rate limit reached—your request will be delayed slightly.','error');
                return false;
            }
            requestTimestamps.push(now);
            return true;
        }

        function showNotification(message,type='success'){
            notification.textContent=message;
            notification.className=`notification ${type} show`;
            setTimeout(()=>{notification.classList.remove('show');},800);
        }

        function toggleTheme(){
            isDarkMode=!isDarkMode;
            document.body.classList.toggle('dark-mode');
            themeBtn.innerHTML=isDarkMode?'<i class="fas fa-sun"></i> Light Mode':'<i class="fas fa-moon"></i> Dark Mode';
            localStorage.setItem('theme',isDarkMode?'dark':'light');
        }

        function loadTheme(){
            const savedTheme=localStorage.getItem('theme');
            if(savedTheme==='dark'){
                isDarkMode=true;
                document.body.classList.add('dark-mode');
                themeBtn.innerHTML='<i class="fas fa-sun"></i> Light Mode';
            }else{
                themeBtn.innerHTML='<i class="fas fa-moon"></i> Dark Mode';
            }
        }

        function requestPermissions(){
            permissionModal.classList.add('open');
        }

        grantPermissionBtn.addEventListener('click',()=>{
            hasPermission=true;
            permissionModal.classList.remove('open');
            showNotification('Permissions granted! All features are now available!');
        });

        denyPermissionBtn.addEventListener('click',()=>{
            hasPermission=false;
            permissionModal.classList.remove('open');
            showNotification('Permissions denied. Features are limited—grant access to unlock everything.','error');
        });

        async function playBackgroundMusic(userRequest=''){
            if(!hasPermission){
                showNotification('Grant permissions to enable background music.','error');
                return;
            }
            if(backgroundAudio){
                backgroundAudio.pause();
                backgroundAudio.remove();
            }
            let musicUrl;
            if(userRequest.toLowerCase().includes('play a music')||userRequest.toLowerCase().includes('background music')){
                const genreMatch=userRequest.match(/play\s*(?:a\s*)?(?:music\s*(?:in\s*the\s*background\s*)?of\s*)?(\w+)/i);
                const genre=genreMatch?genreMatch[1].toLowerCase():'ambient';
                const musicSources={
                    ambient:'https://cdn.pixabay.com/audio/2023/01/26/audio_8cabeb3b53.mp3',
                    jazz:'https://cdn.pixabay.com/audio/2023/01/26/audio_4f8c9b3b53.mp3',
                    classical:'https://cdn.pixabay.com/audio/2023/01/26/audio_7a9d2b3b53.mp3',
                    pop:'https://cdn.pixabay.com/audio/2023/01/26/audio_3e5b8b3b53.mp3',
                    rock:'https://cdn.pixabay.com/audio/2023/01/26/audio_9f7a4b3b53.mp3'
                };
                musicUrl=musicSources[genre]||musicSources.ambient;
            }else{
                const randomMusic=[
                    'https://cdn.pixabay.com/audio/2023/01/26/audio_8cabeb3b53.mp3',
                    'https://cdn.pixabay.com/audio/2023/01/26/audio_4f8c9b3b53.mp3',
                    'https://cdn.pixabay.com/audio/2023/01/26/audio_7a9d2b3b53.mp3'
                ];
                musicUrl=randomMusic[Math.floor(Math.random()*randomMusic.length)];
            }
            backgroundAudio=new Audio(musicUrl);
            backgroundAudio.loop=true;
            backgroundAudio.volume=0.3;
            try{
                await backgroundAudio.play();
                showNotification(`Playing ${userRequest.toLowerCase().includes('play a music')?userRequest.match(/play\s*(?:a\s*)?(?:music\s*(?:in\s*the\s*background\s*)?of\s*)?(\w+)/i)?.[1]||'background':'random'} music!`);
            }catch(error){
                showNotification('Failed to play music—check browser permissions.','error');
            }
        }

        function verifyAdminAccess(message){
            if(message.toLowerCase().includes('take me to admin console')){
                const aiMessage=document.createElement('div');
                aiMessage.className='chat-message ai';
                aiMessage.innerHTML=`<div class="chat-message-content">Please verify you’re an admin by providing the access code.</div><div class="chat-message-meta">Just now</div>`;
                chatHistory.appendChild(aiMessage);
                chatArea.scrollTop=chatArea.scrollHeight;
                conversationHistory.push({role:"assistant",content:"Please verify you’re an admin by providing the access code."});
            }else if(message.toLowerCase().includes('adminpowers$33') && message.toLowerCase().includes('admin console')){
                isAdminVerified=true;
                const aiMessage=document.createElement('div');
                aiMessage.className='chat-message ai';
                aiMessage.innerHTML=`<div class="chat-message-content">Access granted! Taking you to the admin console...</div><div class="chat-message-meta">Just now</div>`;
                chatHistory.appendChild(aiMessage);
                chatArea.scrollTop=chatArea.scrollHeight;
                conversationHistory.push({role:"assistant",content:"Access granted! Taking you to the admin console..."});
                setTimeout(()=>{window.location.href='/adminconsole';},600);
            }else{
                return false;
            }
            return true;
        }

        class WebSearch{
            static async search(query){
                const searchHash=sha256(query);
                if(searchCache.has(searchHash))return searchCache.get(searchHash);
                const response=await fetch(`${SEARCH_API_URL}?q=${encodeURIComponent(query)}`,{
                    method:'GET',
                    headers:{
                        'Content-Type':'application/json'
                    }
                });
                if(!response.ok)return '';
                const data=await response.json();
                const snippets=data.results.slice(0,3).map(r=>`${r.title}: ${r.snippet}`).join('\n');
                searchCache.set(searchHash,snippets);
                return snippets;
            }
        }

        class CodeAnalyzer{
            static analyzeCode(code){
                const issues=[];
                const lines=code.split('\n');
                const variableUsage=new Map();
                let indentLevel=0;
                let braceCount=0;
                let loopDepth=0;
                lines.forEach((line,index)=>{
                    const trimmed=line.trim();
                    if(!trimmed)return;
                    const indent=line.match(/^\s*/)[0].length/2;
                    if(trimmed.match(/\{/))braceCount++;
                    if(trimmed.match(/\}/))braceCount--;
                    if(trimmed.match(/\b(for|while)\b/))loopDepth++;
                    if(trimmed.match(/\bbreak\b/))loopDepth--;
                    if(braceCount<0)issues.push(`Line ${index+1}: Unmatched closing brace.`);
                    if(loopDepth>3)issues.push(`Line ${index+1}: Excessive loop nesting (depth > 3).`);
                    if(Math.abs(indent-indentLevel)>1)issues.push(`Line ${index+1}: Inconsistent indentation.`);
                    indentLevel=trimmed.match(/\{$/) ? indent+1 : trimmed.match(/\}/) ? indent : indentLevel;
                    if(trimmed.match(/var\s+\w+/))issues.push(`Line ${index+1}: Use 'let' or 'const' instead of 'var'.`);
                    const variableMatch=trimmed.match(/(let|const)\s+(\w+)/);
                    if(variableMatch)variableUsage.set(variableMatch[2],{declared:index+1,used:false});
                    variableUsage.forEach((value,key)=>{
                        if(trimmed.includes(key) && index+1!==value.declared)value.used=true;
                    });
                    if(trimmed.match(/eval\(/))issues.push(`Line ${index+1}: Avoid using 'eval'—security risk.`);
                    if(trimmed.match(/==\s/))issues.push(`Line ${index+1}: Use '===' instead of '=='.`);
                    if(trimmed.length>100)issues.push(`Line ${index+1}: Line exceeds 100 characters.`);
                });
                variableUsage.forEach((value,key)=>{
                    if(!value.used)issues.push(`Variable '${key}' declared on line ${value.declared} but never used.`);
                });
                if(braceCount!==0)issues.push(`Unmatched braces in code.`);
                return issues;
            }
            static optimizeCode(code){
                let optimized=code;
                optimized=optimized.replace(/\bvar\b/g,'const');
                optimized=optimized.replace(/\b==\b/g,'===');
                optimized=optimized.replace(/eval\([^)]+\);?\n?/g,'');
                optimized=optimized.replace(/\n\s*\n/g,'\n');
                const lines=optimized.split('\n');
                let indentLevel=0;
                optimized=lines.map(line=>{
                    const trimmed=line.trim();
                    if(!trimmed)return '';
                    if(trimmed.match(/\}/))indentLevel--;
                    const indent=' '.repeat(indentLevel*2);
                    if(trimmed.match(/\{$/))indentLevel++;
                    return indent+trimmed;
                }).filter(line=>line).join('\n');
                return optimized;
            }
        }

        class Obfuscator{
            static obfuscateBase64(code){
                return btoa(code);
            }
            static obfuscateXOR(code,key=42){
                return String.fromCharCode(...code.split('').map((c,i)=>c.charCodeAt(0)^(key+i%13)));
            }
            static obfuscateHex(code){
                return code.split('').map(c=>'\\x'+c.charCodeAt(0).toString(16).padStart(2,'0')).join('');
            }
            static obfuscateStringManipulation(code){
                return code.split('').reverse().map(c=>`[${c.charCodeAt(0)}]`).join('');
            }
            static obfuscateVariableRenaming(code){
                const varMap=new Map();
                let counter=0;
                return code.replace(/\b([a-zA-Z_]\w*)\b/g,(match)=>{
                    if(['var','let','const','function','return','if','else','for','while'].includes(match))return match;
                    if(!varMap.has(match))varMap.set(match,`_v${counter++}`);
                    return varMap.get(match);
                });
            }
            static obfuscateControlFlow(code){
                const lines=code.split('\n');
                const wrapped=lines.map(line=>`(() => { ${line}; return Math.random() > 0.5 ? true : true; })();`);
                return wrapped.join('\n');
            }
            static obfuscateNumberEncoding(code){
                return code.replace(/\d+/g,num=>`Number(${num.toString(16).split('').map(c=>`'${c}'`).join('+')})`);
            }
            static obfuscateStringSplitting(code){
                const segments=code.match(/.{1,10}/g)||[code];
                return segments.map(s=>`String.fromCharCode(${s.split('').map(c=>c.charCodeAt(0)).join(',')})`).join('+');
            }
            static obfuscatePolybiusSquare(code){
                const polybiusMap='ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').reduce((map,c,i)=>{map[c]=(Math.floor(i/5)+1)+''+((i%5)+1);return map;},{});
                return code.toUpperCase().split('').map(c=>polybiusMap[c]||(c.match(/[0-9]/)?c:'#')).join('');
            }
            static obfuscateNestedFunctions(code){
                return `((x)=>(y)=>(z)=>z(x(y)))(x=>x.split('').reverse().join(''))(x=>x.split('').map(c=>String.fromCharCode(c.charCodeAt(0)+1)).join(''))(${JSON.stringify(code)})`;
            }
            static obfuscate(code,method='mixed'){
                let result=code;
                if(method==='mixed'){
                    result=this.obfuscatePolybiusSquare(result);
                    result=this.obfuscateStringSplitting(result);
                    result=this.obfuscateNestedFunctions(result);
                    result=this.obfuscateNumberEncoding(result);
                    result=this.obfuscateControlFlow(result);
                    result=this.obfuscateVariableRenaming(result);
                    result=this.obfuscateStringManipulation(result);
                    result=this.obfuscateXOR(result);
                    result=this.obfuscateHex(result);
                    result=this.obfuscateBase64(result);
                }else if(method==='base64'){
                    result=this.obfuscateBase64(result);
                }else if(method==='xor'){
                    result=this.obfuscateXOR(result);
                }else if(method==='hex'){
                    result=this.obfuscateHex(result);
                }else if(method==='variable'){
                    result=this.obfuscateVariableRenaming(result);
                }else if(method==='controlFlow'){
                    result=this.obfuscateControlFlow(result);
                }else if(method==='number'){
                    result=this.obfuscateNumberEncoding(result);
                }
                return result;
            }
        }

        class Deobfuscator{
            static decodeBase64(str){
                try{
                    return atob(str);
                }catch{
                    return str;
                }
            }
            static decodeXOR(str,key=42){
                return String.fromCharCode(...str.split('').map((c,i)=>c.charCodeAt(0)^(key+i%13)));
            }
            static decodeStringManipulation(str){
                let result=str.replace(/\[(\d+)\]/g,(_,num)=>String.fromCharCode(parseInt(num)));
                result=result.split('').reverse().join('');
                return result;
            }
            static decodeHex(str){
                try{
                    return str.replace(/\\x([0-9A-Fa-f]{2})/g,(_,hex)=>String.fromCharCode(parseInt(hex,16)));
                }catch{
                    return str;
                }
            }
            static decodeControlFlow(str){
                return str.replace(/\(function\(\)\{([\s\S]*?);return (?:Math\.random\(\) > 0\.5 \? true : true);?\}\)\(\);?/g,'$1');
            }
            static decodeNumberEncoding(str){
                return str.replace(/Number\(([^)]+)\)/g,(_,expr)=>{
                    const hex=expr.replace(/[^0-9a-fA-F]/g,'');
                    return parseInt(hex,16).toString();
                });
            }
            static decodeStringSplitting(str){
                try{
                    const segments=str.split('+');
                    return segments.map(segment=>{
                        const chars=segment.match(/String\.fromCharCode\(([\d,]+)\)/)?.[1].split(',').map(Number);
                        return chars?String.fromCharCode(...chars):segment;
                    }).join('');
                }catch{
                    return str;
                }
            }
            static decodePolybiusSquare(str){
                const polybiusMap={};
                'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach((c,i)=>{
                    polybiusMap[(Math.floor(i/5)+1)+''+((i%5)+1)]=c;
                });
                let result='';
                for(let i=0;i<str.length;i+=2){
                    const pair=str.slice(i,i+2);
                    result+=polybiusMap[pair]||(pair.match(/[0-9]/)?pair:'#');
                }
                return result;
            }
            static decodeNestedFunctions(str){
                try{
                    const match=str.match(/\(\(x\)=>\(y\)=>\(z\)=>z\(x\(y\)\)\)\(x=>x\.split\(''\)\.reverse\(\)\.join\(''\)\)\(x=>x\.split\(''\)\.map\(c=>String\.fromCharCode\(c\.charCodeAt\(0\)\+1\)\)\.join\(''\)\)\((.*?)\)/);
                    if(!match)return str;
                    let result=JSON.parse(match[1]);
                    result=result.split('').map(c=>String.fromCharCode(c.charCodeAt(0)-1)).join('');
                    result=result.split('').reverse().join('');
                    return result;
                }catch{
                    return str;
                }
            }
            static deobfuscate(code){
                let result=code;
                let methods=['base64','xor','hex','stringManipulation','controlFlow','number','stringSplitting','polybiusSquare','nestedFunctions'];
                for(let i=0;i<methods.length*2;i++){
                    const method=methods[i%methods.length];
                    if(method==='base64')result=this.decodeBase64(result);
                    else if(method==='xor')result=this.decodeXOR(result);
                    else if(method==='hex')result=this.decodeHex(result);
                    else if(method==='stringManipulation')result=this.decodeStringManipulation(result);
                    else if(method==='controlFlow')result=this.decodeControlFlow(result);
                    else if(method==='number')result=this.decodeNumberEncoding(result);
                    else if(method==='stringSplitting')result=this.decodeStringSplitting(result);
                    else if(method==='polybiusSquare')result=this.decodePolybiusSquare(result);
                    else if(method==='nestedFunctions')result=this.decodeNestedFunctions(result);
                    else break;
                }
                return result;
            }
        }

        class MediaProcessor{
            static async analyzeImage(imageFile){
                const imageUrl=await readImage(imageFile);
                const response=await fetch(API_URL,{
                    method:'POST',
                    headers:{
                        'Authorization':`Bearer ${API_KEY}`,
                        'Content-Type':'application/json'
                    },
                    body:JSON.stringify({
                        model:"gpt-4o",
                        messages:[{role:"user",content:`Analyze this image:\n![Image](${imageUrl})`}],
                        max_tokens:aiModels[selectedAiModel].maxTokens,
                        temperature:aiModels[selectedAiModel].temperature
                    })
                });
                if(!response.ok)return "Unable to analyze image.";
                const data=await response.json();
                return data.choices[0].message.content;
            }
            static async analyzeVideo(videoFile){
                if(videoFile.size>MAX_VIDEO_SIZE)return `Video size exceeds ${MAX_VIDEO_SIZE/1024/1024}MB limit.`;
                const formData=new FormData();
                formData.append('file',videoFile);
                const response=await fetch(VIDEO_PROCESSING_API,{
                    method:'POST',
                    headers:{'Authorization':`Bearer ${API_KEY}`},
                    body:formData
                });
                if(!response.ok)return "Unable to analyze video.";
                const data=await response.json();
                return data.analysis||'No analysis available.';
            }
            static async generateImage(prompt){
                const response=await fetch(DALLE_API_URL,{
                    method:'POST',
                    headers:{
                        'Authorization':`Bearer ${API_KEY}`,
                        'Content-Type':'application/json'
                    },
                    body:JSON.stringify({
                        prompt:prompt,
                        n:1,
                        size:"1024x1024"
                    })
                });
                if(!response.ok)return "Failed to generate image.";
                const data=await response.json();
                return data.data[0].url;
            }
            static async generateVideo(prompt){
                const response=await fetch(SORA_API_URL,{
                    method:'POST',
                    headers:{
                        'Authorization':`Bearer ${API_KEY}`,
                        'Content-Type':'application/json'
                    },
                    body:JSON.stringify({
                        prompt:prompt,
                        duration:10,
                        resolution:"1280x720"
                    })
                });
                if(!response.ok)return "Failed to generate video.";
            const data=await response.json();
            return data.data[0].url;
        }
    }

    class DDoSProtection{
        static analyzeRequest(userId,request){
            const now=Date.now();
            const userRequests=userRequestCounts.get(userId)||[];
            const recentRequests=userRequests.filter(t=>now-t<RATE_LIMIT_WINDOW);
            userRequestCounts.set(userId,recentRequests);
            if(recentRequests.length>=RATE_LIMIT_REQUESTS){
                const delay=Math.min(5000,500*recentRequests.length);
                return new Promise(resolve=>setTimeout(resolve,delay,true));
            }
            recentRequests.push(now);
            userRequestCounts.set(userId,recentRequests);
            if(!request.csrfToken||request.csrfToken!==sha256(userId+API_KEY))return false;
            return true;
        }
    }

    function initializeWebSocket(){
        ws=new WebSocket('wss://api.openai.com/v1/stream');
        ws.onopen=()=>{
            ws.send(JSON.stringify({auth:API_KEY}));
        };
        ws.onmessage=async(event)=>{
            const message=JSON.parse(event.data);
            if(wsMessageCache.has(message.id))return;
            wsMessageCache.set(message.id,true);
            if(message.type==='responseChunk'){
                const aiMessage=chatHistory.lastElementChild;
                if(!aiMessage|| !aiMessage.classList.contains('ai'))return;
                const contentDiv=aiMessage.querySelector('.chat-message-content');
                contentDiv.innerHTML+=message.chunk;
                chatArea.scrollTop=chatArea.scrollHeight;
                latestAiResponse+=message.chunk;
            }
        };
        ws.onerror=()=>{
            showNotification('WebSocket error—reconnecting...','error');
            setTimeout(initializeWebSocket,1000);
        };
        ws.onclose=()=>{
            setTimeout(initializeWebSocket,1000);
        };
    }

    async function readImage(file){
        return new Promise((resolve,reject)=>{
            const reader=new FileReader();
            reader.onload=()=>resolve(reader.result);
            reader.onerror=reject;
            reader.readAsDataURL(file);
        });
    }

    async function readText(file){
        return new Promise((resolve,reject)=>{
            const reader=new FileReader();
            reader.onload=()=>resolve(reader.result);
            reader.onerror=reject;
            reader.readAsText(file);
        });
    }

    function initializeDB(){
        const request=indexedDB.open('VerbiFlowDB',1);
        request.onupgradeneeded=(event)=>{
            db=event.target.result;
            db.createObjectStore('chatHistory',{keyPath:'id',autoIncrement:true});
            db.createObjectStore('mediaCache',{keyPath:'id'});
        };
        request.onsuccess=(event)=>{
            db=event.target.result;
        };
        request.onerror=()=>{
            showNotification('Failed to initialize database.','error');
        };
    }

    function cacheResponse(prompt,response){
        if(!db)return;
        const transaction=db.transaction(['chatHistory'],'readwrite');
        const store=transaction.objectStore('chatHistory');
        const data={prompt,response,timestamp:Date.now()};
        store.add(data);
        cacheSize+=JSON.stringify(data).length;
        if(cacheSize>MAX_CACHE_SIZE){
            const clearTransaction=db.transaction(['chatHistory'],'readwrite');
            const clearStore=clearTransaction.objectStore('chatHistory');
            clearStore.clear();
            cacheSize=0;
        }
    }

    function initializeWorkerPool(){
        const numWorkers=navigator.hardwareConcurrency*1.15||6;
        for(let i=0;i<numWorkers;i++){
            const worker=new Worker(URL.createObjectURL(new Blob([`
                self.onmessage=async(e)=>{
                    const {prompt}=e.data;
                    const response=await fetch('https://api.openai.com/v1/chat/completions',{
                        method:'POST',
                        headers:{
                            'Authorization':'Bearer ${API_KEY}',
                            'Content-Type':'application/json'
                        },
                        body:JSON.stringify({
                            model:'gpt-4o',
                            messages:[{role:'user',content:prompt}],
                            max_tokens:${aiModels[selectedAiModel].maxTokens},
                            temperature:${aiModels[selectedAiModel].temperature}
                        })
                    }).then(res=>res.json());
                    self.postMessage(response.choices[0].message.content);
                };
            `],{type:'application/javascript'})));
            workerPool.push(worker);
        }
    }

    async function processWithWorker(prompt){
        const worker=workerPool.shift();
        return new Promise((resolve,reject)=>{
            worker.onmessage=(e)=>resolve(e.data);
            worker.onerror=reject;
            worker.postMessage({prompt});
            workerPool.push(worker);
        });
    }

    async function batchProcessRequests(){
        if(isProcessing||!batchQueue.length)return;
        isProcessing=true;
        const batch=batchQueue.splice(0,BATCH_SIZE);
        const promises=batch.map(async({message,userId,resolve})=>{
            const isAllowed=await DDoSProtection.analyzeRequest(userId,{csrfToken:sha256(userId+API_KEY)});
            if(!isAllowed){
                resolve("Request blocked due to security concerns.");
                return;
            }
            const response=await processWithWorker(message);
            resolve(response);
        });
        await Promise.all(promises);
        isProcessing=false;
        batchProcessRequests();
    }

    async function fetchResponse(prompt,stream=false){
        if(stream&&ws&&ws.readyState===WebSocket.OPEN){
            ws.send(JSON.stringify({
                type:'request',
                prompt,
                model:'gpt-4o',
                max_tokens:aiModels[selectedAiModel].maxTokens,
                temperature:aiModels[selectedAiModel].temperature
            }));
            return '';
        }
        const response=await fetch(API_URL,{
            method:'POST',
            headers:{
                'Authorization':`Bearer ${API_KEY}`,
                'Content-Type':'application/json'
            },
            body:JSON.stringify({
                model:'gpt-4o',
                messages:conversationHistory.concat([{role:'user',content:prompt}]),
                max_tokens:aiModels[selectedAiModel].maxTokens,
                temperature:aiModels[selectedAiModel].temperature,
                stream
            }),
            signal:abortController?.signal
        });
        if(!response.ok)return "Failed to fetch response.";
        if(stream){
            const reader=response.body.getReader();
            let result='';
            const aiMessage=document.createElement('div');
            aiMessage.className='chat-message ai';
            aiMessage.innerHTML=`<div class="chat-message-content"></div><div class="chat-message-meta">Just now</div>`;
            chatHistory.appendChild(aiMessage);
            chatArea.scrollTop=chatArea.scrollHeight;
            while(true){
                const {done,value}=await reader.read();
                if(done)break;
                const chunk=new TextDecoder().decode(value);
                const lines=chunk.split('\n').filter(line=>line.startsWith('data:'));
                for(const line of lines){
                    if(line==='data: [DONE]')break;
                    const json=JSON.parse(line.replace('data: ',''));
                    const content=json.choices[0].delta.content||'';
                    aiMessage.querySelector('.chat-message-content').innerHTML+=content;
                    result+=content;
                    chatArea.scrollTop=chatArea.scrollHeight;
                }
            }
            return result;
        }
        const data=await response.json();
        return data.choices[0].message.content;
    }

    async function prefetchResponses(){
        const recentMessages=conversationHistory.slice(-3).map(m=>m.content);
        const keywords=recentMessages.join(' ').match(/\b\w+\b/g)?.slice(-7)||[];
        for(const keyword of keywords){
            if(prefetchQueue.has(keyword))continue;
            prefetchQueue.set(keyword,true);
            const response=await fetchResponse(`Tell me about ${keyword}`,false);
            responseCache.set(keyword,response);
        }
    }

    function formatAiResponse(content){
        content=content.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
        content=content.replace(/\*(.*?)\*/g,'<em>$1</em>');
        content=content.replace(/`(.*?)`/g,'<code>$1</code>');
        content=content.replace(/^### (.*)$/gm,'<h3>$1</h3>');
        content=content.replace(/^- (.*)$/gm,'<ul><li>$1</li></ul>');
        content=content.replace(/^\d+\. (.*)$/gm,'<ol><li>$1</li></ol>');
        content=content.replace(/\|.*\|/g,table=>{
            const rows=table.split('\n').filter(row=>row.trim());
            if(rows.length<2)return table;
            const headers=rows[0].split('|').filter(cell=>cell.trim()).map(cell=>`<th>${cell.trim()}</th>`).join('');
            const body=rows.slice(2).map(row=>`<tr>${row.split('|').filter(cell=>cell.trim()).map(cell=>`<td>${cell.trim()}</td>`).join('')}</tr>`).join('');
            return `<table><thead><tr>${headers}</tr></thead><tbody>${body}</tbody></table>`;
        });
        const codeBlocks=content.match(/```[\s\S]*?```/g)||[];
        latestCodeBlocks=codeBlocks.map(block=>block.replace(/```/g,'').trim());
        content=content.replace(/```[\s\S]*?```/g,'<div class="code-block"><pre><code>CONTENT</code></pre><button class="copy-btn">Copy</button></div>').replace(/CONTENT/g,()=>latestCodeBlocks.shift()||'');
        return content;
    }

    async function handleUserInput(){
        const message=userInput.value.trim();
        if(!message&&!filesArray.length)return;
        const userId=sha256(navigator.userAgent+Date.now().toString());
        if(!await DDoSProtection.analyzeRequest(userId,{csrfToken:sha256(userId+API_KEY)})){
            showNotification('Request blocked due to security concerns.','error');
            return;
        }
        if(verifyAdminAccess(message))return;
        if(message.toLowerCase().includes('play a music')||message.toLowerCase().includes('background music')){
            await playBackgroundMusic(message);
            return;
        }
        const userMessage=document.createElement('div');
        userMessage.className='chat-message user';
        userMessage.innerHTML=`<div class="chat-message-content">${message}</div><div class="chat-message-meta">Just now</div>`;
        chatHistory.appendChild(userMessage);
        chatArea.scrollTop=chatArea.scrollHeight;
        conversationHistory.push({role:'user',content:message});
        userInput.value='';
        sendBtn.disabled=true;
        loadingSpinner.style.display='block';
        typingIndicator.style.display='block';
        isGenerating=true;
        stopGeneratingBtn.style.display='block';
        abortController=new AbortController();
        let fullResponse;
        try{
            fullResponse=await fetchResponse(message,true);
        }catch(error){
            if(error.name==='AbortError'){
                showNotification('Generation stopped.');
            }else{
                showNotification('Error generating response.','error');
            }
        }
        isGenerating=false;
        stopGeneratingBtn.style.display='none';
        loadingSpinner.style.display='none';
        typingIndicator.style.display='none';
        sendBtn.disabled=false;
        if(!fullResponse){
            fullResponse=latestAiResponse;
            latestAiResponse='';
        }
        const formattedResponse=formatAiResponse(fullResponse);
        const aiMessage=document.createElement('div');
        aiMessage.className='chat-message ai';
        aiMessage.innerHTML=`<div class="chat-message-content">${formattedResponse}</div><div class="chat-message-meta">Just now</div>`;
        chatHistory.appendChild(aiMessage);
        chatArea.scrollTop=chatArea.scrollHeight;
        conversationHistory.push({role:'assistant',content:fullResponse});
        cacheResponse(message,fullResponse);
        generationTimeout=setTimeout(()=>{
            keepGeneratingBtn.style.display='block';
            keepGeneratingBtn.classList.add('show');
        },3500);
        const copyButtons=aiMessage.querySelectorAll('.copy-btn');
        copyButtons.forEach(btn=>{
            btn.addEventListener('click',()=>{
                const code=btn.previousElementSibling.textContent;
                navigator.clipboard.writeText(code);
                showNotification('Code copied!');
            });
        });
        for(const file of filesArray){
            let analysis;
            if(file.type.startsWith('image/')){
                analysis=await MediaProcessor.analyzeImage(file);
            }else if(file.type.startsWith('video/')){
                analysis=await MediaProcessor.analyzeVideo(file);
            }else if(file.type.startsWith('text/')||file.type.match(/application\/(json|xml)/)){
                const text=await readText(file);
                analysis=`File content:\n\`\`\`\n${text}\n\`\`\``;
            }
            if(analysis){
                const fileMessage=document.createElement('div');
                fileMessage.className='chat-message ai';
                fileMessage.innerHTML=`<div class="chat-message-content">${formatAiResponse(analysis)}</div><div class="chat-message-meta">Just now</div>`;
                chatHistory.appendChild(fileMessage);
                chatArea.scrollTop=chatArea.scrollHeight;
                conversationHistory.push({role:'assistant',content:analysis});
            }
        }
        filesArray=[];
        fileList.innerHTML='';
        fileClearBtn.style.display='none';
    }

    userInput.addEventListener('input',()=>{
        userInput.style.height='auto';
        userInput.style.height=`${userInput.scrollHeight}px`;
    });

    userInput.addEventListener('keydown',(e)=>{
        if(e.key==='Enter'&&!e.shiftKey){
            e.preventDefault();
            handleUserInput();
        }
    });

    sendBtn.addEventListener('click',handleUserInput);

    fileInput.addEventListener('change',async()=>{
        const files=Array.from(fileInput.files);
        for(const file of files){
            if(file.size>MAX_FILE_SIZE){
                showNotification(`File "${file.name}" exceeds ${MAX_FILE_SIZE/1024/1024}MB limit.`,'error');
                continue;
            }
            filesArray.push(file);
            const fileItem=document.createElement('div');
            fileItem.className='file-item';
            fileItem.innerHTML=`<div class="file-item-name">${file.name}</div><div class="file-item-details">${(file.size/1024/1024).toFixed(2)}MB</div><div class="file-progress" style="width:0%"></div>`;
            fileList.appendChild(fileItem);
            const progressBar=fileItem.querySelector('.file-progress');
            let progress=0;
            const interval=setInterval(()=>{
                progress+=10;
                progressBar.style.width=`${progress}%`;
                if(progress>=100){
                    clearInterval(interval);
                    fileItem.addEventListener('click',async()=>{
                        let content;
                        if(file.type.startsWith('image/')){
                            content=`<img src="${await readImage(file)}" alt="${file.name}">`;
                        }else if(file.type.startsWith('video/')){
                            content=`<video controls src="${URL.createObjectURL(file)}"></video>`;
                        }else if(file.type.startsWith('text/')||file.type.match(/application\/(json|xml)/)){
                            content=`<pre>${await readText(file)}</pre>`;
                        }
                        filePreviewContent.innerHTML=content;
                        filePreviewModal.classList.add('open');
                    });
                }
            },50);
        }
        fileClearBtn.style.display=filesArray.length?'block':'none';
        fileInput.value='';
    });

    fileClearBtn.addEventListener('click',()=>{
        filesArray=[];
        fileList.innerHTML='';
        fileClearBtn.style.display='none';
    });

    filePreviewClose.addEventListener('click',()=>{
        filePreviewModal.classList.remove('open');
        filePreviewContent.innerHTML='';
    });

    clearChatBtn.addEventListener('click',()=>{
        chatHistory.innerHTML='';
        conversationHistory=[{role:'assistant',content:aiModels[selectedAiModel].personality}];
        const aiMessage=document.createElement('div');
        aiMessage.className='chat-message ai';
        aiMessage.innerHTML=`<div class="chat-message-content">${aiModels[selectedAiModel].personality}</div><div class="chat-message-meta">Just now</div>`;
        chatHistory.appendChild(aiMessage);
        chatArea.scrollTop=chatArea.scrollHeight;
        showNotification('Chat cleared!');
    });

    copyCodeBtn.addEventListener('click',()=>{
        if(latestCodeBlocks.length){
            navigator.clipboard.writeText(latestCodeBlocks.join('\n\n'));
            showNotification('All code blocks copied!');
        }else{
            showNotification('No code blocks to copy.','error');
        }
    });

    discordBtn.addEventListener('click',()=>{
        window.open(DISCORD_INVITE,'_blank');
    });

    verbiflowUpdatesBtn.addEventListener('click',()=>{
        const aiMessage=document.createElement('div');
        aiMessage.className='chat-message ai';
        aiMessage.innerHTML=`<div class="chat-message-content">Here are the latest updates for VerbiFlow:\n- Enhanced UI with full-screen layout.\n- Added Share Chat feature.\n- Improved performance with faster response streaming.</div><div class="chat-message-meta">Just now</div>`;
        chatHistory.appendChild(aiMessage);
        chatArea.scrollTop=chatArea.scrollHeight;
        conversationHistory.push({role:'assistant',content:"Here are the latest updates for VerbiFlow:\n- Enhanced UI with full-screen layout.\n- Added Share Chat feature.\n- Improved performance with faster response streaming."});
    });

    premiumPriceBtn.addEventListener('click',()=>{
        const aiMessage=document.createElement('div');
        aiMessage.className='chat-message ai';
        aiMessage.innerHTML=`<div class="chat-message-content">For premium pricing details, please visit our official page: <a href="https://x.ai/grok" target="_blank">x.ai/grok</a>.</div><div class="chat-message-meta">Just now</div>`;
        chatHistory.appendChild(aiMessage);
        chatArea.scrollTop=chatArea.scrollHeight;
        conversationHistory.push({role:'assistant',content:"For premium pricing details, please visit our official page: https://x.ai/grok"});
    });

    shareChatBtn.addEventListener('click',()=>{
        const chatContent=conversationHistory.map(msg=>`${msg.role}: ${msg.content}`).join('\n\n');
        const blob=new Blob([chatContent],{type:'text/plain'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download='VerbiFlow_Chat.txt';
        a.click();
        URL.revokeObjectURL(url);
        showNotification('Chat exported!');
    });

    themeBtn.addEventListener('click',toggleTheme);

    codeSidebarClose.addEventListener('click',()=>{
        codeSidebar.classList.remove('open');
    });

    keepGeneratingBtn.addEventListener('click',async()=>{
        keepGeneratingBtn.style.display='none';
        keepGeneratingBtn.classList.remove('show');
        const lastPrompt=conversationHistory[conversationHistory.length-2]?.content||'';
        const lastResponse=conversationHistory[conversationHistory.length-1]?.content||'';
        const newPrompt=`Continue from: ${lastResponse}`;
        conversationHistory.push({role:'user',content:newPrompt});
        const userMessage=document.createElement('div');
        userMessage.className='chat-message user';
        userMessage.innerHTML=`<div class="chat-message-content">Continue generating...</div><div class="chat-message-meta">Just now</div>`;
        chatHistory.appendChild(userMessage);
        chatArea.scrollTop=chatArea.scrollHeight;
        loadingSpinner.style.display='block';
        typingIndicator.style.display='block';
        isGenerating=true;
        stopGeneratingBtn.style.display='block';
        abortController=new AbortController();
        let fullResponse;
        try{
            fullResponse=await fetchResponse(newPrompt,true);
        }catch(error){
            if(error.name==='AbortError'){
                showNotification('Generation stopped.');
            }else{
                showNotification('Error generating response.','error');
            }
        }
        isGenerating=false;
        stopGeneratingBtn.style.display='none';
        loadingSpinner.style.display='none';
        typingIndicator.style.display='none';
        if(!fullResponse){
            fullResponse=latestAiResponse;
            latestAiResponse='';
        }
        const formattedResponse=formatAiResponse(fullResponse);
        const aiMessage=document.createElement('div');
        aiMessage.className='chat-message ai';
        aiMessage.innerHTML=`<div class="chat-message-content">${formattedResponse}</div><div class="chat-message-meta">Just now</div>`;
        chatHistory.appendChild(aiMessage);
        chatArea.scrollTop=chatArea.scrollHeight;
        conversationHistory.push({role:'assistant',content:fullResponse});
        cacheResponse(newPrompt,fullResponse);
        generationTimeout=setTimeout(()=>{
            keepGeneratingBtn.style.display='block';
            keepGeneratingBtn.classList.add('show');
        },3500);
    });

    generateMediaBtn.addEventListener('click',async()=>{
        if(!hasPermission){
            requestPermissions();
            return;
        }
        const prompt=userInput.value.trim()||'Generate a random image';
        loadingSpinner.style.display='block';
        typingIndicator.style.display='block';
        let mediaUrl;
        if(prompt.toLowerCase().includes('video')){
            mediaUrl=await MediaProcessor.generateVideo(prompt);
        }else{
            mediaUrl=await MediaProcessor.generateImage(prompt);
        }
        loadingSpinner.style.display='none';
        typingIndicator.style.display='none';
        if(!mediaUrl.startsWith('http')){
            showNotification(mediaUrl,'error');
            return;
        }
        const aiMessage=document.createElement('div');
        aiMessage.className='chat-message ai';
        const mediaElement=prompt.toLowerCase().includes('video')?`<video controls src="${mediaUrl}"></video>`:`<img src="${mediaUrl}" alt="Generated Media">`;
        aiMessage.innerHTML=`<div class="chat-message-content">${mediaElement}</div><div class="chat-message-meta">Just now</div>`;
        chatHistory.appendChild(aiMessage);
        chatArea.scrollTop=chatArea.scrollHeight;
        conversationHistory.push({role:'assistant',content:`Generated media: ${mediaUrl}`});
    });

    schoolHelpDropdown.addEventListener('change',()=>{
        selectedSchoolMode=schoolHelpDropdown.value;
        if(selectedSchoolMode){
            userInput.value=`Help me with ${selectedSchoolMode}...`;
            userInput.focus();
        }
    });

    aiModelDropdown.addEventListener('change',()=>{
        selectedAiModel=aiModelDropdown.value;
        clearChatBtn.click();
    });

    rephraseBtn.addEventListener('click',async()=>{
        const lastMessage=conversationHistory[conversationHistory.length-1]?.content||'';
        if(!lastMessage||conversationHistory[conversationHistory.length-1].role!=='assistant'){
            showNotification('No AI response to rephrase.','error');
            return;
        }
        const rephrasePrompt=`Rephrase the following: ${lastMessage}`;
        conversationHistory.push({role:'user',content:rephrasePrompt});
        const userMessage=document.createElement('div');
        userMessage.className='chat-message user';
        userMessage.innerHTML=`<div class="chat-message-content">Rephrase the last response...</div><div class="chat-message-meta">Just now</div>`;
        chatHistory.appendChild(userMessage);
        chatArea.scrollTop=chatArea.scrollHeight;
        loadingSpinner.style.display='block';
        typingIndicator.style.display='block';
        const rephrased=await fetchResponse(rephrasePrompt,false);
        loadingSpinner.style.display='none';
        typingIndicator.style.display='none';
        const formattedResponse=formatAiResponse(rephrased);
        const aiMessage=document.createElement('div');
        aiMessage.className='chat-message ai';
        aiMessage.innerHTML=`<div class="chat-message-content">${formattedResponse}</div><div class="chat-message-meta">Just now</div>`;
        chatHistory.appendChild(aiMessage);
        chatArea.scrollTop=chatArea.scrollHeight;
        conversationHistory.push({role:'assistant',content:rephrased});
        cacheResponse(rephrasePrompt,rephrased);
    });

    stopGeneratingBtn.addEventListener('click',()=>{
        if(isGenerating){
            abortController?.abort();
            isGenerating=false;
            stopGeneratingBtn.style.display='none';
            loadingSpinner.style.display='none';
            typingIndicator.style.display='none';
            sendBtn.disabled=false;
        }
    });

    document.addEventListener('paste',async(e)=>{
        const items=e.clipboardData.items;
        for(const item of items){
            if(item.type.startsWith('image/')){
                const file=item.getAsFile();
                const hash=sha256(await readImage(file));
                if(pastedImageHashes.has(hash))continue;
                pastedImageHashes.add(hash);
                filesArray.push(file);
                const fileItem=document.createElement('div');
                fileItem.className='file-item';
                fileItem.innerHTML=`<div class="file-item-name">Pasted Image</div><div class="file-item-details">${(file.size/1024/1024).toFixed(2)}MB</div>`;
                fileList.appendChild(fileItem);
                fileItem.addEventListener('click',async()=>{
                    filePreviewContent.innerHTML=`<img src="${await readImage(file)}" alt="Pasted Image">`;
                    filePreviewModal.classList.add('open');
                });
                fileClearBtn.style.display='block';
            }
        }
    });

    window.addEventListener('beforeunload',()=>{
        if(backgroundAudio)backgroundAudio.pause();
        if(ws)ws.close();
        workerPool.forEach(worker=>worker.terminate());
    });

    loadTheme();
    initializeDB();
    initializeWorkerPool();
    initializeWebSocket();
    setInterval(prefetchResponses,2500);
    setInterval(batchProcessRequests,500);
</script>
</body>
</html>
