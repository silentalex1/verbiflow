<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prysmis AI - #1 Best AI Website</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #e6f0ff 0%, #c3d7ff 100%);
            color: #1a2740;
            line-height: 1.6;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        body.dark-mode {
            background: linear-gradient(135deg, #1a2740 0%, #0a1226 100%);
            color: #d1d9e6;
        }
        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }
        .sidebar {
            width: 0;
            background: #ffffff;
            padding: 0;
            overflow-y: auto;
            transition: all 0.3s ease;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        .sidebar.open {
            width: 280px;
            padding: 1rem;
        }
        .sidebar-content {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            background: #ffffff;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f5f9ff;
            scrollbar-width: thin;
            scrollbar-color: #8a9ab0 #f5f9ff;
        }
        .chat-message {
            max-width: 65%;
            padding: 0.75rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            animation: fadeIn 0.3s ease forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message.user {
            align-self: flex-end;
            background: #d1e7ff;
            margin-left: auto;
        }
        .chat-message.ai {
            align-self: flex-start;
            background: #d9f0ff;
        }
        .chat-input-area {
            background: #ffffff;
            padding: 0.75rem;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }
        .file-upload-progress {
            height: 4px;
            background: #d1d9e6;
            border-radius: 2px;
            overflow: hidden;
        }
        .file-upload-progress div {
            height: 100%;
            background: #2b6cb0;
            transition: width 0.3s ease;
        }
        .preloader {
            position: fixed;
            inset: 0;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.6s ease;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #2b6cb0;
            border-top: 4px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: #ffffff;
            padding: 1.5rem;
            border-radius: 12px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal.open .modal-content {
            transform: scale(1);
        }
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            color: #ffffff;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        button {
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        button:hover {
            transform: scale(1.05);
        }
        button:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div class="preloader" id="preloader">
        <div class="loading-spinner"></div>
        <div class="loading-text mt-4 text-lg text-blue-700 opacity-0 transition-opacity duration-600" id="loadingText"></div>
        <div class="api-key-container mt-6 flex flex-col gap-4 max-w-md opacity-0 transition-opacity duration-800" id="apiKeyContainer">
            <input type="text" id="apiKeyInput" class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-300 outline-none" placeholder="Enter your OpenAI API key">
            <button id="apiKeySubmit" class="bg-blue-700 text-white p-3 rounded-lg hover:bg-blue-800">Submit</button>
        </div>
    </div>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-content">
                <button class="sidebar-close bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700" id="sidebarClose"><i class="fas fa-times"></i> Close</button>
                <button class="clear-chat-btn bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800" id="clearChatBtn"><i class="fas fa-trash"></i> Clear Chat</button>
                <button class="export-chat-btn bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800" id="exportChatBtn"><i class="fas fa-download"></i> Export Chat</button>
                <button class="share-website-btn bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800" id="shareWebsiteBtn"><i class="fas fa-share"></i> Share Website</button>
                <button class="feedback-btn bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800" id="feedbackBtn"><i class="fas fa-comment"></i> Feedback</button>
                <button class="prysmis-updates-btn bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800" id="prysmisUpdatesBtn"><i class="fas fa-info-circle"></i> Updates</button>
            </div>
        </div>
        <div class="chat-container">
            <div class="chat-header">
                <button class="menu-btn bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800" id="menuBtn"><i class="fas fa-bars"></i> Menu</button>
                <div class="flex gap-2">
                    <button class="theme-btn bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800" id="themeBtn"><i class="fas fa-moon"></i> Dark Mode</button>
                    <button class="user-profile-btn bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800" id="userProfileBtn"><i class="fas fa-user"></i> Profile</button>
                    <span class="message-counter text-gray-700 font-medium" id="messageCounter">Messages: 0</span>
                </div>
            </div>
            <div class="chat-area" id="chatArea">
                <div class="chat-history flex flex-col gap-3" id="chatHistory"></div>
                <div class="typing-indicator hidden text-gray-600 mt-3" id="typingIndicator">Prysmis AI is typing...</div>
            </div>
            <div class="chat-input-area">
                <div class="file-actions-container mb-3 max-h-48 overflow-hidden transition-all duration-300 opacity-100" id="fileActionsContainer">
                    <div class="file-input-wrapper flex gap-2 items-center">
                        <label for="fileInput" class="file-input-label bg-blue-700 text-white px-4 py-2 rounded-lg cursor-pointer hover:bg-blue-800"><i class="fas fa-upload"></i> Upload File</label>
                        <input type="file" id="fileInput" class="file-input hidden" multiple>
                        <button class="file-clear-btn hidden bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700" id="fileClearBtn"><i class="fas fa-trash"></i> Clear Files</button>
                    </div>
                    <div class="file-list mt-2 flex flex-col gap-2 max-h-36 overflow-y-auto" id="fileList"></div>
                    <div class="file-upload-progress mt-2" id="fileUploadProgress"><div style="width: 0%"></div></div>
                </div>
                <button class="toggle-actions-btn bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800 mb-2" id="toggleActionsBtn">Hide File Actions</button>
                <div class="input-wrapper flex gap-2 items-center">
                    <textarea class="user-input flex-1 p-3 border rounded-lg resize-none min-h-12 max-h-32 bg-gray-50 focus:border-blue-700 focus:ring-2 focus:ring-blue-300 outline-none" id="userInput" placeholder="Type your message..."></textarea>
                    <button class="send-btn bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800" id="sendBtn"><i class="fas fa-paper-plane"></i> Send</button>
                    <button class="rephrase-btn bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800" id="rephraseBtn"><i class="fas fa-redo"></i> Rephrase</button>
                    <button class="voice-input-btn bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800" id="voiceInputBtn"><i class="fas fa-microphone"></i></button>
                </div>
            </div>
        </div>
    </div>
    <div class="notification" id="notification"></div>
    <div class="modal" id="userProfileModal">
        <div class="modal-content">
            <button class="modal-close absolute top-3 right-3 text-red-600 hover:text-red-700" id="userProfileClose"><i class="fas fa-times fa-lg"></i></button>
            <h3 class="text-xl font-bold mb-4">User Profile</h3>
            <input type="text" id="usernameInput" class="w-full p-3 border rounded-lg mb-4 focus:ring-2 focus:ring-blue-300 outline-none" placeholder="Enter your username">
            <select id="chatLayoutSelect" class="w-full p-3 border rounded-lg mb-4 focus:ring-2 focus:ring-blue-300 outline-none">
                <option value="default">Default Layout</option>
                <option value="compact">Compact</option>
                <option value="spacious">Spacious</option>
            </select>
            <label class="text-sm text-gray-700">Font Size (px):</label>
            <input type="number" id="fontSizeInput" min="12" max="24" value="16" class="w-full p-3 border rounded-lg mb-4 focus:ring-2 focus:ring-blue-300 outline-none">
            <label class="text-sm text-gray-700 flex items-center gap-2 mb-4">
                <input type="checkbox" id="autoScrollToggle" checked>
                Auto-Scroll
            </label>
        </div>
    </div>
    <div class="modal" id="permissionModal">
        <div class="modal-content">
            <button class="modal-close absolute top-3 right-3 text-red-600 hover:text-red-700" id="permissionModalClose"><i class="fas fa-times fa-lg"></i></button>
            <h3 class="text-xl font-bold mb-4">Permission Required</h3>
            <p>Allow microphone access for voice commands?</p>
            <div class="mt-4 flex gap-2">
                <button id="grantPermissionBtn" class="bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800">Grant</button>
                <button id="denyPermissionBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Deny</button>
            </div>
        </div>
    </div>
    <div class="modal" id="confirmClearModal">
        <div class="modal-content">
            <button class="modal-close absolute top-3 right-3 text-red-600 hover:text-red-700" id="confirmClearModalClose"><i class="fas fa-times fa-lg"></i></button>
            <h3 class="text-xl font-bold mb-4">Confirm Clear Chat</h3>
            <p>Are you sure you want to clear the chat? This action cannot be undone.</p>
            <div class="mt-4 flex gap-2">
                <button id="confirmClearBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Clear</button>
                <button id="cancelClearBtn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Cancel</button>
            </div>
        </div>
    </div>
    <div class="modal" id="feedbackModal">
        <div class="modal-content">
            <button class="modal-close absolute top-3 right-3 text-red-600 hover:text-red-700" id="feedbackModalClose"><i class="fas fa-times fa-lg"></i></button>
            <h3 class="text-xl font-bold mb-4">Feedback</h3>
            <textarea id="feedbackInput" class="w-full p-3 border rounded-lg mb-4 focus:ring-2 focus:ring-blue-300 outline-none" placeholder="Enter your feedback..."></textarea>
            <button id="feedbackSubmitBtn" class="bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800">Submit</button>
        </div>
    </div>
    <script>
        const elements = {
            preloader: document.getElementById('preloader'),
            loadingText: document.getElementById('loadingText'),
            apiKeyContainer: document.getElementById('apiKeyContainer'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            apiKeySubmit: document.getElementById('apiKeySubmit'),
            chatArea: document.getElementById('chatArea'),
            chatHistory: document.getElementById('chatHistory'),
            userInput: document.getElementById('userInput'),
            sendBtn: document.getElementById('sendBtn'),
            rephraseBtn: document.getElementById('rephraseBtn'),
            typingIndicator: document.getElementById('typingIndicator'),
            themeBtn: document.getElementById('themeBtn'),
            userProfileBtn: document.getElementById('userProfileBtn'),
            messageCounter: document.getElementById('messageCounter'),
            fileInput: document.getElementById('fileInput'),
            fileClearBtn: document.getElementById('fileClearBtn'),
            fileList: document.getElementById('fileList'),
            fileActionsContainer: document.getElementById('fileActionsContainer'),
            toggleActionsBtn: document.getElementById('toggleActionsBtn'),
            fileUploadProgress: document.getElementById('fileUploadProgress'),
            userProfileModal: document.getElementById('userProfileModal'),
            userProfileClose: document.getElementById('userProfileClose'),
            usernameInput: document.getElementById('usernameInput'),
            chatLayoutSelect: document.getElementById('chatLayoutSelect'),
            fontSizeInput: document.getElementById('fontSizeInput'),
            autoScrollToggle: document.getElementById('autoScrollToggle'),
            voiceInputBtn: document.getElementById('voiceInputBtn'),
            permissionModal: document.getElementById('permissionModal'),
            permissionModalClose: document.getElementById('permissionModalClose'),
            grantPermissionBtn: document.getElementById('grantPermissionBtn'),
            denyPermissionBtn: document.getElementById('denyPermissionBtn'),
            notification: document.getElementById('notification'),
            sidebar: document.getElementById('sidebar'),
            sidebarClose: document.getElementById('sidebarClose'),
            menuBtn: document.getElementById('menuBtn'),
            clearChatBtn: document.getElementById('clearChatBtn'),
            confirmClearModal: document.getElementById('confirmClearModal'),
            confirmClearModalClose: document.getElementById('confirmClearModalClose'),
            confirmClearBtn: document.getElementById('confirmClearBtn'),
            cancelClearBtn: document.getElementById('cancelClearBtn'),
            exportChatBtn: document.getElementById('exportChatBtn'),
            shareWebsiteBtn: document.getElementById('shareWebsiteBtn'),
            feedbackBtn: document.getElementById('feedbackBtn'),
            feedbackModal: document.getElementById('feedbackModal'),
            feedbackModalClose: document.getElementById('feedbackModalClose'),
            feedbackInput: document.getElementById('feedbackInput'),
            feedbackSubmitBtn: document.getElementById('feedbackSubmitBtn'),
            prysmisUpdatesBtn: document.getElementById('prysmisUpdatesBtn')
        };
        const store = {
            state: {
                conversationHistory: [],
                messageCount: 0,
                filesArray: [],
                userProfile: { username: 'User', chatLayout: 'default', preferences: { fontSize: 16, autoScroll: true } },
                isDarkMode: false,
                apiKey: '',
                isApiKeyValid: false,
                deviceType: '',
                notificationQueue: [],
                rateLimit: { interval: 150, lastAction: 0 }
            },
            dispatch(action) {
                switch (action.type) {
                    case 'SET_STATE':
                        this.state = { ...this.state, ...action.payload };
                        this.saveState();
                        break;
                    case 'ADD_MESSAGE':
                        this.state.conversationHistory.push(action.payload);
                        this.state.messageCount++;
                        this.saveState();
                        break;
                    case 'SET_FILES':
                        this.state.filesArray = action.payload;
                        this.saveState();
                        break;
                    case 'CLEAR_CHAT':
                        this.state.conversationHistory = [];
                        this.state.messageCount = 0;
                        this.state.filesArray = [];
                        const welcomeMessage = {
                            id: Date.now(),
                            role: 'ai',
                            content: "Hello! I'm Prysmis AI, your assistant. How can I assist you today?",
                            timestamp: Date.now()
                        };
                        this.state.conversationHistory.push(welcomeMessage);
                        this.state.messageCount = 1;
                        this.saveState();
                        break;
                    case 'ENQUEUE_NOTIFICATION':
                        this.state.notificationQueue.push(action.payload);
                        this.saveState();
                        break;
                    case 'DEQUEUE_NOTIFICATION':
                        this.state.notificationQueue.shift();
                        this.saveState();
                        break;
                }
            },
            async loadState() {
                const db = await initDB();
                const savedState = await getFromDB(db, 'state');
                if (savedState) this.state = { ...this.state, ...savedState };
                if (this.state.conversationHistory.length === 0) {
                    const welcomeMessage = {
                        id: Date.now(),
                        role: 'ai',
                        content: "Hello! I'm Prysmis AI, your assistant. How can I assist you today?",
                        timestamp: Date.now()
                    };
                    this.dispatch({ type: 'ADD_MESSAGE', payload: welcomeMessage });
                    this.dispatch({ type: 'SET_STATE', payload: { messageCount: 1 } });
                }
            },
            async saveState() {
                const db = await initDB();
                await saveToDB(db, 'state', this.state);
            }
        };
        const openai = {
            async validateApiKey(apiKey) {
                try {
                    const response = await fetch('https://api.openai.com/v1/models', {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    });
                    return { success: response.ok, message: response.ok ? 'API key validated!' : 'Invalid API key.' };
                } catch (error) {
                    return { success: false, message: 'Network error during validation.' };
                }
            },
            async getAIResponse(userMessage, apiKey) {
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [
                                { role: 'system', content: 'You are Prysmis AI, an assistant. Provide concise and accurate responses.' },
                                { role: 'user', content: userMessage }
                            ],
                            max_tokens: 1000,
                            temperature: 0.5
                        })
                    });
                    if (!response.ok) throw new Error('Failed to fetch AI response');
                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    return `Error: ${error.message}. Please verify your API key or network connection.`;
                }
            },
            async rephraseMessage(message, apiKey) {
                const prompt = `Rephrase the following message in a different way, maintaining its meaning: "${message}"`;
                return await this.getAIResponse(prompt, apiKey);
            }
        };
        const initDB = () => new Promise((resolve, reject) => {
            const request = indexedDB.open('PrysmisDB', 1);
            request.onupgradeneeded = event => {
                const db = event.target.result;
                db.createObjectStore('state', { keyPath: 'id' });
            };
            request.onsuccess = event => resolve(event.target.result);
            request.onerror = event => reject(event.target.error);
        });
        const saveToDB = (db, storeName, data) => new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.put({ id: 'appState', ...data });
            request.onsuccess = () => resolve();
            request.onerror = event => reject(event.target.error);
        });
        const getFromDB = (db, storeName) => new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.get('appState');
            request.onsuccess = event => resolve(event.target.result);
            request.onerror = event => reject(event.target.error);
        });
        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), delay);
            };
        };
        const showNotification = (message, type = 'success') => {
            store.dispatch({ type: 'ENQUEUE_NOTIFICATION', payload: { message, type } });
            processNotificationQueue();
        };
        const processNotificationQueue = () => {
            if (store.state.notificationQueue.length === 0) return;
            const { message, type } = store.state.notificationQueue[0];
            elements.notification.textContent = message;
            elements.notification.className = `notification ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} show`;
            setTimeout(() => {
                elements.notification.className = 'notification';
                store.dispatch({ type: 'DEQUEUE_NOTIFICATION' });
                processNotificationQueue();
            }, 2000);
        };
        const sanitizeInput = input => {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        };
        const checkRateLimit = () => {
            const now = Date.now();
            if (now - store.state.rateLimit.lastAction < store.state.rateLimit.interval) {
                showNotification('Please wait before performing another action.', 'error');
                return false;
            }
            store.dispatch({ type: 'SET_STATE', payload: { rateLimit: { ...store.state.rateLimit, lastAction: now } } });
            return true;
        };
        const toggleTheme = () => {
            if (!checkRateLimit()) return;
            const isDarkMode = !store.state.isDarkMode;
            store.dispatch({ type: 'SET_STATE', payload: { isDarkMode } });
            document.body.classList.toggle('dark-mode');
            elements.themeBtn.innerHTML = `<i class="fas ${isDarkMode ? 'fa-sun' : 'fa-moon'}"></i> ${isDarkMode ? 'Light Mode' : 'Dark Mode'}`;
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        };
        const loadTheme = () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                store.dispatch({ type: 'SET_STATE', payload: { isDarkMode: true } });
                document.body.classList.add('dark-mode');
                elements.themeBtn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
            }
        };
        const renderMessages = () => {
            const fragment = document.createDocumentFragment();
            store.state.conversationHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${message.role}`;
                messageDiv.dataset.messageId = message.id;
                const contentDiv = document.createElement('div');
                contentDiv.className = 'chat-message-content';
                contentDiv.textContent = message.content;
                messageDiv.appendChild(contentDiv);
                fragment.appendChild(messageDiv);
            });
            elements.chatHistory.innerHTML = '';
            elements.chatHistory.appendChild(fragment);
            elements.messageCounter.textContent = `Messages: ${store.state.messageCount}`;
            if (store.state.userProfile.preferences.autoScroll) {
                elements.chatArea.scrollTo({ top: elements.chatArea.scrollHeight, behavior: 'smooth' });
            }
        };
        const handleSendMessage = async () => {
            if (!checkRateLimit()) return;
            const userMessage = sanitizeInput(elements.userInput.value.trim());
            if (!userMessage || userMessage.length > 1000) {
                showNotification(userMessage ? 'Input too long! Maximum 1000 characters.' : 'Please enter a message.', 'error');
                return;
            }
            const messageId = Date.now();
            const newMessage = { id: messageId, role: 'user', content: userMessage, timestamp: Date.now() };
            store.dispatch({ type: 'ADD_MESSAGE', payload: newMessage });
            elements.userInput.value = '';
            elements.typingIndicator.style.display = 'block';
            renderMessages();
            const aiResponse = await openai.getAIResponse(userMessage, store.state.apiKey);
            const aiMessage = { id: Date.now(), role: 'ai', content: aiResponse, timestamp: Date.now() };
            store.dispatch({ type: 'ADD_MESSAGE', payload: aiMessage });
            elements.typingIndicator.style.display = 'none';
            renderMessages();
        };
        const debouncedSendMessage = debounce(handleSendMessage, 100);
        const handleFileUpload = async event => {
            if (!checkRateLimit()) return;
            const files = Array.from(event.target.files);
            if (files.length > 5) {
                showNotification('Maximum 5 files allowed.', 'error');
                return;
            }
            const progressBar = elements.fileUploadProgress.querySelector('div');
            let uploaded = 0;
            const newFiles = [];
            for (const file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification(`File ${file.name} exceeds 5MB limit.`, 'error');
                    continue;
                }
                const fileId = Date.now() + Math.random();
                const fileObj = { id: fileId, name: file.name, type: file.type, size: file.size, data: null };
                try {
                    if (file.type.startsWith('text/')) {
                        fileObj.data = await new Promise(resolve => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.readAsText(file);
                        });
                    }
                    newFiles.push(fileObj);
                    uploaded++;
                    progressBar.style.width = `${(uploaded / files.length) * 100}%`;
                } catch (error) {
                    showNotification(`Failed to process ${file.name}.`, 'error');
                }
            }
            store.dispatch({ type: 'SET_FILES', payload: [...store.state.filesArray, ...newFiles] });
            renderFileList();
            progressBar.style.width = '0%';
            elements.fileClearBtn.classList.toggle('hidden', store.state.filesArray.length === 0);
            showNotification(`${uploaded} file(s) uploaded successfully!`);
        };
        const renderFileList = () => {
            elements.fileList.innerHTML = '';
            store.state.filesArray.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item p-2 bg-gray-100 rounded-lg flex justify-between items-center';
                fileItem.dataset.fileId = file.id;
                fileItem.innerHTML = `
                    <span class="text-sm">${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>
                    <button class="remove-file-btn text-red-600 hover:text-red-700"><i class="fas fa-trash"></i></button>
                `;
                elements.fileList.appendChild(fileItem);
            });
        };
        const clearFiles = () => {
            if (!checkRateLimit()) return;
            store.dispatch({ type: 'SET_FILES', payload: [] });
            elements.fileList.innerHTML = '';
            elements.fileClearBtn.classList.add('hidden');
            showNotification('All files cleared.');
        };
        const toggleFileActions = () => {
            const isHidden = elements.fileActionsContainer.classList.contains('max-h-0');
            elements.fileActionsContainer.classList.toggle('max-h-0', !isHidden);
            elements.fileActionsContainer.classList.toggle('max-h-48', isHidden);
            elements.fileActionsContainer.classList.toggle('opacity-0', !isHidden);
            elements.fileActionsContainer.classList.toggle('opacity-100', isHidden);
            elements.toggleActionsBtn.textContent = isHidden ? 'Hide File Actions' : 'Show File Actions';
        };
        const applyChatLayout = () => {
            const layout = store.state.userProfile.chatLayout;
            const fontSize = store.state.userProfile.preferences.fontSize;
            const content = elements.chatArea;
            if (layout === 'compact') {
                content.style.padding = '0.5rem';
                content.style.fontSize = `${fontSize - 2}px`;
            } else if (layout === 'spacious') {
                content.style.padding = '1.5rem';
                content.style.fontSize = `${fontSize + 2}px`;
            } else {
                content.style.padding = '1rem';
                content.style.fontSize = `${fontSize}px`;
            }
        };
        const saveUserProfile = () => {
            store.dispatch({
                type: 'SET_STATE',
                payload: {
                    userProfile: {
                        username: sanitizeInput(elements.usernameInput.value) || 'User',
                        chatLayout: elements.chatLayoutSelect.value,
                        preferences: {
                            fontSize: parseInt(elements.fontSizeInput.value) || 16,
                            autoScroll: elements.autoScrollToggle.checked
                        }
                    }
                }
            });
            applyChatLayout();
            showNotification('Profile updated!');
        };
        const handleVoiceInput = () => {
            if (!checkRateLimit()) return;
            if (!('webkitSpeechRecognition' in window)) {
                showNotification('Voice recognition not supported in this browser.', 'error');
                return;
            }
            elements.permissionModal.classList.add('open');
            elements.grantPermissionBtn.focus();
        };
        const startVoiceRecognition = () => {
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = true;
            recognition.onresult = event => {
                const transcript = Array.from(event.results).map(result => result[0].transcript).join('');
                elements.userInput.value = transcript;
            };
            recognition.onerror = event => {
                showNotification(`Voice recognition error: ${event.error}`, 'error');
            };
            recognition.onend = () => {
                showNotification('Voice recognition stopped.');
            };
            recognition.start();
        };
        const rephraseMessage = async () => {
            if (!checkRateLimit()) return;
            const userMessage = sanitizeInput(elements.userInput.value.trim());
            if (!userMessage) {
                showNotification('Please enter a message to rephrase.', 'error');
                return;
            }
            elements.typingIndicator.style.display = 'block';
            const rephrased = await openai.rephraseMessage(userMessage, store.state.apiKey);
            elements.userInput.value = rephrased;
            elements.typingIndicator.style.display = 'none';
            showNotification('Message rephrased!');
        };
        const toggleSidebar = () => {
            if (!checkRateLimit()) return;
            elements.sidebar.classList.toggle('open');
        };
        const clearChat = () => {
            if (!checkRateLimit()) return;
            elements.confirmClearModal.classList.add('open');
        };
        const confirmClearChat = () => {
            store.dispatch({ type: 'CLEAR_CHAT' });
            renderMessages();
            renderFileList();
            elements.fileClearBtn.classList.add('hidden');
            showNotification('Chat cleared!');
            elements.confirmClearModal.classList.remove('open');
        };
        const exportChat = () => {
            if (!checkRateLimit()) return;
            const chatData = JSON.stringify({
                conversationHistory: store.state.conversationHistory,
                timestamp: Date.now()
            }, null, 2);
            const blob = new Blob([chatData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `prysmis_chat_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Chat exported successfully!');
        };
        const shareWebsite = async () => {
            if (!checkRateLimit()) return;
            try {
                await navigator.share({
                    title: 'Prysmis AI',
                    text: 'Check out Prysmis AI, the #1 best AI website!',
                    url: window.location.href
                });
                showNotification('Website shared successfully!');
            } catch (error) {
                showNotification('Sharing failed. Try copying the link instead.', 'error');
            }
        };
        const handleFeedback = () => {
            if (!checkRateLimit()) return;
            const feedback = sanitizeInput(elements.feedbackInput.value.trim());
            if (feedback) {
                console.log(`Feedback submitted: ${feedback}`);
                showNotification('Feedback submitted! Thank you.');
                elements.feedbackInput.value = '';
                elements.feedbackModal.classList.remove('open');
            } else {
                showNotification('Please enter feedback.', 'error');
            }
        };
        const showUpdates = () => {
            if (!checkRateLimit()) return;
            const aiMessage = {
                id: Date.now(),
                role: 'ai',
                content: 'Prysmis AI updates: Improved UI, enhanced device detection, and better performance! More features coming soon.',
                timestamp: Date.now()
            };
            store.dispatch({ type: 'ADD_MESSAGE', payload: aiMessage });
            renderMessages();
        };
        const detectDeviceType = () => {
            const ua = navigator.userAgent.toLowerCase();
            if (/mobile|android|iphone|ipad|tablet/i.test(ua)) {
                if (/iphone|ipad/i.test(ua)) return 'iOS';
                if (/android/i.test(ua)) return 'Android';
                return 'Mobile';
            }
            if (/chromebook/i.test(ua)) return 'Chromebook';
            if (/win|mac|linux/i.test(ua)) return 'PC/Laptop';
            return 'Unknown Device';
        };
        elements.apiKeySubmit.addEventListener('click', async () => {
            const apiKey = elements.apiKeyInput.value.trim();
            if (!apiKey) {
                showNotification('Please enter an API key.', 'error');
                return;
            }
            const response = await openai.validateApiKey(apiKey);
            if (response.success) {
                store.dispatch({ type: 'SET_STATE', payload: { apiKey, isApiKeyValid: true } });
                elements.preloader.classList.add('opacity-0');
                setTimeout(() => {
                    elements.preloader.style.display = 'none';
                }, 600);
                showNotification(response.message);
            } else {
                showNotification(response.message, 'error');
            }
        });
        elements.sendBtn.addEventListener('click', () => debouncedSendMessage());
        elements.userInput.addEventListener('keypress', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                debouncedSendMessage();
            }
        });
        elements.rephraseBtn.addEventListener('click', rephraseMessage);
        elements.themeBtn.addEventListener('click', toggleTheme);
        elements.userProfileBtn.addEventListener('click', () => elements.userProfileModal.classList.add('open'));
        elements.userProfileClose.addEventListener('click', () => elements.userProfileModal.classList.remove('open'));
        elements.fileInput.addEventListener('change', handleFileUpload);
        elements.fileClearBtn.addEventListener('click', clearFiles);
        elements.fileList.addEventListener('click', e => {
            const removeBtn = e.target.closest('.remove-file-btn');
            if (removeBtn) {
                const fileId = parseFloat(removeBtn.closest('.file-item').dataset.fileId);
                store.dispatch({ type: 'SET_FILES', payload: store.state.filesArray.filter(f => f.id !== fileId) });
                renderFileList();
                elements.fileClearBtn.classList.toggle('hidden', store.state.filesArray.length === 0);
                showNotification('File removed.');
            }
        });
        elements.toggleActionsBtn.addEventListener('click', toggleFileActions);
        elements.voiceInputBtn.addEventListener('click', handleVoiceInput);
        elements.permissionModalClose.addEventListener('click', () => elements.permissionModal.classList.remove('open'));
        elements.denyPermissionBtn.addEventListener('click', () => elements.permissionModal.classList.remove('open'));
        elements.grantPermissionBtn.addEventListener('click', () => {
            elements.permissionModal.classList.remove('open');
            startVoiceRecognition();
        });
        elements.usernameInput.addEventListener('input', saveUserProfile);
        elements.chatLayoutSelect.addEventListener('change', saveUserProfile);
        elements.fontSizeInput.addEventListener('input', saveUserProfile);
        elements.autoScrollToggle.addEventListener('change', saveUserProfile);
        elements.menuBtn.addEventListener('click', toggleSidebar);
        elements.sidebarClose.addEventListener('click', toggleSidebar);
        elements.clearChatBtn.addEventListener('click', clearChat);
        elements.confirmClearModalClose.addEventListener('click', () => elements.confirmClearModal.classList.remove('open'));
        elements.cancelClearBtn.addEventListener('click', () => elements.confirmClearModal.classList.remove('open'));
        elements.confirmClearBtn.addEventListener('click', confirmClearChat);
        elements.exportChatBtn.addEventListener('click', exportChat);
        elements.shareWebsiteBtn.addEventListener('click', shareWebsite);
        elements.feedbackBtn.addEventListener('click', () => elements.feedbackModal.classList.add('open'));
        elements.feedbackModalClose.addEventListener('click', () => elements.feedbackModal.classList.remove('open'));
        elements.feedbackSubmitBtn.addEventListener('click', handleFeedback);
        elements.prysmisUpdatesBtn.addEventListener('click', showUpdates);
        const init = async () => {
            store.state.deviceType = detectDeviceType();
            await store.loadState();
            renderMessages();
            loadTheme();
            applyChatLayout();
            const loadingMessages = [
                'Initializing Prysmis AI...',
                'Detecting what device you are on.',
                `${store.state.deviceType} is your device.`,
                'Making sure the website supports the device.',
                'Device supported!'
            ];
            let messageIndex = 0;
            elements.loadingText.classList.add('opacity-100');
            const displayNextMessage = () => {
                if (messageIndex < loadingMessages.length) {
                    elements.loadingText.textContent = loadingMessages[messageIndex];
                    messageIndex++;
                    setTimeout(() => {
                        elements.loadingText.classList.remove('opacity-100');
                        setTimeout(() => {
                            elements.loadingText.classList.add('opacity-100');
                            displayNextMessage();
                        }, 600);
                    }, 1000);
                } else {
                    elements.apiKeyContainer.classList.add('opacity-100');
                    elements.apiKeyInput.focus();
                }
            };
            displayNextMessage();
            if (store.state.deviceType === 'Mobile' || store.state.deviceType === 'Android' || store.state.deviceType === 'iOS') {
                elements.chatArea.style.padding = '0.5rem';
                elements.chatInputArea.style.padding = '0.5rem';
                elements.userInput.style.minHeight = '2.5rem';
            }
        };
        init();
    </script>
</body>
</html>
