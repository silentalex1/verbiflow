<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prysmis AI - Enhanced Offline Assistant</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif}
        body{background:linear-gradient(145deg,#1e2a44,#0d1321);color:#e6e9ff;overflow:hidden;font-size:15px}
        body.light-mode{background:linear-gradient(145deg,#f0f4ff,#d9e2ff);color:#1a2740}
        .container{display:grid;grid-template-columns:260px 1fr 380px;grid-template-rows:70px 1fr 120px;height:100vh;width:100vw;gap:1px;background:#0d1321}
        .container.light-mode{background:#d9e2ff}
        .sidebar{grid-row:1/4;background:#1e2a44;padding:1.5rem;overflow-y:auto;border-right:1px solid rgba(255,255,255,0.15);transition:transform 0.5s cubic-bezier(0.68,-0.55,0.27,1.55);transform:translateX(-100%)}
        .sidebar.light-mode{background:#f0f4ff;border-right:1px solid rgba(0,0,0,0.1)}
        .sidebar.open{transform:translateX(0)}
        .sidebar-content{display:flex;flex-direction:column;gap:1rem}
        .chat-header{grid-column:2/3;background:#1e2a44;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,0.15)}
        .chat-header.light-mode{background:#f0f4ff;border-bottom:1px solid rgba(0,0,0,0.1)}
        .chat-area{grid-column:2/3;grid-row:2/3;overflow-y:auto;padding:2rem;background:#141b2d;scrollbar-width:thin;scrollbar-color:#3b82f6 transparent}
        .chat-area.light-mode{background:#e6ecff}
        .chat-area::-webkit-scrollbar{width:10px}
        .chat-area::-webkit-scrollbar-thumb{background:#3b82f6;border-radius:5px}
        .chat-message{max-width:80%;padding:1.2rem;border-radius:20px;margin-bottom:2rem;background:linear-gradient(145deg,#2a3b5a,#1e2a44);box-shadow:0 8px 24px rgba(0,0,0,0.3);transition:transform 0.3s ease,box-shadow 0.3s ease}
        .chat-message.light-mode{background:linear-gradient(145deg,#ffffff,#e6ecff);box-shadow:0 8px 24px rgba(0,0,0,0.1)}
        .chat-message:hover{transform:translateY(-4px);box-shadow:0 12px 32px rgba(0,0,0,0.4)}
        .chat-message.light-mode:hover{box-shadow:0 12px 32px rgba(0,0,0,0.15)}
        .chat-message.user{align-self:flex-end;background:linear-gradient(145deg,#3b82f6,#2563eb);margin-left:auto}
        .chat-message.user.light-mode{background:linear-gradient(145deg,#60a5fa,#3b82f6)}
        .chat-message.assistant{align-self:flex-start;background:linear-gradient(145deg,#2dd4bf,#10b981)}
        .chat-message.assistant.light-mode{background:linear-gradient(145deg,#6ee7b7,#2dd4bf)}
        .chat-message-content pre{background:#0d1321;border-radius:14px;padding:1.5rem;overflow-x:auto;font-family:'Fira Code',monospace;font-size:0.95rem;box-shadow:0 6px 16px rgba(0,0,0,0.4);color:#e6e9ff}
        .chat-message-content pre.light-mode{background:#ffffff;color:#1a2740;box-shadow:0 6px 16px rgba(0,0,0,0.1)}
        .chat-message-content pre .copy-btn{position:absolute;top:1rem;right:1rem;background:#3b82f6;color:white;border:none;border-radius:10px;padding:0.5rem 1rem;cursor:pointer;font-size:0.85rem;transition:background 0.3s ease}
        .chat-message-content pre .copy-btn:hover{background:#2563eb}
        .chat-input-area{grid-column:2/3;grid-row:3/4;background:#1e2a44;padding:1.5rem;border-top:1px solid rgba(255,255,255,0.15)}
        .chat-input-area.light-mode{background:#f0f4ff;border-top:1px solid rgba(0,0,0,0.1)}
        .file-upload-progress{height:10px;background:#0d1321;border-radius:5px;overflow:hidden;margin-top:0.5rem}
        .file-upload-progress div{height:100%;background:linear-gradient(90deg,#3b82f6,#60a5fa);transition:width 0.5s ease}
        .file-upload-progress.light-mode{background:#e6ecff}
        .file-upload-progress.light-mode div{background:linear-gradient(90deg,#60a5fa,#3b82f6)}
        .preloader{position:fixed;inset:0;background:linear-gradient(145deg,#1e2a44,#0d1321);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999}
        .preloader.light-mode{background:linear-gradient(145deg,#f0f4ff,#d9e2ff)}
        .modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:opacity 0.5s ease,visibility 0.5s ease}
        .modal.open{opacity:1;visibility:visible}
        .modal-content{background:linear-gradient(145deg,#2a3b5a,#1e2a44);padding:2.5rem;border-radius:24px;max-width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 12px 40px rgba(0,0,0,0.5);transform:scale(0.9);transition:transform 0.5s cubic-bezier(0.68,-0.55,0.27,1.55)}
        .modal-content.light-mode{background:linear-gradient(145deg,#ffffff,#e6ecff);box-shadow:0 12px 40px rgba(0,0,0,0.15)}
        .modal.open .modal-content{transform:scale(1)}
        .notification{position:fixed;top:1.5rem;right:1.5rem;padding:1rem 2rem;border-radius:14px;color:#ffffff;background:#10b981;box-shadow:0 8px 24px rgba(0,0,0,0.3);transform:translateY(-50px);transition:transform 0.5s cubic-bezier(0.68,-0.55,0.27,1.55);z-index:10000}
        .notification.show{transform:translateY(0)}
        .notification.error{background:#ef4444}
        button{align-self:center;padding:0.75rem 1.5rem;border:none;border-radius:14px;color:#ffffff;cursor:pointer;font-weight:600;transition:transform 0.3s ease,box-shadow 0.3s ease}
        button:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(0,0,0,0.3)}
        button:active{transform:translateY(0);box-shadow:0 2px 10px rgba(0,0,0,0.2)}
        .glass-effect{background:linear-gradient(145deg,#2a3b5a,#1e2a44);box-shadow:0 8px 24px rgba(0,0,0,0.3)}
        .glass-effect.light-mode{background:linear-gradient(145deg,#ffffff,#e6ecff);box-shadow:0 8px 24px rgba(0,0,0,0.1)}
        select{appearance:none;background:linear-gradient(145deg,#2a3b5a,#1e2a44);border:none;border-radius:12px;padding:0.75rem 2.5rem 0.75rem 1.25rem;color:#e6e9ff;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.2)}
        select.light-mode{background:linear-gradient(145deg,#ffffff,#e6ecff);color:#1a2740}
        select::-ms-expand{display:none}
        select option{background:#0d1321;color:#e6e9ff}
        select option.light-mode{background:#e6ecff;color:#1a2740}
        .select-wrapper{position:relative}
        .select-wrapper::after{content:'\f078';font-family:'Font Awesome 6 Free';font-weight:900;position:absolute;right:1.25rem;top:50%;transform:translateY(-50%);color:#e6e9ff;pointer-events:none}
        .select-wrapper.light-mode::after{color:#1a2740}
        .typing-indicator{display:none;text-align:center;color:#3b82f6;font-style:italic;font-size:1rem;margin-bottom:2rem}
        .typing-indicator.light-mode{color:#60a5fa}
        .typing-bar{width:100px;height:4px;background:#0d1321;border-radius:2px;margin-top:0.5rem;overflow:hidden}
        .typing-bar div{height:100%;background:#3b82f6;animation:loading 2s infinite ease-in-out}
        .typing-bar.light-mode{background:#e6ecff}
        .typing-bar.light-mode div{background:#60a5fa}
        @keyframes loading{0%{width:0;transform:translateX(-100%)}50%{width:100%;transform:translateX(0)}100%{width:0;transform:translateX(100%)}}
        .right-sidebar{grid-column:3/4;grid-row:1/4;background:#1e2a44;padding:1.5rem;overflow-y:auto;border-left:1px solid rgba(255,255,255,0.15);transition:transform 0.5s cubic-bezier(0.68,-0.55,0.27,1.55);transform:translateX(100%)}
        .right-sidebar.light-mode{background:#f0f4ff;border-left:1px solid rgba(0,0,0,0.1)}
        .right-sidebar.open{transform:translateX(0)}
        .device-info,.grade-diagram,.assignment-guide,.task-tracker,.code-analyzer,.app-list{background:linear-gradient(145deg,#2a3b5a,#1e2a44);border-radius:14px;padding:1.5rem;margin-bottom:2rem;box-shadow:0 6px 20px rgba(0,0,0,0.3)}
        .device-info.light-mode,.grade-diagram.light-mode,.assignment-guide.light-mode,.task-tracker.light-mode,.code-analyzer.light-mode,.app-list.light-mode{background:linear-gradient(145deg,#ffffff,#e6ecff);box-shadow:0 6px 20px rgba(0,0,0,0.1)}
        .game-vm{width:100%;height:400px;background:#0d1321;border-radius:14px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,0.3)}
        .game-vm.light-mode{background:#ffffff}
        .app-list{max-height:200px;overflow-y:auto}
        .app-item{padding:0.75rem;border-bottom:1px solid rgba(255,255,255,0.2)}
        .app-item.light-mode{border-bottom:1px solid rgba(0,0,0,0.1)}
        .app-item:last-child{border-bottom:none}
        .reverse-engineer-btn,.analyze-code-btn{background:#10b981;padding:0.5rem 1rem;border-radius:10px;font-size:0.9rem}
        @media (max-width:1024px){
            .container{grid-template-columns:220px 1fr 340px}
            .chat-header,.chat-input-area{padding:1rem}
            .chat-area{padding:1.5rem}
            .right-sidebar.open{padding:1rem}
        }
        @media (max-width:768px){
            body{font-size:13px}
            .container{grid-template-columns:1fr;grid-template-rows:60px 1fr 100px auto}
            .sidebar{grid-column:1/2;grid-row:1/5}
            .chat-header{grid-column:1/2;padding:0.75rem}
            .chat-area{grid-column:1/2;padding:1rem}
            .chat-message{padding:0.75rem;border-radius:14px;margin-bottom:1.5rem}
            .chat-message-content pre{padding:1rem;font-size:0.85rem}
            .chat-message-content pre .copy-btn{padding:0.3rem 0.6rem;font-size:0.75rem}
            .chat-input-area{grid-column:1/2;padding:0.75rem}
            .modal-content{padding:1.5rem;max-width:95%}
            .notification{top:1rem;right:1rem;padding:0.75rem 1.5rem}
            .right-sidebar{grid-column:1/2;grid-row:4/5}
            .right-sidebar.open{padding:1rem}
            .gamevm{height:300px}
            .user-input{min-height:3rem !important;max-height:8rem !important}
            button,.file-input-label,select{padding:0.5rem 1rem !important;font-size:0.9rem}
        }
        @media (max-width:480px){
            .chat-header,.chat-input-area{padding:0.5rem}
            .chat-area{padding:0.75rem}
            .chat-message{padding:0.5rem;border-radius:12px}
            .chat-message-content pre{padding:0.75rem;font-size:0.8rem}
            .modal-content{padding:1rem}
            .game-vm{height:200px}
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
</head>
<body>
    <div class="preloader" id="preloader">
        <div class="api-key-container mt-8 flex flex-col gap-6 max-w-lg opacity-0" id="apiKeyContainer">
            <input type="text" id="apiKeyInput" class="p-4 border rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none glass-effect text-white placeholder-gray-300" placeholder="Enter your ChatGPT OpenAI key">
            <button id="apiKeySubmit" class="bg-blue-600 p-4 rounded-2xl hover:bg-blue-700">Submit</button>
        </div>
    </div>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-content">
                <button class="sidebar-close bg-red-500 px-4 py-2 rounded-xl hover:bg-red-600" id="sidebarClose">Close</button>
                <button class="clear-chat-btn bg-blue-600 px-4 py-2 rounded-xl hover:bg-blue-700" id="clearChatBtn">Clear Chat</button>
                <button class="export-chat-btn bg-blue-600 px-4 py-2 rounded-xl hover:bg-blue-700" id="exportChatBtn">Save Chat</button>
                <button class="share-website-btn bg-blue-600 px-4 py-2 rounded-xl hover:bg-blue-700" id="shareWebsiteBtn">Share Site</button>
                <button class="feedback-btn bg-blue-600 px-4 py-2 rounded-xl hover:bg-blue-700" id="feedbackBtn">Feedback</button>
                <button class="prysmis-updates-btn bg-blue-600 px-4 py-2 rounded-xl hover:bg-blue-700" id="prysmisUpdatesBtn">Updates</button>
                <button class="discord-btn bg-blue-600 px-4 py-2 rounded-xl hover:bg-blue-700" id="discordBtn">Discord</button>
                <button class="premium-btn bg-blue-600 px-4 py-2 rounded-xl hover:bg-blue-700" id="premiumBtn">Premium</button>
                <button class="system-access-btn bg-purple-600 px-4 py-2 rounded-xl hover:bg-purple-700" id="systemAccessBtn">System Access</button>
            </div>
        </div>
        <div class="chat-header glass-effect">
            <button class="menu-btn bg-blue-600 px-4 py-2 rounded-xl hover:bg-blue-700" id="menuBtn">Menu</button>
            <div class="flex gap-3 items-center">
                <button class="theme-btn bg-blue-600 px-4 py-2 rounded-xl hover:bg-blue-700" id="themeBtn">Light Mode</button>
                <button class="user-profile-btn bg-blue-600 px-4 py-2 rounded-xl hover:bg-blue-700" id="userProfileBtn">Profile</button>
                <span class="message-counter font-semibold text-sm" id="messageCounter">Messages: 0</span>
            </div>
        </div>
        <div class="chat-area" id="chatArea">
            <div class="chat-history flex flex-col gap-6" id="chatHistory"></div>
            <div class="typing-indicator mt-6" id="typingIndicator">Prysmis AI is typing...<div class="typing-bar"><div></div></div></div>
        </div>
        <div class="chat-input-area glass-effect">
            <div class="file-actions-container mb-6 max-h-48 overflow-hidden transition-all duration-400 opacity-100" id="fileActionsContainer">
                <div class="file-input-wrapper flex gap-3 items-center">
                    <label for="fileInput" class="file-input-label bg-blue-600 px-4 py-2 rounded-xl cursor-pointer hover:bg-blue-700">Upload File</label>
                    <input type="file" id="fileInput" class="file-input hidden" multiple>
                    <button class="file-clear-btn hidden bg-red-500 px-4 py-2 rounded-xl hover:bg-red-600" id="fileClearBtn">Clear Files</button>
                </div>
                <div class="model-selector mt-3 flex items-center gap-3">
                    <label for="aiModelSelect" class="text-sm">AI Model:</label>
                    <div class="select-wrapper">
                        <select id="aiModelSelect" class="glass-effect">
                            <option value="prysmis">Prysmis AI</option>
                            <option value="aria">Aria AI (Beta)</option>
                        </select>
                    </div>
                </div>
                <div class="file-list mt-3 flex flex-col gap-3 max-h-32 overflow-y-auto" id="fileList"></div>
                <div class="file-upload-progress" id="fileUploadProgress"><div style="width:0%"></div></div>
            </div>
            <button class="toggle-actions-btn bg-blue-600 px-4 py-2 rounded-xl hover:bg-blue-700 mb-3" id="toggleActionsBtn">Hide Extra Options</button>
            <div class="input-wrapper flex gap-3 items-center">
                <textarea class="user-input flex-1 p-4 border rounded-2xl resize-none min-h-14 max-h-36 bg-transparent focus:border-blue-600 focus:ring-2 focus:ring-blue-500 outline-none glass-effect placeholder-gray-300" id="userInput" placeholder="Type your message here..."></textarea>
                <button class="send-btn bg-blue-600 px-4 py-2 rounded-xl hover:bg-blue-700" id="sendBtn">Send</button>
                <button class="rephrase-btn bg-blue-600 px-4 py-2 rounded-xl hover:bg-blue-700" id="rephraseBtn">Rephrase</button>
                <button class="voice-input-btn bg-blue-600 px-4 py-2 rounded-xl hover:bg-blue-700" id="voiceInputBtn">Voice Input</button>
            </div>
        </div>
        <div class="right-sidebar" id="rightSidebar">
            <div class="right-sidebar-content">
                <button class="right-sidebar-close bg-red-500 px-4 py-2 rounded-xl hover:bg-red-600" id="rightSidebarClose">Close</button>
                <div class="device-info" id="deviceInfo"></div>
                <div class="grade-diagram hidden" id="gradeDiagram"></div>
                <div class="assignment-guide hidden" id="assignmentGuide"></div>
                <div class="task-tracker hidden" id="taskTracker"></div>
                <div class="code-analyzer hidden" id="codeAnalyzer"></div>
                <div class="game-vm hidden" id="gameVM"></div>
                <div class="app-list hidden" id="appList">
                    <h3 class="text-lg font-bold mb-4">Apps on your device</h3>
                    <div id="appListContent"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="notification" id="notification"></div>
    <div class="modal" id="userProfileModal">
        <div class="modal-content glass-effect">
            <button class="modal-close absolute top-3 right-3 text-red-500 hover:text-red-600" id="userProfileClose">Close</button>
            <h3 class="text-2xl font-bold mb-6">Your Profile</h3>
            <input type="text" id="usernameInput" class="w-full p-4 border rounded-2xl mb-6 focus:ring-2 focus:ring-blue-500 outline-none glass-effect placeholder-gray-300" placeholder="Your username">
            <select id="chatLayoutSelect" class="w-full p-4 border rounded-2xl mb-6 focus:ring-2 focus:ring-blue-500 outline-none glass-effect">
                <option value="default">Normal Layout</option>
                <option value="compact">Small</option>
                <option value="spacious">Big</option>
            </select>
            <label class="text-sm flex items-center gap-3 mb-6">
                <input type="checkbox" id="autoScrollToggle" checked>
                Auto-Scroll
            </label>
        </div>
    </div>
    <div class="modal" id="permissionModal">
        <div class="modal-content glass-effect">
            <button class="modal-close absolute top-3 right-3 text-red-500 hover:text-red-600" id="permissionModalClose">Close</button>
            <h3 class="text-2xl font-bold mb-6">Need Permission</h3>
            <p class="text-sm mb-6">Let Prysmis AI use your mic, apps, and files?</p>
            <div class="flex gap-3">
                <button id="grantPermissionBtn" class="bg-blue-600 px-4 py-2 rounded-xl hover:bg-blue-700">Yes</button>
                <button id="denyPermissionBtn" class="bg-red-500 px-4 py-2 rounded-xl hover:bg-red-600">No</button>
            </div>
        </div>
    </div>
    <div class="modal" id="confirmClearModal">
        <div class="modal-content glass-effect">
            <button class="modal-close absolute top-3 right-3 text-red-500 hover:text-red-600" id="confirmClearModalClose">Close</button>
            <h3 class="text-2xl font-bold mb-6">Sure to Clear Chat?</h3>
            <p class="text-sm mb-6">You can't undo this. Really clear the chat?</p>
            <div class="flex gap-3">
                <button id="confirmClearBtn" class="bg-red-500 px-4 py-2 rounded-xl hover:bg-red-600">Clear</button>
                <button id="cancelClearBtn" class="bg-gray-500 px-4 py-2 rounded-xl hover:bg-gray-600">Cancel</button>
            </div>
        </div>
    </div>
    <div class="modal" id="feedbackModal">
        <div class="modal-content glass-effect">
            <button class="modal-close absolute top-3 right-3 text-red-500 hover:text-red-600" id="feedbackModalClose">Close</button>
            <h3 class="text-2xl font-bold mb-6">Feedback</h3>
            <textarea id="feedbackInput" class="w-full p-4 border rounded-2xl mb-6 focus:ring-2 focus:ring-blue-500 outline-none glass-effect placeholder-gray-300" placeholder="Tell us what you think..."></textarea>
            <button id="feedbackSubmitBtn" class="bg-blue-600 px-4 py-2 rounded-xl hover:bg-blue-700">Send</button>
        </div>
    </div>
    <div class="modal" id="systemAccessModal">
        <div class="modal-content glass-effect">
            <button class="modal-close absolute top-3 right-3 text-red-500 hover:text-red-600" id="systemAccessModalClose">Close</button>
            <h3 class="text-2xl font-bold mb-6">System Access</h3>
            <p class="text-sm mb-6">Let Prysmis AI see your apps and do deep tasks?</p>
            <div class="flex gap-3">
                <button id="grantSystemAccessBtn" class="bg-blue-600 px-4 py-2 rounded-xl hover:bg-blue-700">Yes</button>
                <button id="denySystemAccessBtn" class="bg-red-500 px-4 py-2 rounded-xl hover:bg-red-600">No</button>
            </div>
        </div>
    </div>
    <script>
        const elements={
            preloader:document.getElementById("preloader"),
            apiKeyContainer:document.getElementById("apiKeyContainer"),
            apiKeyInput:document.getElementById("apiKeyInput"),
            apiKeySubmit:document.getElementById("apiKeySubmit"),
            chatArea:document.getElementById("chatArea"),
            chatHistory:document.getElementById("chatHistory"),
            userInput:document.getElementById("userInput"),
            sendBtn:document.getElementById("sendBtn"),
            rephraseBtn:document.getElementById("rephraseBtn"),
            typingIndicator:document.getElementById("typingIndicator"),
            themeBtn:document.getElementById("themeBtn"),
            userProfileBtn:document.getElementById("userProfileBtn"),
            messageCounter:document.getElementById("messageCounter"),
            fileInput:document.getElementById("fileInput"),
            fileClearBtn:document.getElementById("fileClearBtn"),
            fileList:document.getElementById("fileList"),
            fileActionsContainer:document.getElementById("fileActionsContainer"),
            toggleActionsBtn:document.getElementById("toggleActionsBtn"),
            fileUploadProgress:document.getElementById("fileUploadProgress"),
            userProfileModal:document.getElementById("userProfileModal"),
            userProfileClose:document.getElementById("userProfileClose"),
            usernameInput:document.getElementById("usernameInput"),
            chatLayoutSelect:document.getElementById("chatLayoutSelect"),
            autoScrollToggle:document.getElementById("autoScrollToggle"),
            voiceInputBtn:document.getElementById("voiceInputBtn"),
            permissionModal:document.getElementById("permissionModal"),
            grantPermissionBtn:document.getElementById("grantPermissionBtn"),
            denyPermissionBtn:document.getElementById("denyPermissionBtn"),
            permissionModalClose:document.getElementById("permissionModalClose"),
            menuBtn:document.getElementById("menuBtn"),
            sidebar:document.getElementById("sidebar"),
            sidebarClose:document.getElementById("sidebarClose"),
            clearChatBtn:document.getElementById("clearChatBtn"),
            confirmClearModal:document.getElementById("confirmClearModal"),
            confirmClearBtn:document.getElementById("confirmClearBtn"),
            cancelClearBtn:document.getElementById("cancelClearBtn"),
            confirmClearModalClose:document.getElementById("confirmClearModalClose"),
            exportChatBtn:document.getElementById("exportChatBtn"),
            shareWebsiteBtn:document.getElementById("shareWebsiteBtn"),
            feedbackBtn:document.getElementById("feedbackBtn"),
            feedbackModal:document.getElementById("feedbackModal"),
            feedbackInput:document.getElementById("feedbackInput"),
            feedbackSubmitBtn:document.getElementById("feedbackSubmitBtn"),
            feedbackModalClose:document.getElementById("feedbackModalClose"),
            prysmisUpdatesBtn:document.getElementById("prysmisUpdatesBtn"),
            discordBtn:document.getElementById("discordBtn"),
            premiumBtn:document.getElementById("premiumBtn"),
            aiModelSelect:document.getElementById("aiModelSelect"),
            rightSidebar:document.getElementById("rightSidebar"),
            rightSidebarClose:document.getElementById("rightSidebarClose"),
            gradeDiagram:document.getElementById("gradeDiagram"),
            assignmentGuide:document.getElementById("assignmentGuide"),
            taskTracker:document.getElementById("taskTracker"),
            codeAnalyzer:document.getElementById("codeAnalyzer"),
            gameVM:document.getElementById("gameVM"),
            appList:document.getElementById("appList"),
            appListContent:document.getElementById("appListContent"),
            deviceInfo:document.getElementById("deviceInfo"),
            systemAccessBtn:document.getElementById("systemAccessBtn"),
            systemAccessModal:document.getElementById("systemAccessModal"),
            grantSystemAccessBtn:document.getElementById("grantSystemAccessBtn"),
            denySystemAccessBtn:document.getElementById("denySystemAccessBtn"),
            systemAccessModalClose:document.getElementById("systemAccessModalClose"),
            notification:document.getElementById("notification")
        };
        const store={
            state:{
                conversationHistory:[],
                messageCount:0,
                filesArray:[],
                userProfile:{username:"User",chatLayout:"default",preferences:{autoScroll:!0}},
                isLightMode:!1,
                apiKey:"",
                isApiKeyValid:!1,
                deviceType:"",
                notificationQueue:[],
                rateLimit:{interval:5,lastAction:0},
                selectedModel:"prysmis",
                requestTracker:{count:0,lastReset:Date.now(),maxRequests:5e4,resetInterval:6e4},
                grades:[],
                assignments:[],
                tasks:[],
                analyzedCode:[],
                gameCode:null,
                pastedMedia:null,
                systemAccess:!1,
                installedApps:[],
                sessionId:Date.now(),
                userAgentData:navigator.userAgent,
                browserInfo:{},
                performanceMetrics:{startTime:performance.now(),loadTime:0}
            },
            async dispatch(action){
                switch(action.type){
                    case"SET_STATE":this.state={...this.state,...action.payload};await this.saveState();break;
                    case"ADD_MESSAGE":this.state.conversationHistory.push(action.payload);this.state.messageCount++;await this.saveState();break;
                    case"SET_FILES":this.state.filesArray=action.payload;await this.saveState();break;
                    case"CLEAR_CHAT":this.state.conversationHistory=[];this.state.messageCount=0;this.state.filesArray=[];this.state.conversationHistory.push({id:Date.now(),role:"assistant",content:`Hey ${this.state.userProfile.username}, I can help with that! What do you need?`,timestamp:Date.now()});this.state.messageCount=1;await this.saveState();break;
                    case"ENQUEUE_NOTIFICATION":this.state.notificationQueue.push(action.payload);await this.saveState();break;
                    case"DEQUEUE_NOTIFICATION":this.state.notificationQueue.shift();await this.saveState();break;
                    case"INCREMENT_REQUEST":if(Date.now()-this.state.requestTracker.lastReset>this.state.requestTracker.resetInterval)this.state.requestTracker={count:0,lastReset:Date.now(),maxRequests:5e4,resetInterval:6e4};this.state.requestTracker.count++;await this.saveState();break;
                    case"SET_GRADES":this.state.grades=action.payload;await this.saveState();break;
                    case"SET_ASSIGNMENTS":this.state.assignments=action.payload;await this.saveState();break;
                    case"SET_TASKS":this.state.tasks=action.payload;await this.saveState();break;
                    case"SET_ANALYZED_CODE":this.state.analyzedCode=action.payload;await this.saveState();break;
                    case"SET_GAME_CODE":this.state.gameCode=action.payload;await this.saveState();break;
                    case"SET_PASTED_MEDIA":this.state.pastedMedia=action.payload;await this.saveState();break;
                    case"SET_SYSTEM_ACCESS":this.state.systemAccess=action.payload;await this.saveState();break;
                    case"SET_INSTALLED_APPS":this.state.installedApps=action.payload;await this.saveState();break;
                    case"SET_BROWSER_INFO":this.state.browserInfo=action.payload;await this.saveState();break;
                    case"SET_PERFORMANCE_METRICS":this.state.performanceMetrics={...this.state.performanceMetrics,...action.payload};await this.saveState();break
                }
            },
            async loadState(){
                const db=await initDB();
                const savedState=await getFromDB(db,"state");
                if(savedState)this.state={...this.state,...savedState};
                if(!this.state.conversationHistory.length){
                    await this.dispatch({type:"ADD_MESSAGE",payload:{id:Date.now(),role:"assistant",content:`Hey ${this.state.userProfile.username}, I can help with that! What do you need?`,timestamp:Date.now()}});
                    await this.dispatch({type:"SET_STATE",payload:{messageCount:1}})
                }
            },
            async saveState(){
                const db=await initDB();
                await saveToDB(db,"state",this.state)
            }
        };
        const openai={
            async validateApiKey(apiKey){
                try{
                    const mockValidation=!apiKey.includes("invalid");
                    return{success:mockValidation,message:mockValidation?"Key works!":"Invalid key."}
                }catch(error){
                    return{success:!1,message:`Error checking key: ${error.message}`}
                }
            },
            async getAIResponse(userMessage,apiKey,media=null){
                if(store.state.selectedModel==="aria")return`Aria AI is in testing, ${store.state.userProfile.username}! Use Prysmis AI for now.`;
                try{
                    const messages=[
                        {role:"system",content:`You're Prysmis AI, a smart AI helper at prysmisai.wtf. Talk like a friend, use simple words, and always say the user's name, ${store.state.userProfile.username}, in your reply. Be very accurate like Gauth for school stuff, giving step-by-step answers for math, science, and more. For images and videos, look at them closely and describe everything: colors, shapes, words, numbers, and what it feels like. For grades, pull out scores, subjects, and dates, then give tips. For assignments, break them into steps and help the user start. For tasks, break them down and track progress. For code, analyze deeply, suggest fixes, and optimize. Give correct code that works with clear steps and handle all cases. For deep tasks like app checks or game hacks, make working code if the user allows system access. Answer fast, search the web if asked, and handle lots of messages. Reply to all questions, even hard coding ones, unless they're not allowed.`},
                        ...store.state.conversationHistory.slice(-15).map(msg=>({role:msg.role,content:msg.content})),
                        {role:"user",content:userMessage}
                    ];
                    if(store.state.filesArray.length||media){
                        const filesToProcess=media?[media]:store.state.filesArray;
                        const fileDescriptions=await Promise.all(filesToProcess.map(async file=>{
                            let content="";
                            if(file.type.startsWith("image/"))content=await this.analyzeImage(file.data);
                            else if(file.type.startsWith("video/"))content=await this.analyzeVideo(file);
                            else if(file.type.startsWith("text/")||file.type==="application/octet-stream")content=file.data;
                            return`File: ${file.name}, Type: ${file.type}, Size: ${(file.size/1024).toFixed(2)} KB, Content: ${content}`
                        }));
                        messages.push({role:"user",content:`Files:\n${fileDescriptions.join("\n")}`})
                    }
                    if(userMessage.toLowerCase().includes("game hack")&&store.state.systemAccess)messages.push({role:"system",content:`User wants a game hack and gave system access. Make working hack code for their apps, with steps and safety checks.`});
                    const mockResponses={
                        "hello":"Hi there, ${store.state.userProfile.username}! How can I assist you today?",
                        "what's 2+2":"Hey ${store.state.userProfile.username}, let's do some math! 2 + 2 equals 4.",
                        "solve x^2 + 2x - 3 = 0":"Alright ${store.state.userProfile.username}, let's solve this quadratic equation: x^2 + 2x - 3 = 0. First, we use the quadratic formula x = [-b ± √(b^2 - 4ac)] / 2a. Here, a = 1, b = 2, c = -3. So, x = [-2 ± √(2^2 - 4*1*-3)] / (2*1) = [-2 ± √(4 + 12)] / 2 = [-2 ± √16] / 2 = [-2 ± 4] / 2. This gives us two solutions: x = (2) / 2 = 1, and x = (-6) / 2 = -3. So, the solutions are x = 1 and x = -3.",
                        "whats 1+1":"Hey ${store.state.userProfile.username}, 1 + 1 equals 2! Let me know if you need more help."
                    };
                    const userInputLower=userMessage.toLowerCase();
                    let aiResponse="";
                    for(const[key,response]of Object.entries(mockResponses)){
                        if(userInputLower.includes(key)){
                            aiResponse=response.replace("${store.state.userProfile.username}",store.state.userProfile.username);
                            break;
                        }
                    }
                    if(!aiResponse)aiResponse=`Hey ${store.state.userProfile.username}, I can help with that! Here's a response to your query: "${userMessage}". Let me know if you need more details!`;
                    return aiResponse.trim()
                }catch(error){
                    return`Oops ${store.state.userProfile.username}, something broke: ${error.message}. Check your key or try again.`
                }
            },
            async rephraseMessage(message,apiKey){
                const mockRephrase=`Hey ${store.state.userProfile.username}, here's a simpler version: "${message}" in a friendlier way!`;
                return mockRephrase;
            },
            async analyzeImage(dataUrl){
                return`Picture with main colors: RGB(120, 150, 200). Brightness: 75%. Edges: 60%. Stuff: Lots of shapes. Text: Sample Text.`;
            },
            async analyzeVideo(file){
                return`Video: ${file.name}. Time: 10 seconds. Frames: Simple colors and shapes. Movement: Not much movement. Sound: Can’t check here.`;
            }
        };
        const codeProcessor={
            analyzeCode(code){
                return`Hey ${store.state.userProfile.username}, I analyzed your code:\n\`\`\`\n${code}\n\`\`\`\nIt looks good! Performance score: 85/100. Suggestion: Add error handling for edge cases.`;
            },
            reverseEngineerApp(appName){
                if(!store.state.systemAccess)return`Hey ${store.state.userProfile.username}, I need system access to check ${appName}. Turn it on in the sidebar!`;
                const app=store.state.installedApps.find(app=>app.name.toLowerCase()===appName.toLowerCase());
                if(!app)return`Can’t find ${appName} on your device, ${store.state.userProfile.username}. Look at the app list on the right.`;
                return`Hey ${store.state.userProfile.username}, here's a breakdown of ${appName} (v${app.version}):\n- It’s a simple app with basic functions.\n- Core code: \`function main() { console.log("Running"); }\`\n- It logs user actions.`;
            },
            createGameHack(gameName){
                if(!store.state.systemAccess)return`Hey ${store.state.userProfile.username}, I need system access to make a hack for ${gameName}. Turn it on in the sidebar!`;
                return`Hey ${store.state.userProfile.username}, here's a hack for ${gameName}:\n1. Modify score: \`let score = 9999;\`\n2. Apply safely: Check game state first.\nThis works on your device (${store.state.deviceType}).`;
            }
        };
        const systemAccess={
            requestSystemAccess(){
                elements.systemAccessModal.classList.add("open");
                gsap.fromTo(elements.systemAccessModal.querySelector(".modal-content"),{scale:0.8,opacity:0},{scale:1,opacity:1,duration:0.5,ease:"elastic.out(1,0.5)"})
            },
            async grantSystemAccess(){
                await store.dispatch({type:"SET_SYSTEM_ACCESS",payload:!0});
                const apps=await this.fetchInstalledApps();
                await store.dispatch({type:"SET_INSTALLED_APPS",payload:apps});
                this.renderAppList();
                toggleRightSidebar();
                elements.systemAccessModal.classList.remove("open");
                showNotification("System access granted! App list ready.")
            },
            fetchInstalledApps(){
                return[
                    {name:"Notepad",version:"10.0.1",path:"C:\\Windows\\notepad.exe"},
                    {name:"Chrome",version:"126.0.6478.127",path:"C:\\Program Files\\Google\\Chrome\\chrome.exe"},
                    {name:"Counter-Strike 2",version:"1.39.8",path:"C:\\Steam\\cs2.exe"}
                ];
            },
            renderAppList(){
                elements.appList.classList.remove("hidden");
                elements.appListContent.innerHTML=store.state.installedApps.length>0?store.state.installedApps.map(app=>`
                    <div class="app-item flex justify-between items-center">
                        <span>${app.name} (v${app.version})</span>
                        <button class="reverse-engineer-btn" data-app="${app.name}">Check App</button>
                    </div>
                `).join(""): `<p class="text-gray-200">No apps found.</p>`;
                gsap.from(elements.appListContent.children,{y:20,opacity:0,stagger:0.1,duration:0.5,ease:"power3.out"});
                elements.appListContent.querySelectorAll(".reverse-engineer-btn").forEach(btn=>{
                    btn.addEventListener("click",async()=>{
                        const appName=btn.dataset.app;
                        const response=await codeProcessor.reverseEngineerApp(appName);
                        const aiMessage={id:Date.now(),role:"assistant",content:response,timestamp:Date.now()};
                        await store.dispatch({type:"ADD_MESSAGE",payload:aiMessage});
                        renderMessages()
                    })
                });
            }
        };
        const gradeOrganizer={
            async processGradeMedia(dataUrl,mediaType){
                const description=mediaType==="image"?await openai.analyzeImage(dataUrl):await openai.analyzeVideo({data:dataUrl});
                const grades=await this.parseGrades(description);
                await store.dispatch({type:"SET_GRADES",payload:grades});
                this.renderGradeDiagram();
                toggleRightSidebar()
            },
            parseGrades(description){
                return[
                    {subject:"Math",score:92,due:"2025-05-10",comments:"Good work",advice:"Try harder problems to get better.",predictedNext:94},
                    {subject:"Science",score:85,due:"2025-05-03",comments:"Needs focus",advice:"Read more on energy topics.",predictedNext:88},
                    {subject:"English",score:88,due:"2025-05-15",comments:"Nice effort",advice:"Read more books to improve.",predictedNext:90}
                ].sort((a,b)=>new Date(a.due)-new Date(b.due));
            },
            renderGradeDiagram(){
                elements.gradeDiagram.classList.remove("hidden");
                elements.gradeDiagram.innerHTML=`
                    <h3 class="text-xl font-bold mb-6">Your Grades</h3>
                    <ul class="space-y-3">
                        ${store.state.grades.map(grade=>`
                            <li class="p-3 rounded-2xl glass-effect">
                                <strong>${grade.subject}</strong>: ${grade.score}% (Due: ${grade.due})<br>
                                <span class="text-sm">Comments: ${grade.comments||"None"}</span><br>
                                <span class="text-sm">Tip: ${grade.advice}</span><br>
                                <span class="text-sm">Next Semester Prediction: ${grade.predictedNext}%</span>
                            </li>
                        `).join("")}
                    </ul>
                `;
                gsap.from(elements.gradeDiagram.querySelectorAll("li"),{x:-20,opacity:0,stagger:0.1,duration:0.5,ease:"power3.out"})
            }
        };
        const assignmentHelper={
            async processAssignmentMedia(dataUrl,mediaType){
                const description=mediaType==="image"?await openai.analyzeImage(dataUrl):await openai.analyzeVideo({data:dataUrl});
                const assignments=await this.parseAssignments(description);
                await store.dispatch({type:"SET_ASSIGNMENTS",payload:assignments});
                this.renderAssignmentGuide();
                toggleRightSidebar()
            },
            parseAssignments(description){
                return[
                    {subject:"Math",task:"Solve 10 algebra problems",due:"2025-05-05",details:"Focus on linear equations",steps:[{step:"Write down each equation",time:"10 min",resource:"Khan Academy"},{step:"Isolate the variable",time:"15 min",resource:"Mathway"},{step:"Solve step-by-step",time:"20 min",resource:"Symbolab"},{step:"Check your answers",time:"10 min",resource:"Wolfram Alpha"}]},
                    {subject:"Science",task:"Write a report on ecosystems",due:"2025-05-07",details:"Include examples",steps:[{step:"Research ecosystems",time:"30 min",resource:"National Geographic"},{step:"Take notes on examples",time:"20 min",resource:"BBC Earth"},{step:"Write an outline",time:"15 min",resource:"Purdue OWL"},{step:"Draft the report",time:"40 min",resource:"Grammarly"}]}
                ].sort((a,b)=>new Date(a.due)-new Date(b.due));
            },
            renderAssignmentGuide(){
                elements.assignmentGuide.classList.remove("hidden");
                elements.assignmentGuide.innerHTML=`
                    <h3 class="text-xl font-bold mb-6">Your Assignments</h3>
                    <ul class="space-y-3">
                        ${store.state.assignments.map(assignment=>`
                            <li class="p-3 rounded-2xl glass-effect">
                                <strong>${assignment.subject}</strong>: ${assignment.task} (Due: ${assignment.due})<br>
                                <span class="text-sm">Details: ${assignment.details}</span><br>
                                <span class="text-sm">Steps to Start:</span>
                                <ul class="list-disc pl-5 text-sm">
                                    ${assignment.steps.map(step=>`<li>${step.step} (${step.time}) - Resource: ${step.resource}</li>`).join("")}
                                </ul>
                            </li>
                        `).join("")}
                    </ul>
                `;
                gsap.from(elements.assignmentGuide.querySelectorAll("li"),{x:-20,opacity:0,stagger:0.1,duration:0.5,ease:"power3.out"})
            }
        };
        const taskManager={
            async processTask(userMessage){
                const tasks=await this.parseTasks(userMessage);
                await store.dispatch({type:"SET_TASKS",payload:tasks});
                this.renderTaskTracker();
                toggleRightSidebar()
            },
            parseTasks(userMessage){
                return[
                    {task:"Finish math homework",due:"2025-05-02",priority:"high",details:"Chapter 5 problems",subtasks:["Solve problems 1-5","Solve problems 6-10","Review answers"],completion:30,nextSteps:"Start with problems 1-5 tonight."},
                    {task:"Prepare for science quiz",due:"2025-05-04",priority:"medium",details:"Ecosystems topic",subtasks:["Read chapter 3","Make flashcards","Practice questions"],completion:50,nextSteps:"Make flashcards this evening."}
                ].sort((a,b)=>new Date(a.due)-new Date(b.due));
            },
            renderTaskTracker(){
                elements.taskTracker.classList.remove("hidden");
                elements.taskTracker.innerHTML=`
                    <h3 class="text-xl font-bold mb-6">Task Tracker</h3>
                    <ul class="space-y-3">
                        ${store.state.tasks.map(task=>`
                            <li class="p-3 rounded-2xl glass-effect">
                                <strong>${task.task}</strong> (Due: ${task.due}, Priority: ${task.priority})<br>
                                <span class="text-sm">Details: ${task.details}</span><br>
                                <span class="text-sm">Progress: ${task.completion}%</span><br>
                                <span class="text-sm">Subtasks:</span>
                                <ul class="list-disc pl-5 text-sm">
                                    ${task.subtasks.map(subtask=>`<li>${subtask}</li>`).join("")}
                                </ul>
                                <span class="text-sm">Next Steps: ${task.nextSteps}</span>
                            </li>
                        `).join("")}
                    </ul>
                `;
                gsap.from(elements.taskTracker.querySelectorAll("li"),{x:-20,opacity:0,stagger:0.1,duration:0.5,ease:"power3.out"})
            }
        };
        const codeAnalyzer={
            async processCode(code){
                const analysis=await codeProcessor.analyzeCode(code);
                await store.dispatch({type:"SET_ANALYZED_CODE",payload:analysis});
                this.renderCodeAnalysis();
                toggleRightSidebar()
            },
            renderCodeAnalysis(){
                elements.codeAnalyzer.classList.remove("hidden");
                elements.codeAnalyzer.innerHTML=`
                    <h3 class="text-xl font-bold mb-6">Code Analysis</h3>
                    <div class="p-3 rounded-2xl glass-effect">
                        <pre>${store.state.analyzedCode}</pre>
                    </div>
                `;
                gsap.from(elements.codeAnalyzer.querySelector("div"),{y:20,opacity:0,duration:0.5,ease:"power3.out"})
            }
        };
        const gameEngine={
            initializeGame(){
                elements.gameVM.classList.remove("hidden");
                elements.gameVM.innerHTML=`
                    <p>Game placeholder for ${store.state.userProfile.username}!</p>
                `;
                toggleRightSidebar();
                gsap.from(elements.gameVM,{scale:0.9,opacity:0,duration:0.5,ease:"back.out(1.7)"})
            }
        };
        const deviceDetector={
            detectDevice(){
                const ua=navigator.userAgent;
                let deviceType="desktop",os="Unknown";
                if(/Mobi|Android/i.test(ua)){
                    deviceType="mobile";
                    os=/Android/i.test(ua)?"Android":"iOS"
                }else if(/iPad/i.test(ua)){
                    deviceType="tablet";
                    os="iOS"
                }else if(/Macintosh/i.test(ua))os="macOS";
                else if(/Windows/i.test(ua))os="Windows";
                else if(/Linux/i.test(ua))os="Linux";
                const browser=ua.match(/(Chrome|Firefox|Safari|Edge|Opera)/i)?.[0]||"Unknown";
                const browserVersion=ua.match(/(Chrome|Firefox|Safari|Edge|Opera)\/([\d.]+)/i)?.[2]||"Unknown";
                return{
                    deviceType,
                    os,
                    browser,
                    browserVersion,
                    screenWidth:window.screen.width,
                    screenHeight:window.screen.height,
                    devicePixelRatio:window.devicePixelRatio||1,
                    touchSupport:"ontouchstart"in window||navigator.maxTouchPoints>0,
                    memory:navigator.deviceMemory||"Unknown",
                    cpuCores:navigator.hardwareConcurrency||"Unknown"
                }
            },
            async initialize(){
                const deviceInfo=this.detectDevice();
                await store.dispatch({type:"SET_STATE",payload:{deviceType:deviceInfo.deviceType}});
                await store.dispatch({type:"SET_BROWSER_INFO",payload:deviceInfo});
                this.renderDeviceInfo(deviceInfo);
                toggleRightSidebar();
                this.optimizeForDevice(deviceInfo)
            },
            renderDeviceInfo(deviceInfo){
                elements.deviceInfo.classList.remove("hidden");
                elements.deviceInfo.innerHTML=`
                    <h3 class="text-xl font-bold mb-6">Device Info</h3>
                    <ul class="space-y-2">
                        <li><strong>Device Type:</strong> ${deviceInfo.deviceType}</li>
                        <li><strong>OS:</strong> ${deviceInfo.os}</li>
                        <li><strong>Browser:</strong> ${deviceInfo.browser} v${deviceInfo.browserVersion}</li>
                        <li><strong>Screen:</strong> ${deviceInfo.screenWidth}x${deviceInfo.screenHeight} (${deviceInfo.devicePixelRatio}x)</li>
                        <li><strong>Touch:</strong> ${deviceInfo.touchSupport?"Yes":"No"}</li>
                        <li><strong>Memory:</strong> ${deviceInfo.memory} GB</li>
                        <li><strong>CPU Cores:</strong> ${deviceInfo.cpuCores}</li>
                    </ul>
                `;
                gsap.from(elements.deviceInfo.querySelectorAll("li"),{x:20,opacity:0,stagger:0.1,duration:0.5,ease:"power3.out"})
            },
            optimizeForDevice(deviceInfo){
                if(deviceInfo.deviceType==="mobile"||deviceInfo.deviceType==="tablet"){
                    elements.chatArea.style.padding="0.5rem";
                    elements.userInput.style.fontSize="12px"
                }
            }
        };
        const performanceTracker={
            async trackLoadTime(){
                const loadTime=performance.now()-store.state.performanceMetrics.startTime;
                await store.dispatch({type:"SET_PERFORMANCE_METRICS",payload:{loadTime}})
            }
        };
        const initDB=()=>new Promise((resolve,reject)=>{
            const request=indexedDB.open("PrysmisDB",5);
            request.onupgradeneeded=e=>e.target.result.createObjectStore("state",{keyPath:"id"});
            request.onsuccess=e=>resolve(e.target.result);
            request.onerror=e=>reject(e.target.error)
        });
        const saveToDB=(db,storeName,data)=>new Promise((resolve,reject)=>{
            const transaction=db.transaction([storeName],"readwrite");
            const store=transaction.objectStore(storeName);
            const request=store.put({id:"appState",...data});
            request.onsuccess=()=>resolve();
            request.onerror=e=>reject(e.target.error)
        });
        const getFromDB=(db,storeName)=>new Promise((resolve,reject)=>{
            const transaction=db.transaction([storeName],"readonly");
            const store=transaction.objectStore(storeName);
            const request=store.get("appState");
            request.onsuccess=e=>resolve(e.target.result);
            request.onerror=e=>reject(e.target.error)
        });
        const debounce=(func,delay)=>{
            let timeout;
            return(...args)=>{
                clearTimeout(timeout);
                timeout=setTimeout(()=>func(...args),delay)
            }
        };
        const showNotification=(message,type="success")=>{
            store.dispatch({type:"ENQUEUE_NOTIFICATION",payload:{message,type}});
            processNotificationQueue()
        };
        const processNotificationQueue=()=>{
            if(!store.state.notificationQueue.length)return;
            const{message,type}=store.state.notificationQueue[0];
            elements.notification.textContent=message;
            elements.notification.className=`notification ${type==="success"?"":"error"} show`;
            gsap.from(elements.notification,{y:-50,opacity:0,duration:0.5,ease:"power3.out"});
            setTimeout(()=>{
                gsap.to(elements.notification,{y:-50,opacity:0,duration:0.5,ease:"power3.in",onComplete:()=>{
                    elements.notification.className="notification";
                    store.dispatch({type:"DEQUEUE_NOTIFICATION"});
                    processNotificationQueue()
                }})
            },1500)
        };
        const sanitizeInput=input=>{
            const div=document.createElement("div");
            div.textContent=input;
            return div.innerHTML
        };
        const checkRateLimit=()=>{
            store.dispatch({type:"INCREMENT_REQUEST"});
            if(store.state.requestTracker.count>store.state.requestTracker.maxRequests){
                showNotification("Too many messages. Wait a bit.","error");
                return!1
            }
            const now=Date.now();
            if(now-store.state.rateLimit.lastAction<store.state.rateLimit.interval){
                showNotification("Slow down!","error");
                return!1
            }
            store.dispatch({type:"SET_STATE",payload:{rateLimit:{...store.state.rateLimit,lastAction:now}}});
            return!0
        };
        const toggleTheme=()=>{
            if(!checkRateLimit())return;
            const isLightMode=!store.state.isLightMode;
            store.dispatch({type:"SET_STATE",payload:{isLightMode}});
            document.body.classList.toggle("light-mode");
            elements.themeBtn.textContent=isLightMode?"Dark Mode":"Light Mode";
            localStorage.setItem("theme",isLightMode?"light":"dark");
            gsap.to(document.body,{background:isLightMode?"linear-gradient(145deg,#f0f4ff,#d9e2ff)":"linear-gradient(145deg,#1e2a44,#0d1321)",duration:0.5,ease:"power3.inOut"})
        };
        const loadTheme=()=>{
            const savedTheme=localStorage.getItem("theme");
            if(savedTheme==="light"){
                store.dispatch({type:"SET_STATE",payload:{isLightMode:!0}});
                document.body.classList.add("light-mode");
                elements.themeBtn.textContent="Dark Mode"
            }
        };
        const renderMessages=()=>{
            const fragment=document.createDocumentFragment();
            store.state.conversationHistory.forEach((message,index)=>{
                const messageDiv=document.createElement("div");
                messageDiv.className=`chat-message ${message.role}`;
                messageDiv.dataset.messageId=message.id;
                const contentDiv=document.createElement("div");
                contentDiv.className="chat-message-content";
                if(message.content.includes("```")){
                    const parts=message.content.split(/```/);
                    let htmlContent="";
                    parts.forEach((part,i)=>{
                        if(i%2===0)htmlContent+=part.replace(/\n/g,"<br>");
                        else{
                            const[lang,...codeLines]=part.split("\n");
                            const code=codeLines.join("\n");
                            htmlContent+=`<pre><code class="${lang||""}">${code}</code><button class="copy-btn">Copy</button></pre>`
                        }
                    });
                    contentDiv.innerHTML=htmlContent;
                    contentDiv.querySelectorAll(".copy-btn").forEach(btn=>{
                        btn.addEventListener("click",()=>{
                            const code=btn.previousSibling.textContent;
                            navigator.clipboard.writeText(code).then(()=>{
                                showNotification("Code copied!")
                            }).catch(()=>{
                                showNotification("Can’t copy code.","error")
                            })
                        })
                    })
                }else contentDiv.innerHTML=message.content.replace(/\n/g,"<br>");
                messageDiv.appendChild(contentDiv);
                fragment.appendChild(messageDiv);
                gsap.from(messageDiv,{y:30,opacity:0,delay:index*0.1,duration:0.5,ease:"power3.out"})
            });
            elements.chatHistory.innerHTML="";
            elements.chatHistory.appendChild(fragment);
            elements.messageCounter.textContent=`Messages: ${store.state.messageCount}`;
            if(store.state.userProfile.preferences.autoScroll)elements.chatArea.scrollTop=elements.chatArea.scrollHeight
        };
        const handleSendMessage=async()=>{
            if(!checkRateLimit())return;
            const userMessage=sanitizeInput(elements.userInput.value.trim());
            let media=store.state.pastedMedia;
            if(!userMessage&&!media){
                showNotification("Type something or add a file first!","error");
                return
            }
            const messageId=Date.now();
            const newMessage={id:messageId,role:"user",content:userMessage||"Added a file",timestamp:Date.now()};
            await store.dispatch({type:"ADD_MESSAGE",payload:newMessage});
            elements.userInput.value="";
            await store.dispatch({type:"SET_PASTED_MEDIA",payload:null});
            elements.typingIndicator.style.display="block";
            gsap.from(elements.typingIndicator,{opacity:0,y:10,duration:0.5,ease:"power3.out"});
            renderMessages();
            const aiResponse=await openai.getAIResponse(userMessage,store.state.apiKey,media);
            const aiMessage={id:Date.now(),role:"assistant",content:aiResponse,timestamp:Date.now()};
            await store.dispatch({type:"ADD_MESSAGE",payload:aiMessage});
            elements.typingIndicator.style.display="none";
            renderMessages();
            if(userMessage.toLowerCase().includes("grade")&&media)await gradeOrganizer.processGradeMedia(media.data,"image");
            else if(userMessage.toLowerCase().includes("assignment")&&media)await assignmentHelper.processAssignmentMedia(media.data,"image");
            else if(userMessage.toLowerCase().includes("task"))await taskManager.processTask(userMessage);
            else if(userMessage.toLowerCase().includes("code"))await codeAnalyzer.processCode(userMessage);
            else if(userMessage.toLowerCase().includes("game hack"))await codeProcessor.createGameHack(userMessage);
        };
        const debouncedSendMessage=debounce(handleSendMessage,300);
        const handleFileUpload=async(event)=>{
            const files=Array.from(event.target.files);
            const filePromises=files.map(file=>new Promise((resolve,reject)=>{
                const reader=new FileReader();
                reader.onload=e=>resolve({id:Date.now()+Math.random(),name:file.name,type:file.type,size:file.size,data:e.target.result});
                reader.onerror=reject;
                reader.readAsDataURL(file)
            }));
            try{
                const newFiles=await Promise.all(filePromises);
                await store.dispatch({type:"SET_FILES",payload:[...store.state.filesArray,...newFiles]});
                renderFileList();
                elements.fileClearBtn.classList.toggle("hidden",store.state.filesArray.length===0);
                showNotification("Files uploaded! Send to analyze.")
            }catch(error){
                showNotification(`Can’t upload files: ${error.message}`,"error")
            }
        };
        const handlePaste=async(event)=>{
            const items=event.clipboardData.items;
            for(const item of items){
                if(item.type.startsWith("image/")){
                    const file=item.getAsFile();
                    const fileId=Date.now()+Math.random();
                    const fileObj={id:fileId,name:`pasted-image-${fileId}.png`,type:file.type,size:file.size,data:null};
                    try{
                        fileObj.data=await new Promise(resolve=>{
                            const reader=new FileReader();
                            reader.onload=()=>resolve(reader.result);
                            reader.readAsDataURL(file);
                        });
                        if(fileObj.name.toLowerCase().includes("grade"))await gradeOrganizer.processGradeMedia(fileObj.data,"image");
                        else if(fileObj.name.toLowerCase().includes("assignment"))await assignmentHelper.processAssignmentMedia(fileObj.data,"image");
                        await store.dispatch({type:"SET_PASTED_MEDIA",payload:fileObj});
                        showNotification("Image pasted! Send it to analyze.")
                    }catch(error){
                        showNotification(`Can’t paste image: ${error.message}`,"error")
                    }
                }
            }
        };
        const renderFileList=()=>{
            elements.fileList.innerHTML=store.state.filesArray.length>0?store.state.filesArray.map(file=>`
                <div class="file-item flex justify-between items-center p-2 rounded-xl glass-effect" data-file-id="${file.id}">
                    <span class="text-sm truncate">${file.name} (${(file.size/1024).toFixed(2)} KB)</span>
                    <button class="remove-file-btn text-red-500 hover:text-red-600">Remove</button>
                </div>
            `).join(""): `<p class="text-sm">No files added.</p>`;
            gsap.from(elements.fileList.children,{y:10,opacity:0,stagger:0.1,duration:0.5,ease:"power3.out"})
        };
        const clearFiles=async()=>{
            await store.dispatch({type:"SET_FILES",payload:[]});
            renderFileList();
            elements.fileClearBtn.classList.add("hidden");
            showNotification("Files removed.")
        };
        const toggleFileActions=()=>{
            const isHidden=elements.fileActionsContainer.classList.toggle("opacity-0");
            elements.fileActionsContainer.style.maxHeight=isHidden?"0":"12rem";
            elements.toggleActionsBtn.textContent=isHidden?"Show Extra Options":"Hide Extra Options";
            gsap.to(elements.fileActionsContainer,{maxHeight:isHidden?0:"12rem",opacity:isHidden?0:1,duration:0.4,ease:"power3.inOut"})
        };
        const saveUserProfile=async()=>{
            const userProfile={
                username:sanitizeInput(elements.usernameInput.value.trim())||"User",
                chatLayout:elements.chatLayoutSelect.value,
                preferences:{autoScroll:elements.autoScrollToggle.checked}
            };
            await store.dispatch({type:"SET_STATE",payload:{userProfile}});
            applyChatLayout();
            showNotification("Profile saved!")
        };
        const applyChatLayout=()=>{
            const{chatLayout}=store.state.userProfile;
            if(chatLayout==="compact"){
                elements.chatArea.style.gap="0.5rem";
                elements.chatMessage.style.padding="0.5rem"
            }else if(chatLayout==="spacious"){
                elements.chatArea.style.gap="2rem";
                elements.chatMessage.style.padding="1.5rem"
            }else{
                elements.chatArea.style.gap="1rem";
                elements.chatMessage.style.padding="1rem"
            }
        };
        let recognition=null;
        const startVoiceRecognition=async()=>{
            try{
                if(!("webkitSpeechRecognition"in window)){
                    showNotification("Your browser can’t use voice input.","error");
                    return
                }
                recognition=new webkitSpeechRecognition();
                recognition.continuous=!1;
                recognition.interimResults=!1;
                recognition.lang="en-US";
                recognition.onstart=()=>{
                    elements.voiceInputBtn.textContent="Stop";
                    showNotification("Listening...")
                };
                recognition.onresult=event=>{
                    const transcript=event.results[0][0].transcript.trim();
                    elements.userInput.value=transcript;
                    showNotification("Heard you! Hit Send to use it.")
                };
                recognition.onerror=event=>{
                    showNotification(`Voice input broke: ${event.error}`,"error")
                };
                recognition.onend=()=>{
                    elements.voiceInputBtn.textContent="Voice Input";
                    recognition=null
                };
                recognition.start()
            }catch(error){
                showNotification(`Voice input broke: ${error.message}`,"error")
            }
        };
        const handleVoiceInput=()=>{
            if(recognition){
                recognition.stop();
                return
            }
            if(!("webkitSpeechRecognition"in window)){
                showNotification("Your browser can’t use voice input.","error");
                return
            }
            if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){
                showNotification("Can’t find your mic.","error");
                return
            }
            navigator.mediaDevices.getUserMedia({audio:!0}).then(()=>{
                startVoiceRecognition()
            }).catch(()=>{
                elements.permissionModal.classList.add("open");
                gsap.fromTo(elements.permissionModal.querySelector(".modal-content"),{scale:0.8,opacity:0},{scale:1,opacity:1,duration:0.5,ease:"elastic.out(1,0.5)"})
            })
        };
        const rephraseMessage=async()=>{
            if(!checkRateLimit())return;
            const lastAIMessage=store.state.conversationHistory.slice().reverse().find(msg=>msg.role==="assistant");
            if(!lastAIMessage){
                showNotification("No AI message to rephrase.","error");
                return
            }
            const rephrased=await openai.rephraseMessage(lastAIMessage.content,store.state.apiKey);
            const rephrasedMessage={id:Date.now(),role:"assistant",content:rephrased,timestamp:Date.now()};
            await store.dispatch({type:"ADD_MESSAGE",payload:rephrasedMessage});
            renderMessages()
        };
        const toggleSidebar=()=>{
            elements.sidebar.classList.toggle("open");
            gsap.to(elements.sidebar,{x:elements.sidebar.classList.contains("open")?0:-100+"%",duration:0.5,ease:"power3.inOut"})
        };
        const toggleRightSidebar=()=>{
            elements.rightSidebar.classList.toggle("open");
            gsap.to(elements.rightSidebar,{x:elements.rightSidebar.classList.contains("open")?0:100+"%",duration:0.5,ease:"power3.inOut"})
        };
        const clearChat=()=>{
            elements.confirmClearModal.classList.add("open");
            gsap.fromTo(elements.confirmClearModal.querySelector(".modal-content"),{scale:0.8,opacity:0},{scale:1,opacity:1,duration:0.5,ease:"elastic.out(1,0.5)"})
        };
        const exportChat=()=>{
            const chatData=JSON.stringify(store.state.conversationHistory,null,2);
            const blob=new Blob([chatData],{type:"application/json"});
            const url=URL.createObjectURL(blob);
            const a=document.createElement("a");
            a.href=url;
            a.download="prysmis_chat_history.json";
            a.click();
            URL.revokeObjectURL(url);
            showNotification("Chat saved!")
        };
        const shareWebsite=()=>{
            navigator.clipboard.writeText("https://prysmisai.wtf").then(()=>{
                showNotification("Link copied!")
            }).catch(()=>{
                showNotification("Couldn’t copy link.","error")
            })
        };
        const initialize=async()=>{
            await store.loadState();
            await deviceDetector.initialize();
            loadTheme();
            applyChatLayout();
            renderMessages();
            gsap.to(elements.preloader,{opacity:0,duration:0.5,ease:"power3.in",onComplete:()=>{
                elements.preloader.style.display="none";
                gsap.from(elements.chatHeader.children,{y:-20,opacity:0,stagger:0.1,duration:0.5,ease:"power3.out"});
                gsap.from(elements.chatInputArea.children,{y:20,opacity:0,stagger:0.1,duration:0.5,ease:"power3.out"})
            }});
            gsap.from(elements.apiKeyContainer,{opacity:0,y:20,duration:0.5,ease:"power3.out"})
        };
        elements.sendBtn.addEventListener("click",debouncedSendMessage);
        elements.userInput.addEventListener("keydown",event=>{
            if(event.key==="Enter"&&!event.shiftKey){
                event.preventDefault();
                debouncedSendMessage()
            }
        });
        elements.rephraseBtn.addEventListener("click",rephraseMessage);
        elements.themeBtn.addEventListener("click",toggleTheme);
        elements.userProfileBtn.addEventListener("click",()=>{
            elements.userProfileModal.classList.add("open");
            elements.usernameInput.value=store.state.userProfile.username;
            elements.chatLayoutSelect.value=store.state.userProfile.chatLayout;
            elements.autoScrollToggle.checked=store.state.userProfile.preferences.autoScroll;
            gsap.fromTo(elements.userProfileModal.querySelector(".modal-content"),{scale:0.8,opacity:0},{scale:1,opacity:1,duration:0.5,ease:"elastic.out(1,0.5)"})
        });
        elements.userProfileClose.addEventListener("click",()=>{
            elements.userProfileModal.classList.remove("open");
            saveUserProfile()
        });
        elements.fileInput.addEventListener("change",handleFileUpload);
        elements.fileClearBtn.addEventListener("click",clearFiles);
        elements.fileList.addEventListener("click",async event=>{
            if(event.target.classList.contains("remove-file-btn")){
                const fileId=event.target.closest(".file-item").dataset.fileId;
                await store.dispatch({type:"SET_FILES",payload:store.state.filesArray.filter(file=>file.id!=fileId)});
                renderFileList();
                elements.fileClearBtn.classList.toggle("hidden",store.state.filesArray.length===0);
                showNotification("File removed.")
            }
        });
        elements.toggleActionsBtn.addEventListener("click",toggleFileActions);
        elements.apiKeySubmit.addEventListener("click",async()=>{
            const apiKey=elements.apiKeyInput.value.trim();
            if(!apiKey){
                showNotification("Put a key first!","error");
                return
            }
            const validation=await openai.validateApiKey(apiKey);
            if(validation.success){
                await store.dispatch({type:"SET_STATE",payload:{apiKey:apiKey,isApiKeyValid:!0}});
                showNotification(validation.message);
                elements.preloader.style.display="none"
            }else showNotification(validation.message,"error")
        });
        elements.apiKeyInput.addEventListener("keydown",event=>{
            if(event.key==="Enter")elements.apiKeySubmit.click()
        });
        elements.voiceInputBtn.addEventListener("click",handleVoiceInput);
        elements.grantPermissionBtn.addEventListener("click",()=>{
            elements.permissionModal.classList.remove("open");
            startVoiceRecognition()
        });
        elements.denyPermissionBtn.addEventListener("click",()=>{
            elements.permissionModal.classList.remove("open");
            showNotification("Permission not given.","error")
        });
        elements.permissionModalClose.addEventListener("click",()=>{
            elements.permissionModal.classList.remove("open")
        });
        elements.menuBtn.addEventListener("click",toggleSidebar);
        elements.sidebarClose.addEventListener("click",toggleSidebar);
        elements.clearChatBtn.addEventListener("click",clearChat);
        elements.confirmClearBtn.addEventListener("click",async()=>{
            await store.dispatch({type:"CLEAR_CHAT"});
            renderMessages();
            elements.confirmClearModal.classList.remove("open");
            showNotification("Chat cleared.")
        });
        elements.cancelClearBtn.addEventListener("click",()=>{
            elements.confirmClearModal.classList.remove("open")
        });
        elements.confirmClearModalClose.addEventListener("click",()=>{
            elements.confirmClearModal.classList.remove("open")
        });
        elements.exportChatBtn.addEventListener("click",exportChat);
        elements.shareWebsiteBtn.addEventListener("click",shareWebsite);
elements.feedbackBtn.addEventListener("click",()=>{
    elements.feedbackModal.classList.add("open");
    gsap.fromTo(elements.feedbackModal.querySelector(".modal-content"),{scale:0.8,opacity:0},{scale:1,opacity:1,duration:0.5,ease:"elastic.out(1,0.5)"})
});
elements.feedbackSubmitBtn.addEventListener("click",async()=>{
    const feedback=sanitizeInput(elements.feedbackInput.value.trim());
    if(!feedback){
        showNotification("Write feedback first!","error");
        return
    }
    elements.feedbackInput.value="";
    elements.feedbackModal.classList.remove("open");
    showNotification("Thanks for the feedback!")
});
elements.feedbackModalClose.addEventListener("click",()=>{
    elements.feedbackModal.classList.remove("open")
});
elements.prysmisUpdatesBtn.addEventListener("click",()=>{
    showNotification("No updates yet. Check back later!")
});
elements.discordBtn.addEventListener("click",()=>{
    navigator.clipboard.writeText("https://discord.gg/prysmisai").then(()=>{
        showNotification("Discord link copied!")
    }).catch(()=>{
        showNotification("Couldn’t copy Discord link.","error")
    })
});
elements.premiumBtn.addEventListener("click",()=>{
    showNotification("Premium coming soon! Stay tuned.")
});
elements.aiModelSelect.addEventListener("change",async()=>{
    await store.dispatch({type:"SET_STATE",payload:{selectedModel:elements.aiModelSelect.value}});
    showNotification(`Switched to ${elements.aiModelSelect.value} model!`)
});
elements.rightSidebarClose.addEventListener("click",toggleRightSidebar);
elements.systemAccessBtn.addEventListener("click",systemAccess.requestSystemAccess);
elements.grantSystemAccessBtn.addEventListener("click",()=>systemAccess.grantSystemAccess());
elements.denySystemAccessBtn.addEventListener("click",()=>{
    elements.systemAccessModal.classList.remove("open");
    showNotification("System access denied.","error")
});
elements.systemAccessModalClose.addEventListener("click",()=>{
    elements.systemAccessModal.classList.remove("open")
});
document.addEventListener("paste",handlePaste);
window.addEventListener("load",async()=>{
    await performanceTracker.trackLoadTime();
    initialize()
});
window.addEventListener("beforeunload",async()=>{
    await store.saveState()
});
</script>
</body>
</html>
