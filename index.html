<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VerbiFlow</title>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" as="style" onload="this.rel='stylesheet'">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{background:linear-gradient(135deg,#1a1a2e,#2e2e5e,#3e3e8e);font-family:Poppins,sans-serif;color:#fff;min-height:100vh;display:flex;overflow:auto;animation:bgShift 20s linear infinite;transition:background 0.5s ease}body::-webkit-scrollbar{display:none}@keyframes bgShift{0%{background:linear-gradient(135deg,#1a1a2e,#2e2e5e,#3e3e8e)}33%{background:linear-gradient(135deg,#3e3e8e,#1a1a2e,#2e2e5e)}66%{background:linear-gradient(135deg,#2e2e5e,#3e3e8e,#1a1a2e)}100%{background:linear-gradient(135deg,#1a1a2e,#2e2e5e,#3e3e8e)}}.container{display:flex;width:100%;height:100vh}.sidebar{width:60px;background:linear-gradient(180deg,rgba(15,14,22,0.95),rgba(30,30,60,0.95));transition:width 0.3s ease;padding:20px 10px;display:flex;flex-direction:column;align-items:center;border-right:2px solid rgba(255,106,136,0.3);box-shadow:0 0 15px rgba(0,0,0,0.5)}.sidebar.open{width:250px;align-items:flex-start}.sidebar-toggle{background:linear-gradient(135deg,#ff6a88,#ff99ac);border:none;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;margin-bottom:20px;transition:transform 0.3s ease,box-shadow 0.3s ease}.sidebar-toggle:hover{transform:scale(1.1);box-shadow:0 0 20px rgba(255,106,136,0.8)}.sidebar-toggle:focus{outline:none;border:2px solid #ff99ac}.sidebar-toggle svg{width:20px;height:20px;fill:#fff}.sidebar-item{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:12px;color:#fff;padding:10px 15px;margin:5px 0;cursor:pointer;font-size:14px;width:100%;text-align:left;transition:background 0.3s ease,border 0.3s ease,box-shadow 0.3s ease,transform 0.3s ease}.sidebar-item:hover{background:linear-gradient(135deg,rgba(255,106,136,0.5),rgba(255,153,172,0.5));border-color:#ff6a88;transform:translateX(5px);box-shadow:0 0 15px rgba(255,106,136,0.7)}.sidebar-item:focus{outline:none;border:2px solid #ff99ac;box-shadow:0 0 10px rgba(255,106,136,0.8)}.sidebar-item svg{width:18px;height:18px;fill:#fff}.sidebar-select{background:none;border:none;color:#fff;font-size:14px;padding:0;width:100%;outline:none}.main-area{flex:1;display:flex;flex-direction:column;padding:20px;gap:15px}.header{display:flex;align-items:center;justify-content:space-between;padding:15px 25px;background:linear-gradient(135deg,rgba(15,14,22,0.9),rgba(30,30,60,0.9));border-radius:20px;box-shadow:0 5px 15px rgba(0,0,0,0.3);border:1px solid rgba(255,106,136,0.2);transition:box-shadow 0.3s ease}.header:hover{box-shadow:0 5px 25px rgba(255,106,136,0.5)}.logo{display:flex;align-items:center}.logo-pulse{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#ff6a88,#ff99ac);margin-right:15px;animation:spin3D 4s infinite;box-shadow:0 0 15px rgba(255,106,136,0.5)}@keyframes spin3D{0%{transform:rotateY(0deg)}50%{transform:rotateY(180deg)}100%{transform:rotateY(360deg)}}.logo-text{font-size:26px;font-weight:700;background:linear-gradient(135deg,#ff6a88,#ff99ac);-webkit-background-clip:text;color:transparent;letter-spacing:1px;text-shadow:0 0 10px rgba(255,106,136,0.3)}.version{font-size:14px;color:rgba(255,255,255,0.6);padding:5px 12px;border-radius:14px;background:linear-gradient(135deg,rgba(255,255,255,0.1),rgba(255,255,255,0.05));box-shadow:0 2px 5px rgba(0,0,0,0.2)}.api-keys-container{background:linear-gradient(135deg,rgba(15,14,22,0.9),rgba(30,30,60,0.9));border-radius:20px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,0.3);border:1px solid rgba(255,106,136,0.2)}.api-key-section{display:flex;align-items:center;gap:10px}.api-key-input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.3);background-color:rgba(255,255,255,0.05);color:#fff;font-size:14px;outline:none;transition:border 0.3s ease,box-shadow 0.3s ease}.api-key-input.error{border-color:#ff0000;animation:pulseError 1s infinite}@keyframes pulseError{0%{box-shadow:0 0 5px rgba(255,0,0,0.5)}50%{box-shadow:0 0 15px rgba(255,0,0,0.8)}100%{box-shadow:0 0 5px rgba(255,0,0,0.5)}}.api-key-input:focus{border-color:#ff6a88;box-shadow:0 0 12px rgba(255,106,136,0.5)}.api-key-btn{background:linear-gradient(135deg,#ff6a88,#ff99ac);border:none;padding:10px 20px;border-radius:10px;color:#fff;cursor:pointer;font-size:14px;transition:transform 0.3s ease,box-shadow 0.3s ease}.api-key-btn:hover{transform:scale(1.05);box-shadow:0 0 20px rgba(255,106,136,0.8)}.api-key-btn:focus{outline:none;border:2px solid #ff99ac}.api-key-warning{display:none;color:#ff5555;font-size:13px;margin-top:5px;font-weight:500}.file-upload-container{background:linear-gradient(135deg,rgba(15,14,22,0.9),rgba(30,30,60,0.9));border-radius:20px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,0.3);border:1px solid rgba(255,106,136,0.2)}.file-actions{display:flex;gap:10px;align-items:center;margin-bottom:10px}.file-input-label{background:linear-gradient(135deg,#ff6a88,#ff99ac);border:none;padding:10px 20px;border-radius:12px;color:#fff;cursor:pointer;font-size:14px;transition:transform 0.3s ease,box-shadow 0.3s ease}.file-input-label:hover{transform:scale(1.05);box-shadow:0 0 15px rgba(255,106,136,0.7)}.file-input-label:focus{outline:none;border:2px solid #ff99ac}.file-input{display:none}.file-clear-btn{background:linear-gradient(135deg,#ff5555,#ff9999);border:none;padding:10px 20px;border-radius:12px;color:#fff;cursor:pointer;font-size:14px;transition:transform 0.3s ease,box-shadow 0.3s ease}.file-clear-btn:hover{transform:scale(1.05);box-shadow:0 0 15px rgba(255,85,85,0.7)}.file-clear-btn:focus{outline:none;border:2px solid #ff9999}.file-preview{background:linear-gradient(135deg,rgba(0,0,0,0.3),rgba(0,0,0,0.2));padding:15px;border-radius:12px;font-size:14px;color:rgba(255,255,255,0.9);max-height:120px;overflow-y:auto;border:1px solid rgba(255,255,255,0.1);box-shadow:inset 0 0 5px rgba(0,0,0,0.3)}.chat-area{flex:1;background:linear-gradient(135deg,rgba(15,14,22,0.9),rgba(30,30,60,0.9));border-radius:20px;padding:25px;overflow-y:auto;box-shadow:0 5px 15px rgba(0,0,0,0.3);border:1px solid rgba(255,106,136,0.2);min-height:500px}.chat-history{max-height:100%;overflow-y:auto;padding:15px;border-radius:16px;background:linear-gradient(135deg,rgba(0,0,0,0.3),rgba(0,0,0,0.2));box-shadow:inset 0 0 10px rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.1)}.chat-message{margin-bottom:20px;animation:fadeIn 0.5s ease forwards;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);box-shadow:0 2px 8px rgba(0,0,0,0.2);transition:transform 0.3s ease,box-shadow 0.3s ease}.chat-message:hover{transform:scale(1.02) translateY(-2px);box-shadow:0 5px 15px rgba(255,106,136,0.3)}@keyframes fadeIn{0%{opacity:0;transform:scale(0.95)}100%{opacity:1;transform:scale(1)}}.chat-message.user{text-align:right}.chat-message.ai{text-align:left}.chat-message-content{display:inline-block;padding:15px 20px;border-radius:12px;font-size:16px;line-height:1.6;box-shadow:0 2px 5px rgba(0,0,0,0.2)}.chat-message.user .chat-message-content{background:linear-gradient(135deg,#ff6a88,#ff99ac);color:#fff}.chat-message.ai .chat-message-content{background:linear-gradient(135deg,rgba(255,255,255,0.15),rgba(255,255,255,0.1));color:rgba(255,255,255,0.9)}.chat-message-timestamp{font-size:12px;color:rgba(255,255,255,0.5);margin:5px 0;font-weight:400}.chat-controls{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:linear-gradient(135deg,rgba(15,14,22,0.9),rgba(30,30,60,0.9));border-radius:20px;box-shadow:0 5px 15px rgba(0,0,0,0.3);border:1px solid rgba(255,106,136,0.2);margin-bottom:10px}.clear-chat-btn{background:linear-gradient(135deg,#ff5555,#ff9999);border:none;padding:10px 20px;border-radius:12px;color:#fff;cursor:pointer;font-size:14px;transition:transform 0.3s ease,box-shadow 0.3s ease}.clear-chat-btn:hover{transform:scale(1.05);box-shadow:0 0 15px rgba(255,85,85,0.7)}.clear-chat-btn:focus{outline:none;border:2px solid #ff9999}.input-container{display:flex;align-items:center;background:linear-gradient(135deg,rgba(15,14,22,0.9),rgba(30,30,60,0.9));border-radius:20px;padding:15px;gap:15px;box-shadow:0 5px 15px rgba(0,0,0,0.3);border:1px solid rgba(255,106,136,0.2)}.user-input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.3);background-color:rgba(255,255,255,0.05);color:#fff;font-size:15px;outline:none;resize:none;transition:border 0.3s ease,box-shadow 0.3s ease}.user-input:focus{border-color:#ff6a88;box-shadow:0 0 12px rgba(255,106,136,0.5)}.user-input::placeholder{color:rgba(255,255,255,0.5);animation:placeholderPulse 2s infinite}@keyframes placeholderPulse{0%{opacity:0.5}50%{opacity:0.8}100%{opacity:0.5}}.send-btn{background:linear-gradient(135deg,#ff6a88,#ff99ac);border:none;border-radius:50%;width:45px;height:45px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform 0.3s ease,box-shadow 0.3s ease}.send-btn:hover{transform:scale(1.1);box-shadow:0 0 20px rgba(255,106,136,0.8)}.send-btn:focus{outline:none;border:2px solid #ff99ac}.send-btn svg{width:22px;height:22px;fill:#fff}.word-counter{font-size:12px;color:rgba(255,255,255,0.6);text-align:right;padding:5px 20px;font-weight:400}.neon-mode body{background:linear-gradient(135deg,#1a1a1a,#ff00ff,#00ffff)}.neon-mode .chat-area,.neon-mode .header,.neon-mode .api-keys-container,.neon-mode .file-upload-container,.neon-mode .input-container,.neon-mode .chat-controls{background:linear-gradient(135deg,rgba(20,20,20,0.9),rgba(40,40,80,0.9));border:1px solid #ff00ff}.neon-mode .chat-message.ai .chat-message-content{background:linear-gradient(135deg,rgba(0,255,255,0.15),rgba(0,255,255,0.1))}.light-mode body{background:linear-gradient(135deg,#f0f0f0,#e0e0e0,#d0d0d0)}.light-mode .chat-area,.light-mode .header,.light-mode .api-keys-container,.light-mode .file-upload-container,.light-mode .input-container,.light-mode .chat-controls{background:linear-gradient(135deg,rgba(255,255,255,0.95),rgba(240,240,240,0.95));color:#2a2a2a}.light-mode .chat-message.ai .chat-message-content{background:linear-gradient(135deg,rgba(0,0,0,0.05),rgba(0,0,0,0.03));color:#2a2a2a}.light-mode .word-counter,.light-mode .chat-message-timestamp{color:rgba(0,0,0,0.6)}.high-contrast body{background:#000}.high-contrast .chat-area,.high-contrast .header,.high-contrast .api-keys-container,.high-contrast .file-upload-container,.high-contrast .input-container,.high-contrast .chat-controls{background:#fff;color:#000;border:1px solid #000}.high-contrast .chat-message.ai .chat-message-content{background:#e0e0e0;color:#000}.high-contrast .word-counter,.high-contrast .chat-message-timestamp{color:#000}.focus-mode .sidebar{display:none}.focus-mode .chat-area{box-shadow:0 0 30px rgba(255,106,136,0.7)}.ocean-theme .chat-area{background:linear-gradient(135deg,#0a3d62,#1b263b);border:1px solid #3e92cc}.ocean-theme .chat-message.user .chat-message-content{background:linear-gradient(135deg,#3e92cc,#90e0ef)}.forest-theme .chat-area{background:linear-gradient(135deg,#1b4332,#2d6a4f);border:1px solid #52b788}.forest-theme .chat-message.user .chat-message-content{background:linear-gradient(135deg,#52b788,#95d5b2)}@media (max-width:900px){.sidebar.open{width:200px}.main-area{padding:10px;gap:10px}.header,.chat-area,.api-keys-container,.file-upload-container,.input-container,.chat-controls{padding:15px}.logo-text{font-size:22px}.chat-area{min-height:400px}}
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                </svg>
            </button>
            <div class="sidebar-item" id="themeToggle" role="button" tabindex="0" aria-label="Select theme">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12 3a9 9 0 0 0-9 9c0 4.97 4.03 9 9 9s9-4.03 9-9a9 9 0 0 0-9-9zm0 16c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7zm0-14c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6z"/>
                </svg>
                <select class="sidebar-select">
                    <option value="dark">Dark Mode</option>
                    <option value="light">Light Mode</option>
                    <option value="neon">Neon Mode</option>
                </select>
            </div>
            <div class="sidebar-item" id="chatTheme" role="button" tabindex="0" aria-label="Select chat theme">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93s3.05-7.44 7-7.93v15.86zm2 0V4.07c3.95.49 7 3.85 7 7.93s-3.05 7.44-7 7.93z"/>
                </svg>
                <select class="sidebar-select">
                    <option value="">Default Theme</option>
                    <option value="ocean">Ocean Theme</option>
                    <option value="forest">Forest Theme</option>
                </select>
            </div>
            <button class="sidebar-item" id="debugToggle" aria-label="Toggle debug mode">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 18H4V4h16v16zM8 16h2v-2H8v2zm0-4h2v-2H8v2zm0-4h2v-2H8v2zm6 8h2v-2h-2v2zm0-4h2v-2h-2v2zm0-4h2v-2h-2v2z"/>
                </svg>
                Debug Mode
            </button>
            <button class="sidebar-item" id="focusToggle" aria-label="Toggle focus mode">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
                </svg>
                Focus Mode
            </button>
            <button class="sidebar-item" id="contrastToggle" aria-label="Toggle high contrast mode">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-8c0-2.76 2.24-5 5-5V5c-3.86 0-7 3.14-7 7s3.14 7 7 7v-2c-2.76 0-5-2.24-5-5z"/>
                </svg>
                High Contrast
            </button>
            <div class="sidebar-item" id="quickReply" role="button" tabindex="0" aria-label="Quick reply prompts">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 18H4V4h16v16zM6 14h12v2H6zm0-4h12v2H6zm0-4h12v2H6z"/>
                </svg>
                <select class="sidebar-select">
                    <option value="">Quick Reply</option>
                    <option value="Explain this in simple terms">Explain this</option>
                    <option value="Summarize this">Summarize</option>
                    <option value="Provide an example">Example</option>
                </select>
            </div>
        </div>
        <div class="main-area">
            <div class="header">
                <div class="logo">
                    <div class="logo-pulse"></div>
                    <div class="logo-text">VerbiFlow</div>
                </div>
                <div class="version">v2.0</div>
            </div>
            <div class="api-keys-container">
                <div class="api-key-section">
                    <input type="text" class="api-key-input" id="chatApiKeyInput" placeholder="Enter Chat API Key" aria-label="Enter Chat API Key">
                    <button class="api-key-btn" id="chatApiKeySubmit" aria-label="Set Chat API Key">Set</button>
                </div>
                <div class="api-key-warning" id="chatApiKeyWarning">Please set a valid Chat API key.</div>
            </div>
            <div class="file-upload-container">
                <div class="file-actions">
                    <label class="file-input-label" for="fileInput" aria-label="Upload File">Upload File</label>
                    <button class="file-clear-btn" id="fileClearBtn" aria-label="Clear File Preview">Clear Preview</button>
                </div>
                <input type="file" class="file-input" id="fileInput">
                <div class="file-preview" id="filePreview"></div>
            </div>
            <div class="chat-controls">
                <button class="clear-chat-btn" id="clearChatBtn" aria-label="Clear Chat">Clear Chat</button>
            </div>
            <div class="chat-area" id="chatArea">
                <div class="chat-history" id="chatHistory"></div>
            </div>
            <div class="input-container">
                <textarea class="user-input" id="userInput" placeholder="Ask me anything..." rows="3" aria-label="Enter your message"></textarea>
                <button class="send-btn" id="sendBtn" aria-label="Send message">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
            <div class="word-counter" id="wordCounter">0 words</div>
        </div>
    </div>
    <script>
        if (typeof micromark === "undefined") {
            window.micromark = (text) => text.replace(/\n/g, "<br>");
        }

        let micromarkLoaded = false;
        async function loadMicromark() {
            if (micromarkLoaded) return;
            try {
                const script = document.createElement("script");
                script.src = "https://cdn.jsdelivr.net/npm/micromark@3.0.10/dist/micromark.min.js";
                script.defer = true;
                document.head.appendChild(script);
                await new Promise(resolve => script.onload = resolve);
                micromarkLoaded = true;
            } catch (error) {
                window.micromark = (text) => text.replace(/\n/g, "<br>");
            }
        }

        async function safeMicromark(text) {
            if (!micromarkLoaded) await loadMicromark();
            return typeof micromark !== "undefined" ? micromark(text) : text.replace(/\n/g, "<br>");
        }

        const sidebar = document.getElementById("sidebar");
        const sidebarToggle = document.getElementById("sidebarToggle");
        const themeToggle = document.getElementById("themeToggle").querySelector("select");
        const chatTheme = document.getElementById("chatTheme").querySelector("select");
        const debugToggle = document.getElementById("debugToggle");
        const focusToggle = document.getElementById("focusToggle");
        const contrastToggle = document.getElementById("contrastToggle");
        const quickReply = document.getElementById("quickReply").querySelector("select");
        const userInput = document.getElementById("userInput");
        const sendBtn = document.getElementById("sendBtn");
        const chatHistory = document.getElementById("chatHistory");
        const wordCounter = document.getElementById("wordCounter");
        const chatApiKeyInput = document.getElementById("chatApiKeyInput");
        const chatApiKeySubmit = document.getElementById("chatApiKeySubmit");
        const chatApiKeyWarning = document.getElementById("chatApiKeyWarning");
        const fileInput = document.getElementById("fileInput");
        const filePreview = document.getElementById("filePreview");
        const fileClearBtn = document.getElementById("fileClearBtn");
        const clearChatBtn = document.getElementById("clearChatBtn");
        let conversation = [];
        let chatApiKey = "";
        let chatApiKeyValid = false;
        let debugMode = false;

        function formatTimestamp() {
            const now = new Date();
            return now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        }

        function addToHistory(role, content) {
            conversation.push({ role, content });
            const messageDiv = document.createElement("div");
            messageDiv.className = `chat-message ${role}`;
            const contentDiv = document.createElement("div");
            contentDiv.className = "chat-message-content";
            contentDiv.innerHTML = content;
            const timestampDiv = document.createElement("div");
            timestampDiv.className = "chat-message-timestamp";
            timestampDiv.textContent = formatTimestamp();
            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(timestampDiv);
            chatHistory.insertBefore(messageDiv, chatHistory.firstChild);
            chatHistory.scrollTop = 0;
        }

        function debounce(func, wait) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }

        async function validateApiKey(apiKey) {
            if (!apiKey) return false;
            return true;
        }

        async function generateChatResponse(message) {
            if (!chatApiKeyValid) {
                addToHistory("assistant", "Please set a valid Chat API key.");
                return;
            }
            addToHistory("user", message);
            const response = `Mock chat response for: ${message}`;
            addToHistory("assistant", await safeMicromark(response));
        }

        async function generateVideo(prompt) {
            if (!chatApiKeyValid) {
                addToHistory("assistant", "Please set a valid Chat API key.");
                return;
            }
            addToHistory("user", `Generate a video: ${prompt}`);
            const response = `Mock video generated: [Video URL Placeholder for "${prompt}"]`;
            addToHistory("assistant", await safeMicromark(response));
        }

        async function generateRobloxScript(prompt) {
            if (!chatApiKeyValid) {
                addToHistory("assistant", "Please set a valid Chat API key.");
                return;
            }
            addToHistory("user", `Generate a Roblox script: ${prompt}`);
            const response = `Mock Roblox Lua script:\nlocal part = Instance.new("Part")\npart.Position = Vector3.new(0, 5, 0)\npart.Size = Vector3.new(5, 1, 5)\npart.Anchored = true\npart.Parent = game.Workspace`;
            addToHistory("assistant", await safeMicromark(response));
        }

        async function handleFileUpload(file) {
            if (!file) {
                addToHistory("assistant", "No file selected.");
                return;
            }
            try {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    filePreview.textContent = content.substring(0, 1000);
                    addToHistory("user", `Uploaded file: ${file.name}`);
                    addToHistory("assistant", `File content preview:\n${content.substring(0, 500)}`);
                };
                reader.onerror = () => {
                    addToHistory("assistant", "Error reading the file. Please try again.");
                };
                if (file.name.endsWith(".rblx")) {
                    reader.readAsText(file);
                } else {
                    reader.readAsText(file);
                }
            } catch (error) {
                addToHistory("assistant", `Error processing file: ${error.message}`);
            }
        }

        sidebarToggle.onclick = () => {
            sidebar.classList.toggle("open");
        };

        themeToggle.onchange = () => {
            document.body.className = "";
            if (themeToggle.value) document.body.classList.add(`${themeToggle.value}-mode`);
        };

        chatTheme.onchange = () => {
            document.body.classList.remove("ocean-theme", "forest-theme");
            if (chatTheme.value) document.body.classList.add(`${chatTheme.value}-theme`);
        };

        debugToggle.onclick = () => {
            debugMode = !debugMode;
            addToHistory("assistant", `Debug mode ${debugMode ? "enabled" : "disabled"}`);
        };

        focusToggle.onclick = () => {
            document.body.classList.toggle("focus-mode");
        };

        contrastToggle.onclick = () => {
            document.body.classList.toggle("high-contrast");
        };

        quickReply.onchange = () => {
            if (quickReply.value) {
                userInput.value = quickReply.value;
                quickReply.value = "";
                generateChatResponse(userInput.value);
            }
        };

        const debouncedInputHandler = debounce(() => {
            const words = userInput.value.trim().split(/\s+/).filter(Boolean).length;
            wordCounter.textContent = `${words} words`;
        }, 300);

        userInput.addEventListener("input", debouncedInputHandler);

        userInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                const message = userInput.value.trim();
                if (message) {
                    if (message.toLowerCase().startsWith("generate a video")) {
                        generateVideo(message);
                    } else if (message.toLowerCase().startsWith("generate a roblox script")) {
                        generateRobloxScript(message);
                    } else {
                        generateChatResponse(message);
                    }
                    userInput.value = "";
                }
            }
        });

        sendBtn.onclick = () => {
            const message = userInput.value.trim();
            if (message) {
                if (message.toLowerCase().startsWith("generate a video")) {
                    generateVideo(message);
                } else if (message.toLowerCase().startsWith("generate a roblox script")) {
                    generateRobloxScript(message);
                } else {
                    generateChatResponse(message);
                }
                userInput.value = "";
            }
        };

        chatApiKeySubmit.onclick = async () => {
            chatApiKey = chatApiKeyInput.value.trim();
            chatApiKeyValid = await validateApiKey(chatApiKey);
            chatApiKeyWarning.style.display = chatApiKeyValid ? "none" : "block";
            if (chatApiKeyValid) addToHistory("assistant", "Chat API key set successfully.");
        };

        const debouncedFileUpload = debounce((file) => {
            handleFileUpload(file);
        }, 500);

        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            debouncedFileUpload(file);
        };

        fileClearBtn.onclick = () => {
            filePreview.textContent = "";
            fileInput.value = "";
            addToHistory("assistant", "File preview cleared.");
        };

        clearChatBtn.onclick = () => {
            conversation = [];
            chatHistory.innerHTML = "";
            addToHistory("assistant", "Chat cleared.");
        };
    </script>
</body>
</html>
