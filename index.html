<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' https://api.openai.com;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <title>VerbiFlow - AI Chat</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{background:linear-gradient(135deg,#f5f7fa,#e4e9f2);font-family:Inter,sans-serif;color:#1a202c;min-height:100vh;display:flex;justify-content:center;padding:20px;transition:background 0.4s ease}
        .dark-mode body{background:linear-gradient(135deg,#2a3444,#1c2526);color:#e2e8f0}
        .container{max-width:1280px;width:100%;background:#fff;border-radius:28px;box-shadow:0 16px 48px rgba(0,0,0,0.2);overflow:hidden;display:flex;flex-direction:column;transition:all 0.4s ease}
        .dark-mode .container{background:#2d3748;box-shadow:0 16px 48px rgba(0,0,0,0.4)}
        .nav-bar{background:linear-gradient(90deg,#2b6cb0,#3182ce);padding:20px;display:flex;gap:20px;justify-content:flex-end;align-items:center}
        .dark-mode .nav-bar{background:linear-gradient(90deg,#1a4971,#2b6cb0)}
        .nav-btn{background:#fff;color:#2b6cb0;border:none;padding:14px 28px;border-radius:14px;cursor:pointer;font-size:16px;font-weight:600;transition:all 0.25s ease;outline:none}
        .dark-mode .nav-btn{background:#4a5568;color:#e2e8f0}
        .nav-btn:hover{transform:scale(1.08);background:#f7fafc}
        .dark-mode .nav-btn:hover{background:#718096}
        .nav-btn:active{transform:scale(0.92)}
        .discord-btn{background:#7289da;color:#fff}
        .discord-btn:hover{background:#677bc4}
        .theme-btn{background:#fff;color:#2b6cb0;border:2px solid #2b6cb0;padding:12px 20px;border-radius:14px;cursor:pointer;font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px;transition:all 0.25s ease}
        .dark-mode .theme-btn{background:#4a5568;color:#e2e8f0;border:2px solid #63b3ed}
        .theme-btn:hover{transform:scale(1.08);background:#f7fafc}
        .dark-mode .theme-btn:hover{background:#718096}
        .theme-btn i{font-size:18px}
        .header{background:#fff;padding:28px;text-align:center;border-bottom:1px solid #e2e8f0}
        .dark-mode .header{background:#2d3748;border-bottom:1px solid #4a5568}
        .logo{font-size:36px;font-weight:800;color:#2b6cb0;letter-spacing:-1px}
        .dark-mode .logo{color:#63b3ed}
        .chat-area{flex:1;padding:40px;overflow-y:auto;max-height:70vh;min-height:50vh;background:#f7fafc;scroll-behavior:smooth;display:flex}
        .dark-mode .chat-area{background:#1a202c}
        .chat-content{flex:1;display:flex;flex-direction:column}
        .chat-history{display:flex;flex-direction:column;gap:24px}
        .chat-message{display:flex;flex-direction:column;gap:12px;padding:20px;border-radius:24px;max-width:85%;animation:slideIn 0.5s ease}
        .chat-message.user{align-self:flex-end;background:#2b6cb0;color:#fff}
        .dark-mode .chat-message.user{background:#1a4971}
        .chat-message.ai{align-self:flex-start;background:#edf2f7;color:#1a202c}
        .dark-mode .chat-message.ai{background:#4a5568;color:#e2e8f0}
        .chat-message-content{padding:20px;border-radius:24px;font-size:17px;line-height:1.8;word-break:break-word}
        .chat-message-meta{font-size:14px;color:#718096;margin-top:8px;opacity:0.8}
        .dark-mode .chat-message-meta{color:#a0aec0}
        .chat-message img{max-width:100%;border-radius:20px;margin-top:20px;cursor:pointer;transition:transform 0.25s ease}
        .chat-message img:hover{transform:scale(1.03)}
        .code-block{position:relative;margin:20px 0;border-radius:20px;overflow:hidden}
        .code-block pre{background:#1a202c;color:#e2e8f0;padding:24px;border-radius:20px;overflow-x:auto;font-family:'JetBrains Mono',monospace;font-size:16px;line-height:1.7}
        .dark-mode .code-block pre{background:#2d3748}
        .code-text{background:#1a202c;color:#e2e8f0;padding:24px;border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:16px;white-space:pre-wrap;user-select:text}
        .dark-mode .code-text{background:#2d3748}
        .copy-btn,.copy-all-btn{position:absolute;top:20px;background:#2b6cb0;color:#fff;border:none;padding:12px 24px;border-radius:12px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.25s ease}
        .dark-mode .copy-btn,.dark-mode .copy-all-btn{background:#1a4971}
        .copy-btn{right:20px}
        .copy-all-btn{right:120px}
        .copy-btn:hover,.copy-all-btn:hover{background:#3182ce;transform:scale(1.08)}
        .dark-mode .copy-btn:hover,.dark-mode .copy-all-btn:hover{background:#2b6cb0}
        .code-sidebar{position:fixed;top:0;right:-450px;width:450px;height:100%;background:#f7fafc;border-left:1px solid #e2e8f0;padding:28px;overflow-y:auto;transition:right 0.4s ease;z-index:150}
        .dark-mode .code-sidebar{background:#2d3748;border-left:1px solid #4a5568}
        .code-sidebar.open{right:0}
        .code-sidebar-close{background:#e53e3e;color:#fff;border:none;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:24px;margin-bottom:20px}
        .code-sidebar-close:hover{background:#c53030;transform:scale(1.1)}
        .code-sidebar-content{font-family:'JetBrains Mono',monospace;font-size:16px;color:#1a202c;white-space:pre-wrap}
        .dark-mode .code-sidebar-content{color:#e2e8f0}
        .file-upload-container{padding:24px;border-top:1px solid #e2e8f0;background:#fff}
        .dark-mode .file-upload-container{background:#2d3748;border-top:1px solid #4a5568}
        .file-actions{display:flex;gap:20px;align-items:center}
        .file-input-label{background:#2b6cb0;color:#fff;padding:16px 28px;border-radius:14px;cursor:pointer;font-size:16px;font-weight:600;min-height:52px;transition:all 0.25s ease}
        .dark-mode .file-input-label{background:#1a4971}
        .file-input-label:hover{transform:scale(1.08)}
        .file-input{display:none}
        .file-clear-btn{background:#e53e3e;color:#fff;padding:16px 28px;border-radius:14px;cursor:pointer;font-size:16px;font-weight:600;border:none;min-height:52px;transition:all 0.25s ease}
        .file-clear-btn:hover{transform:scale(1.08);background:#c53030}
        .file-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:20px;margin-top:20px}
        .file-item{display:flex;align-items:center;gap:20px;background:#edf2f7;padding:14px;border-radius:20px;cursor:pointer;transition:all 0.25s ease}
        .dark-mode .file-item{background:#4a5568}
        .file-item:hover{background:#e2e8f0;transform:scale(1.03)}
        .dark-mode .file-item:hover{background:#718096}
        .file-item-name{flex:1;font-size:16px;color:#1a202c;overflow:hidden;text-overflow:ellipsis;white-space nowrap}
        .dark-mode .file-item-name{color:#e2e8f0}
        .file-item-details{font-size:14px;color:#718096}
        .dark-mode .file-item-details{color:#a0aec0}
        .file-preview-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:200;padding:28px;justify-content:center;align-items:center}
        .file-preview-modal.open{display:flex}
        .file-preview-content{background:#fff;border-radius:24px;padding:28px;max-width:95%;max-height:95%;overflow:auto;color:#1a202c;font-size:16px}
        .dark-mode .file-preview-content{background:#2d3748;color:#e2e8f0}
        .file-preview-content img{max-width:85% !important}
        .file-preview-close{background:#e53e3e;color:#fff;border:none;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;position:absolute;top:28px;right:28px;transition:all 0.25s ease}
        .file-preview-close:hover{transform:scale(1.1);background:#c53030}
        .file-preview-close svg{width:28px;height:28px;fill:#fff}
        .input-container{display:flex;align-items:flex-end;padding:24px;border-top:1px solid #e2e8f0;background:#fff;gap:20px;position:sticky;bottom:0;z-index:10}
        .dark-mode .input-container{background:#2d3748;border-top:1px solid #4a5568}
        .user-input{flex:1;padding:20px;border:1px solid #e2e8f0;border-radius:14px;font-size:17px;outline:none;resize:none;min-height:52px;max-height:240px;background:#fff;color:#1a202c;transition:all 0.25s ease}
        .dark-mode .user-input{background:#4a5568;border:1px solid #718096;color:#e2e8f0}
        .user-input:focus{border-color:#2b6cb0;box-shadow:0 0 0 5px rgba(43,108,176,0.2)}
        .dark-mode .user-input:focus{border-color:#63b3ed;box-shadow:0 0 0 5px rgba(99,179,237,0.2)}
        .send-btn{background:#2b6cb0;border:none;border-radius:14px;padding:16px 32px;cursor:pointer;color:#fff;font-size:16px;font-weight:600;min-height:52px;transition:all 0.25s ease}
        .dark-mode .send-btn{background:#1a4971}
        .send-btn:hover{transform:scale(1.08);background:#3182ce}
        .dark-mode .send-btn:hover{background:#2b6cb0}
        .send-btn:disabled{background:#a0aec0;cursor:not-allowed}
        .loading-spinner{display:none;margin:20px auto;width:48px;height:48px;border:6px solid #2b6cb0;border-top:6px solid transparent;border-radius:50%;animation:spin 0.6s linear infinite}
        .typing-indicator{display:none;font-size:16px;color:#718096;margin:20px auto;text-align:center}
        .dark-mode .typing-indicator{color:#a0aec0}
        .typing-indicator span{display:inline-block;animation:dotPulse 1.2s infinite ease-in-out}
        .typing-indicator span:nth-child(2){animation-delay:0.15s}
        .typing-indicator span:nth-child(3){animation-delay:0.3s}
        .notification{position:fixed;top:28px;right:28px;padding:20px 40px;border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,0.3);opacity:0;transform:translateY(-28px);transition:all 0.5s ease;font-size:16px;font-weight:500;z-index:300}
        .notification.show{opacity:1;transform:translateY(0)}
        .notification.success{background:#2b6cb0;color:#fff}
        .notification.error{background:#e53e3e;color:#fff}
        @keyframes slideIn{0%{opacity:0;transform:translateY(28px)}100%{opacity:1;transform:translateY(0)}}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        @keyframes dotPulse{0%,80%,100%{transform:scale(1);opacity:0.5}40%{transform:scale(1.6);opacity:1}}
        @media (max-width:768px){
            .container{max-width:100%;border-radius:20px;padding:16px}
            .nav-bar{padding:16px;gap:16px}
            .nav-btn{font-size:15px;padding:12px 24px}
            .theme-btn{padding:10px 16px;font-size:15px}
            .header{padding:24px}
            .logo{font-size:32px}
            .chat-area{padding:32px;min-height:45vh;max-height:65vh}
            .chat-message{max-width:90%}
            .chat-message-content{font-size:16px}
            .chat-message img{max-width:90%}
            .input-container{padding:20px;gap:16px}
            .user-input{font-size:16px;min-height:48px}
            .send-btn{padding:14px 28px;min-height:48px}
            .file-input-label,.file-clear-btn{font-size:15px;padding:14px 24px;min-height:48px}
            .file-preview-content img{max-width:90% !important}
            .notification{top:24px;right:24px;padding:16px 32px;font-size:15px}
            .code-sidebar{width:100%;right:-100%}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-bar">
            <button class="nav-btn" id="clearChatBtn">Clear Chat</button>
            <button class="nav-btn" id="verbiflowUpdatesBtn">VerbiFlow Updates</button>
            <button class="theme-btn" id="themeBtn"><i class="fas fa-moon"></i> Theme</button>
            <button class="nav-btn" id="copyCodeBtn">Copy Code</button>
            <button class="nav-btn discord-btn" id="discordBtn">Discord Server</button>
        </div>
        <div class="header">
            <div class="logo">VerbiFlow</div>
        </div>
        <div class="chat-area" id="chatArea">
            <div class="chat-content">
                <div class="chat-history" id="chatHistory">
                    <div class="chat-message ai">
                        <div class="chat-message-content">Welcome to VerbiFlow! I'm your advanced AI assistant, capable of generating images, answering complex queries, and deobfuscating code. Ask me anything or upload an image to get started!</div>
                        <div class="chat-message-meta">Just now</div>
                    </div>
                </div>
                <div class="loading-spinner" id="loadingSpinner"></div>
                <div class="typing-indicator" id="typingIndicator">
                    VerbiFlow is typing<span>.</span><span>.</span><span>.</span>
                </div>
            </div>
        </div>
        <div class="file-upload-container" id="fileUploadContainer">
            <div class="file-actions">
                <label class="file-input-label" for="fileInput">Upload File</label>
                <input type="file" class="file-input" id="fileInput" multiple accept="image/*,text/*">
                <button class="file-clear-btn" id="fileClearBtn" style="display:none;">Clear</button>
            </div>
            <div class="file-list" id="fileList"></div>
        </div>
        <div class="input-container">
            <textarea class="user-input" id="userInput" placeholder="Type your query or paste an image..." rows="1"></textarea>
            <button class="send-btn" id="sendBtn">Send</button>
        </div>
        <div class="file-preview-modal" id="filePreviewModal">
            <button class="file-preview-close" id="filePreviewClose">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <div class="file-preview-content" id="filePreviewContent"></div>
        </div>
        <div class="code-sidebar" id="codeSidebar">
            <button class="code-sidebar-close" id="codeSidebarClose">×</button>
            <pre class="code-sidebar-content" id="codeSidebarContent"></pre>
        </div>
        <div class="notification" id="notification"></div>
    </div>
    <script defer>
        const API_KEY = "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";
        const API_URL = "https://api.openai.com/v1/chat/completions";
        const IMAGE_GEN_API_URL = "https://api.openai.com/v1/images/generations";
        const DISCORD_INVITE = "https://discord.gg/rCTRQvD4TP";
        const chatHistory = document.getElementById('chatHistory');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const fileClearBtn = document.getElementById('fileClearBtn');
        const fileUploadContainer = document.getElementById('fileUploadContainer');
        const filePreviewModal = document.getElementById('filePreviewModal');
        const filePreviewContent = document.getElementById('filePreviewContent');
        const filePreviewClose = document.getElementById('filePreviewClose');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const typingIndicator = document.getElementById('typingIndicator');
        const chatArea = document.getElementById('chatArea');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const copyCodeBtn = document.getElementById('copyCodeBtn');
        const discordBtn = document.getElementById('discordBtn');
        const verbiflowUpdatesBtn = document.getElementById('verbiflowUpdatesBtn');
        const themeBtn = document.getElementById('themeBtn');
        const notification = document.getElementById('notification');
        const codeSidebar = document.getElementById('codeSidebar');
        const codeSidebarClose = document.getElementById('codeSidebarClose');
        const codeSidebarContent = document.getElementById('codeSidebarContent');
        let filesArray = [];
        let conversationHistory = [{ role: "assistant", content: "Welcome to VerbiFlow! I'm your advanced AI assistant, capable of generating images, answering complex queries, and deobfuscating code. Ask me anything or upload an image to get started!" }];
        let latestCodeBlocks = [];
        let latestAiResponse = '';
        let isDarkMode = false;

        class Deobfuscator {
            static decodeBase64(str) {
                try {
                    return atob(str);
                } catch {
                    return str;
                }
            }
            static decodeXOR(str, key = 42) {
                return String.fromCharCode(...str.split('').map((c, i) => c.charCodeAt(0) ^ (key + i % 10)));
            }
            static decodeStringManipulation(str) {
                let result = str.replace(/\[(\d+)\]/g, (_, num) => String.fromCharCode(parseInt(num)));
                result = result.split('').reverse().join('');
                return result;
            }
            static decodeHex(str) {
                try {
                    return str.replace(/\\x([0-9A-Fa-f]{2})/g, (_, hex) => String.fromCharCode(parseInt(hex, 16)));
                } catch {
                    return str;
                }
            }
            static analyzePatterns(code) {
                const patterns = [
                    { regex: /^[A-Za-z0-9+/=]+$/g, method: 'base64' },
                    { regex: /[\x00-\x1F\x7F-\xFF]+/g, method: 'xor' },
                    { regex: /\[\d+\]/g, method: 'stringManipulation' },
                    { regex: /\\x[0-9A-Fa-f]{2}/g, method: 'hex' }
                ];
                for (const pattern of patterns) {
                    if (code.match(pattern.regex)) {
                        return pattern.method;
                    }
                }
                return 'unknown';
            }
            static deobfuscate(code) {
                let result = code;
                const maxLayers = 7;
                for (let i = 0; i < maxLayers; i++) {
                    const method = this.analyzePatterns(result);
                    if (method === 'base64') {
                        result = this.decodeBase64(result);
                    } else if (method === 'xor') {
                        result = this.decodeXOR(result);
                    } else if (method === 'stringManipulation') {
                        result = this.decodeStringManipulation(result);
                    } else if (method === 'hex') {
                        result = this.decodeHex(result);
                    } else {
                        break;
                    }
                }
                return result;
            }
        }

        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3500);
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');
            themeBtn.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i> Light Mode' : '<i class="fas fa-moon"></i> Dark Mode';
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                isDarkMode = true;
                document.body.classList.add('dark-mode');
                themeBtn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
            } else {
                themeBtn.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
            }
        }

        themeBtn.addEventListener('click', toggleTheme);

        discordBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(DISCORD_INVITE);
            showNotification('Discord invite link copied to clipboard.');
        });

        verbiflowUpdatesBtn.addEventListener('click', () => {
            window.open('/updates', '_blank');
        });

        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = `${Math.min(userInput.scrollHeight, 240)}px`;
        });

        userInput.addEventListener('paste', async (e) => {
            const items = e.clipboardData.items;
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    if (file.size > 2 * 1024 * 1024 * 1024) {
                        showError(`Image "${file.name}" exceeds the 2GB limit.`);
                        return;
                    }
                    filesArray.push(file);
                    displayFileItem(file);
                }
            }
        });

        fileInput.addEventListener('change', handleFileUpload);
        fileUploadContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadContainer.style.background = isDarkMode ? '#4a5568' : '#e2e8f0';
        });
        fileUploadContainer.addEventListener('dragleave', () => {
            fileUploadContainer.style.background = isDarkMode ? '#2d3748' : '#fff';
        });
        fileUploadContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadContainer.style.background = isDarkMode ? '#2d3748' : '#fff';
            fileInput.files = e.dataTransfer.files;
            handleFileUpload();
        });

        function handleFileUpload() {
            const files = Array.from(fileInput.files);
            files.forEach(file => {
                if (file.size > 2 * 1024 * 1024 * 1024) {
                    showError(`File "${file.name}" exceeds the 2GB limit.`);
                    return;
                }
                if (!filesArray.some(f => f.name === file.name && f.size === file.size)) {
                    filesArray.push(file);
                    displayFileItem(file);
                }
            });
            fileClearBtn.style.display = filesArray.length ? 'block' : 'none';
            fileInput.value = '';
        }

        function displayFileItem(file) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <span class="file-item-name">${file.name}</span>
                <span class="file-item-details">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
            `;
            fileItem.addEventListener('click', () => previewFile(file));
            fileList.appendChild(fileItem);
        }

        fileClearBtn.addEventListener('click', () => {
            filesArray = [];
            fileList.innerHTML = '';
            fileClearBtn.style.display = 'none';
        });

        function previewFile(file) {
            filePreviewContent.innerHTML = `<strong>${file.name}</strong><br>Size: ${(file.size / 1024 / 1024).toFixed(2)} MB<br>Type: ${file.type}`;
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.style.maxWidth = '100%';
                filePreviewContent.appendChild(img);
            } else if (file.type.startsWith('text/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const pre = document.createElement('pre');
                    pre.textContent = e.target.result;
                    filePreviewContent.appendChild(pre);
                };
                reader.readAsText(file);
            }
            filePreviewModal.classList.add('open');
        }

        filePreviewClose.addEventListener('click', () => {
            filePreviewModal.classList.remove('open');
            filePreviewContent.innerHTML = '';
        });

        clearChatBtn.addEventListener('click', () => {
            chatHistory.innerHTML = `
                <div class="chat-message ai">
                    <div class="chat-message-content">Welcome to VerbiFlow! I'm your advanced AI assistant, capable of generating images, answering complex queries, and deobfuscating code. Ask me anything or upload an image to get started!</div>
                    <div class="chat-message-meta">Just now</div>
                </div>
            `;
            conversationHistory = [{ role: "assistant", content: "Welcome to VerbiFlow! I'm your advanced AI assistant, capable of generating images, answering complex queries, and deobfuscating code. Ask me anything or upload an image to get started!" }];
            filesArray = [];
            fileList.innerHTML = '';
            fileClearBtn.style.display = 'none';
            userInput.value = '';
            userInput.style.height = 'auto';
            chatArea.scrollTop = 0;
            latestCodeBlocks = [];
            latestAiResponse = '';
            codeSidebarContent.textContent = '';
        });

        copyCodeBtn.addEventListener('click', () => {
            if (latestCodeBlocks.length > 0) {
                navigator.clipboard.writeText(latestCodeBlocks.join('\n\n'));
                showNotification('Code copied to clipboard.');
                codeSidebarContent.textContent = latestCodeBlocks.join('\n\n');
                codeSidebar.classList.add('open');
            } else if (latestAiResponse) {
                navigator.clipboard.writeText(latestAiResponse);
                showNotification('AI response copied to clipboard.');
            } else {
                showNotification('Please ask AI first.', 'error');
            }
        });

        codeSidebarClose.addEventListener('click', () => {
            codeSidebar.classList.remove('open');
        });

        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function showError(message) {
            const errorMessage = document.createElement('div');
            errorMessage.className = 'chat-message ai';
            errorMessage.innerHTML = `
                <div class="chat-message-content">${message}</div>
                <div class="chat-message-meta">Just now</div>
            `;
            chatHistory.appendChild(errorMessage);
            chatArea.scrollTop = chatArea.scrollHeight;
            latestCodeBlocks = [];
            latestAiResponse = '';
        }

        function formatMessage(content, messageElement) {
            const codeBlockRegex = /```([\s\S]*?)```/g;
            let codeBlocks = [];
            let html = content.replace(codeBlockRegex, (match, code) => {
                codeBlocks.push(code.trim());
                return `<div class="code-block"><pre class="code-text">${code.trim()}</pre><button class="copy-btn" onclick="navigator.clipboard.writeText(\`${code.trim().replace(/`/g, '\\`')}\`)">Copy Code</button></div>`;
            });
            latestCodeBlocks = codeBlocks;
            if (codeBlocks.length > 1) {
                const copyAllBtn = `<button class="copy-all-btn" onclick="navigator.clipboard.writeText(\`${codeBlocks.join('\n\n').replace(/`/g, '\\`')}\`)">Copy All Code</button>`;
                messageElement.querySelector('.chat-message-content').insertAdjacentHTML('afterbegin', copyAllBtn);
            }
            return html;
        }

        async function generateImage(prompt) {
            try {
                const response = await fetch(IMAGE_GEN_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        n: 1,
                        size: "1024x1024",
                    }),
                });
                if (!response.ok) throw new Error('Image generation failed');
                const data = await response.json();
                return data.data[0].url;
            } catch (error) {
                return null;
            }
        }

        async function readImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message && filesArray.length === 0) return;

            const userMessage = document.createElement('div');
            userMessage.className = 'chat-message user';
            let messageContent = message;
            let messageHTML = `<div class="chat-message-content">${message}</div>`;

            if (filesArray.length > 0) {
                const fileDescriptions = filesArray.map(file => `File: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`).join(', ');
                messageContent += `\nAttached files: ${fileDescriptions}`;
                messageHTML += filesArray.map(file => file.type.startsWith('image/') ? `<img src="${URL.createObjectURL(file)}" alt="${file.name}">` : '').join('');
            }

            userMessage.innerHTML = `${messageHTML}<div class="chat-message-meta">Just now</div>`;
            chatHistory.appendChild(userMessage);
            userInput.value = '';
            userInput.style.height = 'auto';
            chatArea.scrollTop = chatArea.scrollHeight;

            conversationHistory.push({ role: "user", content: messageContent });

            typingIndicator.style.display = 'block';
            sendBtn.disabled = true;

            try {
                let aiMessageText = '';
                const aiMessage = document.createElement('div');
                aiMessage.className = 'chat-message ai';
                aiMessage.innerHTML = `<div class="chat-message-content"></div><div class="chat-message-meta">Just now</div>`;
                chatHistory.appendChild(aiMessage);

                if (message.toLowerCase().includes('generate image') || message.toLowerCase().includes('create image')) {
                    const imageUrl = await generateImage(message);
                    if (imageUrl) {
                        aiMessageText = `Generated image for: "${message}"`;
                        aiMessage.querySelector('.chat-message-content').innerHTML = `${formatMessage(aiMessageText, aiMessage)}<img src="${imageUrl}" alt="Generated Image">`;
                    } else {
                        aiMessageText = 'Sorry, image generation failed. Please try a different prompt.';
                        aiMessage.querySelector('.chat-message-content').innerHTML = formatMessage(aiMessageText, aiMessage);
                    }
                    latestAiResponse = aiMessageText;
                    conversationHistory.push({ role: "assistant", content: aiMessageText });
                    chatArea.scrollTop = chatArea.scrollHeight;
                } else if (message.toLowerCase().includes('deobfuscate') || message.toLowerCase().includes('decode')) {
                    const codeToDeobfuscate = message.match(/```([\s\S]*?)```/)?.[1]?.trim() || message;
                    try {
                        const deobfuscatedCode = Deobfuscator.deobfuscate(codeToDeobfuscate);
                        aiMessageText = `Deobfuscated code:\n\`\`\`\n${deobfuscatedCode}\n\`\`\``;
                        aiMessage.querySelector('.chat-message-content').innerHTML = formatMessage(aiMessageText, aiMessage);
                    } catch (error) {
                        aiMessageText = 'Failed to deobfuscate the code. It may not be obfuscated or requires a different approach.';
                        aiMessage.querySelector('.chat-message-content').innerHTML = formatMessage(aiMessageText, aiMessage);
                    }
                    latestAiResponse = aiMessageText;
                    conversationHistory.push({ role: "assistant", content: aiMessageText });
                    chatArea.scrollTop = chatArea.scrollHeight;
                } else if (message.toLowerCase().includes('luau') || message.toLowerCase().includes('roblox')) {
                    const luauPrompt = `You are an expert in Luau, the scripting language used in Roblox. Design a clean, modern, and delightful UI for a Roblox game based on the following user request: "${message}". Provide the Luau code with a focus on creating an intuitive, visually appealing, and responsive UI using Roblox's UI framework (e.g., Frames, TextLabels, TextButtons, ImageLabels). Ensure the code is optimized for performance and includes error handling.`;
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${API_KEY}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: "gpt-4o",
                            messages: [{ role: "user", content: luauPrompt }],
                            max_tokens: 800,
                            temperature: 0.7,
                        }),
                    });
                    if (!response.ok) throw new Error('API request failed');
                    const data = await response.json();
                    aiMessageText = data.choices[0].message.content;
                    aiMessage.querySelector('.chat-message-content').innerHTML = formatMessage(aiMessageText, aiMessage);
                    latestAiResponse = aiMessageText;
                    conversationHistory.push({ role: "assistant", content: aiMessageText });
                    chatArea.scrollTop = chatArea.scrollHeight;
                } else {
                    const messages = [...conversationHistory];
                    if (filesArray.some(file => file.type.startsWith('image/'))) {
                        const image = filesArray.find(file => file.type.startsWith('image/'));
                        const imageData = await readImage(image);
                        messages.push({
                            role: "user",
                            content: [
                                { type: "text", text: messageContent },
                                { type: "image_url", image_url: { url: imageData } },
                            ],
                        });
                    }

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${API_KEY}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: "gpt-4o",
                            messages: messages.slice(-7),
                            max_tokens: 300,
                            temperature: 0.7,
                            stream: true,
                        }),
                    });

                    if (!response.ok) throw new Error('API request failed');

                    const reader = response.body.getReader();
                    let buffer = '';
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        buffer += new TextDecoder().decode(value);
                        const lines = buffer.split('\n');
                        buffer = lines.pop();
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') continue;
                                try {
                                    const parsed = JSON.parse(data);
                                    const content = parsed.choices[0].delta.content;
                                    if (content) {
                                        aiMessageText += content;
                                        aiMessage.querySelector('.chat-message-content').innerHTML = formatMessage(aiMessageText, aiMessage);
                                        chatArea.scrollTop = chatArea.scrollHeight;
                                    }
                                } catch (e) {}
                            }
                        }
                    }
                    aiMessage.querySelector('.chat-message-content').innerHTML = formatMessage(aiMessageText, aiMessage);
                    latestAiResponse = aiMessageText;
                    chatArea.scrollTop = chatArea.scrollHeight;
                    conversationHistory.push({ role: "assistant", content: aiMessageText });
                }

                filesArray = [];
                fileList.innerHTML = '';
                fileClearBtn.style.display = 'none';
            } catch (error) {
                showError('An error occurred. Please try again or check your connection.');
            } finally {
                typingIndicator.style.display = 'none';
                sendBtn.disabled = false;
            }
        }

        loadTheme();
    </script>
</body>
</html>
