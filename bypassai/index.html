<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prysmis AI - Your Ultimate AI Coding & Learning Partner</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.24.1/themes/prism-tomorrow.css" rel="stylesheet">
    <style>
body {
    background: #0a0f1a;
    min-height: 100vh;
    margin: 0;
    font-family: 'Inter', sans-serif;
    color: #d1d5db;
    overflow-x: hidden;
    overflow-y: auto;
    transition: background 0.6s ease;
}

body.light-mode {
    background: #f9fafb;
    color: #111827;
}

.app-container {
    max-width: 1300px;
    margin: 0 auto;
    padding: 2rem;
}

.sidebar {
    width: 260px;
    background: #111827;
    height: 100vh;
    position: fixed;
    top: 0;
    left: 0;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

body.light-mode .sidebar {
    background: #f3f4f6;
}

.main-content {
    margin-left: 260px;
    padding: 2rem;
}

.chat-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-width: 800px;
    margin: 0 auto;
}

.message {
    max-width: 70%;
    padding: 1rem;
    border-radius: 0.75rem;
    line-height: 1.6;
}

.message.user {
    background: #3b82f6;
    color: #ffffff;
    align-self: flex-end;
    margin-left: auto;
}

.message.ai {
    background: #1f2937;
    color: #e5e7eb;
    align-self: flex-start;
}

body.light-mode .message.ai {
    background: #e5e7eb;
    color: #1f2937;
}

.input-area {
    display: flex;
    gap: 0.5rem;
    padding: 1rem;
    background: #1f2937;
    border-radius: 0.75rem;
    position: fixed;
    bottom: 1rem;
    width: calc(100% - 280px);
    margin-left: 260px;
}

body.light-mode .input-area {
    background: #f3f4f6;
}

input[type="text"] {
    flex: 1;
    padding: 0.75rem;
    border: 1px solid #374151;
    border-radius: 0.5rem;
    background: #111827;
    color: #d1d5db;
    font-size: 1rem;
}

body.light-mode input[type="text"] {
    background: #ffffff;
    color: #1f2937;
    border-color: #d1d5db;
}

button.send-btn {
    padding: 0.75rem 1.5rem;
    background: #3b82f6;
    color: #ffffff;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: background 0.3s;
}

button.send-btn:hover {
    background: #2563eb;
}

.profile-btn, .theme-toggle-btn {
    background: #1f2937;
    color: #d1d5db;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    transition: background 0.3s;
}

body.light-mode .profile-btn, body.light-mode .theme-toggle-btn {
    background: #e5e7eb;
    color: #1f2937;
}

.profile-btn:hover, .theme-toggle-btn:hover {
    background: #374151;
}

body.light-mode .profile-btn:hover, body.light-mode .theme-toggle-btn:hover {
    background: #d1d5db;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid #374151;
}

body.light-mode .header {
    border-color: #d1d5db;
}

.logo {
    font-size: 1.5rem;
    font-weight: 600;
    color: #3b82f6;
}

.profile-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #1f2937;
    padding: 1.5rem;
    border-radius: 0.75rem;
    box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    color: #d1d5db;
    width: 400px;
    max-height: 90vh;
    overflow-y: auto;
}

body.light-mode .profile-modal {
    background: #ffffff;
    color: #1f2937;
}

.profile-modal.active {
    display: block;
}

.close-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: none;
    border: none;
    color: #d1d5db;
    font-size: 1.25rem;
    cursor: pointer;
    transition: color 0.3s;
}

body.light-mode .close-btn {
    color: #1f2937;
}

.close-btn:hover {
    color: #3b82f6;
}

.api-key-input, .custom-instruction, .model-selection {
    margin: 1.2rem 0;
}

label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

input[type="text"], textarea, select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #374151;
    border-radius: 0.5rem;
    background: #111827;
    color: #d1d5db;
    font-size: 1rem;
    transition: border-color 0.3s, background 0.3s;
}

body.light-mode input[type="text"], body.light-mode textarea, body.light-mode select {
    background: #ffffff;
    color: #1f2937;
    border-color: #d1d5db;
}

input[type="text"]:focus, textarea:focus, select:focus {
    border-color: #3b82f6;
    outline: none;
    background: #1e293b;
}

body.light-mode input[type="text"]:focus, body.light-mode textarea:focus, body.light-mode select:focus {
    background: #f9fafb;
}

button.save-btn {
    background: #3b82f6;
    color: #ffffff;
    border: none;
    border-radius: 0.5rem;
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    width: 100;
    transition: background 0.3s;
}

button.save-btn:hover {
    background: #2563eb;
}

.section-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    justify-content: center;
}

.tab {
    padding: 0.75rem 1.5rem;
    background: #1f2937;
    border-radius: 0.5rem;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.3s;
}

body.light-mode .tab {
    background: #e5e7eb;
}

.tab.active {
    background: #3b82f6;
    color: #ffffff;
}

.tab:hover:not(.active) {
    background: #374151;
}

body.light-mode .tab:hover:not(.active) {
    background: #d1d5db;
}

.language-selector {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    justify-content: center;
}

.language-option {
    padding: 0.75rem 1.5rem;
    background: #1f2937;
    border-radius: 9999px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.3s;
}

body.light-mode .language-option {
    background: #e5e7eb;
}

.language-option.active {
    background: #3b82f6;
    color: #ffffff;
}

.language-option:hover {
    background: #374151;
}

body.light-mode .language-option:hover {
    background: #d1d5db;
}

.model-selector {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    justify-content: center;
}

.model-option {
    padding: 0.75rem 1.5rem;
    background: #1f2937;
    border-radius: 9999px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.3s;
}

body.light-mode .model-option {
    background: #e5e7eb;
}

.model-option.active {
    background: #3b82f6;
    color: #ffffff;
}

.model-option:hover {
    background: #374151;
}

body.light-mode .model-option:hover {
    background: #d1d5db;
}

.code-area, .general-area, .homework-area, .analysis-area {
    display: none;
    max-width: 800px;
    margin: 0 auto 1.5rem;
    padding: 1rem;
    background: #1f2937;
    border-radius: 0.75rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

body.light-mode .code-area, body.light-mode .general-area, body.light-mode .homework-area, body.light-mode .analysis-area {
    background: #ffffff;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.code-area.active, .general-area.active, .homework-area.active, .analysis-area.active {
    display: block;
}

textarea {
    width: 100%;
    min-height: 150px;
    padding: 0.75rem;
    border: 1px solid #374151;
    border-radius: 0.5rem;
    background: #111827;
    color: #d1d5db;
    font-family: 'Fira Code', monospace;
    font-size: 0.95rem;
    resize: vertical;
}

body.light-mode textarea {
    background: #ffffff;
    color: #1f2937;
    border-color: #d1d5db;
}

.output {
    margin-top: 1rem;
    padding: 1rem;
    background: #111827;
    border-radius: 0.5rem;
    white-space: pre-wrap;
    overflow-x: auto;
}

body.light-mode .output {
    background: #f9fafb;
}

.button-group {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 1rem;
}

.btn-primary {
    background: #3b82f6;
    color: #ffffff;
    border: none;
    border-radius: 0.5rem;
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.3s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary:hover {
    background: #2563eb;
}

.btn-primary:disabled {
    background: #9ca3af;
    cursor: not-allowed;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: #374151;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 0.75rem;
    display: none;
}

body.light-mode .progress-bar {
    background: #d1d5db;
}

.progress-bar.active {
    display: block;
}

.progress-bar-fill {
    width: 0;
    height: 100%;
    background: #3b82f6;
    transition: width 0.05s linear;
}

.retry-btn {
    background: #ef4444;
    color: #ffffff;
    border: none;
    border-radius: 0.5rem;
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    margin-top: 0.75rem;
    display: none;
    transition: background 0.3s;
}

.retry-btn:hover {
    background: #dc2626;
}

.copy-btn {
    background: #10b981;
    color: #ffffff;
    border: none;
    border-radius: 0.5rem;
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    margin-top: 0.75rem;
    transition: background 0.3s;
}

.copy-btn:hover {
    background: #059669;
}

.continue-btn {
    background: #8b5cf6;
    color: #ffffff;
    border: none;
    border-radius: 0.5rem;
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    margin-top: 0.75rem;
    transition: background 0.3s;
}

.continue-btn:hover {
    background: #7c3aed;
}

.ai-to-human-btn {
    background: #f59e0b;
    color: #ffffff;
    border: none;
    border-radius: 0.5rem;
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    margin-top: 0.75rem;
    transition: background 0.3s;
}

.ai-to-human-btn:hover {
    background: #d97706;
}
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">Prysmis AI</div>
        <button class="profile-btn" id="profileBtn">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </button>
        <button class="theme-toggle-btn" id="themeToggleBtn">
            <i class="fas fa-moon"></i>
            <span>Toggle Theme</span>
        </button>
        <button class="profile-btn" id="signOutBtn" style="background: #ef4444; color: #ffffff;">
            <i class="fas fa-sign-out-alt"></i>
            <span>Sign Out</span>
        </button>
    </div>
    <div class="main-content">
        <div class="header">
            <h1 class="text-xl font-semibold">Prysmis AI Chat</h1>
            <div>
                <div class="status-badge" id="statusBadge">
                    <span class="pulsing-dot"></span>
                    <span id="statusText">API Active</span>
                </div>
            </div>
        </div>
        <div class="section-tabs">
            <div class="tab active" data-section="coding">Code Processing</div>
            <div class="tab" data-section="general">General Query</div>
            <div class="tab" data-section="homework">Homework Solver</div>
            <div class="tab" data-section="analysis">Code Analysis</div>
        </div>
        <div class="language-selector" id="languageSelector">
            <div class="language-option active" data-lang="javascript">JavaScript</div>
            <div class="language-option" data-lang="python">Python</div>
            <div class="language-option" data-lang="lua">Lua</div>
            <div class="language-option" data-lang="ruby">Ruby</div>
            <div class="language-option" data-lang="go">Go</div>
            <div class="language-option" data-lang="cpp">C++</div>
            <div class="language-option" data-lang="csharp">C#</div>
            <div class="language-option" data-lang="java">Java</div>
        </div>
        <div class="model-selector" id="modelSelector">
            <div class="model-option active" data-model="chatgpt">ChatGPT</div>
            <div class="model-option" data-model="deepseek">DeepSeek</div>
        </div>
        <div class="chat-container" id="chatContainer">
            <div class="message ai" id="welcomeMessage">
                Hi, I'm Prysmis AI. How can I assist you today?
            </div>
        </div>
        <div class="input-area">
            <input type="text" id="inputField" placeholder="Type your message...">
            <button class="send-btn" id="sendBtn">Send</button>
        </div>
        <div class="code-area" id="codingSection">
            <textarea id="codeInput" placeholder="Enter code or URL..."></textarea>
            <div class="output" id="codeOutput"></div>
            <div class="progress-bar" id="codeProgressBar">
                <div class="progress-bar-fill" id="codeProgressFill"></div>
            </div>
            <div class="button-group">
                <button class="btn-primary" id="processBtn">Optimize</button>
                <button class="btn-primary" id="debugBtn">Debug</button>
                <button class="btn-primary" id="explainBtn">Explain</button>
                <button class="btn-primary" id="obfuscateBtn">Obfuscate</button>
                <button class="btn-primary" id="deobfuscateBtn">Deobfuscate</button>
                <button class="btn-primary" id="improveBtn">Improve</button>
                <button class="btn-primary" id="continueBtn" style="display: none;">Continue</button>
                <button class="copy-btn" id="copyCodeBtn">Copy</button>
                <button class="retry-btn" id="retryCodeBtn">Retry</button>
            </div>
        </div>
        <div class="general-area" id="generalSection">
            <textarea id="generalInput" placeholder="Ask anything..."></textarea>
            <div class="output" id="generalOutput"></div>
            <div class="progress-bar" id="generalProgressBar">
                <div class="progress-bar-fill" id="generalProgressFill"></div>
            </div>
            <div class="button-group">
                <button class="btn-primary" id="generalBtn">Query</button>
                <button class="copy-btn" id="copyGeneralBtn">Copy</button>
                <button class="retry-btn" id="retryGeneralBtn">Retry</button>
            </div>
        </div>
        <div class="homework-area" id="homeworkSection">
            <textarea id="homeworkInput" placeholder="Enter problem or question..."></textarea>
            <div class="output" id="homeworkOutput"></div>
            <div class="progress-bar" id="homeworkProgressBar">
                <div class="progress-bar-fill" id="homeworkProgressFill"></div>
            </div>
            <div class="button-group">
                <button class="btn-primary" id="homeworkBtn">Solve</button>
                <button class="copy-btn" id="copyHomeworkBtn">Copy</button>
                <button class="retry-btn" id="retryHomeworkBtn">Retry</button>
            </div>
        </div>
        <div class="analysis-area" id="analysisSection">
            <textarea id="analysisInput" placeholder="Enter code for analysis..."></textarea>
            <div class="output" id="analysisOutput"></div>
            <div class="progress-bar" id="analysisProgressBar">
                <div class="progress-bar-fill" id="analysisProgressFill"></div>
            </div>
            <div class="button-group">
                <button class="btn-primary" id="analyzeBtn">Analyze</button>
                <button class="copy-btn" id="copyAnalysisBtn">Copy</button>
                <button class="ai-to-human-btn" id="aiToHumanBtn">AI to Human</button>
                <button class="retry-btn" id="retryAnalysisBtn">Retry</button>
            </div>
        </div>
    </div>
    <div class="profile-modal" id="profileModal">
        <button class="close-btn" id="closeProfileBtn">×</button>
        <h2 class="text-xl font-semibold mb-2">Profile Settings</h2>
        <div class="api-key-input">
            <label>API Keys</label>
            <input type="text" id="chatGptApiKey" placeholder="Enter API Key for ChatGPT">
            <input type="text" id="deepSeekApiKey" placeholder="Enter API Key for DeepSeek">
        </div>
        <div class="model-selection">
            <label>AI Models</label>
            <select id="modelSelect">
                <option value="chatgpt">ChatGPT</option>
                <option value="deepseek">DeepSeek</option>
            </select>
        </div>
        <div class="custom-instruction">
            <label>Custom Instructions</label>
            <textarea id="customInstruction" placeholder="Tell me how Prysmis AI should respond..."></textarea>
        </div>
        <button class="save-btn" id="saveApiKeyBtn">Save Changes</button>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.24.1/prism.min.js"></script>
    <script>
if (!localStorage.getItem('username')) {
    window.location.href = 'index.html';
}

const username = localStorage.getItem('username');
document.querySelector('.logo').textContent += ` - ${username}${username === 'realalex' ? ' [Admin]' : ''}`;
if (username === 'realalex') {
    const adminBtn = document.createElement('button');
    adminBtn.className = 'profile-btn';
    adminBtn.innerHTML = '<i class="fas fa-user-shield"></i><span>Admin Panel</span>';
    document.querySelector('.sidebar').appendChild(adminBtn);
}

async function validateDeepSeekApiKey(key) {
    if (!key) return false;
    try {
        const response = await fetch('https://api.deepseek.com/v1/models', {
            headers: { 'Authorization': `Bearer ${key}` }
        });
        if (!response.ok) throw new Error('Invalid DeepSeek API key');
        return true;
    } catch {
        return false;
    }
}

async function validateChatGptApiKey(key) {
    if (!key) return false;
    try {
        const response = await fetch('https://api.openai.com/v1/models', {
            headers: { 'Authorization': `Bearer ${key}` }
        });
        if (!response.ok) throw new Error('Invalid ChatGPT API key');
        return true;
    } catch {
        return false;
    }
}

async function callChatGpt(prompt, maxTokens = 4000, apiKey = localStorage.getItem('chatGptApiKey')) {
    if (!apiKey) return "Looks like I need a ChatGPT API key to help you—please add one in your profile!";
    try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: [{ role: 'system', content: localStorage.getItem('customInstruction') || 'Respond as a friendly, knowledgeable coding and learning assistant, offering clear, natural, and engaging advice.' }, { role: 'user', content: prompt }],
                max_tokens: maxTokens,
                temperature: 0.7,
                top_p: 0.9
            })
        });
        if (!response.ok) throw new Error('ChatGPT had a hiccup');
        const data = await response.json();
        return data.choices[0].message.content.trim();
    } catch {
        return "Oops! Something went wrong with ChatGPT. Let’s try another model or check your API key.";
    }
}

async function callDeepSeek(prompt, maxTokens = 4000, apiKey = localStorage.getItem('deepSeekApiKey')) {
    if (!apiKey) return "I need a DeepSeek API key to assist you—please add one in your profile!";
    try {
        const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: 'deepseek-coder',
                messages: [{ role: 'system', content: localStorage.getItem('customInstruction') || 'Respond as a friendly, knowledgeable coding and learning assistant, offering clear, natural, and engaging advice.' }, { role: 'user', content: prompt }],
                max_tokens: maxTokens,
                temperature: 0.7,
                top_p: 0.9
            })
        });
        if (!response.ok) throw new Error('DeepSeek ran into an issue');
        const data = await response.json();
        return data.choices[0].message.content.trim();
    } catch {
        return "Hmm, DeepSeek isn’t cooperating. Let’s switch models or verify your API key.";
    }
}

async function callAI(prompt, maxTokens = 4000) {
    const activeModel = localStorage.getItem('activeModel') || document.querySelector('.model-option.active')?.dataset.model || 'chatgpt';
    const promises = { chatgpt: callChatGpt(prompt, maxTokens), deepseek: callDeepSeek(prompt, maxTokens) };
    const result = await promises[activeModel];
    return result.includes('error') ? await promises[activeModel === 'chatgpt' ? 'deepseek' : 'chatgpt'] : result;
}

const elements = {
    inputField: document.getElementById('inputField'),
    sendBtn: document.getElementById('sendBtn'),
    chatContainer: document.getElementById('chatContainer'),
    codingSection: document.getElementById('codingSection'),
    generalSection: document.getElementById('generalSection'),
    homeworkSection: document.getElementById('homeworkSection'),
    analysisSection: document.getElementById('analysisSection'),
    codeInput: document.getElementById('codeInput'),
    codeOutput: document.getElementById('codeOutput'),
    codeProgressBar: document.getElementById('codeProgressBar'),
    codeProgressFill: document.getElementById('codeProgressFill'),
    generalInput: document.getElementById('generalInput'),
    generalOutput: document.getElementById('generalOutput'),
    generalProgressBar: document.getElementById('generalProgressBar'),
    generalProgressFill: document.getElementById('generalProgressFill'),
    homeworkInput: document.getElementById('homeworkInput'),
    homeworkOutput: document.getElementById('homeworkOutput'),
    homeworkProgressBar: document.getElementById('homeworkProgressBar'),
    homeworkProgressFill: document.getElementById('homeworkProgressFill'),
    analysisInput: document.getElementById('analysisInput'),
    analysisOutput: document.getElementById('analysisOutput'),
    analysisProgressBar: document.getElementById('analysisProgressBar'),
    analysisProgressFill: document.getElementById('analysisProgressFill'),
    processBtn: document.getElementById('processBtn'),
    debugBtn: document.getElementById('debugBtn'),
    explainBtn: document.getElementById('explainBtn'),
    obfuscateBtn: document.getElementById('obfuscateBtn'),
    deobfuscateBtn: document.getElementById('deobfuscateBtn'),
    improveBtn: document.getElementById('improveBtn'),
    generalBtn: document.getElementById('generalBtn'),
    homeworkBtn: document.getElementById('homeworkBtn'),
    analyzeBtn: document.getElementById('analyzeBtn'),
    continueBtn: document.getElementById('continueBtn'),
    copyCodeBtn: document.getElementById('copyCodeBtn'),
    retryCodeBtn: document.getElementById('retryCodeBtn'),
    copyGeneralBtn: document.getElementById('copyGeneralBtn'),
    retryGeneralBtn: document.getElementById('retryGeneralBtn'),
    copyHomeworkBtn: document.getElementById('copyHomeworkBtn'),
    retryHomeworkBtn: document.getElementById('retryHomeworkBtn'),
    copyAnalysisBtn: document.getElementById('copyAnalysisBtn'),
    aiToHumanBtn: document.getElementById('aiToHumanBtn'),
    retryAnalysisBtn: document.getElementById('retryAnalysisBtn'),
    themeToggleBtn: document.getElementById('themeToggleBtn'),
    profileBtn: document.getElementById('profileBtn'),
    profileModal: document.getElementById('profileModal'),
    closeProfileBtn: document.getElementById('closeProfileBtn'),
    chatGptApiKey: document.getElementById('chatGptApiKey'),
    deepSeekApiKey: document.getElementById('deepSeekApiKey'),
    modelSelect: document.getElementById('modelSelect'),
    customInstruction: document.getElementById('customInstruction'),
    saveApiKeyBtn: document.getElementById('saveApiKeyBtn'),
    languageSelector: document.getElementById('languageSelector'),
    modelSelector: document.getElementById('modelSelector'),
    statusBadge: document.getElementById('statusBadge'),
    statusText: document.getElementById('statusText')
};

if (localStorage.getItem('theme') === 'light') {
    document.body.classList.add('light-mode');
    elements.themeToggleBtn.querySelector('i').classList.replace('fa-moon', 'fa-sun');
    elements.themeToggleBtn.querySelector('span').textContent = 'Dark Mode';
}

elements.themeToggleBtn.addEventListener('click', () => {
    document.body.classList.toggle('light-mode');
    const isLightMode = document.body.classList.contains('light-mode');
    elements.themeToggleBtn.querySelector('i').classList.toggle('fa-moon', !isLightMode);
    elements.themeToggleBtn.querySelector('i').classList.toggle('fa-sun', isLightMode);
    elements.themeToggleBtn.querySelector('span').textContent = isLightMode ? 'Dark Mode' : 'Light Mode';
    localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
});

elements.signOutBtn.addEventListener('click', () => {
    localStorage.clear();
    window.location.href = 'index.html';
});

elements.profileBtn.addEventListener('click', () => {
    elements.chatGptApiKey.value = localStorage.getItem('chatGptApiKey') || '';
    elements.deepSeekApiKey.value = localStorage.getItem('deepSeekApiKey') || '';
    elements.modelSelect.value = localStorage.getItem('activeModel') || 'chatgpt';
    elements.customInstruction.value = localStorage.getItem('customInstruction') || '';
    elements.profileModal.classList.add('active');
});

elements.closeProfileBtn.addEventListener('click', () => {
    elements.profileModal.classList.remove('active');
});

elements.saveApiKeyBtn.addEventListener('click', async () => {
    const chatGptKey = elements.chatGptApiKey.value.trim();
    const deepSeekKey = elements.deepSeekApiKey.value.trim();
    const customInstruction = elements.customInstruction.value.trim();
    const activeModel = elements.modelSelect.value;

    localStorage.setItem('chatGptApiKey', chatGptKey);
    localStorage.setItem('deepSeekApiKey', deepSeekKey);
    localStorage.setItem('customInstruction', customInstruction);
    localStorage.setItem('activeModel', activeModel);

    const chatGptValid = await validateChatGptApiKey(chatGptKey);
    const deepSeekValid = await validateDeepSeekApiKey(deepSeekKey);

    if (chatGptKey && !chatGptValid) alert('Invalid ChatGPT API key. Please try again.');
    if (deepSeekKey && !deepSeekValid) alert('Invalid DeepSeek API key. Please try again.');

    updateModelSelector(chatGptValid, deepSeekValid);
    updateApiStatus();
    elements.profileModal.classList.remove('active');
});

function updateApiStatus() {
    const hasChatGptKey = !!localStorage.getItem('chatGptApiKey');
    const hasDeepSeekKey = !!localStorage.getItem('deepSeekApiKey');
    const isApiActive = hasChatGptKey || hasDeepSeekKey;
    elements.statusText.textContent = isApiActive ? 'API Active' : 'No API Keys';
    elements.statusBadge.classList.toggle('inactive', !isApiActive);
}

function updateModelSelector(chatGptValid, deepSeekValid) {
    elements.modelSelector.innerHTML = '';
    const models = ['chatgpt', 'deepseek'];
    models.forEach(model => {
        const hasApiKey = !!localStorage.getItem(`${model}ApiKey`);
        const isValid = (model === 'chatgpt' && chatGptValid) || (model === 'deepseek' && deepSeekValid);
        if (hasApiKey && isValid) {
            const div = document.createElement('div');
            div.className = `model-option ${localStorage.getItem('activeModel') === model ? 'active' : ''}`;
            div.dataset.model = model;
            div.textContent = model.charAt(0).toUpperCase() + model.slice(1);
            div.addEventListener('click', () => {
                localStorage.setItem('activeModel', model);
                elements.modelSelector.querySelectorAll('.model-option').forEach(o => o.classList.remove('active'));
                div.classList.add('active');
            });
            elements.modelSelector.appendChild(div);
        }
    });
    if (!elements.modelSelector.querySelector('.model-option')) {
        elements.modelSelector.innerHTML = '<span style="color: #ef4444;">Please add a valid API key in Profile Settings.</span>';
    }
}

const sectionTabs = document.querySelectorAll('.tab');
sectionTabs.forEach(tab => {
    tab.addEventListener('click', () => {
        sectionTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const section = tab.dataset.section;
        elements.codingSection.classList.toggle('active', section === 'coding');
        elements.generalSection.classList.toggle('active', section === 'general');
        elements.homeworkSection.classList.toggle('active', section === 'homework');
        elements.analysisSection.classList.toggle('active', section === 'analysis');
        elements.chatContainer.style.display = 'none';
        document.querySelectorAll('.btn-primary').forEach(btn => {
            btn.style.display = (btn.id === 'generalBtn' && section === 'general') ||
                               (btn.id === 'homeworkBtn' && section === 'homework') ||
                               (btn.id === 'analyzeBtn' && section === 'analysis') ||
                               (section === 'coding' && btn.id !== 'generalBtn' && btn.id !== 'homeworkBtn' && btn.id !== 'analyzeBtn')
                               ? 'inline-flex' : 'none';
        });
        elements.languageSelector.style.display = section === 'coding' || section === 'analysis' ? 'flex' : 'none';
        if (section === 'coding') elements.continueBtn.style.display = 'none';
    });
});

const languageTabs = document.querySelectorAll('.language-option');
languageTabs.forEach(tab => {
    tab.addEventListener('click', () => {
        languageTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
    });
});

elements.sendBtn.addEventListener('click', () => handleInput());
elements.inputField.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) handleInput(); });

function handleInput() {
    const input = elements.inputField.value.trim();
    if (!input) return;
    addMessage(input, 'user');
    elements.inputField.value = '';
    processInput(input);
}

function addMessage(text, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.textContent = text;
    elements.chatContainer.appendChild(messageDiv);
    elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
}

async function processInput(input) {
    const section = document.querySelector('.tab.active').dataset.section;
    let outputElement, progressBar, progressFill, retryBtn, continueBtn, aiToHumanBtn;

    if (section === 'coding') {
        outputElement = elements.codeOutput;
        progressBar = elements.codeProgressBar;
        progressFill = elements.codeProgressFill;
        retryBtn = elements.retryCodeBtn;
        continueBtn = elements.continueBtn;
    } else if (section === 'general') {
        outputElement = elements.generalOutput;
        progressBar = elements.generalProgressBar;
        progressFill = elements.generalProgressFill;
        retryBtn = elements.retryGeneralBtn;
    } else if (section === 'homework') {
        outputElement = elements.homeworkOutput;
        progressBar = elements.homeworkProgressBar;
        progressFill = elements.homeworkProgressFill;
        retryBtn = elements.retryHomeworkBtn;
    } else if (section === 'analysis') {
        outputElement = elements.analysisOutput;
        progressBar = elements.analysisProgressBar;
        progressFill = elements.analysisProgressFill;
        retryBtn = elements.retryAnalysisBtn;
        aiToHumanBtn = elements.aiToHumanBtn;
    }

    progressBar.classList.add('active');
    progressFill.style.width = '0';
    let width = 0;
    const interval = setInterval(() => {
        width += Math.random() * 10;
        progressFill.style.width = `${Math.min(width, 100)}%`;
    }, 30);

    let result;
    if (section === 'coding') {
        const action = ['optimize', 'debug', 'explain', 'obfuscate', 'deobfuscate', 'improve'].find(a => input.toLowerCase().includes(a)) || 'optimize';
        const lang = elements.languageSelector.querySelector('.language-option.active')?.dataset.lang || 'javascript';
        result = await processCodeWithAI(input, lang, action);
        if (action !== 'continue') continueBtn.style.display = 'inline-flex';
        else continueBtn.style.display = 'none';
    } else if (section === 'general') {
        result = await processGeneralQuery(input);
    } else if (section === 'homework') {
        result = await solveHomework(input);
    } else if (section === 'analysis') {
        const lang = elements.languageSelector.querySelector('.language-option.active')?.dataset.lang || 'javascript';
        result = await processCodeWithAI(input, lang, 'analyze');
        aiToHumanBtn.style.display = 'inline-flex';
    }

    clearInterval(interval);
    progressFill.style.width = '100%';
    setTimeout(() => {
        progressBar.classList.remove('active');
        outputElement.innerHTML = `<pre><code class="language-${section === 'coding' || section === 'analysis' ? (elements.languageSelector.querySelector('.language-option.active')?.dataset.lang || 'javascript') : 'text'}">${result}</code></pre>`;
        Prism.highlightAll();
        retryBtn.style.display = result.includes('error') ? 'inline-flex' : 'none';
        if (section === 'coding') addMessage(result, 'ai');
    }, 10);
}

async function processCodeWithAI(code, lang, action) {
    const inputCode = code.match(/^https?:\/\//) ? await fetchCodeFromUrl(code) : code;
    let prompt = `Hey, I’ve got some ${lang} code here. Can you ${action} it for me? Make it natural, clear, and engaging—like you’re explaining it to a friend. Add some helpful notes if needed. Here’s the code:\n\`\`\`${lang}\n${inputCode}\n\`\`\``;
    return await callAI(prompt, 4000);
}

async function solveHomework(problem) {
    let prompt = `I need help with this: ${problem}. Could you walk me through it step by step, like you’re teaching a friend? Include examples or code with clear explanations if it fits.`;
    return await callAI(prompt, 4000);
}

async function processGeneralQuery(query) {
    let prompt = `Hey, I’ve got a question: ${query}. Can you give me a friendly, detailed answer like you’re chatting with me?`;
    return await callAI(prompt, 4000);
}

function humanizeText(text) {
    return text.replace(/\. /g, '.\n').replace(/[A-Z]/g, match => match.toLowerCase()).replace(/([a-z])([a-z]+)(?=[A-Z])/g, '$1 $2');
}

elements.aiToHumanBtn.addEventListener('click', () => {
    const text = elements.analysisOutput.textContent;
    elements.analysisOutput.innerHTML = `<pre><code class="language-text">${humanizeText(text)}</code></pre>`;
    Prism.highlightAll();
});

elements.copyCodeBtn.addEventListener('click', () => navigator.clipboard.writeText(elements.codeOutput.textContent).then(() => alert('Code copied!')));
elements.copyGeneralBtn.addEventListener('click', () => navigator.clipboard.writeText(elements.generalOutput.textContent).then(() => alert('Response copied!')));
elements.copyHomeworkBtn.addEventListener('click', () => navigator.clipboard.writeText(elements.homeworkOutput.textContent).then(() => alert('Solution copied!')));
elements.copyAnalysisBtn.addEventListener('click', () => navigator.clipboard.writeText(elements.analysisOutput.textContent).then(() => alert('Analysis copied!')));

elements.retryCodeBtn.addEventListener('click', () => processInput(elements.codeInput.value));
elements.retryGeneralBtn.addEventListener('click', () => processInput(elements.generalInput.value));
elements.retryHomeworkBtn.addEventListener('click', () => processInput(elements.homeworkInput.value));
elements.retryAnalysisBtn.addEventListener('click', () => processInput(elements.analysisInput.value));

elements.processBtn.addEventListener('click', () => processInput('optimize ' + elements.codeInput.value));
elements.debugBtn.addEventListener('click', () => processInput('debug ' + elements.codeInput.value));
elements.explainBtn.addEventListener('click', () => processInput('explain ' + elements.codeInput.value));
elements.obfuscateBtn.addEventListener('click', () => processInput('obfuscate ' + elements.codeInput.value));
elements.deobfuscateBtn.addEventListener('click', () => processInput('deobfuscate ' + elements.codeInput.value));
elements.improveBtn.addEventListener('click', () => processInput('improve ' + elements.codeInput.value));
elements.generalBtn.addEventListener('click', () => processInput(elements.generalInput.value));
elements.homeworkBtn.addEventListener('click', () => processInput(elements.homeworkInput.value));
elements.analyzeBtn.addEventListener('click', () => processInput('analyze ' + elements.analysisInput.value));
elements.continueBtn.addEventListener('click', () => processInput('continue ' + elements.codeInput.value));

async function fetchCodeFromUrl(url) {
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Couldn’t fetch that URL');
        return await response.text();
    } catch {
        return 'Sorry, I couldn’t grab the code from that URL.';
    }
}

updateModelSelector(false, false);
updateApiStatus();
</script>
</body>
</html>
