<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data:; connect-src 'self' https://api.openai.com https://api.deepseek.com https://api.anthropic.com; object-src 'none'; base-uri 'none'; frame-ancestors 'none'; form-action 'none';">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains">
    <title>Prysmis AI - Coding & Learning Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.24.1/themes/prism-okaidia.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.12/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.24.1/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/rojo@7.3.0/dist/rojo.min.js"></script>
    <style>
        body {
            background: #0f172a;
            font-family: 'Inter', sans-serif;
            color: #d1d5db;
            margin: 0;
            min-height: 100vh;
            display: flex;
            overflow: hidden;
            transition: background 0.3s ease;
        }
        .light-mode {
            background: #f9fafb;
            color: #1f2937;
        }
        .sidebar {
            width: 320px;
            background: #1e293b;
            padding: 1.5rem;
            overflow-y: auto;
            border-right: 1px solid #374151;
            height: 100vh;
            position: fixed;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease;
            z-index: 50;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
        }
        .sidebar.open {
            transform: translateX(0);
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.3);
        }
        .light-mode .sidebar {
            background: #ffffff;
            border-color: #e5e7eb;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #374151;
        }
        .light-mode .sidebar-header {
            border-color: #e5e7eb;
        }
        .sidebar-toggle {
            background: #374151;
            color: #d1d5db;
            padding: 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            border: none;
            transition: background 0.2s ease, color 0.2s ease;
        }
        .light-mode .sidebar-toggle {
            background: #e5e7eb;
            color: #1f2937;
        }
        .sidebar-toggle:hover {
            background: #3b82f6;
            color: #ffffff;
        }
        .chat-history {
            display: grid;
            gap: 0.75rem;
        }
        .chat-item {
            padding: 0.875rem;
            background: #374151;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background 0.2s ease, transform 0.1s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-item:hover, .chat-item.active {
            background: #3b82f6;
            color: #ffffff;
            transform: translateX(5px);
        }
        .light-mode .chat-item {
            background: #e5e7eb;
            color: #1f2937;
        }
        .chat-item .timestamp {
            font-size: 0.75rem;
            color: #9ca3af;
        }
        .light-mode .chat-item .timestamp {
            color: #6b7280;
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            transition: margin 0.3s ease-in-out;
            margin-left: 0;
        }
        .main-content.shifted {
            margin-left: 320px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2.5rem;
            background: rgba(17, 24, 39, 0.95);
            border-bottom: 1px solid #374151;
            position: sticky;
            top: 0;
            z-index: 40;
        }
        .light-mode .header {
            background: #ffffff;
            border-color: #e5e7eb;
        }
        .logo {
            font-size: 1.75rem;
            font-weight: 700;
            color: #3b82f6;
            transition: color 0.2s ease;
        }
        .logo:hover {
            color: #60a5fa;
        }
        .subtitle {
            font-size: 0.9rem;
            color: #6b7280;
        }
        .light-mode .subtitle {
            color: #4b5563;
        }
        .buttons {
            display: flex;
            gap: 0.75rem;
        }
        .theme-toggle-btn, .settings-btn, .ai-improvements-btn {
            background: #374151;
            color: #d1d5db;
            font-size: 1.1rem;
            padding: 0.625rem 1.25rem;
            border-radius: 0.375rem;
            cursor: pointer;
            border: none;
            transition: background 0.2s ease, color 0.2s ease;
        }
        .theme-toggle-btn:hover, .settings-btn:hover, .ai-improvements-btn:hover {
            background: #3b82f6;
            color: #ffffff;
        }
        .light-mode .theme-toggle-btn, .light-mode .settings-btn, .light-mode .ai-improvements-btn {
            background: #e5e7eb;
            color: #1f2937;
        }
        .mode-selector {
            display: flex;
            gap: 0.75rem;
            padding: 1.25rem;
            justify-content: center;
            background: #1f2937;
            border-radius: 0.625rem;
            margin: 1.25rem auto;
            max-width: 90%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .light-mode .mode-selector {
            background: #e5e7eb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .mode-btn {
            padding: 0.625rem 1.25rem;
            background: #374151;
            color: #d1d5db;
            border-radius: 1.5rem;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: background 0.2s ease, transform 0.1s ease;
        }
        .light-mode .mode-btn {
            background: #d1d5db;
            color: #1f2937;
        }
        .mode-btn.active, .mode-btn:hover {
            background: #3b82f6;
            color: #ffffff;
            transform: scale(1.05);
        }
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column-reverse;
            gap: 1.25rem;
            scrollbar-width: thin;
            scrollbar-color: #4b5563 #1f2937;
        }
        .light-mode .chat-container {
            scrollbar-color: #9ca3af #f3f4f6;
        }
        .message {
            max-width: 85%;
            padding: 1rem;
            border-radius: 0.75rem;
            line-height: 1.6;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .message:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        .message.user {
            background: #3b82f6;
            color: #ffffff;
            align-self: flex-end;
        }
        .message.ai {
            background: #1f2937;
            color: #d1d5db;
            align-self: flex-start;
        }
        .light-mode .message.ai {
            background: #f3f4f6;
            color: #1f2937;
        }
        .action-buttons {
            display: flex;
            gap: 0.625rem;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }
        .action-btn {
            padding: 0.375rem 0.875rem;
            background: #4b5563;
            color: #d1d5db;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 0.8rem;
            border: none;
            transition: background 0.2s ease, transform 0.1s ease;
        }
        .light-mode .action-btn {
            background: #9ca3af;
            color: #1f2937;
        }
        .action-btn:hover {
            background: #60a5fa;
            color: #ffffff;
            transform: translateY(-2px);
        }
        .clear-btn {
            background: #ef4444;
            color: #ffffff;
            padding: 0.375rem 0.875rem;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 0.75rem;
            transition: background 0.2s ease, transform 0.1s ease;
        }
        .light-mode .clear-btn {
            background: #f87171;
            color: #1f2937;
        }
        .clear-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }
        .clear-chat-btn, .add-files-btn {
            background: #374151;
            color: #d1d5db;
            padding: 0.625rem 1.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            border: none;
            transition: background 0.2s ease, transform 0.1s ease;
            margin: 0.75rem;
        }
        .clear-chat-btn:hover, .add-files-btn:hover {
            background: #3b82f6;
            transform: translateY(-2px);
        }
        .light-mode .clear-chat-btn, .light-mode .add-files-btn {
            background: #e5e7eb;
            color: #1f2937;
        }
        .input-area {
            padding: 1.5rem;
            background: rgba(17, 24, 39, 0.95);
            display: flex;
            gap: 0.75rem;
            border-top: 1px solid #374151;
            position: sticky;
            bottom: 0;
            width: 100%;
            z-index: 40;
        }
        .light-mode .input-area {
            background: #ffffff;
            border-color: #e5e7eb;
        }
        #inputField {
            flex: 1;
            padding: 0.875rem 1.25rem;
            border: none;
            border-radius: 1.5rem;
            background: #374151;
            color: #d1d5db;
            font-size: 1rem;
            resize: none;
            min-height: 40px;
            max-height: 200px;
            overflow-y: auto;
            transition: background 0.2s ease, box-shadow 0.2s ease;
        }
        #inputField:focus {
            background: #4b5563;
            outline: none;
            box-shadow: 0 0 0 2px #3b82f6;
        }
        .light-mode #inputField {
            background: #ffffff;
            color: #1f2937;
        }
        .light-mode #inputField:focus {
            box-shadow: 0 0 0 2px #60a5fa;
        }
        .send-btn {
            padding: 0.875rem 1.75rem;
            background: #3b82f6;
            color: #ffffff;
            border: none;
            border-radius: 1.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background 0.2s ease, transform 0.1s ease;
        }
        .send-btn:hover {
            background: #60a5fa;
            transform: translateY(-2px);
        }
        .profile-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1f293b;
            padding: 2.5rem;
            border-radius: 0.75rem;
            z-index: 60;
            color: #d1d5db;
            width: 90%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.3s ease-out;
        }
        .light-mode .profile-modal {
            background: #ffffff;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .close-btn {
            position: absolute;
            top: 1.25rem;
            right: 1.25rem;
            background: #374151;
            color: #d1d5db;
            font-size: 1.25rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            border: none;
            transition: background 0.2s ease;
        }
        .close-btn:hover {
            background: #ef4444;
        }
        .light-mode .close-btn {
            background: #e5e7eb;
            color: #1f2937;
        }
        .light-mode .close-btn:hover {
            background: #f87171;
        }
        label {
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: block;
            color: #3b82f6;
            transition: color 0.2s ease;
        }
        label:hover {
            color: #60a5fa;
        }
        input, textarea, select {
            width: 100%;
            padding: 0.875rem;
            margin-bottom: 0.75rem;
            border: none;
            border-radius: 0.5rem;
            background: #374151;
            color: #d1d5db;
            font-size: 1rem;
            transition: background 0.2s ease, box-shadow 0.2s ease;
        }
        input:focus, textarea:focus, select:focus {
            background: #4b5563;
            outline: none;
            box-shadow: 0 0 0 2px #3b82f6;
        }
        .light-mode input, .light-mode textarea, .light-mode select {
            background: #ffffff;
            color: #1f2937;
            border: 1px solid #e5e7eb;
        }
        .light-mode input:focus, .light-mode textarea:focus, .light-mode select:focus {
            box-shadow: 0 0 0 2px #60a5fa;
        }
        button.save-btn, button.sign-out-btn, button.export-btn, button.import-btn {
            background: #3b82f6;
            color: #ffffff;
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 1.5rem;
            cursor: pointer;
            width: 100%;
            margin-top: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.2s ease, transform 0.1s ease;
        }
        button.save-btn:hover, button.export-btn:hover, button.import-btn:hover {
            background: #60a5fa;
            transform: translateY(-2px);
        }
        button.sign-out-btn {
            background: #ef4444;
        }
        button.sign-out-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }
        .typing-indicator {
            background: #1f2937;
            color: #3b82f6;
            padding: 0.875rem 1.25rem;
            border-radius: 0.75rem;
            align-self: flex-start;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.625rem;
            animation: pulse 1.5s infinite ease;
            display: none;
        }
        .light-mode .typing-indicator {
            background: #f3f4f6;
            color: #3b82f6;
        }
        .dot {
            width: 10px;
            height: 10px;
            background: #3b82f6;
            border-radius: 50%;
            animation: bounce 0.6s infinite alternate ease;
        }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0% { transform: translateY(0); }
            100% { transform: translateY(-6px); }
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .code-block {
            background: #2a2a3d;
            border-radius: 0.75rem;
            padding: 1.25rem;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            overflow-x: auto;
            border: 1px solid #5b4e77;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            position: relative;
            margin: 0.75rem 0;
        }
        .light-mode .code-block {
            background: #f5f5ff;
            border: 1px solid #d1d1e0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .code-block:hover .code-actions {
            opacity: 1;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
        }
        code {
            background: none !important;
            padding: 0 !important;
            font-size: 0.95rem;
        }
        .code-actions {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            display: flex;
            gap: 0.625rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .code-action-btn {
            background: #4b5563;
            color: #d1d5db;
            border: none;
            padding: 0.375rem 0.875rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s ease, transform 0.1s ease;
        }
        .code-action-btn:hover {
            background: #60a5fa;
            transform: translateY(-2px);
        }
        .light-mode .code-action-btn {
            background: #9ca3af;
            color: #1f2937;
        }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.375rem;
            display: none;
        }
        .visualization {
            background: #2a2a3d;
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-top: 1.25rem;
            max-height: 350px;
            overflow: auto;
        }
        .light-mode .visualization {
            background: #f5f5ff;
        }
        .quality-score {
            display: inline-block;
            padding: 0.375rem 0.625rem;
            background: #10b981;
            color: #ffffff;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            margin-left: 0.75rem;
            transition: background 0.2s ease;
        }
        .quality-score:hover {
            background: #059669;
        }
        .complexity-insights {
            font-size: 0.8rem;
            color: #60a5fa;
            margin-top: 0.75rem;
            transition: color 0.2s ease;
        }
        .complexity-insights:hover {
            color: #3b82f6;
        }
        .generator-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1f293b;
            padding: 2.5rem;
            border-radius: 0.75rem;
            z-index: 60;
            color: #d1d5db;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.3s ease-out;
            display: none;
        }
        .light-mode .generator-modal {
            background: #ffffff;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .generator-close-btn {
            position: absolute;
            top: 1.25rem;
            right: 1.25rem;
            background: #374151;
            color: #d1d5db;
            font-size: 1.25rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            border: none;
            transition: background 0.2s ease;
        }
        .generator-close-btn:hover {
            background: #ef4444;
        }
        .light-mode .generator-close-btn {
            background: #e5e7eb;
            color: #1f2937;
        }
        .light-mode .generator-close-btn:hover {
            background: #f87171;
        }
        .download-btn {
            background: #10b981;
            color: #ffffff;
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 1.5rem;
            cursor: pointer;
            width: 100%;
            margin-top: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.2s ease, transform 0.1s ease;
        }
        .download-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 280px;
            }
            .main-content.shifted {
                margin-left: 280px;
            }
            .header { padding: 1rem 1.5rem; }
            .logo { font-size: 1.5rem; }
            .subtitle { font-size: 0.8rem; }
            .mode-selector { padding: 1rem; margin: 1rem auto; gap: 0.5rem; }
            .mode-btn { padding: 0.5rem 1rem; font-size: 0.85rem; }
            .chat-container { padding: 1rem; }
            .message { max-width: 90%; padding: 0.75rem; }
            .input-area { padding: 1rem; }
            #inputField { padding: 0.625rem 1rem; font-size: 0.9rem; }
            .send-btn { padding: 0.625rem 1.25rem; font-size: 0.9rem; }
            .profile-modal { width: 85%; padding: 1.5rem; }
            .generator-modal { width: 85%; padding: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2 class="text-lg font-bold">Chat History</h2>
            <button class="sidebar-toggle" id="sidebarToggleClose"><i class="fas fa-times"></i></button>
        </div>
        <div class="chat-history" id="chatHistory"></div>
        <button class="mt-4 w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-all" id="newChatBtn">New Chat</button>
    </div>
    <div class="main-content" id="mainContent">
        <header class="header">
            <div>
                <div class="logo">Prysmis AI</div>
                <p class="subtitle">Coding & Learning Assistant</p>
            </div>
            <div class="buttons">
                <button class="theme-toggle-btn" id="themeToggleBtn"><i class="fas fa-moon"></i></button>
                <button class="settings-btn" id="settingsBtn"><i class="fas fa-cog"></i></button>
                <button class="ai-improvements-btn" id="aiImprovementsBtn"><i class="fas fa-brain"></i></button>
                <button class="sidebar-toggle" id="sidebarToggleOpen"><i class="fas fa-bars"></i></button>
            </div>
        </header>
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="general">General</button>
            <button class="mode-btn" data-mode="coding">Coding</button>
            <button class="mode-btn" data-mode="homework">Homework</button>
            <button class="mode-btn" data-mode="analysis">Analysis</button>
            <button class="mode-btn" data-mode="robloxGameGenerator">Roblox Game Generator</button>
        </div>
        <div style="display: flex; justify-content: center;">
            <button class="clear-chat-btn" id="clearChatBtn">Clear Chat</button>
            <button class="add-files-btn" id="addFilesBtn">Add Files</button>
        </div>
        <div class="chat-container" id="chatContainer">
            <div class="typing-indicator" id="typingIndicator">
                <span>Prysmis AI is thinking</span>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>
        <div class="input-area">
            <textarea id="inputField" placeholder="Ask me anything..."></textarea>
            <button class="send-btn" id="sendBtn">Send</button>
        </div>
    </div>
    <div class="ai-sidebar" id="aiSidebar">
        <div class="sidebar-header">
            <h2 class="text-lg font-bold">AI Improvements</h2>
            <button class="sidebar-toggle" id="aiSidebarToggleClose"><i class="fas fa-times"></i></button>
        </div>
        <div class="chat-history" id="aiSuggestions">
            <h3 class="text-sm font-bold mb-1">Quick Actions</h3>
        </div>
        <div class="chat-history" id="codeSnippets" style="margin-top: 1.5rem;">
            <h3 class="text-sm font-bold mb-1">Code Snippets</h3>
        </div>
        <div class="chat-history" id="learningPaths" style="margin-top: 1.5rem;">
            <h3 class="text-sm font-bold mb-1">Learning Paths</h3>
        </div>
        <div class="chat-history" id="complexityInsights" style="margin-top: 1.5rem;">
            <h3 class="text-sm font-bold mb-1">Complexity Insights</h3>
        </div>
    </div>
    <div class="profile-modal" id="profileModal" style="display: none;">
        <button class="close-btn" id="closeProfileBtn">×</button>
        <h2 class="text-xl font-bold mb-4">Settings</h2>
        <div class="api-key-input">
            <label for="chatGptApiKey">OpenAI API Key</label>
            <input type="text" id="chatGptApiKey" placeholder="Enter OpenAI API Key">
            <p class="error-message" id="chatGptApiKeyError">Invalid API key</p>
            <label for="deepSeekApiKey">DeepSeek API Key</label>
            <input type="text" id="deepSeekApiKey" placeholder="Enter DeepSeek API Key">
            <p class="error-message" id="deepSeekApiKeyError">Invalid API key</p>
            <label for="anthropicApiKey">Anthropic API Key</label>
            <input type="text" id="anthropicApiKey" placeholder="Enter Anthropic API Key">
            <p class="error-message" id="anthropicApiKeyError">Invalid API key</p>
        </div>
        <div class="model-selection">
            <label for="modelSelect">Preferred Model</label>
            <select id="modelSelect">
                <option value="chatgpt">OpenAI (ChatGPT)</option>
                <option value="deepseek">DeepSeek</option>
                <option value="anthropic">Anthropic</option>
            </select>
        </div>
        <div class="mode-instructions">
            <label for="generalInstruction">General Mode Instructions</label>
            <textarea id="generalInstruction" placeholder="Custom instructions for General mode" rows="3"></textarea>
            <label for="codingInstruction">Coding Mode Instructions</label>
            <textarea id="codingInstruction" placeholder="Custom instructions for Coding mode" rows="3"></textarea>
            <label for="homeworkInstruction">Homework Mode Instructions</label>
            <textarea id="homeworkInstruction" placeholder="Custom instructions for Homework mode" rows="3"></textarea>
            <label for="analysisInstruction">Analysis Mode Instructions</label>
            <textarea id="analysisInstruction" placeholder="Custom instructions for Analysis mode" rows="3"></textarea>
            <label for="robloxGameGeneratorInstruction">Roblox Game Generator Instructions</label>
            <textarea id="robloxGameGeneratorInstruction" placeholder="Custom instructions for Roblox Game Generator mode" rows="3"></textarea>
        </div>
        <div class="privacy-controls">
            <label for="dataRetention">Data Retention</label>
            <select id="dataRetention">
                <option value="session">Session Only</option>
                <option value="30days">30 Days</option>
                <option value="permanent">Permanent</option>
            </select>
        </div>
        <button class="save-btn" id="saveApiKeyBtn">Save</button>
        <button class="export-btn" id="exportBtn">Export Conversations</button>
        <button class="import-btn" id="importBtn">Import Conversations</button>
        <button class="sign-out-btn" id="signOutBtn">Sign Out</button>
    </div>
    <div class="generator-modal" id="generatorModal">
        <button class="generator-close-btn" id="generatorCloseBtn">×</button>
        <h2 class="text-xl font-bold mb-4">Roblox Game Generator</h2>
        <textarea id="gameIdeaInput" placeholder="Enter your game idea (e.g., 'Survival game with zombies and crafting')" rows="5" style="width: 100%; padding: 0.875rem; border-radius: 0.5rem; background: #374151; color: #d1d5db; border: none; margin-bottom: 1rem;"></textarea>
        <button class="download-btn" id="generateGameBtn">Generate and Download .rbxl</button>
    </div>
    <input type="file" id="fileInput" style="display: none;" accept="image/*,text/*,.pdf,.docx">
    <input type="file" id="importInput" style="display: none;" accept=".json">
    <script>
        const elements = {
            chatContainer: document.getElementById('chatContainer'),
            inputField: document.getElementById('inputField'),
            sendBtn: document.getElementById('sendBtn'),
            settingsBtn: document.getElementById('settingsBtn'),
            profileModal: document.getElementById('profileModal'),
            closeProfileBtn: document.getElementById('closeProfileBtn'),
            saveApiKeyBtn: document.getElementById('saveApiKeyBtn'),
            chatGptApiKey: document.getElementById('chatGptApiKey'),
            deepSeekApiKey: document.getElementById('deepSeekApiKey'),
            anthropicApiKey: document.getElementById('anthropicApiKey'),
            modelSelect: document.getElementById('modelSelect'),
            generalInstruction: document.getElementById('generalInstruction'),
            codingInstruction: document.getElementById('codingInstruction'),
            homeworkInstruction: document.getElementById('homeworkInstruction'),
            analysisInstruction: document.getElementById('analysisInstruction'),
            robloxGameGeneratorInstruction: document.getElementById('robloxGameGeneratorInstruction'),
            dataRetention: document.getElementById('dataRetention'),
            themeToggleBtn: document.getElementById('themeToggleBtn'),
            signOutBtn: document.getElementById('signOutBtn'),
            exportBtn: document.getElementById('exportBtn'),
            importBtn: document.getElementById('importBtn'),
            typingIndicator: document.getElementById('typingIndicator'),
            sidebar: document.querySelector('.sidebar'),
            aiSidebar: document.getElementById('aiSidebar'),
            sidebarToggleOpen: document.getElementById('sidebarToggleOpen'),
            sidebarToggleClose: document.getElementById('sidebarToggleClose'),
            aiImprovementsBtn: document.getElementById('aiImprovementsBtn'),
            aiSidebarToggleClose: document.getElementById('aiSidebarToggleClose'),
            chatHistory: document.getElementById('chatHistory'),
            aiSuggestions: document.getElementById('aiSuggestions'),
            codeSnippets: document.getElementById('codeSnippets'),
            learningPaths: document.getElementById('learningPaths'),
            complexityInsights: document.getElementById('complexityInsights'),
            clearChatBtn: document.getElementById('clearChatBtn'),
            addFilesBtn: document.getElementById('addFilesBtn'),
            fileInput: document.getElementById('fileInput'),
            importInput: document.getElementById('importInput'),
            chatGptApiKeyError: document.getElementById('chatGptApiKeyError'),
            deepSeekApiKeyError: document.getElementById('deepSeekApiKeyError'),
            anthropicApiKeyError: document.getElementById('anthropicApiKeyError'),
            newChatBtn: document.getElementById('newChatBtn'),
            mainContent: document.getElementById('mainContent'),
            generatorModal: document.getElementById('generatorModal'),
            generatorCloseBtn: document.getElementById('generatorCloseBtn'),
            gameIdeaInput: document.getElementById('gameIdeaInput'),
            generateGameBtn: document.getElementById('generateGameBtn')
        };

        let currentMode = 'general';
        let chatHistory = [];
        let chatSessions = JSON.parse(localStorage.getItem('chatSessions') || '{}');
        let currentSessionId = null;
        let codeSnippets = JSON.parse(localStorage.getItem('codeSnippets') || '[]');
        let theme = localStorage.getItem('theme') || 'dark';
        let scrollPosition = 0;

        function saveScrollPosition() {
            scrollPosition = elements.chatContainer.scrollTop;
        }

        function restoreScrollPosition() {
            elements.chatContainer.scrollTop = scrollPosition;
        }

        function loadChatHistory() {
            elements.chatHistory.innerHTML = '';
            Object.keys(chatSessions).sort((a, b) => chatSessions[b].timestamp - chatSessions[a].timestamp).forEach(sessionId => {
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item ${sessionId === currentSessionId ? 'active' : ''}`;
                chatItem.innerHTML = `<span>${chatSessions[sessionId].title || 'New Chat'}</span><span class="timestamp">${new Date(chatSessions[sessionId].timestamp).toLocaleString()}</span>`;
                chatItem.addEventListener('click', () => loadSession(sessionId));
                elements.chatHistory.appendChild(chatItem);
            });
        }

        function saveSession() {
            if (currentSessionId && chatHistory.length) {
                chatSessions[currentSessionId] = {
                    title: chatHistory[0].content.slice(0, 30) || 'New Chat',
                    messages: [...chatHistory],
                    mode: currentMode,
                    timestamp: Date.now()
                };
                const retention = localStorage.getItem('dataRetention') || 'session';
                if (retention === '30days' && Date.now() - chatSessions[currentSessionId].timestamp > 30 * 24 * 60 * 60 * 1000) {
                    delete chatSessions[currentSessionId];
                }
                localStorage.setItem('chatSessions', JSON.stringify(chatSessions));
                loadChatHistory();
                updateAiSidebar();
            }
        }

        function loadSession(sessionId) {
            saveScrollPosition();
            currentSessionId = sessionId;
            chatHistory = [...chatSessions[sessionId].messages];
            currentMode = chatSessions[sessionId].mode || 'general';
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === currentMode));
            elements.chatContainer.innerHTML = '';
            elements.chatContainer.appendChild(elements.typingIndicator);
            chatHistory.forEach(msg => addMessage(msg.content, msg.role === 'user' ? 'user' : 'ai', false));
            loadChatHistory();
            updateAiSidebar();
            restoreScrollPosition();
            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
        }

        function newSession() {
            currentSessionId = Date.now().toString();
            chatHistory = [];
            chatSessions[currentSessionId] = { title: 'New Chat', messages: [], mode: currentMode, timestamp: Date.now() };
            elements.chatContainer.innerHTML = '';
            elements.chatContainer.appendChild(elements.typingIndicator);
            saveSession();
            scrollPosition = 0;
            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
        }

        function updateAiSidebar() {
            [elements.aiSuggestions, elements.codeSnippets, elements.learningPaths, elements.complexityInsights].forEach(el => el.innerHTML = '');
            const suggestions = getContextualSuggestions();
            suggestions.forEach(s => {
                const item = document.createElement('div');
                item.className = 'chat-item';
                item.textContent = s.text;
                item.addEventListener('click', () => {
                    elements.inputField.value = s.action;
                    sendMessage();
                });
                elements.aiSuggestions.appendChild(item);
            });
            codeSnippets.forEach((snippet, i) => {
                const item = document.createElement('div');
                item.className = 'chat-item';
                item.textContent = snippet.title;
                item.addEventListener('click', () => {
                    elements.inputField.value = snippet.code;
                    sendMessage();
                });
                elements.codeSnippets.appendChild(item);
            });
            getLearningPaths().forEach(path => {
                const item = document.createElement('div');
                item.className = 'chat-item';
                item.textContent = path;
                item.addEventListener('click', () => {
                    elements.inputField.value = `Guide me through ${path}`;
                    sendMessage();
                });
                elements.learningPaths.appendChild(item);
            });
            getComplexityInsights().forEach(insight => {
                const item = document.createElement('div');
                item.className = 'chat-item';
                item.textContent = insight;
                elements.complexityInsights.appendChild(item);
            });
        }

        function getContextualSuggestions() {
            const lastMessage = chatHistory[chatHistory.length - 1]?.content || '';
            return currentMode === 'coding' ? [
                { text: 'Optimize Code', action: `improve this: ${lastMessage}` },
                { text: 'Debug Code', action: `debug this: ${lastMessage}` },
                { text: 'Explain Code', action: `explain this: ${lastMessage}` },
                { text: 'Security Check', action: `analyze this: ${lastMessage}` }
            ] : currentMode === 'homework' ? [
                { text: 'Step-by-Step', action: `Solve ${lastMessage} step-by-step` },
                { text: 'Alternative Solution', action: `Provide another solution for ${lastMessage}` },
                { text: 'Simplify', action: `Simplify ${lastMessage}` }
            ] : currentMode === 'analysis' ? [
                { text: 'Visualize Data', action: `Visualize ${lastMessage}` },
                { text: 'Compare Solutions', action: `Compare solutions for ${lastMessage}` },
                { text: 'Performance Analysis', action: `Analyze performance of ${lastMessage}` }
            ] : currentMode === 'robloxGameGenerator' ? [
                { text: 'Enhance Game', action: `Enhance ${lastMessage} with more features` },
                { text: 'Add NPCs', action: `Add NPCs to ${lastMessage}` },
                { text: 'Optimize Terrain', action: `Optimize terrain for ${lastMessage}` }
            ] : [
                { text: 'More Details', action: `Tell me more about ${lastMessage}` },
                { text: 'Summarize', action: `Summarize ${lastMessage}` },
                { text: 'Clarify', action: `Clarify ${lastMessage}` }
            ];
        }

        function getLearningPaths() {
            return currentMode === 'coding' ? ['C++ Mastery', 'Python Optimization', 'Secure Coding'] :
                   currentMode === 'homework' ? ['Algebra Deep Dive', 'Physics Concepts', 'CS Foundations'] :
                   currentMode === 'analysis' ? ['Data Visualization', 'Performance Metrics', 'Code Review'] :
                   currentMode === 'robloxGameGenerator' ? ['Roblox Scripting', 'Game Design', 'Multiplayer Systems'] :
                   ['General Knowledge', 'Skill Development', 'Project Ideas'];
        }

        function getComplexityInsights() {
            const lastCode = chatHistory.filter(m => m.role === 'user' && currentMode === 'coding').slice(-1)[0]?.content || '';
            if (!lastCode) return ['No code to analyze'];
            const lines = lastCode.split('\n').length;
            const loops = (lastCode.match(/for\s*\(|while\s*\(/g) || []).length;
            const functions = (lastCode.match(/function\s+\w+|def\s+\w+/g) || []).length;
            return [
                `Lines: ${lines}`,
                `Loops: ${loops}`,
                `Functions: ${functions}`,
                `Complexity: ${lines > 50 || loops > 5 || functions > 10 ? 'High' : 'Moderate'}`
            ];
        }

        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
                saveSession();
            });
        });

        function sendMessage() {
            const input = elements.inputField.value.trim();
            if (!input) return;
            if (!currentSessionId) newSession();
            saveScrollPosition();
            addMessage(input, 'user');
            chatHistory.push({ role: 'user', content: input });
            elements.inputField.value = '';
            elements.inputField.style.height = 'auto';
            processInput(input);
            saveSession();
            restoreScrollPosition();
            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
        }

        elements.sendBtn.addEventListener('click', sendMessage);
        elements.inputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        elements.inputField.addEventListener('input', () => {
            elements.inputField.style.height = 'auto';
            elements.inputField.style.height = `${Math.min(elements.inputField.scrollHeight, 200)}px`;
        });

        elements.clearChatBtn.addEventListener('click', () => {
            if (currentSessionId && confirm('Clear current chat? This cannot be undone.')) {
                delete chatSessions[currentSessionId];
                localStorage.setItem('chatSessions', JSON.stringify(chatSessions));
                newSession();
            }
        });

        elements.addFilesBtn.addEventListener('click', () => elements.fileInput.click());
        elements.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (!currentSessionId) newSession();
                saveScrollPosition();
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const content = ev.target.result;
                    addMessage(`Attached: ${file.name}\n${content.slice(0, 500)}`, 'user');
                    chatHistory.push({ role: 'user', content: `Attached: ${file.name}\n${content}` });
                    processInput(content);
                    saveSession();
                };
                reader.readAsText(file);
                elements.fileInput.value = '';
                restoreScrollPosition();
                elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
            }
        });

        elements.sidebarToggleOpen.addEventListener('click', () => {
            elements.sidebar.classList.add('open');
            elements.mainContent.classList.add('shifted');
        });
        elements.sidebarToggleClose.addEventListener('click', () => {
            elements.sidebar.classList.remove('open');
            elements.mainContent.classList.remove('shifted');
        });
        elements.aiImprovementsBtn.addEventListener('click', () => elements.aiSidebar.classList.add('open'));
        elements.aiSidebarToggleClose.addEventListener('click', () => elements.aiSidebar.classList.remove('open'));

        elements.newChatBtn.addEventListener('click', newSession);

        function addMessage(text, type, showActions = type === 'ai') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            const formattedText = marked.parse(text, { gfm: true, breaks: true });
            const codeRegex = /<pre><code class="language-(\w+)">([\s\S]*?)<\/code><\/pre>/g;
            let lang = 'text';
            const formattedWithCode = formattedText.replace(codeRegex, (match, language, code) => {
                lang = language;
                const decodedCode = code.replace(/</g, '<').replace(/>/g, '>').replace(/&/g, '&');
                return `<div class="code-block"><pre><code class="language-${language}">${decodedCode}</code></pre><div class="code-actions"><button class="code-action-btn" onclick="copyCode(this)">Copy</button><button class="code-action-btn" onclick="saveSnippet('${encodeURIComponent(decodedCode)}', '${language}')">Save</button></div></div>`;
            });
            messageDiv.innerHTML = formattedWithCode;
            if (showActions) {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'action-buttons';
                const actions = currentMode === 'coding' ? ['debug', 'explain', 'optimize', 'security'] :
                               currentMode === 'homework' ? ['step-by-step', 'alternate', 'simplify'] :
                               currentMode === 'analysis' ? ['visualize', 'compare', 'metrics'] :
                               currentMode === 'robloxGameGenerator' ? ['enhance', 'addNPCs', 'optimizeTerrain'] :
                               ['summarize', 'elaborate', 'clarify'];
                actions.forEach(action => {
                    const btn = document.createElement('button');
                    btn.className = 'action-btn';
                    btn.textContent = action.charAt(0).toUpperCase() + action.slice(1);
                    btn.addEventListener('click', () => processAction(action, text));
                    actionsDiv.appendChild(btn);
                });
                const clearBtn = document.createElement('button');
                clearBtn.className = 'clear-btn';
                clearBtn.textContent = 'Delete';
                clearBtn.addEventListener('click', () => {
                    messageDiv.remove();
                    chatHistory = chatHistory.filter(m => m.content !== text);
                    saveSession();
                });
                actionsDiv.appendChild(clearBtn);
                messageDiv.appendChild(actionsDiv);
            }
            if (type === 'ai' && currentMode === 'coding' && lang !== 'text') {
                const { score, insights } = calculateCodeQuality(text, lang);
                const scoreSpan = document.createElement('span');
                scoreSpan.className = 'quality-score';
                scoreSpan.textContent = `Quality: ${score}%`;
                messageDiv.insertBefore(scoreSpan, messageDiv.firstChild);
                const insightsDiv = document.createElement('div');
                insightsDiv.className = 'complexity-insights';
                insightsDiv.textContent = insights.join(' | ');
                messageDiv.appendChild(insightsDiv);
            }
            if (type === 'ai' && currentMode === 'analysis') {
                const visualization = createVisualization(text);
                if (visualization) messageDiv.appendChild(visualization);
            }
            elements.chatContainer.insertBefore(messageDiv, elements.chatContainer.firstChild);
            Prism.highlightAllUnder(messageDiv);
            if (type === 'user') {
                elements.chatContainer.scrollTop = 0;
            } else {
                restoreScrollPosition();
                const aiMessages = elements.chatContainer.getElementsByClassName('message ai');
                if (aiMessages.length) aiMessages[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        window.copyCode = function(btn) {
            const code = btn.parentElement.previousElementSibling.querySelector('code').textContent;
            navigator.clipboard.writeText(code).then(() => {
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy', 2000);
            });
        };

        window.saveSnippet = function(code, language) {
            const title = prompt('Enter snippet title:') || `Snippet_${Date.now()}`;
            codeSnippets.push({ title, code: decodeURIComponent(code), language });
            localStorage.setItem('codeSnippets', JSON.stringify(codeSnippets));
            updateAiSidebar();
            alert('Snippet saved!');
        };

        function calculateCodeQuality(code, language) {
            let score = 100;
            const lines = code.split('\n').length;
            const loops = (code.match(/for\s*\(|while\s*\(/g) || []).length;
            const functions = (code.match(/function\s+\w+|def\s+\w+/g) || []).length;
            if (lines < 10) score -= 20;
            if (!code.includes('\n')) score -= 15;
            if (language === 'javascript' && !code.includes('const') && !code.includes('let')) score -= 10;
            if (language === 'python' && !code.includes('def')) score -= 10;
            if (code.includes('goto') || code.includes('eval')) score -= 30;
            if (loops > 5 || functions > 10) score -= 15;
            return { score: Math.max(0, score), insights: [`Lines: ${lines}`, `Loops: ${loops}`, `Functions: ${functions}`] };
        }

        function createVisualization(data) {
            try {
                const numbers = data.match(/-?\d+\.?\d*/g)?.map(Number) || [];
                if (numbers.length < 2) return null;
                const canvas = document.createElement('canvas');
                canvas.className = 'visualization';
                new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: numbers.map((_, i) => `Point ${i + 1}`),
                        datasets: [{
                            label: 'Data Trend',
                            data: numbers,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { labels: { color: theme === 'light' ? '#1f2937' : '#d1d5db' } } }
                    }
                });
                return canvas;
            } catch {
                return null;
            }
        }

        async function processInput(input) {
            elements.typingIndicator.style.display = 'flex';
            let response;
            try {
                const action = inferAction(input);
                response = currentMode === 'coding' ? await processCoding(input, action) :
                          currentMode === 'general' ? await processGeneral(input) :
                          currentMode === 'homework' ? await processHomework(input, action) :
                          currentMode === 'analysis' ? await processAnalysis(input, action) :
                          currentMode === 'robloxGameGenerator' ? await processRobloxGameGenerator(input) : 'Invalid mode';
                chatHistory.push({ role: 'assistant', content: response });
                saveSession();
            } catch (error) {
                response = `Error: ${error.message}. Please check API keys in settings or your quota at the provider's dashboard.`;
                if (error.message.includes('quota')) response += ' Visit your API provider for more details.';
            }
            elements.typingIndicator.style.display = 'none';
            saveScrollPosition();
            addMessage(response, 'ai');
            restoreScrollPosition();
            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
        }

        function inferAction(input) {
            const lower = input.toLowerCase();
            return lower.includes('debug') ? 'debug' :
                   lower.includes('explain') || lower.includes('clarify') ? 'explain' :
                   lower.includes('optimize') || lower.includes('improve') ? 'optimize' :
                   lower.includes('security') || lower.includes('analyze') ? 'security' :
                   lower.includes('step') ? 'step-by-step' :
                   lower.includes('alternate') ? 'alternate' :
                   lower.includes('simplify') ? 'simplify' :
                   lower.includes('visualize') ? 'visualize' :
                   lower.includes('compare') ? 'compare' :
                   lower.includes('metrics') ? 'metrics' :
                   lower.includes('summarize') ? 'summarize' :
                   lower.includes('elaborate') ? 'elaborate' :
                   lower.includes('enhance') ? 'enhance' :
                   lower.includes('addnpcs') ? 'addNPCs' :
                   lower.includes('optimizeterrain') ? 'optimizeTerrain' : 'default';
        }

        function parseInput(input) {
            const regex = /(debug|explain|optimize|security|step-by-step|alternate|simplify|visualize|compare|metrics|enhance|addNPCs|optimizeTerrain)\s*(this:)?\s*([\s\S]*)/i;
            const match = input.match(regex);
            return match ? { action: match[1].toLowerCase(), content: match[3].trim() } : { action: inferAction(input), content: input.trim() };
        }

        async function processCoding(input, action) {
            const { content: code } = parseInput(input);
            if (!code) return 'Please provide code with an action (e.g., "debug this: code").';
            const lang = detectLanguage(code);
            const prompts = {
                debug: `Debug this ${lang} code, fix bugs, explain issues, and check vulnerabilities:\n\`\`\`${lang}\n${code}\n\`\`\``,
                explain: `Explain this ${lang} code step-by-step with examples:\n\`\`\`${lang}\n${code}\n\`\`\``,
                optimize: `Optimize this ${lang} code with best practices:\n\`\`\`${lang}\n${code}\n\`\`\``,
                security: `Analyze this ${lang} code for security risks and improvements:\n\`\`\`${lang}\n${code}\n\`\`\``
            };
            return await callAI(prompts[action] || prompts.optimize);
        }

        function detectLanguage(code) {
            return code.includes('def ') || code.includes('import ') ? 'python' :
                   code.includes('function ') || code.includes('const ') ? 'javascript' :
                   code.includes('public class ') || code.includes('void main') ? 'java' :
                   code.includes('#include') || code.includes('int main') ? 'cpp' :
                   code.includes('local ') || code.includes('game.') ? 'lua' : 'text';
        }

        async function processGeneral(input) {
            const prompt = `Answer naturally and concisely: ${input}\n\nContext:\n${chatHistory.slice(-5).map(msg => `${msg.role}: ${msg.content}`).join('\n')}`;
            return await callAI(prompt);
        }

        async function processHomework(input, action) {
            const { content } = parseInput(input);
            const prompts = {
                'step-by-step': `Solve ${content} step-by-step with detailed explanations and examples.`,
                alternate: `Provide an alternative solution to ${content} with pros and cons.`,
                simplify: `Simplify the solution to ${content} for beginners.`,
                default: `Solve ${content} with clear steps and examples, adapting to user's skill level.`
            };
            return await callAI(prompts[action] || prompts.default);
        }

        async function processAnalysis(input, action) {
            const { content } = parseInput(input);
            const lang = detectLanguage(content);
            const prompts = {
                visualize: `Visualize this data/code and provide a chart:\n\`\`\`${lang}\n${content}\n\`\`\``,
                compare: `Compare different approaches to solve this ${lang} code:\n\`\`\`${lang}\n${content}\n\`\`\``,
                metrics: `Provide performance metrics and insights for this ${lang} code:\n\`\`\`${lang}\n${content}\n\`\`\``,
                default: `Analyze this ${lang} code for performance, security, and improvements:\n\`\`\`${lang}\n${content}\n\`\`\``
            };
            return await callAI(prompts[action] || prompts.default);
        }

        async function processRobloxGameGenerator(input) {
            if (currentMode === 'robloxGameGenerator') {
                elements.generatorModal.style.display = 'block';
                elements.gameIdeaInput.value = input;
                return 'Please review your game idea in the modal and click "Generate and Download .rbxl" to create your Roblox game.';
            }
        }

        async function generateRobloxGame(gameIdea) {
            elements.typingIndicator.style.display = 'flex';
            try {
                const blueprint = await generateGameBlueprint(gameIdea);
                const luaScripts = await generateLuaScripts(blueprint);
                const objectHierarchy = await generateObjectHierarchy(blueprint);
                const gameServices = await setupGameServices(blueprint);
                const rbxlFile = await createRbxlFile(luaScripts, objectHierarchy, gameServices);
                elements.typingIndicator.style.display = 'none';
                return rbxlFile;
            } catch (error) {
                elements.typingIndicator.style.display = 'none';
                throw new Error(`Failed to generate Roblox game: ${error.message}`);
            }
        }

        async function generateGameBlueprint(gameIdea) {
            const prompt = `Generate a detailed Roblox game blueprint based on this idea:\n${gameIdea}\nInclude:\n- Gameplay mechanics\n- UI structure\n- Object hierarchy\n- Required game services\nReturn the blueprint in JSON format.`;
            const response = await callAI(prompt);
            return JSON.parse(response);
        }

        async function generateLuaScripts(blueprint) {
            const scripts = {};
            for (const component of blueprint.components) {
                const prompt = `Generate a Roblox Lua script for a ${component.type} component named "${component.name}" with the following functionality:\n${component.functionality}\nUse Roblox best practices and ensure compatibility with Roblox Studio.`;
                scripts[component.name] = await callAI(prompt);
            }
            return scripts;
        }

        async function generateObjectHierarchy(blueprint) {
            const hierarchy = {};
            for (const obj of blueprint.objects) {
                const prompt = `Generate a Roblox object hierarchy in Lua for a ${obj.type} named "${obj.name}" with properties:\n${JSON.stringify(obj.properties)}\nInclude placement in Workspace or other services as needed.`;
                hierarchy[obj.name] = await callAI(prompt);
            }
            return hierarchy;
        }

        async function setupGameServices(blueprint) {
            const services = {};
            for (const service of blueprint.services) {
                const prompt = `Generate a Roblox Lua script to set up the ${service.name} service with the following configurations:\n${JSON.stringify(service.config)}\nEnsure proper initialization for a Roblox game.`;
                services[service.name] = await callAI(prompt);
            }
            return services;
        }

        async function createRbxlFile(luaScripts, objectHierarchy, gameServices) {
            const projectStructure = {
                src: {
                    ServerScriptService: {},
                    StarterPlayer: {
                        StarterPlayerScripts: {}
                    },
                    Workspace: {},
                    ReplicatedStorage: {},
                    Lighting: {}
                }
            };

            Object.keys(luaScripts).forEach(scriptName => {
                projectStructure.src.ServerScriptService[`${scriptName}.lua`] = luaScripts[scriptName];
            });

            Object.keys(objectHierarchy).forEach(objName => {
                projectStructure.src.Workspace[`${objName}.lua`] = objectHierarchy[objName];
            });

            Object.keys(gameServices).forEach(serviceName => {
                if (serviceName === 'Lighting') {
                    projectStructure.src.Lighting[`${serviceName}.lua`] = gameServices[serviceName];
                } else {
                    projectStructure.src.ReplicatedStorage[`${serviceName}.lua`] = gameServices[serviceName];
                }
            });

            const rojoProject = {
                name: "GeneratedGame",
                tree: projectStructure
            };

            const rbxlContent = await Rojo.build(rojoProject);
            const blob = new Blob([rbxlContent], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `GeneratedRobloxGame_${Date.now()}.rbxl`;
            a.click();
            URL.revokeObjectURL(url);
            return `Roblox game generated and downloaded as GeneratedRobloxGame_${Date.now()}.rbxl`;
        }

        async function processAction(action, text) {
            elements.typingIndicator.style.display = 'flex';
            let response;
            try {
                response = currentMode === 'coding' ? await processCoding(`${action} this: ${text}`, action) :
                          currentMode === 'general' ? await processGeneral(`${action} this: ${text}`) :
                          currentMode === 'homework' ? await processHomework(`${action} this: ${text}`, action) :
                          currentMode === 'analysis' ? await processAnalysis(`${action} this: ${text}`, action) :
                          currentMode === 'robloxGameGenerator' ? await processRobloxGameGenerator(`${action} this: ${text}`) : 'Invalid mode';
                chatHistory.push({ role: 'assistant', content: response });
                saveSession();
            } catch (error) {
                response = `Error: ${error.message}. Please check API keys in settings or your quota at the provider's dashboard.`;
                if (error.message.includes('quota')) response += ' Visit your API provider for more details.';
            }
            elements.typingIndicator.style.display = 'none';
            saveScrollPosition();
            addMessage(response, 'ai');
            restoreScrollPosition();
            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
        }

        async function validateApiKey(apiKey, model) {
            if (!apiKey) return false;
            const urls = {
                chatgpt: 'https://api.openai.com/v1/models',
                deepseek: 'https://api.deepseek.com/v1/models',
                anthropic: 'https://api.anthropic.com/v1/models'
            };
            const headers = model === 'anthropic' ? {
                'Content-Type': 'application/json',
                'x-api-key': CryptoJS.SHA256(apiKey).toString(),
                'anthropic-version': '2023-06-01'
            } : {
                'Authorization': `Bearer ${CryptoJS.SHA256(apiKey).toString()}`,
                'Content-Type': 'application/json'
            };
            try {
                const response = await fetch(urls[model], { method: 'GET', headers, mode: 'cors', credentials: 'omit' });
                return response.ok;
            } catch {
                return false;
            }
        }

        async function callAI(prompt) {
            const apiKeys = {
                chatgpt: localStorage.getItem('chatGptApiKey'),
                deepseek: localStorage.getItem('deepSeekApiKey'),
                anthropic: localStorage.getItem('anthropicApiKey')
            };
            const availableModels = Object.keys(apiKeys).filter(model => apiKeys[model] && await validateApiKey(apiKeys[model], model));
            if (!availableModels.length) throw new Error('No valid API keys found. Add one in settings.');
            let model = localStorage.getItem('activeModel') || availableModels[0];
            if (!apiKeys[model] || !(await validateApiKey(apiKeys[model], model))) {
                model = availableModels[0];
                localStorage.setItem('activeModel', model);
                elements.modelSelect.value = model;
            }
            const apiKey = apiKeys[model];
            const urls = {
                chatgpt: 'https://api.openai.com/v1/chat/completions',
                deepseek: 'https://api.deepseek.com/v1/chat/completions',
                anthropic: 'https://api.anthropic.com/v1/messages'
            };
            const models = {
                chatgpt: 'gpt-4o',
                deepseek: 'deepseek-coder',
                anthropic: 'claude-3-5-sonnet-20240620'
            };
            const instructions = {
                general: localStorage.getItem('generalInstruction') || 'Be concise, natural, and helpful.',
                coding: localStorage.getItem('codingInstruction') || 'Provide clear code solutions with best practices.',
                homework: localStorage.getItem('homeworkInstruction') || 'Solve step-by-step, adapt to user skill level.',
                analysis: localStorage.getItem('analysisInstruction') || 'Offer insights, visualize data, compare solutions.',
                robloxGameGenerator: localStorage.getItem('robloxGameGeneratorInstruction') || 'Generate Roblox game blueprints, Lua scripts, and .rbxl files based on user input.'
            };
            const url = urls[model];
            const requestBody = model === 'anthropic' ? {
                model: models[model],
                messages: [
                    { role: 'system', content: instructions[currentMode] },
                    ...chatHistory.slice(-5),
                    { role: 'user', content: prompt }
                ],
                max_tokens: 4000
            } : {
                model: models[model],
                messages: [
                    { role: 'system', content: instructions[currentMode] },
                    ...chatHistory.slice(-5),
                    { role: 'user', content: prompt }
                ],
                max_tokens: 4000,
                temperature: 0.7,
                top_p: 0.9
            };
            const headers = model === 'anthropic' ? {
                'Content-Type': 'application/json',
                'x-api-key': apiKey,
                'anthropic-version': '2023-06-01'
            } : {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            };
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API request failed.');
                }
                const data = await response.json();
                return model === 'anthropic' ? data.content[0].text.trim() : data.choices[0].message.content.trim();
            } catch (error) {
                throw new Error(`API error: ${error.message}`);
            }
        }

        elements.settingsBtn.addEventListener('click', () => {
            elements.profileModal.style.display = 'block';
            elements.chatGptApiKey.value = localStorage.getItem('chatGptApiKey') || '';
            elements.deepSeekApiKey.value = localStorage.getItem('deepSeekApiKey') || '';
            elements.anthropicApiKey.value = localStorage.getItem('anthropicApiKey') || '';
            elements.modelSelect.value = localStorage.getItem('activeModel') || 'chatgpt';
            elements.generalInstruction.value = localStorage.getItem('generalInstruction') || '';
            elements.codingInstruction.value = localStorage.getItem('codingInstruction') || '';
            elements.homeworkInstruction.value = localStorage.getItem('homeworkInstruction') || '';
            elements.analysisInstruction.value = localStorage.getItem('analysisInstruction') || '';
            elements.robloxGameGeneratorInstruction.value = localStorage.getItem('robloxGameGeneratorInstruction') || '';
            elements.dataRetention.value = localStorage.getItem('dataRetention') || 'session';
            [elements.chatGptApiKeyError, elements.deepSeekApiKeyError, elements.anthropicApiKeyError].forEach(el => el.style.display = 'none');
        });

        elements.closeProfileBtn.addEventListener('click', () => {
            elements.profileModal.style.display = 'none';
        });

        elements.saveApiKeyBtn.addEventListener('click', async () => {
            const chatGptKey = elements.chatGptApiKey.value.trim();
            const deepSeekKey = elements.deepSeekApiKey.value.trim();
            const anthropicKey = elements.anthropicApiKey.value.trim();
            const model = elements.modelSelect.value;
            const generalInst = elements.generalInstruction.value.trim();
            const codingInst = elements.codingInstruction.value.trim();
            const homeworkInst = elements.homeworkInstruction.value.trim();
            const analysisInst = elements.analysisInstruction.value.trim();
            const robloxGameGeneratorInst = elements.robloxGameGeneratorInstruction.value.trim();
            const retention = elements.dataRetention.value;

            [elements.chatGptApiKeyError, elements.deepSeekApiKeyError, elements.anthropicApiKeyError].forEach(el => el.style.display = 'none');

            if (chatGptKey && !(await validateApiKey(chatGptKey, 'chatgpt'))) {
                elements.chatGptApiKeyError.style.display = 'block';
            } else if (deepSeekKey && !(await validateApiKey(deepSeekKey, 'deepseek'))) {
                elements.deepSeekApiKeyError.style.display = 'block';
            } else if (anthropicKey && !(await validateApiKey(anthropicKey, 'anthropic'))) {
                elements.anthropicApiKeyError.style.display = 'block';
            } else {
                if (chatGptKey) localStorage.setItem('chatGptApiKey', chatGptKey);
                if (deepSeekKey) localStorage.setItem('deepSeekApiKey', deepSeekKey);
                if (anthropicKey) localStorage.setItem('anthropicApiKey', anthropicKey);
                localStorage.setItem('activeModel', model);
                if (generalInst) localStorage.setItem('generalInstruction', generalInst);
                if (codingInst) localStorage.setItem('codingInstruction', codingInst);
                if (homeworkInst) localStorage.setItem('homeworkInstruction', homeworkInst);
                if (analysisInst) localStorage.setItem('analysisInstruction', analysisInst);
                if (robloxGameGeneratorInst) localStorage.setItem('robloxGameGeneratorInstruction', robloxGameGeneratorInst);
                localStorage.setItem('dataRetention', retention);
                elements.profileModal.style.display = 'none';
            }
        });

        elements.themeToggleBtn.addEventListener('click', () => {
            theme = theme === 'dark' ? 'light' : 'dark';
            document.body.classList.toggle('light-mode', theme === 'light');
            localStorage.setItem('theme', theme);
            elements.themeToggleBtn.innerHTML = theme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
        });

        elements.signOutBtn.addEventListener('click', () => {
            if (confirm('Sign out? This will clear all data.')) {
                localStorage.clear();
                chatSessions = {};
                codeSnippets = [];
                newSession();
                loadChatHistory();
                updateAiSidebar();
                elements.profileModal.style.display = 'none';
            }
        });

        elements.exportBtn.addEventListener('click', () => {
            const data = { chatSessions, codeSnippets };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `prymis-ai-backup-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        elements.importBtn.addEventListener('click', () => {
            elements.importInput.click();
        });

        elements.importInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        chatSessions = data.chatSessions || {};
                        codeSnippets = data.codeSnippets || [];
                        localStorage.setItem('chatSessions', JSON.stringify(chatSessions));
                        localStorage.setItem('codeSnippets', JSON.stringify(codeSnippets));
                        newSession();
                        loadChatHistory();
                        updateAiSidebar();
                    } catch {
                        alert('Invalid backup file.');
                    }
                };
                reader.readAsText(file);
                elements.importInput.value = '';
            }
        });

        elements.generatorCloseBtn.addEventListener('click', () => {
            elements.generatorModal.style.display = 'none';
        });

        elements.generateGameBtn.addEventListener('click', async () => {
            const gameIdea = elements.gameIdeaInput.value.trim();
            if (!gameIdea) {
                alert('Please enter a game idea.');
                return;
            }
            try {
                const response = await generateRobloxGame(gameIdea);
                addMessage(response, 'ai');
                chatHistory.push({ role: 'assistant', content: response });
                saveSession();
                elements.generatorModal.style.display = 'none';
            } catch (error) {
                addMessage(`Error: ${error.message}`, 'ai');
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            document.body.classList.toggle('light-mode', theme === 'light');
            elements.themeToggleBtn.innerHTML = theme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
            if (Object.keys(chatSessions).length) {
                currentSessionId = Object.keys(chatSessions).sort((a, b) => chatSessions[b].timestamp - chatSessions[a].timestamp)[0];
                loadSession(currentSessionId);
            } else {
                newSession();
            }
        });
    </script>
</body>
</html>
