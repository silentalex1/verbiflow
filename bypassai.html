<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prysmis AI - Coding & Learning Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.24.1/themes/prism-tomorrow.css" rel="stylesheet">
    <style>
:root {
    --primary: #6d28d9;
    --primary-hover: #5b21b6;
    --secondary: #10b981;
    --dark: #0f172a;
    --light: #f9fafb;
    --gray: #64748b;
    --code-bg: #1e1e1e;
    --code-text: #d4d4d4;
}

body {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    min-height: 100vh;
    margin: 0;
    font-family: 'Inter', sans-serif;
    color: #e2e8f0;
    overflow-x: hidden;
    overflow-y: auto;
    transition: background 0.5s ease-in-out;
}

body.light-mode {
    background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
    color: #1f2937;
}

.app-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 1rem;
}

@media (min-width: 640px) {
    .app-container {
        padding: 2rem;
    }
}

@media (min-width: 1024px) {
    .app-container {
        padding: 3rem;
    }
}

.glass-card {
    background: rgba(30, 41, 59, 0.95);
    backdrop-filter: blur(30px);
    border-radius: 35px;
    box-shadow: 0 25px 90px rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.25);
    overflow: hidden;
    transition: transform 0.4s ease-in-out, box-shadow 0.4s ease-in-out;
}

body.light-mode .glass-card {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.15);
    box-shadow: 0 25px 90px rgba(0, 0, 0, 0.25);
}

.glass-card:hover {
    transform: translateY(-15px);
    box-shadow: 0 35px 120px rgba(109, 40, 217, 0.8);
}

.section-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.tab {
    padding: 0.8rem 1.5rem;
    background: rgba(255, 255, 255, 0.25);
    border-radius: 9999px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.4s ease-in-out;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
}

@media (min-width: 640px) {
    .tab {
        padding: 1rem 2rem;
        font-size: 1.1rem;
    }
}

@media (min-width: 1024px) {
    .tab {
        padding: 1.2rem 2.5rem;
        font-size: 1.2rem;
    }
}

body.light-mode .tab {
    background: rgba(0, 0, 0, 0.15);
}

.tab.active {
    background: var(--primary);
    box-shadow: 0 8px 30px rgba(109, 40, 217, 1);
    transform: scale(1.15);
}

.tab:hover:not(.active) {
    background: rgba(255, 255, 255, 0.5);
    transform: scale(1.1);
}

.editor-container, .general-container, .homework-container {
    display: none;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    background: rgba(15, 23, 42, 0.4);
    border-radius: 20px;
    padding: 1rem;
    opacity: 0;
    transition: all 0.4s ease-in-out;
}

@media (min-width: 768px) {
    .editor-container, .general-container, .homework-container {
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        padding: 1.5rem;
        border-radius: 30px;
    }
}

@media (min-width: 1024px) {
    .editor-container, .general-container, .homework-container {
        gap: 3rem;
        padding: 2rem;
        height: 700px;
    }
}

body.light-mode .editor-container, body.light-mode .general-container, body.light-mode .homework-container {
    background: rgba(229, 231, 235, 0.4);
}

.editor-container.active, .general-container.active, .homework-container.active {
    display: grid;
    opacity: 1;
}

.code-area, .general-area, .homework-area {
    position: relative;
    height: 400px;
    border-radius: 25px;
    overflow: hidden;
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
    background: var(--code-bg);
}

@media (min-width: 768px) {
    .code-area, .general-area, .homework-area {
        height: 100%;
    }
}

body.light-mode .code-area, body.light-mode .general-area, body.light-mode .homework-area {
    background: #f5f5f5;
}

.code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: linear-gradient(90deg, #1a1a3a, #2a2a5a);
    border-radius: 25px 25px 0 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
}

@media (min-width: 640px) {
    .code-header {
        padding: 1.5rem 2rem;
    }
}

body.light-mode .code-header {
    background: linear-gradient(90deg, #e5e7eb, #d1d5db);
}

.code-textarea, .general-textarea, .homework-textarea {
    width: 100%;
    height: calc(100% - 60px);
    padding: 1rem;
    border: none;
    background: transparent;
    color: var(--code-text);
    font-family: 'Fira Code', monospace;
    font-size: 0.9rem;
    line-height: 1.8;
    resize: none;
    outline: none;
    scrollbar-width: thin;
    scrollbar-color: var(--primary) rgba(255, 255, 255, 0.2);
}

@media (min-width: 640px) {
    .code-textarea, .general-textarea, .homework-textarea {
        padding: 1.5rem;
        font-size: 1rem;
        line-height: 2;
    }
}

@media (min-width: 1024px) {
    .code-textarea, .general-textarea, .homework-textarea {
        padding: 2rem;
        font-size: 1.1rem;
    }
}

body.light-mode .code-textarea, body.light-mode .general-textarea, body.light-mode .homework-textarea {
    color: #1f2937;
}

#codeOutput, #generalOutput, #homeworkOutput {
    white-space: pre-wrap;
    overflow-y: auto;
    padding: 1rem;
}

#codeOutput pre, #homeworkOutput pre {
    background: transparent;
    padding: 0;
    border-radius: 0;
    margin: 0;
}

#codeOutput code, #homeworkOutput code {
    background: transparent !important;
    padding: 0 !important;
}

.btn-primary {
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 15px;
    padding: 0.8rem 1.5rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.4s ease-in-out;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 10px 30px rgba(109, 40, 217, 0.7);
}

@media (min-width: 640px) {
    .btn-primary {
        padding: 1rem 2rem;
    }
}

@media (min-width: 1024px) {
    .btn-primary {
        padding: 1.2rem 2.5rem;
        gap: 0.8rem;
    }
}

.btn-primary:hover {
    background: var(--primary-hover);
    transform: translateY(-8px);
    box-shadow: 0 15px 40px rgba(109, 40, 217, 0.9);
}

.feature-button {
    background: rgba(255, 255, 255, 0.25);
    border: none;
    border-radius: 12px;
    padding: 0.6rem;
    color: #e2e8f0;
    cursor: pointer;
    transition: all 0.4s ease-in-out;
}

@media (min-width: 640px) {
    .feature-button {
        padding: 0.9rem;
    }
}

body.light-mode .feature-button {
    background: rgba(0, 0, 0, 0.15);
}

.status-badge {
    background: rgba(16, 185, 129, 0.35);
    color: #10b981;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.pulsing-dot {
    width: 12px;
    height: 12px;
    background-color: #10b981;
    border-radius: 50%;
    animation: pulse 1.2s infinite;
}

@keyframes pulse {
    0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.9); }
    70% { transform: scale(1.1); box-shadow: 0 0 0 12px rgba(16, 185, 129, 0); }
    100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
}

.language-selector, .model-selector {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.language-pill, .model-option {
    padding: 0.8rem 1.5rem;
    background: rgba(255, 255, 255, 0.25);
    border-radius: 9999px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.4s ease-in-out;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
}

@media (min-width: 640px) {
    .language-pill, .model-option {
        padding: 1rem 2rem;
        font-size: 1rem;
    }
}

@media (min-width: 1024px) {
    .language-pill, .model-option {
        font-size: 1.1rem;
    }
}

.language-pill.active, .model-option.active {
    background: var(--primary);
    transform: scale(1.15);
}

.model-option {
    background: linear-gradient(90deg, #4b5563, #1f2937);
    position: relative;
    overflow: hidden;
}

.model-option:hover {
    background: linear-gradient(90deg, #6b7280, #374151);
}

body.light-mode .model-option {
    background: linear-gradient(90deg, #d1d5db, #9ca3af);
}

body.light-mode .model-option:hover {
    background: linear-gradient(90deg, #e5e7eb, #b9c2d0);
}

.model-option::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: 0.5s;
}

.model-option:hover::before {
    left: 100%;
}

.theme-toggle-btn {
    background: rgba(255, 255, 255, 0.25);
    color: #e2e8f0;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

body.light-mode .theme-toggle-btn {
    background: rgba(0, 0, 0, 0.15);
}

.header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 2rem;
}

@media (min-width: 1024px) {
    .header-container {
        gap: 2rem;
        margin-bottom: 3rem;
    }
}

.header-right {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

@media (min-width: 640px) {
    .header-right {
        gap: 1rem;
    }
}

.slogan {
    text-align: center;
    font-size: 1.5rem;
    font-weight: 700;
    color: #e2e8f0;
    margin-bottom: 2rem;
    background: linear-gradient(90deg, #6d28d9, #5b21b6);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
}

@media (min-width: 1024px) {
    .slogan {
        font-size: 2rem;
        margin-bottom: 3rem;
    }
}

.progress-bar {
    width: 100%;
    height: 6px;
    background: rgba(255, 255, 255, 0.25);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 0.7rem;
    display: none;
}

.progress-bar-fill {
    width: 0;
    height: 100%;
    background: #6d28d9;
    transition: width 0.02s linear;
}

.retry-btn {
    background: rgba(234, 88, 12, 0.35);
    color: #ea580c;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    display: none;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.copy-btn {
    background: var(--secondary);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    margin-top: 0.5rem;
    transition: background 0.3s;
}

@media (min-width: 640px) {
    .copy-btn {
        margin-top: 1rem;
    }
}

.copy-btn:hover {
    background: #0f766e;
}

.continue-btn {
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    margin-top: 0.5rem;
    transition: background 0.3s;
}

@media (min-width: 640px) {
    .continue-btn {
        margin-top: 1rem;
    }
}

.continue-btn:hover {
    background: var(--primary-hover);
}

.ai-to-human-btn {
    background: #f59e0b;
    color: white;
    border: none;
    border-radius: 10px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    margin-top: 0.5rem;
    transition: background 0.3s;
}

@media (min-width: 640px) {
    .ai-to-human-btn {
        margin-top: 1rem;
    }
}

.ai-to-human-btn:hover {
    background: #d97706;
}
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header-container">
            <div class="header-left">
                <div class="text-primary text-4xl sm:text-5xl">
                    <i class="fas fa-code"></i>
                </div>
                <div>
                    <h1 class="text-3xl sm:text-4xl font-bold">Prysmis AI</h1>
                    <p class="text-gray-400 text-sm sm:text-base" id="welcomeText"></p>
                </div>
            </div>
            <div class="header-right">
                <div class="status-badge">
                    <span class="pulsing-dot"></span>
                    <span>API Active</span>
                </div>
                <div id="themeToggleBtn" class="theme-toggle-btn">
                    <i class="fas fa-moon"></i>
                    <span>Toggle Theme</span>
                </div>
                <button id="signOutBtn" class="theme-toggle-btn" style="background: rgba(255, 0, 0, 0.25);">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sign Out</span>
                </button>
                <button id="adminPanelBtn" class="theme-toggle-btn" style="background: rgba(0, 255, 0, 0.25); display: none;">
                    <i class="fas fa-user-shield"></i>
                    <span>Admin Panel</span>
                </button>
            </div>
        </header>

        <div class="slogan">Prysmis - Your AI Coding & Learning Partner</div>

        <div class="section-tabs">
            <div class="tab active" data-section="coding">Code Processing</div>
            <div class="tab" data-section="general">General Query</div>
            <div class="tab" data-section="homework">Homework Solver</div>
            <div class="tab" data-section="analysis">Code Analysis</div>
        </div>

        <div class="language-selector">
            <div class="language-pill active" data-lang="javascript">JavaScript</div>
            <div class="language-pill" data-lang="python">Python</div>
            <div class="language-pill" data-lang="lua">Lua</div>
            <div class="language-pill" data-lang="ruby">Ruby</div>
            <div class="language-pill" data-lang="go">Go</div>
            <div class="language-pill" data-lang="cpp">C++</div>
            <div class="language-pill" data-lang="csharp">C#</div>
            <div class="language-pill" data-lang="java">Java</div>
        </div>

        <div class="model-selector">
            <div class="model-option active" data-model="chatgpt">ChatGPT</div>
            <div class="model-option" data-model="grok">Grok</div>
        </div>

        <div class="glass-card mb-10">
            <div class="p-4 sm:p-6">
                <h2 class="text-2xl sm:text-3xl font-semibold mb-4">Code Processing</h2>
                <p class="text-sm sm:text-base text-gray-400" id="sectionDescription">Input code or URL for processing.</p>
            </div>

            <div class="editor-container active" id="codingSection">
                <div class="code-area">
                    <div class="code-header">
                        <span class="text-sm sm:text-base font-medium">Input Code</span>
                        <div class="flex gap-2 sm:gap-3">
                            <button class="feature-button clear-btn"><i class="fas fa-trash-alt"></i></button>
                            <button class="feature-button copy-input-btn"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                    <textarea id="codeInput" class="code-textarea" placeholder="Enter code or URL..."></textarea>
                </div>
                <div class="code-area">
                    <div class="code-header">
                        <span class="text-sm sm:text-base font-medium">Result</span>
                        <div class="flex gap-2 sm:gap-3 flex-wrap">
                            <button class="feature-button copy-output-btn"><i class="fas fa-copy"></i></button>
                            <button class="feature-button download-btn"><i class="fas fa-download"></i></button>
                            <button class="copy-btn" id="copyCodeBtn">Copy Code</button>
                            <button class="continue-btn" id="continueBtn" style="display: none;">Continue</button>
                        </div>
                    </div>
                    <div id="codeOutput" class="code-textarea"></div>
                    <div class="progress-bar" id="codeProgressBar">
                        <div class="progress-bar-fill" id="codeProgressFill"></div>
                    </div>
                    <button class="retry-btn" id="retryCodeBtn">
                        <i class="fas fa-redo"></i>
                        <span>Retry</span>
                    </button>
                </div>
            </div>

            <div class="general-container" id="generalSection">
                <div class="general-area">
                    <div class="code-header">
                        <span class="text-sm sm:text-base font-medium">Input Query</span>
                        <div class="flex gap-2 sm:gap-3">
                            <button class="feature-button clear-general-btn"><i class="fas fa-trash-alt"></i></button>
                            <button class="feature-button copy-general-input-btn"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                    <textarea id="generalInput" class="general-textarea" placeholder="Ask anything..."></textarea>
                </div>
                <div class="general-area">
                    <div class="code-header">
                        <span class="text-sm sm:text-base font-medium">Response</span>
                        <div class="flex gap-2 sm:gap-3">
                            <button class="feature-button copy-general-output-btn"><i class="fas fa-copy"></i></button>
                            <button class="feature-button download-general-btn"><i class="fas fa-download"></i></button>
                        </div>
                    </div>
                    <div id="generalOutput" class="general-textarea">Responses will appear here...</div>
                    <div class="progress-bar" id="generalProgressBar">
                        <div class="progress-bar-fill" id="generalProgressFill"></div>
                    </div>
                    <button class="retry-btn" id="retryGeneralBtn">
                        <i class="fas fa-redo"></i>
                        <span>Retry</span>
                    </button>
                </div>
            </div>

            <div class="homework-container" id="homeworkSection">
                <div class="homework-area">
                    <div class="code-header">
                        <span class="text-sm sm:text-base font-medium">Input Problem</span>
                        <div class="flex gap-2 sm:gap-3">
                            <button class="feature-button clear-homework-btn"><i class="fas fa-trash-alt"></i></button>
                            <button class="feature-button copy-homework-input-btn"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                    <textarea id="homeworkInput" class="homework-textarea" placeholder="Enter problem or code..."></textarea>
                </div>
                <div class="homework-area">
                    <div class="code-header">
                        <span class="text-sm sm:text-base font-medium">Solution</span>
                        <div class="flex gap-2 sm:gap-3">
                            <button class="feature-button copy-homework-output-btn"><i class="fas fa-copy"></i></button>
                            <button class="feature-button download-homework-btn"><i class="fas fa-download"></i></button>
                        </div>
                    </div>
                    <div id="homeworkOutput" class="homework-textarea"></div>
                    <div class="progress-bar" id="homeworkProgressBar">
                        <div class="progress-bar-fill" id="homeworkProgressFill"></div>
                    </div>
                    <button class="retry-btn" id="retryHomeworkBtn">
                        <i class="fas fa-redo"></i>
                        <span>Retry</span>
                    </button>
                </div>
            </div>

            <div class="editor-container" id="analysisSection">
                <div class="code-area">
                    <div class="code-header">
                        <span class="text-sm sm:text-base font-medium">Input Code</span>
                        <div class="flex gap-2 sm:gap-3">
                            <button class="feature-button clear-analysis-btn"><i class="fas fa-trash-alt"></i></button>
                            <button class="feature-button copy-analysis-input-btn"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                    <textarea id="analysisInput" class="code-textarea" placeholder="Enter code for analysis..."></textarea>
                </div>
                <div class="code-area">
                    <div class="code-header">
                        <span class="text-sm sm:text-base font-medium">Analysis Report</span>
                        <div class="flex gap-2 sm:gap-3 flex-wrap">
                            <button class="feature-button copy-analysis-output-btn"><i class="fas fa-copy"></i></button>
                            <button class="feature-button download-analysis-btn"><i class="fas fa-download"></i></button>
                            <button class="ai-to-human-btn" id="aiToHumanBtn">AI to Human</button>
                        </div>
                    </div>
                    <div id="analysisOutput" class="code-textarea">Analysis will appear here...</div>
                    <div class="progress-bar" id="analysisProgressBar">
                        <div class="progress-bar-fill" id="analysisProgressFill"></div>
                    </div>
                    <button class="retry-btn" id="retryAnalysisBtn">
                        <i class="fas fa-redo"></i>
                        <span>Retry</span>
                    </button>
                </div>
            </div>

            <div class="button-group flex justify-center gap-2 flex-wrap p-4 sm:p-6">
                <button class="btn-primary" id="processBtn" style="display: flex;">
                    <i class="fas fa-magic"></i><span>Optimize</span>
                </button>
                <button class="btn-primary" id="debugBtn" style="display: flex;">
                    <i class="fas fa-bug"></i><span>Debug</span>
                </button>
                <button class="btn-primary" id="explainBtn" style="display: flex;">
                    <i class="fas fa-info-circle"></i><span>Explain</span>
                </button>
                <button class="btn-primary" id="obfuscateBtn" style="display: flex;">
                    <i class="fas fa-lock"></i><span>Obfuscate</span>
                </button>
                <button class="btn-primary" id="deobfuscateBtn" style="display: flex;">
                    <i class="fas fa-unlock"></i><span>Deobfuscate</span>
                </button>
                <button class="btn-primary" id="improveBtn" style="display: flex;">
                    <i class="fas fa-wrench"></i><span>Improve</span>
                </button>
                <button class="btn-primary" id="generalBtn" style="display: none;">
                    <i class="fas fa-question-circle"></i><span>Query</span>
                </button>
                <button class="btn-primary" id="homeworkBtn" style="display: none;">
                    <i class="fas fa-book"></i><span>Solve</span>
                </button>
                <button class="btn-primary" id="analyzeBtn" style="display: none;">
                    <i class="fas fa-chart-bar"></i><span>Analyze</span>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.24.1/prism.min.js"></script>
    <script>
if (!localStorage.getItem('apiKey') || !localStorage.getItem('username')) {
    window.location.href = 'index.html';
}

const apiKeyChatGPT = localStorage.getItem('apiKey');
const apiKeyGrok = "xai-f0YcNkJUcdLhX3HNU1chnN5RvvFPD02qTyZCweACGutC0gt34B78iwOuNyJqWighC4pGpkFVD5Nnh0a2";
const username = localStorage.getItem('username');
document.getElementById('welcomeText').textContent = `Welcome, ${username}${username === 'realalex' ? ' [Admin]' : ''} | Coding & Learning Assistant`;
if (username === 'realalex') document.getElementById('adminPanelBtn').style.display = 'inline-flex';

async function validateApiKey(key, retries = 3, endpoint = 'https://api.openai.com/v1/models') {
    for (let i = 0; i < retries; i++) {
        try {
            const response = await fetch(endpoint, {
                headers: { 'Authorization': `Bearer ${key}` }
            });
            if (response.ok) return true;
            if (response.status === 401) throw new Error('Invalid API Key');
            await new Promise(resolve => setTimeout(resolve, 300 * (i + 1)));
        } catch (error) {
            if (i === retries - 1) {
                alert('API key validation failed after multiple attempts. Please log in again.');
                localStorage.clear();
                window.location.href = 'index.html';
                return false;
            }
        }
    }
    return false;
}

(async () => {
    if (!(await validateApiKey(apiKeyChatGPT))) return;
    if (!(await validateApiKey(apiKeyGrok, 3, 'https://api.x.ai/v1/models'))) return;
})();

async function callChatGPT(prompt, maxTokens = 2000) {
    try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKeyChatGPT}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'gpt-4-turbo',
                messages: [{ role: 'user', content: prompt }],
                max_tokens: maxTokens,
                temperature: 0.6,
                stream: true
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`ChatGPT API Error: ${response.status} - ${errorText}`);
        }

        const reader = response.body.getReader();
        let result = '';
        const startTime = performance.now();
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            const chunk = new TextDecoder().decode(value);
            const lines = chunk.split('\n').filter(line => line.startsWith('data: '));
            for (const line of lines) {
                if (line === 'data: [DONE]') continue;
                const json = JSON.parse(line.slice(6));
                if (json.choices[0].delta.content) result += json.choices[0].delta.content;
            }
            if (performance.now() - startTime > 50) await new Promise(resolve => setTimeout(resolve, 0));
        }
        return result.trim();
    } catch (error) {
        return `Error: ${error.message}. Please check your API key or network connection and retry.`;
    }
}

async function callGrok(prompt, maxTokens = 2000) {
    try {
        const response = await fetch('https://api.x.ai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKeyGrok}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'grok-3-latest',
                messages: [
                    { role: 'system', content: 'You are an expert coding and learning assistant with enhanced accuracy and clarity.' },
                    { role: 'user', content: prompt }
                ],
                max_tokens: maxTokens,
                temperature: 0,
                stream: false
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Grok API Error: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        return data.choices[0].message.content.trim();
    } catch (error) {
        return `Error: ${error.message}. Please check your API key or network connection and retry.`;
    }
}

async function callAI(prompt, maxTokens = 2000) {
    const activeModel = document.querySelector('.model-option.active')?.dataset.model || 'chatgpt';
    return activeModel === 'grok' ? callGrok(prompt, maxTokens) : callChatGPT(prompt, maxTokens);
}

const elements = {
    codeInput: document.getElementById('codeInput'),
    generalInput: document.getElementById('generalInput'),
    homeworkInput: document.getElementById('homeworkInput'),
    analysisInput: document.getElementById('analysisInput'),
    codeOutput: document.getElementById('codeOutput'),
    generalOutput: document.getElementById('generalOutput'),
    homeworkOutput: document.getElementById('homeworkOutput'),
    analysisOutput: document.getElementById('analysisOutput'),
    processBtn: document.getElementById('processBtn'),
    debugBtn: document.getElementById('debugBtn'),
    explainBtn: document.getElementById('explainBtn'),
    obfuscateBtn: document.getElementById('obfuscateBtn'),
    deobfuscateBtn: document.getElementById('deobfuscateBtn'),
    improveBtn: document.getElementById('improveBtn'),
    generalBtn: document.getElementById('generalBtn'),
    homeworkBtn: document.getElementById('homeworkBtn'),
    analyzeBtn: document.getElementById('analyzeBtn'),
    codeProgressBar: document.getElementById('codeProgressBar'),
    codeProgressFill: document.getElementById('codeProgressFill'),
    generalProgressBar: document.getElementById('generalProgressBar'),
    generalProgressFill: document.getElementById('generalProgressFill'),
    homeworkProgressBar: document.getElementById('homeworkProgressBar'),
    homeworkProgressFill: document.getElementById('homeworkProgressFill'),
    analysisProgressBar: document.getElementById('analysisProgressBar'),
    analysisProgressFill: document.getElementById('analysisProgressFill'),
    retryCodeBtn: document.getElementById('retryCodeBtn'),
    retryGeneralBtn: document.getElementById('retryGeneralBtn'),
    retryHomeworkBtn: document.getElementById('retryHomeworkBtn'),
    retryAnalysisBtn: document.getElementById('retryAnalysisBtn'),
    themeToggleBtn: document.getElementById('themeToggleBtn'),
    codingSection: document.getElementById('codingSection'),
    generalSection: document.getElementById('generalSection'),
    homeworkSection: document.getElementById('homeworkSection'),
    analysisSection: document.getElementById('analysisSection'),
    signOutBtn: document.getElementById('signOutBtn'),
    adminPanelBtn: document.getElementById('adminPanelBtn'),
    copyCodeBtn: document.getElementById('copyCodeBtn'),
    continueBtn: document.getElementById('continueBtn'),
    aiToHumanBtn: document.getElementById('aiToHumanBtn')
};

if (localStorage.getItem('theme') === 'light') {
    document.body.classList.add('light-mode');
    elements.themeToggleBtn.querySelector('i').classList.replace('fa-moon', 'fa-sun');
    elements.themeToggleBtn.querySelector('span').textContent = 'Dark Mode';
}

elements.themeToggleBtn.addEventListener('click', () => {
    document.body.classList.toggle('light-mode');
    const isLightMode = document.body.classList.contains('light-mode');
    elements.themeToggleBtn.querySelector('i').classList.toggle('fa-moon', !isLightMode);
    elements.themeToggleBtn.querySelector('i').classList.toggle('fa-sun', isLightMode);
    elements.themeToggleBtn.querySelector('span').textContent = isLightMode ? 'Dark Mode' : 'Light Mode';
    localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
});

elements.signOutBtn.addEventListener('click', () => {
    localStorage.clear();
    window.location.href = 'index.html';
});

elements.adminPanelBtn.addEventListener('click', () => {
    alert('Admin Panel Coming Soon');
});

const sectionTabs = document.querySelectorAll('.tab');
const sectionDescriptions = {
    coding: 'Input code or URL for processing, including optimization, debugging, and more.',
    general: 'Ask any question for a detailed, real-time response.',
    homework: 'Enter problems or code for precise step-by-step solutions.',
    analysis: 'Analyze code for quality, performance, and humanization.'
};

sectionTabs.forEach(tab => {
    tab.addEventListener('click', () => {
        sectionTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const section = tab.dataset.section;
        elements.codingSection.classList.toggle('active', section === 'coding');
        elements.generalSection.classList.toggle('active', section === 'general');
        elements.homeworkSection.classList.toggle('active', section === 'homework');
        elements.analysisSection.classList.toggle('active', section === 'analysis');
        document.querySelectorAll('.btn-primary').forEach(btn => {
            btn.style.display = (btn.id === 'generalBtn' && section === 'general') ||
                               (btn.id === 'homeworkBtn' && section === 'homework') ||
                               (btn.id === 'analyzeBtn' && section === 'analysis') ||
                               (section === 'coding' && btn.id !== 'generalBtn' && btn.id !== 'homeworkBtn' && btn.id !== 'analyzeBtn')
                               ? 'flex' : 'none';
        });
        document.querySelector('.language-selector').style.display = section !== 'general' ? 'flex' : 'none';
        document.querySelector('.glass-card h2').textContent = section.charAt(0).toUpperCase() + section.slice(1);
        document.getElementById('sectionDescription').textContent = sectionDescriptions[section];
    });
});

const languagePills = document.querySelectorAll('.language-pill');
languagePills.forEach(pill => {
    pill.addEventListener('click', () => {
        languagePills.forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
    });
});

const modelOptions = document.querySelectorAll('.model-option');
modelOptions.forEach(option => {
    option.addEventListener('click', () => {
        modelOptions.forEach(o => o.classList.remove('active'));
        option.classList.add('active');
    });
});

elements.copyCodeBtn.addEventListener('click', () => {
    const codeBlock = elements.codeOutput.querySelector('code');
    if (codeBlock) {
        navigator.clipboard.writeText(codeBlock.textContent);
        alert('Code copied to clipboard!');
    } else {
        alert('No code to copy!');
    }
});

elements.continueBtn.addEventListener('click', () => {
    const lastCode = elements.codeOutput.querySelector('code')?.textContent || '';
    processRequest(lastCode, 'coding', 'continue');
});

elements.aiToHumanBtn.addEventListener('click', () => {
    const analysisText = elements.analysisOutput.textContent;
    const humanizedText = humanizeText(analysisText);
    elements.analysisOutput.innerHTML = `<pre><code class="language-text">${humanizedText}</code></pre>`;
    Prism.highlightAll();
});

function humanizeText(text) {
    const words = text.split(/\s+/);
    const shift = 3;
    return words.map(word => {
        if (word.length < 3) return word;
        return word.split('').map((char, idx) => {
            if (!char.match(/[a-zA-Z]/)) return char;
            const code = char.charCodeAt(0);
            const base = char === char.toLowerCase() ? 97 : 65;
            const shifted = String.fromCharCode(((code - base + shift + idx) % 26) + base);
            return idx === 0 ? shifted.toUpperCase() : shifted.toLowerCase();
        }).join('');
    }).join(' ').replace(/\b\w+\b/g, match => {
        return match.charAt(0).toUpperCase() + match.slice(1).toLowerCase();
    });
}

async function processCodeWithAI(code, lang, action) {
    const inputCode = code.trim().match(/^https?:\/\//) ? await fetchCodeFromUrl(code) : code;
    let prompt = `You are an expert programmer proficient in ${lang}. `;
    switch (action) {
        case 'optimize':
            prompt += `Highly optimize the following ${lang} code for performance, scalability, and readability. Use advanced techniques like spatial partitioning, event-driven updates, and modular design. Provide only the optimized code.\n\`\`\`${lang}\n${inputCode}\n\`\`\``;
            break;
        case 'debug':
            prompt += `Thoroughly debug the following ${lang} code. Identify all errors, suggest fixes with detailed reasoning, and provide only the corrected code.\n\`\`\`${lang}\n${inputCode}\n\`\`\``;
            break;
        case 'explain':
            prompt += `Provide a detailed explanation of the following ${lang} code, breaking down its logic, structure, and best practices. Provide only the explanation.\n\`\`\`${lang}\n${inputCode}\n\`\`\``;
            break;
        case 'obfuscate':
            prompt += `Obfuscate the following ${lang} code to make it unreadable while ensuring Roblox compatibility using variable renaming and function shuffling. Provide only the obfuscated code.\n\`\`\`${lang}\n${inputCode}\n\`\`\``;
            break;
        case 'deobfuscate':
            prompt += `Deobfuscate the following ${lang} code to restore readability while preserving Roblox functionality. Use advanced reverse-engineering techniques. Provide only the deobfuscated code.\n\`\`\`${lang}\n${inputCode}\n\`\`\``;
            break;
        case 'improve':
            prompt += `Enhance the following ${lang} code with modern best practices, improved readability, and performance optimizations. Provide only the improved code.\n\`\`\`${lang}\n${inputCode}\n\`\`\``;
            break;
        case 'analyze':
            prompt += `Analyze the following ${lang} code for complexity, quality, performance, and detect if it's "bad" (e.g., inefficient loops, poor structure). Suggest improvements and humanize the style. Provide only the analysis.\n\`\`\`${lang}\n${inputCode}\n\`\`\``;
            break;
        case 'continue':
            prompt += `Continue the following ${lang} code logically from where it left off, maintaining its style and functionality. Provide only the continued code.\n\`\`\`${lang}\n${inputCode}\n\`\`\``;
            break;
    }
    const result = await callAI(prompt, 1500);
    return result;
}

async function solveHomework(problem, lang) {
    let prompt = `You are an expert tutor with accuracy rivaling Gauth. Solve the following problem step-by-step with clear explanations and examples:\n${problem}`;
    if (lang && problem.match(/function|def|void/)) {
        prompt += `\nThis is a ${lang} coding problem. Provide a detailed solution with only the code and steps.`;
    } else if (problem.match(/(\d+\.?\d*)\s*([+\-*/^])\s*(\d+\.?\d*)/)) {
        prompt += `\nThis is a mathematical problem. Solve with detailed derivations and only the final answer.`;
    } else {
        prompt += `\nProvide a comprehensive solution with only clear steps and examples.`;
    }
    const solution = await callAI(prompt, 1500);
    return solution;
}

async function processGeneralQuery(query) {
    const prompt = `You are a knowledgeable assistant. Provide a detailed and accurate response to the following query:\n${query}`;
    const response = await callAI(prompt, 1500);
    return response;
}

async function processRequest(input, section, action) {
    const sectionMap = {
        coding: { input: elements.codeInput, output: elements.codeOutput, progressBar: elements.codeProgressBar, progressFill: elements.codeProgressFill, retryBtn: elements.retryCodeBtn, continueBtn: elements.continueBtn },
        general: { input: elements.generalInput, output: elements.generalOutput, progressBar: elements.generalProgressBar, progressFill: elements.generalProgressFill, retryBtn: elements.retryGeneralBtn },
        homework: { input: elements.homeworkInput, output: elements.homeworkOutput, progressBar: elements.homeworkProgressBar, progressFill: elements.homeworkProgressFill, retryBtn: elements.retryHomeworkBtn },
        analysis: { input: elements.analysisInput, output: elements.analysisOutput, progressBar: elements.analysisProgressBar, progressFill: elements.analysisProgressFill, retryBtn: elements.retryAnalysisBtn, aiToHumanBtn: elements.aiToHumanBtn }
    };
    const { output, progressBar, progressFill, retryBtn, continueBtn, aiToHumanBtn } = sectionMap[section];

    if (!input) {
        output.innerHTML = '<span style="color: #ff5555;">Error: Please provide an input.</span>';
        return;
    }

    progressBar.classList.add('active');
    progressFill.style.width = '0';
    let width = 0;
    const interval = setInterval(() => {
        width += Math.random() * 20;
        progressFill.style.width = `${Math.min(width, 100)}%`;
        if (width >= 100) clearInterval(interval);
    }, 30);

    const activeLang = document.querySelector('.language-pill.active')?.dataset.lang || 'javascript';
    let result;
    if (section === 'coding') {
        result = await processCodeWithAI(input, activeLang, action);
        if (action !== 'continue') continueBtn.style.display = 'block';
        else continueBtn.style.display = 'none';
    } else if (section === 'general') {
        result = await processGeneralQuery(input);
    } else if (section === 'homework') {
        result = await solveHomework(input, activeLang);
    } else if (section === 'analysis') {
        result = await processCodeWithAI(input, activeLang, 'analyze');
        aiToHumanBtn.style.display = 'block';
    }

    clearInterval(interval);
    progressFill.style.width = '100%';
    setTimeout(() => {
        progressBar.classList.remove('active');
        output.innerHTML = `<pre><code class="language-${activeLang}">${result}</code></pre>`;
        Prism.highlightAll();
        retryBtn.style.display = result.includes('Error') ? 'inline-flex' : 'none';
    }, 100);
}

async function fetchCodeFromUrl(url) {
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Invalid URL or access denied.');
        return await response.text();
    } catch (error) {
        return `Error fetching from ${url}: ${error.message}.`;
    }
}

elements.processBtn.addEventListener('click', () => processRequest(elements.codeInput.value, 'coding', 'optimize'));
elements.debugBtn.addEventListener('click', () => processRequest(elements.codeInput.value, 'coding', 'debug'));
elements.explainBtn.addEventListener('click', () => processRequest(elements.codeInput.value, 'coding', 'explain'));
elements.obfuscateBtn.addEventListener('click', () => processRequest(elements.codeInput.value, 'coding', 'obfuscate'));
elements.deobfuscateBtn.addEventListener('click', () => processRequest(elements.codeInput.value, 'coding', 'deobfuscate'));
elements.improveBtn.addEventListener('click', () => processRequest(elements.codeInput.value, 'coding', 'improve'));
elements.generalBtn.addEventListener('click', () => processRequest(elements.generalInput.value, 'general', 'general'));
elements.homeworkBtn.addEventListener('click', () => processRequest(elements.homeworkInput.value, 'homework', 'homework'));
elements.analyzeBtn.addEventListener('click', () => processRequest(elements.analysisInput.value, 'analysis', 'analyze'));

elements.retryCodeBtn.addEventListener('click', () => processRequest(elements.codeInput.value, 'coding', 'optimize'));
elements.retryGeneralBtn.addEventListener('click', () => processRequest(elements.generalInput.value, 'general', 'general'));
elements.retryHomeworkBtn.addEventListener('click', () => processRequest(elements.homeworkInput.value, 'homework', 'homework'));
elements.retryAnalysisBtn.addEventListener('click', () => processRequest(elements.analysisInput.value, 'analysis', 'analyze'));

document.querySelectorAll('.clear-btn').forEach(btn => btn.addEventListener('click', () => elements.codeInput.value = ''));
document.querySelectorAll('.clear-general-btn').forEach(btn => btn.addEventListener('click', () => elements.generalInput.value = ''));
document.querySelectorAll('.clear-homework-btn').forEach(btn => btn.addEventListener('click', () => elements.homeworkInput.value = ''));
document.querySelectorAll('.clear-analysis-btn').forEach(btn => btn.addEventListener('click', () => elements.analysisInput.value = ''));

document.querySelectorAll('.copy-input-btn').forEach(btn => btn.addEventListener('click', () => navigator.clipboard.writeText(elements.codeInput.value)));
document.querySelectorAll('.copy-general-input-btn').forEach(btn => btn.addEventListener('click', () => navigator.clipboard.writeText(elements.generalInput.value)));
document.querySelectorAll('.copy-homework-input-btn').forEach(btn => btn.addEventListener('click', () => navigator.clipboard.writeText(elements.homeworkInput.value)));
document.querySelectorAll('.copy-analysis-input-btn').forEach(btn => btn.addEventListener('click', () => navigator.clipboard.writeText(elements.analysisInput.value)));

document.querySelectorAll('.copy-output-btn').forEach(btn => btn.addEventListener('click', () => navigator.clipboard.writeText(elements.codeOutput.textContent)));
document.querySelectorAll('.copy-general-output-btn').forEach(btn => btn.addEventListener('click', () => navigator.clipboard.writeText(elements.generalOutput.textContent)));
document.querySelectorAll('.copy-homework-output-btn').forEach(btn => btn.addEventListener('click', () => navigator.clipboard.writeText(elements.homeworkOutput.textContent)));
document.querySelectorAll('.copy-analysis-output-btn').forEach(btn => btn.addEventListener('click', () => navigator.clipboard.writeText(elements.analysisOutput.textContent)));

document.querySelectorAll('.download-btn').forEach(btn => btn.addEventListener('click', () => downloadText(elements.codeOutput.textContent, 'processed-code.txt')));
document.querySelectorAll('.download-general-btn').forEach(btn => btn.addEventListener('click', () => downloadText(elements.generalOutput.textContent, 'general-response.txt')));
document.querySelectorAll('.download-homework-btn').forEach(btn => btn.addEventListener('click', () => downloadText(elements.homeworkOutput.textContent, 'homework-solution.txt')));
document.querySelectorAll('.download-analysis-btn').forEach(btn => btn.addEventListener('click', () => downloadText(elements.analysisOutput.textContent, 'analysis-report.txt')));

function downloadText(text, filename) {
    const blob = new Blob([text], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}
</script>
</body>
</html>
